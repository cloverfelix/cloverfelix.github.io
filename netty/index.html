<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Netty - clover</title><meta name="Description" content="Netty"><meta property="og:title" content="Netty" />
<meta property="og:description" content="Netty" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cloverfelix.github.io/netty/" /><meta property="og:image" content="https://cloverfelix.github.io/RW.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-04T16:44:07&#43;08:00" />
<meta property="article:modified_time" content="2021-07-04T16:44:07&#43;08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://cloverfelix.github.io/RW.png"/>

<meta name="twitter:title" content="Netty"/>
<meta name="twitter:description" content="Netty"/>
<meta name="application-name" content="Clover">
<meta name="apple-mobile-web-app-title" content="Clover"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://cloverfelix.github.io/netty/" /><link rel="prev" href="https://cloverfelix.github.io/spring/" /><link rel="next" href="https://cloverfelix.github.io/environment/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Netty",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/cloverfelix.github.io\/netty\/"
        },"image": ["https:\/\/cloverfelix.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "Netty","wordcount":  79759 ,
        "url": "https:\/\/cloverfelix.github.io\/netty\/","datePublished": "2021-07-04T16:44:07+08:00","dateModified": "2021-07-04T16:44:07+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "clover","logo": "https:\/\/cloverfelix.github.io\/images\/RW.png"},"author": {
                "@type": "Person",
                "name": "Clover"
            },"description": "Netty"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="clover"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Clover</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/cloverfelix" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="clover"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Clover</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/cloverfelix" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Netty</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Clover</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/netty/"><i class="far fa-folder fa-fw"></i>Netty</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-07-04">2021-07-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 79759 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 160 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#21io模型基本说明">2.1、I/O模型基本说明</a></li>
    <li><a href="#22io模型适用场景">2.2、I/O模型适用场景</a></li>
    <li><a href="#23bio基本介绍">2.3、BIO基本介绍</a></li>
    <li><a href="#24bio工作机制">2.4、BIO工作机制</a></li>
    <li><a href="#25bio应用实例">2.5、BIO应用实例</a></li>
    <li><a href="#26java-bio问题分析">2.6、Java BIO问题分析</a></li>
  </ul>

  <ul>
    <li><a href="#31java-nio基本介绍">3.1、Java NIO基本介绍</a></li>
    <li><a href="#32nio和bio的比较">3.2、NIO和BIO的比较</a></li>
    <li><a href="#33nio三大核心原理示意图">3.3、NIO三大核心原理示意图</a></li>
    <li><a href="#34缓冲区buffer">3.4、缓冲区(Buffer)</a>
      <ul>
        <li><a href="#341基本介绍">3.4.1、基本介绍</a></li>
        <li><a href="#342buffer类及其子类">3.4.2、Buffer类及其子类</a></li>
        <li><a href="#343bytebuffer">3.4.3、ByteBuffer</a></li>
      </ul>
    </li>
    <li><a href="#35通道channel">3.5、通道(Channel)</a>
      <ul>
        <li><a href="#351基本介绍">3.5.1、基本介绍</a></li>
        <li><a href="#352filechannel类">3.5.2、FileChannel类</a></li>
        <li><a href="#353应用实例1-本地文件写数据">3.5.3、应用实例1-本地文件写数据</a></li>
        <li><a href="#354应用实例2-本地文件读写数据">3.5.4、应用实例2-本地文件读写数据</a></li>
        <li><a href="#355应用实例3-使用一个buffer完成文件读取写入">3.5.5、应用实例3-使用一个Buffer完成文件读取、写入</a></li>
        <li><a href="#356应用实例4-拷贝文件transferfrom方法">3.5.6、应用实例4-拷贝文件transferFrom方法</a></li>
        <li><a href="#357关于buffer和channel的注意事项和细节">3.5.7、关于Buffer和Channel的注意事项和细节</a></li>
      </ul>
    </li>
    <li><a href="#36selector选择器">3.6、Selector(选择器)</a>
      <ul>
        <li><a href="#361基本介绍">3.6.1、基本介绍</a></li>
        <li><a href="#362selector示意图和特点说明">3.6.2、Selector示意图和特点说明</a></li>
        <li><a href="#363selector类相关的方法">3.6.3、Selector类相关的方法</a></li>
      </ul>
    </li>
    <li><a href="#37nio非阻塞网络编程原理分析图">3.7、NIO非阻塞网络编程原理分析图</a></li>
    <li><a href="#38nio非阻塞网络编程快速入门">3.8、NIO非阻塞网络编程快速入门</a></li>
    <li><a href="#39selectionkey">3.9、SelectionKey</a></li>
    <li><a href="#310serversocketchannel">3.10、ServerSocketChannel</a></li>
    <li><a href="#311socketchannel">3.11、SocketChannel</a></li>
    <li><a href="#312nio网络编程应用实例-群聊系统">3.12、NIO网络编程应用实例-群聊系统</a></li>
    <li><a href="#313nio与零拷贝">3.13、NIO与零拷贝</a>
      <ul>
        <li><a href="#3131零拷贝基本介绍">3.13.1、零拷贝基本介绍</a></li>
        <li><a href="#3132传统io">3.13.2、传统IO</a></li>
        <li><a href="#3133mmap优化">3.13.3、mmap优化</a></li>
        <li><a href="#3134sendfile优化">3.13.4、sendFile优化</a></li>
        <li><a href="#3135零拷贝的再次理解">3.13.5、零拷贝的再次理解</a></li>
        <li><a href="#3136mmap和sendfile的区别">3.13.6、mmap和sendFile的区别</a></li>
      </ul>
    </li>
    <li><a href="#314零拷贝实例">3.14、零拷贝实例</a>
      <ul>
        <li><a href="#3141传统io方式">3.14.1、传统IO方式</a></li>
        <li><a href="#3142transferto">3.14.2、transferTo</a></li>
      </ul>
    </li>
    <li><a href="#315java-aio基本介绍">3.15、Java AIO基本介绍</a></li>
    <li><a href="#316bionioaio对比表">3.16、BIO、NIO、AIO对比表</a></li>
  </ul>

  <ul>
    <li><a href="#41原生nio存在的问题">4.1、原生NIO存在的问题</a></li>
    <li><a href="#42netty官网说明">4.2、Netty官网说明</a></li>
    <li><a href="#43netty的优点">4.3、Netty的优点</a></li>
    <li><a href="#44版本说明">4.4、版本说明</a></li>
  </ul>

  <ul>
    <li><a href="#51线程模型基本介绍">5.1、线程模型基本介绍</a></li>
    <li><a href="#52传统阻塞io服务模型">5.2、传统阻塞I/O服务模型</a>
      <ul>
        <li><a href="#521工作原理图">5.2.1、工作原理图</a></li>
        <li><a href="#522模型特点">5.2.2、模型特点</a></li>
        <li><a href="#523问题分析">5.2.3、问题分析</a></li>
      </ul>
    </li>
    <li><a href="#53reactor模式">5.3、Reactor模式</a>
      <ul>
        <li><a href="#531针对传统阻塞io服务模型的2个缺点解决方案">5.3.1、针对传统阻塞I/O服务模型的2个缺点，解决方案</a></li>
        <li><a href="#532reactor模式中核心组成">5.3.2、Reactor模式中核心组成：</a></li>
        <li><a href="#533reactor模式分类">5.3.3、Reactor模式分类：</a></li>
      </ul>
    </li>
    <li><a href="#54单reactor-单线程">5.4、单Reactor 单线程</a>
      <ul>
        <li><a href="#541方案说明">5.4.1、方案说明</a></li>
        <li><a href="#542方案优缺点分析">5.4.2、方案优缺点分析</a></li>
      </ul>
    </li>
    <li><a href="#55单reactor-多线程">5.5、单Reactor 多线程</a>
      <ul>
        <li><a href="#551方案说明">5.5.1、方案说明：</a></li>
        <li><a href="#552方案优缺点分析">5.5.2、方案优缺点分析：</a></li>
      </ul>
    </li>
    <li><a href="#56主从reactor-多线程">5.6、主从Reactor 多线程</a>
      <ul>
        <li><a href="#561方案说明">5.6.1、方案说明：</a></li>
        <li><a href="#562方案优缺点说明">5.6.2、方案优缺点说明</a></li>
      </ul>
    </li>
    <li><a href="#57reactor模式小结">5.7、Reactor模式小结</a></li>
    <li><a href="#58netty模型">5.8、Netty模型</a>
      <ul>
        <li><a href="#581工作原理示意图1-简单版">5.8.1、工作原理示意图1-简单版</a></li>
        <li><a href="#582工作原理示意图2-进阶版">5.8.2、工作原理示意图2-进阶版</a></li>
        <li><a href="#583工作原理示意图3-详细版">5.8.3、工作原理示意图3-详细版</a></li>
        <li><a href="#584netty快速入门实例-tcp服务">5.8.4、Netty快速入门实例-TCP服务</a></li>
        <li><a href="#585任务队列中的task有3种典型使用场景">5.8.5、任务队列中的Task有3种典型使用场景</a></li>
      </ul>
    </li>
    <li><a href="#59异步模型">5.9、异步模型</a>
      <ul>
        <li><a href="#591基本介绍">5.9.1、基本介绍</a></li>
        <li><a href="#592future说明">5.9.2、Future说明</a></li>
        <li><a href="#593工作原理示意图">5.9.3、工作原理示意图</a></li>
        <li><a href="#594future-listener机制">5.9.4、Future-Listener机制</a></li>
      </ul>
    </li>
    <li><a href="#510快速入门实例-http服务">5.10、快速入门实例-HTTP服务</a></li>
  </ul>

  <ul>
    <li><a href="#61bootstrapserverbootstrap">6.1、Bootstrap、ServerBootstrap</a></li>
    <li><a href="#62futurechannelfuture">6.2、Future、ChannelFuture</a></li>
    <li><a href="#63channel">6.3、Channel</a></li>
    <li><a href="#64selector">6.4、Selector</a></li>
    <li><a href="#65channelhandler-及其实现类">6.5、ChannelHandler 及其实现类</a></li>
    <li><a href="#66pipeline和channelpipeline">6.6、Pipeline和ChannelPipeline</a></li>
    <li><a href="#67channelhandlercontext">6.7、ChannelHandlerContext</a></li>
    <li><a href="#68channeloption">6.8、ChannelOption</a></li>
    <li><a href="#69eventloopgroup-和其实现类-nioeventloopgroup">6.9、EventLoopGroup 和其实现类 NioEventLoopGroup</a></li>
    <li><a href="#610unpooled类">6.10、Unpooled类</a></li>
    <li><a href="#611群聊系统升级">6.11、群聊系统升级</a></li>
    <li><a href="#612netty心跳检测机制案例">6.12、Netty心跳检测机制案例</a></li>
    <li><a href="#613netty-通过websocket编程实现服务器和客户端长连接">6.13、Netty 通过WebSocket编程实现服务器和客户端长连接</a></li>
  </ul>

  <ul>
    <li><a href="#71编码和解码的基本介绍">7.1、编码和解码的基本介绍</a></li>
    <li><a href="#72netty-本身的编码解码的机制和问题分析">7.2、Netty 本身的编码解码的机制和问题分析</a></li>
    <li><a href="#73protobuf">7.3、Protobuf</a>
      <ul>
        <li><a href="#731protobuf基本介绍和使用示意图">7.3.1、Protobuf基本介绍和使用示意图</a></li>
      </ul>
    </li>
    <li><a href="#74protobuf快速入门实例1">7.4、Protobuf快速入门实例1</a></li>
    <li><a href="#75protobuf快速入门实例2">7.5、Protobuf快速入门实例2</a></li>
  </ul>

  <ul>
    <li><a href="#81基本说明">8.1、基本说明</a></li>
    <li><a href="#82编码解码器">8.2、编码解码器</a></li>
    <li><a href="#83解码器-bytetomessagedecoder">8.3、解码器-ByteToMessageDecoder</a></li>
    <li><a href="#84netty的handler链的调用机制">8.4、Netty的handler链的调用机制</a></li>
    <li><a href="#85解码器-replayingdecoder">8.5、解码器-ReplayingDecoder</a></li>
    <li><a href="#86其它编解码器">8.6、其它编解码器</a></li>
  </ul>

  <ul>
    <li><a href="#91tcp-粘包和拆包基本介绍">9.1、TCP 粘包和拆包基本介绍</a></li>
    <li><a href="#92tcp粘包和拆包案例">9.2、TCP粘包和拆包案例</a></li>
    <li><a href="#93tcp粘包和拆包解决方案">9.3、TCP粘包和拆包解决方案</a></li>
  </ul>

  <ul>
    <li><a href="#101基本说明">10.1、基本说明</a></li>
    <li><a href="#102netty-启动过程源码剖析">10.2、Netty 启动过程源码剖析</a>
      <ul>
        <li><a href="#1021源码剖析目的">10.2.1、源码剖析目的</a></li>
        <li><a href="#1022源码剖析">10.2.2、源码剖析</a></li>
        <li><a href="#1023源码剖析过程">10.2.3、源码剖析过程</a>
          <ul>
            <li><a href="#1demo源码的基本理解">1、demo源码的基本理解</a></li>
            <li><a href="#2服务器端处理器代码">2、服务器端处理器代码</a></li>
            <li><a href="#3serverbootstrap基本使用情况">3、ServerBootstrap基本使用情况</a></li>
            <li><a href="#4端口绑定的分析">4、端口绑定的分析</a>
              <ul>
                <li><a href="#41服务器就是在这个bind方法里面启动完成的">4.1、服务器就是在这个bind方法里面启动完成的</a></li>
                <li><a href="#42bind方法追踪到创建了一个端口对象并做了一些空判断核心代码dobind">4.2、bind方法，追踪到创建了一个端口对象，并做了一些空判断，核心代码doBind</a></li>
                <li><a href="#43dobind-源码剖析核心是两个方法-initandrefister-和-dobind">4.3、doBind 源码剖析，核心是两个方法 initAndRefister 和 doBind()</a></li>
                <li><a href="#44分析说明-initandregister">4.4、分析说明 initAndRegister</a></li>
                <li><a href="#45init方法会调用-addlast现在进入到-addlast方法内查看">4.5、init方法会调用 addLast，现在进入到 addLast方法内查看</a></li>
                <li><a href="#46前面说了-dobind-方法有两个重要的步骤initandregister说完解下来看-dobind0方法代码如下">4.6、前面说了 dobind 方法有两个重要的步骤，initAndRegister说完，解下来看 doBind0()方法，代码如下</a></li>
              </ul>
            </li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#103netty接收请求过程源码剖析">10.3、Netty接收请求过程源码剖析</a>
      <ul>
        <li><a href="#1031源码剖析目的">10.3.1、源码剖析目的</a></li>
        <li><a href="#1032源码剖析">10.3.2、源码剖析</a></li>
        <li><a href="#1033netty接受请求过程">10.3.3、Netty接受请求过程</a></li>
      </ul>
    </li>
    <li><a href="#104pipeline-handler-handlercontext创建源码剖析">10.4、Pipeline Handler HandlerContext创建源码剖析</a>
      <ul>
        <li><a href="#1041源码剖析目的">10.4.1、源码剖析目的</a></li>
        <li><a href="#1042源码剖析">10.4.2、源码剖析</a></li>
        <li><a href="#1043pipeline-handler-handlercontext-创建过程梳理">10.4.3、Pipeline Handler HandlerContext 创建过程梳理</a></li>
      </ul>
    </li>
    <li><a href="#105channelpipeline-调度-handler-的源码剖析">10.5、ChannelPipeline 调度 handler 的源码剖析</a>
      <ul>
        <li><a href="#1051源码剖析的目的">10.5.1、源码剖析的目的</a></li>
        <li><a href="#1052源码剖析">10.5.2、源码剖析</a></li>
        <li><a href="#1053源码分析">10.5.3、源码分析</a></li>
        <li><a href="#1054channel-pipeline-调度-handler-梳理">10.5.4、Channel Pipeline 调度 handler 梳理</a></li>
      </ul>
    </li>
    <li><a href="#106netty-心跳heartbeat服务源码剖析">10.6、Netty 心跳(heartbeat)服务源码剖析</a>
      <ul>
        <li><a href="#1061idlestatehandler-分析">10.6.1、IdleStateHandler 分析</a></li>
        <li><a href="#1062小结netty的心跳机制">10.6.2、小结Netty的心跳机制</a></li>
      </ul>
    </li>
    <li><a href="#107netty-核心组件-eventloop-源码剖析">10.7、Netty 核心组件 EventLoop 源码剖析</a>
      <ul>
        <li><a href="#1071源码剖析">10.7.1、源码剖析</a></li>
      </ul>
    </li>
    <li><a href="#108handler-中加入线程池和-context-中添加线程池的源码剖析">10.8、Handler 中加入线程池和 Context 中添加线程池的源码剖析</a>
      <ul>
        <li><a href="#1081源码剖析目的">10.8.1、源码剖析目的</a></li>
        <li><a href="#1082第一种方式">10.8.2、第一种方式</a></li>
        <li><a href="#1083write-方法的源码在-abstractchannelhandlercontext-类">10.8.3、write 方法的源码(在 AbstractChannelHandlerContext 类)</a></li>
        <li><a href="#1084第二种方式">10.8.4、第二种方式</a></li>
        <li><a href="#1085两种方式的比较">10.8.5、两种方式的比较</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#111rpc-基本介绍">11.1、RPC 基本介绍</a></li>
    <li><a href="#112rpc调用流程">11.2、RPC调用流程</a></li>
    <li><a href="#113自己实现-dubbo-rpc-基于-netty">11.3、自己实现 dubbo RPC (基于 Netty)</a>
      <ul>
        <li><a href="#1131需求说明">11.3.1、需求说明</a></li>
        <li><a href="#1132设计说明">11.3.2、设计说明</a></li>
      </ul>
    </li>
    <li><a href="#114代码实现">11.4、代码实现</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="1netty的介绍">1、Netty的介绍</h1>
<p>1、Netty是由JBOSS提供的一个Java开源框架，现为Github上的独立项目</p>
<p>2、Netty是一个<code>异步的</code>、<code>基于事件驱动</code>的<code>网络</code>应用框架，用以快速开发高性能、高可靠性的网络IO程序</p>
<ul>
<li>基于事件驱动：比如一个网页中有一个按钮，当你点击时会触发一个事件，这个事件就会去调用一个函数</li>
</ul>
<p>3、Netty主要针对在<code>TCP协议</code>下，面向Clients端的高并发应用，或者Peer-to-Peer场景下的大量数据持续传输的应用。</p>
<p>4、Netty本质是一个<code>NIO框架</code>，适用于服务器通讯相关的多种应用场景</p>
<p>5、要透彻理解Netty，需要先学习NIO，这样才能阅读Netty源码</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906172744.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906172744.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906172744.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906172744.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906172744.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906172744.png" /></p>
<h1 id="2bio">2、BIO</h1>
<h2 id="21io模型基本说明">2.1、I/O模型基本说明</h2>
<ol>
<li>
<p>I/O模型简单理解：就是用什么样的通道进行数据的发送和接收，很大程度上决定了程序通信的性能</p>
</li>
<li>
<p>Java共支持3种网络编程模型I/O模型：BIO、NIO、AIO</p>
</li>
<li>
<p>Java BIO：同步并阻塞(<strong>传统阻塞型</strong>)，服务器实现模式为一个连接对应一个线程，即客户端有连接请求时服务端就需要启动一个线程进行处理，如果这个连接不做任何事情会造成不必要的线程开销
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205501.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205501.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205501.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205501.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205501.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205501.png" /></p>
</li>
<li>
<p>Java NIO：<strong>同步非阻塞</strong>，服务器实现模式为一个线程处理多个请求(连接)，即客户端发送的连接请求都会注册到多路复用器上，多路复用器轮询到连接有I/O请求就进行处理
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205426.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205426.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205426.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205426.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205426.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210906205426.png" /></p>
</li>
</ol>
<p>5.Java AIO(NIO.2)：异步非阻塞，AIO引入异步通道的概念，采用了Proactor模式，简化了程序编写，有效的请求才启动线程，它的特点是先由操作系统完成后才通知服务端程序启动线程去处理，一般适用于连接数较多且连接时间较长的应用</p>
<h2 id="22io模型适用场景">2.2、I/O模型适用场景</h2>
<ol>
<li>BIO方式适用于<strong>连接数目比较小且固定</strong>的架构，这种方式对服务器资源要求比较高，并发局限于应用中，JDK1.4以前唯一选择，但是程序简单易理解。</li>
<li>NIO方式适用于<strong>连接数目多且连接比较短</strong>(轻操作)的架构，比如聊天服务器，弹幕系统，服务器间通讯等。编程比较复杂，JDK1.4开始支持。</li>
<li>AIO方式适用于<strong>连接数目多且连接比较长</strong>(重操作)的架构，比如相册服务器，充分调用操作系统参与并发操作，编程比较复杂，JDK7开始支持。</li>
</ol>
<h2 id="23bio基本介绍">2.3、BIO基本介绍</h2>
<ol>
<li>Java BIO就是<strong>传统的java io编程</strong>，其相关的类和接口在java.io</li>
<li>BIO(blocking I/O)：<strong>同步阻塞</strong>，服务器实现模式为一个连接对应一个线程，即客户端有连接请求时服务端就需要启动一个线程进行处理，如果这个连接不做任何事情会造成不必要的线程开销，可以通过<strong>线程池机制</strong>改善(实现多个客户连接服务器)</li>
</ol>
<h2 id="24bio工作机制">2.4、BIO工作机制</h2>
<ol>
<li>服务器端启动一个ServerSocket</li>
<li>客户端启动Socket对服务器进行通信，默认情况下服务器端需要对每个客户建立一个线程与之通信</li>
<li>客户端发出请求后，先咨询服务器是否有线程响应，如果没有则等待，或者被拒绝</li>
<li>如果有响应，客户端线程会等待请求结束后，再继续执行</li>
</ol>
<h2 id="25bio应用实例">2.5、BIO应用实例</h2>
<p><strong>实例说明</strong></p>
<ol>
<li>使用BIO模型编写一个服务器端，监听6666端口，当有客户端连接时，就启动一个线程与之通讯</li>
<li>要求使用线程池机制改善，可以连接多个客户端</li>
<li>服务器端可以接受客户端发送的数据(<code>telnet</code>方式即可)</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.bio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BIOServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="c1">// 线程池机制
</span><span class="c1"></span>
        <span class="c1">//思路
</span><span class="c1"></span>        <span class="c1">//1.创建一个线程池
</span><span class="c1"></span>        <span class="c1">//2.如果有客户端连接，就创建一个线程，与之通信(单独写一个方法)
</span><span class="c1"></span>
        <span class="n">ExecutorService</span> <span class="n">newCachedThreadPool</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newCachedThreadPool</span><span class="o">();</span>

        <span class="c1">// 创建ServerSocket
</span><span class="c1"></span>        <span class="n">ServerSocket</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">6666</span><span class="o">);</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器启动了&#34;</span><span class="o">);</span>

        <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
            <span class="c1">// 监听，等待客户端连接
</span><span class="c1"></span>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;线程信息 id =&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;名字=&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;等待连接.........&#34;</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;连接到一个客户端&#34;</span><span class="o">);</span>

            <span class="c1">// 连接到一个客户端就创建一个线程，与之通信(单独写一个方法)
</span><span class="c1"></span>            <span class="n">newCachedThreadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="c1">// 我们可以重写这个方法
</span><span class="c1"></span>                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="c1">// 可以和客户端通讯
</span><span class="c1"></span>                    <span class="n">handler</span><span class="o">(</span><span class="n">socket</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 编写一个handler方法和客户端通讯
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">handler</span><span class="o">(</span><span class="n">Socket</span> <span class="n">socket</span><span class="o">){</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;线程信息 id =&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;名字=&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
            <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">1024</span><span class="o">];</span>

            <span class="c1">// 通过socket获取输入流
</span><span class="c1"></span>            <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>

            <span class="c1">// 循环读取客户端发送的数据
</span><span class="c1"></span>            <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;线程信息 id =&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;名字=&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>

                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;read.........&#34;</span><span class="o">);</span>
                <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
                <span class="k">if</span><span class="o">(</span><span class="n">read</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">){</span>
                    <span class="c1">// 不等于-1说明还未读完，还可以继续读取
</span><span class="c1"></span>                    <span class="c1">// 输出客户端发送的数据
</span><span class="c1"></span>                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span><span class="n">0</span><span class="o">,</span><span class="n">read</span><span class="o">));</span>
                <span class="o">}</span><span class="k">else</span><span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;关闭和client的连接&#34;</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183049.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183049.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183049.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183049.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183049.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183049.png" /></p>
<p>还可以测试每一次客户端连接后对应的线程是否与它通讯的线程是否一样</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183754.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183754.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183754.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183754.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183754.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907183754.png" /></p>
<p>这个代码中的<code>accept和read</code>函数会产生阻塞情况</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184009.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184009.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184009.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184009.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184009.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184009.png" /></p>
<p>连接过后</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184240.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184240.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184240.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184240.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184240.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184240.png" /></p>
<p>有连接的就会卡在<code>read</code>处，但是当你发送数据后又会阻塞再read处，这就会使性能很低</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184527.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184527.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184527.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184527.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184527.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210907184527.png" /></p>
<h2 id="26java-bio问题分析">2.6、Java BIO问题分析</h2>
<ol>
<li>每个请求都需要创建独立的线程，与对应的客户端进行数据Read，业务处理，数据Write</li>
<li>当并发数较大时，<strong>需要创建大量线程来处理连接</strong>，系统资源占用比较大</li>
<li>连接建立后，如果当前线程暂时没有数据可读，则线程就会阻塞再Read操作上，造成线程资源浪费</li>
</ol>
<h1 id="3nio">3、NIO</h1>
<h2 id="31java-nio基本介绍">3.1、Java NIO基本介绍</h2>
<ol>
<li>Java NIO全称Java non-blocking IO，是指JDK提供的新API。从JDK1.4开始，Java提供了一系列改进的输入/输出的新特性，被称为NIO(即New IO)，是<strong>同步非阻塞</strong>的。</li>
<li>NIO相关类都被放在Java.nio包及子包下，并且对原java.io包中的很多类进行改写。</li>
<li>NIO有三大核心部分：<strong>Channel(通道)</strong>，<strong>Buffer(缓冲区)</strong>，<strong>Selector(选择器)</strong></li>
<li>NIO是面向<strong>缓冲区，或者面向块</strong>编程的。数据读取到一个它稍后处理的缓冲区，需要时可在缓冲区中前后移动，这就增加了处理过程中的灵活性，使用它可以提供<strong>非阻塞式</strong>的高伸缩性网络。</li>
<li>Java NIO的非阻塞模式，使一个线程从某通道发送请求或者读取数据，但是它仅能得到目前可用的数据，如果目前没有数据可用时，就什么都不会获取，而<strong>不是保持线程阻塞</strong>，所以直至数据变的可以读取之前，该线程可以继续做其它的事情。非阻塞写也是如此，一个线程请求写入一些数据到某通道，但不需要等待它完全写入，这个线程同时可以去做别的事情</li>
<li>通俗理解：NIO是可以做到用一个线程来处理多个操作的。假设有10000个请求过来，根据实际情况，可以分配50或者100个线程来处理。不像之前的阻塞IO那样，非得分配10000个。</li>
<li>HTTP2.0使用了<strong>多路复用技术</strong>，做到同一个连接并发处理多个请求，而且并发请求的数量比HTTP1.1大了好几个数量级。</li>
</ol>
<h2 id="32nio和bio的比较">3.2、NIO和BIO的比较</h2>
<ol>
<li>BIO是以流的方式处理数据，而NIO以块的方式处理数据，块I/O的效率比流I/O高很多</li>
<li>BIO是阻塞的，NIO则是非阻塞的</li>
<li>BIO基于字节流和字符流进行操作，而NIO基于<strong>Channel(通道)</strong> 和 <strong>Buffer(缓冲区)</strong> 进行操作，<code>数据总是从通道读取到缓冲区中，或者从缓冲区写入到通道中</code>。Selector(选择器)用于监听多个通道的事件(比如；连接请求，数据到达等)，因此使用<strong>单个线程就可以监听多个客户端</strong>通道</li>
</ol>
<h2 id="33nio三大核心原理示意图">3.3、NIO三大核心原理示意图</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908151106.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908151106.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908151106.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908151106.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908151106.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908151106.png" /></p>
<p><strong>Selector、Channel和Buffer的关系图说明</strong></p>
<ol>
<li>每个Channel都会对应一个Buffer</li>
<li>每个Selector都对应一个线程，一个线程对应多个Channel(连接)</li>
<li>该图反应了有三个Channel注册到了该Selector(使用程序解释)</li>
<li>程序切换到哪个Channel是由事件决定的，Event就是一个重要的概念</li>
<li>Selector会根据不同的事件，在各个通道上切换</li>
<li>Buffer就是一个内存块，底层是有一个数组</li>
<li>数据的读取写入是通过Buffer，这个和BIO有本质的区别，BIO中要么是输入流，或者是输出流，不能双向，但是NIO的Buffer是可以读也可以写，需要flip方法切换</li>
<li>Channel是双向的，可以返回底层操作系统的情况，比如Linux，底层的操作系统通道就是双向的</li>
</ol>
<h2 id="34缓冲区buffer">3.4、缓冲区(Buffer)</h2>
<h3 id="341基本介绍">3.4.1、基本介绍</h3>
<p>缓冲区(Buffer)：缓冲区本质上是一个<strong>可以读写数据的内存块</strong>，可以理解成是一个<strong>容器对象(含数组)</strong>，该对象提供了<strong>一组方法</strong>，可以更轻松地使用内存块，缓冲区对象内置了一些机制，能够跟踪和记录缓冲区的状态变化情况。Channel提供从文件、网络读取数据的渠道，但是读取或写入的数据都必须经由Buffer。如图：(后面举例说明)</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908162426.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908162426.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908162426.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908162426.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908162426.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908162426.png" /></p>
<h3 id="342buffer类及其子类">3.4.2、Buffer类及其子类</h3>
<ol>
<li>在NIO中，Buffer是一个顶层父类，它是一个抽象类，类的层级关系图</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165147.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165147.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165147.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165147.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165147.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165147.png" /></p>
<ol start="2">
<li>Buffer类定义了所有的缓冲区都具有的四个属性来提供关于其所包含的数据元素的信息</li>
</ol>
<ul>
<li><strong>Capacity</strong>：容量，即可以容纳的最大数据量；在缓冲区创建的时候被设定并且不能改变</li>
<li><strong>Limit</strong>：表示缓冲区的当前终点，不能对缓冲区超过极限的位置进行读写操作。且极限是可以修改的</li>
<li><strong>Position</strong>：位置，下一个要被读或写的元素的索引，每次读写缓冲区数据时都会改变值，为下次读写做准备</li>
<li><strong>Mark</strong>：标记</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165856.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165856.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165856.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165856.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165856.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908165856.png" /></p>
<ol start="3">
<li>Buffer类相关方法</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170155.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170155.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170155.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170155.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170155.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170155.png" /></p>
<h3 id="343bytebuffer">3.4.3、ByteBuffer</h3>
<p>从前面可以看出对于Java中的基本数据类型(boolean除外)，都有一个Buffer类型与之相对应，<strong>最常用</strong>的自然是ByteBuffer类(二进制数据)，该类的主要方法如下</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170707.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170707.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170707.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170707.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170707.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908170707.png" /></p>
<h2 id="35通道channel">3.5、通道(Channel)</h2>
<h3 id="351基本介绍">3.5.1、基本介绍</h3>
<ol>
<li>NIO的通道类似于流，但是有些区别如下
<ul>
<li>通道可以同时进行读写，而流只能读或者写</li>
<li>通道可以实现异步读写数据</li>
<li>通道可以从缓冲区读数据，也可以写数据到缓冲区中</li>
</ul>
</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908172448.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908172448.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908172448.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908172448.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908172448.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908172448.png" /></p>
<ol start="2">
<li>BIO中的Stream是单向的，例如FileInputStream对象只能进行读取数据的操作，而NIO中的通道(Channel)是双向的，可以读操作，也可以写操作</li>
<li>Channel在NIO中是一个接口<code>public interface Channel extends Closeable{}</code></li>
<li>常用的Channel类有：FileChannel、DatagramChannel、<strong>ServerSocketChannel</strong>和<strong>SocketChannel</strong>
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908173140.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908173140.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908173140.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908173140.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908173140.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210908173140.png" />
<ul>
<li>这里需要注意<strong>ServerSocketChannel</strong>和<strong>SocketChannel</strong>两个类</li>
<li>当有一个连接产生的时候，我们Server中的<code>ServerSocketChannel</code>会产生一个与该客户端对应的通道，通道类型为<code>SocketChannel</code>，而其真实的实现类型为<code>SockerChannelImpl</code>，然后再通过该通道与服务器进行通讯</li>
</ul>
</li>
<li>FileChannel用于文件的数据读写，DatagramChannel用于UDP的数据读写，ServerSocketChannel和SocketChannel用于TCP的数据读写</li>
</ol>
<h3 id="352filechannel类">3.5.2、FileChannel类</h3>
<p>FileChannel主要用来对本地文件进行IO操作，常见的方法有</p>
<ol>
<li><code>public int read (ByteBuffer dst)</code> ，从通道读取数据并放入缓冲区中</li>
<li><code>public int write(ByteBuffer src)</code> ，把缓冲区的数据写到通道中</li>
<li><code>public long transferFrom(ReadableByteChannel src,long position,long count)</code> , 从目标通道中复制数据到当前通道</li>
<li><code>public long transferTo(long position,long count,WriteableByteChannel target)</code> , 把数据从当前通道复制给目标通道</li>
</ol>
<h3 id="353应用实例1-本地文件写数据">3.5.3、应用实例1-本地文件写数据</h3>
<p>实例要求：</p>
<ol>
<li>使用前面学习后的ByteBuffer(缓冲)和FileChannel(通道)，将&quot;hello,韋&quot;写入到file01.txt中</li>
<li>文件不存在就创建 <strong>(一个汉字3个字节)</strong>
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091517.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091517.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091517.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091517.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091517.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091517.png" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091823.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091823.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091823.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091823.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091823.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909091823.png" /></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NIOFileChannel01</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">&#34;hello,韋&#34;</span><span class="o">;</span>
      <span class="c1">//创建一个输出流-&gt;然后获取内置channel
</span><span class="c1"></span>      <span class="n">FileOutputStream</span> <span class="n">fileOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">&#34;H:\\file01.txt&#34;</span><span class="o">);</span>

      <span class="c1">//通过FileOutputStream获取对应的FileChannel
</span><span class="c1"></span>      <span class="c1">//这个FileChannel真实类型为FileChannelImpl
</span><span class="c1"></span>      <span class="n">FileChannel</span> <span class="n">fileChannel</span> <span class="o">=</span> <span class="n">fileOutputStream</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>

      <span class="c1">//创建一个缓冲区 ByteBuffer
</span><span class="c1"></span>      <span class="n">ByteBuffer</span> <span class="n">byteBuffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">1024</span><span class="o">);</span>

      <span class="c1">//将数据放入缓冲区中
</span><span class="c1"></span>      <span class="n">byteBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>

      <span class="c1">//数据写入完毕后要将buffer反转
</span><span class="c1"></span>      <span class="n">byteBuffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>

      <span class="c1">// 将缓冲区数据写入fileChannel
</span><span class="c1"></span>      <span class="n">fileChannel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">);</span>
      <span class="c1">//因为fileChannel中封装了Java的输出流，最终写入文件中也是通过流写入，所以最后需要关闭
</span><span class="c1"></span>      <span class="n">fileOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="354应用实例2-本地文件读写数据">3.5.4、应用实例2-本地文件读写数据</h3>
<p>实例要求：</p>
<ol>
<li>使用前面学习后的ByteBuffer(缓冲)和FileChannel(通道)，将file01.txt中的数据读入到程序，并显示再控制台屏幕</li>
<li>假定文件已存在
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909093607.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909093607.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909093607.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909093607.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909093607.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909093607.png" /></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NIOFileChannel02</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
      <span class="c1">//创建一个文件的输入流-&gt;然后获取内置channel
</span><span class="c1"></span>      <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;H:\\file01.txt&#34;</span><span class="o">);</span>
      <span class="n">FileInputStream</span> <span class="n">fileInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>

      <span class="c1">//通过fileInputStream获取对应的channel
</span><span class="c1"></span>      <span class="n">FileChannel</span> <span class="n">fileChannel</span> <span class="o">=</span> <span class="n">fileInputStream</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>

      <span class="c1">//创建一个缓冲区
</span><span class="c1"></span>      <span class="n">ByteBuffer</span> <span class="n">byteBuffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>

      <span class="c1">//将通道中的数据向缓冲区中写入
</span><span class="c1"></span>      <span class="n">fileChannel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">);</span>

      <span class="c1">//将byteBuffer的字节数据转成String
</span><span class="c1"></span>      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">.</span><span class="na">array</span><span class="o">()));</span>

      <span class="n">fileInputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="355应用实例3-使用一个buffer完成文件读取写入">3.5.5、应用实例3-使用一个Buffer完成文件读取、写入</h3>
<p>实例要求：</p>
<ol>
<li>使用FIleChannel(通道)和方法read,write，完成文件的拷贝</li>
<li>拷贝一个文本文件 1.txt，放在项目下即可
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909094437.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909094437.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909094437.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909094437.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909094437.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909094437.png" /></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.nio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NIOFileChannel03</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
      <span class="c1">// 创建一个文件
</span><span class="c1"></span>      <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;H:\\1.txt&#34;</span><span class="o">);</span>
      <span class="n">FileInputStream</span> <span class="n">fileInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">file</span><span class="o">);</span>
      <span class="c1">// 通过文件输入流获取channel
</span><span class="c1"></span>      <span class="n">FileChannel</span> <span class="n">fileInputStreamChannel</span> <span class="o">=</span> <span class="n">fileInputStream</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>

      <span class="c1">// 创建一个输出流，读取数据
</span><span class="c1"></span>      <span class="n">FileOutputStream</span> <span class="n">fileOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">&#34;H:\\2.txt&#34;</span><span class="o">);</span>
      <span class="c1">// 获取对应的channel
</span><span class="c1"></span>      <span class="n">FileChannel</span> <span class="n">fileOutputStreamChannel</span> <span class="o">=</span> <span class="n">fileOutputStream</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>

      <span class="c1">// 创建一个缓冲区
</span><span class="c1"></span>      <span class="n">ByteBuffer</span> <span class="n">byteBuffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">((</span><span class="kt">int</span><span class="o">)</span> <span class="n">file</span><span class="o">.</span><span class="na">length</span><span class="o">());</span>

      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
          <span class="c1">// 这里有一个重要操作，一定不能忘记
</span><span class="c1"></span>          <span class="n">byteBuffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span> <span class="c1">// 清空buffer
</span><span class="c1"></span>          <span class="c1">// 将通道数据写入缓冲区
</span><span class="c1"></span>          <span class="kt">int</span> <span class="n">read</span> <span class="o">=</span> <span class="n">fileInputStreamChannel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">read</span> <span class="o">==</span> <span class="o">-</span><span class="n">1</span><span class="o">){</span>
              <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="c1">// buffer写入完数据后要反转为后面从buffer读取数据做准备
</span><span class="c1"></span>          <span class="n">byteBuffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
          <span class="c1">// 将缓冲区数据读取到通道中
</span><span class="c1"></span>          <span class="n">fileOutputStreamChannel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">byteBuffer</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// 关闭相关的流
</span><span class="c1"></span>      <span class="n">fileInputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="n">fileOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="356应用实例4-拷贝文件transferfrom方法">3.5.6、应用实例4-拷贝文件transferFrom方法</h3>
<p>实例要求：</p>
<ol>
<li>使用FileChannel(通道)和方法 transferFrom，完成文件的拷贝</li>
<li>拷贝一张图片</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NIOFileChannel04</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
      <span class="c1">// 创建相关的流
</span><span class="c1"></span>      <span class="n">FileInputStream</span> <span class="n">fileInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="s">&#34;H:\\1.jpg&#34;</span><span class="o">);</span>
      <span class="n">FileOutputStream</span> <span class="n">fileOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="s">&#34;H:\\2.jpg&#34;</span><span class="o">);</span>

      <span class="c1">// 获取相关流所对应的通道
</span><span class="c1"></span>      <span class="n">FileChannel</span> <span class="n">fileInputStreamChannel</span> <span class="o">=</span> <span class="n">fileInputStream</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>
      <span class="n">FileChannel</span> <span class="n">fileOutputStreamChannel</span> <span class="o">=</span> <span class="n">fileOutputStream</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>

      <span class="c1">// 将文件从目标通道拷贝到当前通道
</span><span class="c1"></span>      <span class="n">fileOutputStreamChannel</span><span class="o">.</span><span class="na">transferFrom</span><span class="o">(</span><span class="n">fileInputStreamChannel</span><span class="o">,</span><span class="n">0</span><span class="o">,</span><span class="n">fileInputStreamChannel</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>

      <span class="c1">// 关闭相关的通道和流
</span><span class="c1"></span>      <span class="n">fileInputStreamChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="n">fileOutputStreamChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="n">fileInputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="n">fileOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="357关于buffer和channel的注意事项和细节">3.5.7、关于Buffer和Channel的注意事项和细节</h3>
<ol>
<li>ByteBuffer支持类型化的put和get，put放入的是什么数据类型，get就应该使用响应的数据类型来取出，否则可能有BufferUnderflowException异常</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NIOByteBufferPutGet</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 创建一个Buffer
</span><span class="c1"></span>      <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">64</span><span class="o">);</span>

      <span class="c1">//类型化方式放入数据
</span><span class="c1"></span>      <span class="n">buffer</span><span class="o">.</span><span class="na">putInt</span><span class="o">(</span><span class="n">824</span><span class="o">);</span>
      <span class="n">buffer</span><span class="o">.</span><span class="na">putLong</span><span class="o">(</span><span class="n">8</span><span class="o">);</span>
      <span class="n">buffer</span><span class="o">.</span><span class="na">putChar</span><span class="o">(</span><span class="sc">&#39;韋&#39;</span><span class="o">);</span>
      <span class="n">buffer</span><span class="o">.</span><span class="na">putShort</span><span class="o">((</span><span class="kt">short</span><span class="o">)</span> <span class="n">4</span><span class="o">);</span>

      <span class="c1">// 取出数据
</span><span class="c1"></span>      <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>

      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">getInt</span><span class="o">());</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">getLong</span><span class="o">());</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">getChar</span><span class="o">());</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">getShort</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909111514.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909111514.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909111514.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909111514.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909111514.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909111514.png" /></p>
<ol start="2">
<li>可以将一个普通的Buffer转成只读Buffer</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReadOnlyBuffer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 创建一个Buffer
</span><span class="c1"></span>      <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">64</span><span class="o">);</span>
      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">64</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
          <span class="n">buffer</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="n">i</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">//读取
</span><span class="c1"></span>      <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>

      <span class="c1">// 得到一个只读的Buffer
</span><span class="c1"></span>      <span class="n">ByteBuffer</span> <span class="n">readOnlyBuffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="na">asReadOnlyBuffer</span><span class="o">();</span>
      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">readOnlyBuffer</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>

      <span class="k">while</span> <span class="o">(</span><span class="n">readOnlyBuffer</span><span class="o">.</span><span class="na">hasRemaining</span><span class="o">()){</span>
          <span class="c1">// 这个方法会让我们的position自动加1
</span><span class="c1"></span>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">readOnlyBuffer</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
      <span class="o">}</span>

      <span class="n">readOnlyBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="kt">byte</span><span class="o">)</span> <span class="n">824</span><span class="o">);</span> <span class="c1">// 用只读的Buffer进行写入操作会抛出ReadOnlyBufferException
</span><span class="c1"></span>  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909112807.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909112807.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909112807.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909112807.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909112807.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909112807.png" /></p>
<ol start="3">
<li>NIO还提供了MappedByteBuffer，可以让文件直接在内存(堆外的内存)中进行修改，而如何同步到文件由NIO来完成</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.RandomAccessFile</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.MappedByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>

<span class="cm">/*
</span><span class="cm"> * 说明
</span><span class="cm"> * 1.MappedByteBuffer 可以让文件直接在内存(堆外内存)中修改，操作系统不需要拷贝一次
</span><span class="cm"> */</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MappedByteBufferTest</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
      <span class="n">RandomAccessFile</span> <span class="n">randomAccessFile</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RandomAccessFile</span><span class="o">(</span><span class="s">&#34;H:\\1.txt&#34;</span><span class="o">,</span> <span class="s">&#34;rw&#34;</span><span class="o">);</span>
      <span class="c1">//获取对应的通道
</span><span class="c1"></span>      <span class="n">FileChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">randomAccessFile</span><span class="o">.</span><span class="na">getChannel</span><span class="o">();</span>

      <span class="cm">/*
</span><span class="cm">       * 参数1：FileChannel.MapMode.READ_WRITE 使用的读写模式
</span><span class="cm">       * 参数2：0 ：可以直接修改的起始位置
</span><span class="cm">       * 参数3：5 ：是映射到内存的大小(不是索引位置)，即将 1.txt的多少个字节映射到内存
</span><span class="cm">       * 可以直接修改的范围就是0-5
</span><span class="cm">       * MappedByteBuffer 实际类型 DirectByteBuffer
</span><span class="cm">       */</span>
      <span class="n">MappedByteBuffer</span> <span class="n">mappedByteBuffer</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">FileChannel</span><span class="o">.</span><span class="na">MapMode</span><span class="o">.</span><span class="na">READ_WRITE</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">5</span><span class="o">);</span>

      <span class="n">mappedByteBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="sc">&#39;H&#39;</span><span class="o">);</span>
      <span class="n">mappedByteBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">3</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="sc">&#39;8&#39;</span><span class="o">);</span>
      <span class="n">mappedByteBuffer</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">5</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="sc">&#39;8&#39;</span><span class="o">);</span>  <span class="c1">//这个地方的5并不是代表索引，而是代表可以修改字节数的大小，超过5会抛出异常IndexOutOfBoundsException
</span><span class="c1"></span>
      <span class="n">randomAccessFile</span><span class="o">.</span><span class="na">close</span><span class="o">()</span> <span class="o">;</span>

  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909120125.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909120125.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909120125.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909120125.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909120125.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909120125.png" /></p>
<ol start="4">
<li>前面我们讲的读写操作，都是通过一个Buffer完成的，<strong>NIO还支持通过多个Buffer(即Buffer数组)完成读写操作</strong>，即Scattering和Gatering</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.ServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="cm">/*
</span><span class="cm"> * Scattering：将数据写入到buffer时，可以采用buffer数组，依次写入  [分散]
</span><span class="cm"> * Gathering：从buffer读取数据时，可以采用buffer数组，依次读取
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ScatteringAndGatheringTest</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
      <span class="c1">// 使用ServerSocketChannel 和 SocketChannel  这就需要网络了
</span><span class="c1"></span>      <span class="n">ServerSocketChannel</span> <span class="n">serverSocketChannel</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
      <span class="n">InetSocketAddress</span> <span class="n">inetSocketAddress</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">7000</span><span class="o">);</span>

      <span class="c1">// 绑定端口到socket，并启动
</span><span class="c1"></span>      <span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="n">inetSocketAddress</span><span class="o">);</span>

      <span class="c1">// 创建buffer数组
</span><span class="c1"></span>      <span class="n">ByteBuffer</span><span class="o">[]</span> <span class="n">byteBuffers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteBuffer</span><span class="o">[</span><span class="n">2</span><span class="o">];</span>
      <span class="n">byteBuffers</span><span class="o">[</span><span class="n">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">5</span><span class="o">);</span>
      <span class="n">byteBuffers</span><span class="o">[</span><span class="n">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>

      <span class="c1">// 等待客户端连接(telnet)
</span><span class="c1"></span>      <span class="n">SocketChannel</span> <span class="n">socketChannel</span> <span class="o">=</span> <span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>

      <span class="kt">int</span> <span class="n">messageLength</span> <span class="o">=</span> <span class="n">8</span><span class="o">;</span>   <span class="c1">// 假设我们从客户端最多接受8个字节
</span><span class="c1"></span>
      <span class="c1">// 循环读取
</span><span class="c1"></span>      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
          <span class="c1">// 统计读取了多少个字节
</span><span class="c1"></span>          <span class="kt">int</span> <span class="n">byteRead</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
          <span class="k">while</span> <span class="o">(</span><span class="n">byteRead</span> <span class="o">&lt;</span> <span class="n">messageLength</span><span class="o">){</span>
              <span class="kt">long</span> <span class="n">l</span> <span class="o">=</span> <span class="n">socketChannel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">byteBuffers</span><span class="o">);</span>
              <span class="n">byteRead</span> <span class="o">+=</span> <span class="n">l</span><span class="o">;</span><span class="c1">// 累计读取的字节数
</span><span class="c1"></span>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;byteRead =&#34;</span> <span class="o">+</span> <span class="n">byteRead</span><span class="o">);</span>
              <span class="c1">// 使用流打印，查看当前buffer的position和limit
</span><span class="c1"></span>              <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">byteBuffers</span><span class="o">).</span><span class="na">stream</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">buffer</span> <span class="o">-&gt;</span> <span class="s">&#34;position=&#34;</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;,limit=&#34;</span> <span class="o">+</span> <span class="n">buffer</span><span class="o">.</span><span class="na">limit</span><span class="o">()).</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
          <span class="o">}</span>

          <span class="c1">// 将所有的buffer进行一个反转flip
</span><span class="c1"></span>          <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">byteBuffers</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">buffer</span> <span class="o">-&gt;</span> <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">());</span>

          <span class="c1">// 将数据读取出来显示在控制台
</span><span class="c1"></span>          <span class="kt">long</span> <span class="n">byteWrite</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span><span class="c1">// 查看显示在控制台字节大小
</span><span class="c1"></span>          <span class="k">while</span> <span class="o">(</span><span class="n">byteWrite</span> <span class="o">&lt;</span> <span class="n">messageLength</span><span class="o">){</span>
              <span class="kt">long</span> <span class="n">w</span> <span class="o">=</span> <span class="n">socketChannel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">byteBuffers</span><span class="o">);</span>
              <span class="n">byteWrite</span> <span class="o">+=</span> <span class="n">w</span><span class="o">;</span>
          <span class="o">}</span>

          <span class="c1">// 将所有的buffer进行clear
</span><span class="c1"></span>          <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">byteBuffers</span><span class="o">).</span><span class="na">forEach</span><span class="o">(</span><span class="n">buffer</span> <span class="o">-&gt;</span> <span class="o">{</span>
              <span class="c1">// 如果数据是全部读取完毕，接着再次往buffer写数据，这时position是上次读取位置，limit是最大可读取位置，全部读取完成position=limit
</span><span class="c1"></span>              <span class="c1">// 那么直接往里面写数据会报错，因为position必须小于limit，而我们也想从0开始存储，并且需要让最大存储限制limit应该是容量capacity
</span><span class="c1"></span>              <span class="c1">// 那我们就需要手动修改position和limit的值。让position=0，而limit=capacity，buffer提供了这个方法clear()
</span><span class="c1"></span>              <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
          <span class="o">});</span>

          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;byteRead=&#34;</span> <span class="o">+</span> <span class="n">byteRead</span> <span class="o">+</span> <span class="s">&#34;,byteWrite=&#34;</span> <span class="o">+</span> <span class="n">byteWrite</span> <span class="o">+</span> <span class="s">&#34;,messageLength=&#34;</span> <span class="o">+</span> <span class="n">messageLength</span><span class="o">);</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171320.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171320.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171320.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171320.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171320.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171320.png" />
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171205.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171205.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171205.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171205.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171205.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909171205.png" /></p>
<h2 id="36selector选择器">3.6、Selector(选择器)</h2>
<h3 id="361基本介绍">3.6.1、基本介绍</h3>
<ol>
<li>Java的NIO，用非阻塞的IO方式。可以用一个线程，处理多个的客户端连接，就会使用到<strong>Selector(选择器)</strong></li>
<li><strong>Selector能够检测到多个注册的通道上是否有事件发生(注意：多个Channel以事件的方式可以注册到同一个Selector)</strong>，如果有事件发生，便获取事件然后针对每个事件进行相应的处理。这样就可以只用一个单线程去管理多个通道，也就是管理多个连接和请求。</li>
<li>只有在通道真正有读写事件发生时，才会进行读写，就大大的减少了系统开销，并且不必为每个连接都创建一个线程，不用去维护多个线程</li>
<li>避免了多线程之间的上下文切换导致的开销</li>
</ol>
<h3 id="362selector示意图和特点说明">3.6.2、Selector示意图和特点说明</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909174806.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909174806.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909174806.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909174806.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909174806.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909174806.png" /></p>
<p><strong>特点再说明：</strong></p>
<ol>
<li>Netty的IO线程NioEventLoop聚合了Selector(选择器，也叫多路复用器),可以同时并发处理成百上千个客户端的连接</li>
<li>当线程从某客户端Socket通道进行读写数据时，若没有数据可读写时，该线程可以进行其它任务。</li>
<li>线程通常将非阻塞IO的空闲时间用于在其它通道上执行IO操作，所以单独的线程可以管理多个输入和输出通道</li>
<li>由于读写操作都是非阻塞的，这就可以充分提升IO线程的运行效率，避免由于频繁IO阻塞导致的线程挂起</li>
<li>一个IO线程可以并发处理N个客户端连接和读写操作，这从根本上解决了传统同步阻塞IO，一个连接一个线程模型，架构的性能、弹性伸缩能力和可靠性都得到了极大的提升。</li>
</ol>
<h3 id="363selector类相关的方法">3.6.3、Selector类相关的方法</h3>
<p>Selector类是一个抽象类，常用方法和说明如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Selector</span> <span class="kd">implements</span> <span class="n">Closeable</span><span class="o">{</span>
		<span class="kd">public</span> <span class="kd">static</span> <span class="n">Selector</span> <span class="nf">open</span><span class="o">();</span> <span class="c1">// 得到一个选择器对象
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kt">int</span> <span class="nf">select</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">);</span> <span class="c1">// 监控所有注册的通道，当其中有IO操作可以进行时，将对应的SelectionKey加入到内部集合中并返回，参数用来设置超时时间
</span><span class="c1"></span>		<span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="nf">selectedKeys</span><span class="o">();</span> <span class="c1">// 从内部集合中得到所有的SelectionKey
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>注意事项
1. NIO中的ServerSocketChannel功能类似ServerSocket，SocketChannel功能类似Socket
2. Selector相关方法说明
       selector.select(); //阻塞
       selector.select(1000); // 阻塞1000毫秒，在1000毫秒后返回
       selector.wakeup(); // 唤醒selector
       selector.selectNow(); // 不阻塞，立马返还
</code></pre>
<h2 id="37nio非阻塞网络编程原理分析图">3.7、NIO非阻塞网络编程原理分析图</h2>
<p>NIO非阻塞网络编程相关的(Selector、SelectionKey、ServerSocketChannel和SocketChannel)关系梳理图
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909210151.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909210151.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909210151.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909210151.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909210151.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210909210151.png" /></p>
<p><strong>对上图说明：</strong></p>
<ol>
<li>当客户端连接时，会通过<code>ServerSocketChannel</code>得到<code>SocketChannel</code></li>
<li>Selector进行监听，使用<code>select</code>方法，可以使用阻塞的也可以使用非阻塞的，返回有事件发生的通道的个数</li>
<li>将<code>SocketChannel</code>注册到Selector上，使用<code>register(Selector sel,int ops)</code>，一个selector上可以注册多个<code>SocketChannel</code></li>
<li>注册后返回一个<code>SelectionKey</code>，会和该Selector关联<code>该key被Selector管理起来，做成一个集合的形式</code></li>
<li>进一步得到各个SelectionKey(有事件发生)</li>
<li>再通过SelectionKey反向获取<code>SocketChannel</code>，通过channel()方法</li>
<li>可以通过得到的<code>channel</code>，完成业务处理</li>
</ol>
<h2 id="38nio非阻塞网络编程快速入门">3.8、NIO非阻塞网络编程快速入门</h2>
<p>案例要求：</p>
<ol>
<li>编写一个NIO入门案例，实现服务器端和客户端之间的数据简单通讯(非阻塞)</li>
<li>目的：理解NIO非阻塞网络编程机制</li>
</ol>
<p><strong>服务器端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NIOServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="c1">// 创建ServerSocketChannel -&gt; ServerSocket
</span><span class="c1"></span>      <span class="n">ServerSocketChannel</span> <span class="n">serverSocketChannel</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>

      <span class="c1">// 得到一个Selector对象
</span><span class="c1"></span>      <span class="n">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>

      <span class="c1">// 绑定一个端口6666，在服务器端监听
</span><span class="c1"></span>      <span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">6666</span><span class="o">));</span>

      <span class="c1">// 设置为非阻塞
</span><span class="c1"></span>      <span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

      <span class="c1">// 把 serverSocketChannel 注册到 selector 关心事件为OP_ACCEPT
</span><span class="c1"></span>      <span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>

      <span class="c1">// 循环等待客户端连接
</span><span class="c1"></span>      <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
          <span class="c1">// 这里我们等待1秒，如果没有事件发生，就返回
</span><span class="c1"></span>          <span class="k">if</span> <span class="o">(</span><span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">1000</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">){</span>
              <span class="c1">// 没有事件发生
</span><span class="c1"></span>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器等待了1秒，无连接&#34;</span><span class="o">);</span>
              <span class="k">continue</span><span class="o">;</span>
          <span class="o">}</span>

          <span class="c1">// 如果返回的 &gt;0,就获取到相关的selectionKey集合
</span><span class="c1"></span>          <span class="c1">// 1.如果返回的 &gt;0,表示已经获取到关注的事件
</span><span class="c1"></span>          <span class="c1">// 2.selector.selectedKeys() 返回关注事件的集合
</span><span class="c1"></span>          <span class="c1">// 3.通过 selectionKeys 反向获取通道
</span><span class="c1"></span>          <span class="n">Set</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">selectionKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>

          <span class="c1">// 遍历&lt;SelectionKey&gt; ，使用迭代器遍历
</span><span class="c1"></span>          <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">keyIterator</span> <span class="o">=</span> <span class="n">selectionKeys</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>

          <span class="k">while</span> <span class="o">(</span><span class="n">keyIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()){</span>
              <span class="c1">// 获取到SelectionKey
</span><span class="c1"></span>              <span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">keyIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

              <span class="c1">//根据key对应的通道发生的事件做相应的处理
</span><span class="c1"></span>              <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">()){</span>
                  <span class="c1">// 如果是 OP_ACCEPT，有新的客户端连接
</span><span class="c1"></span>                  <span class="c1">// 给该客户端生成一个SocketChannel
</span><span class="c1"></span>                  <span class="c1">// 这里使用 accept 为什么不会产生阻塞？ 因为你原本的判断就已经判定了它时处于哪一个事件，自然不会在去等待
</span><span class="c1"></span>                  <span class="n">SocketChannel</span> <span class="n">socketChannel</span> <span class="o">=</span> <span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
                  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端连接成功  生成了一个 socketChannel &#34;</span> <span class="o">+</span> <span class="n">socketChannel</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
                  <span class="n">socketChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                  <span class="c1">// 将 socketChannel 注册到selector，关注事件为 OP_READ，同时给该 socketChannel 关联一个Buffer
</span><span class="c1"></span>                  <span class="cm">/*
</span><span class="cm">                   * 这里需要注意：
</span><span class="cm">                   *    如果你在将 socketChannel 注册到selector时，给其关联一个buffer分配空间过大时，在
</span><span class="cm">                   *    后面使用输出语句进行输出时，没有字节填充时，后面会默认输出乱码
</span><span class="cm">                   */</span>
                  <span class="n">socketChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span><span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">,</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">9</span><span class="o">));</span>
              <span class="o">}</span>

              <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">()){</span>
                  <span class="c1">// 发生 OP_READ 事件
</span><span class="c1"></span>                  <span class="c1">// 通过key反向获取到对应的channel
</span><span class="c1"></span>                  <span class="n">SocketChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="o">(</span><span class="n">SocketChannel</span><span class="o">)</span><span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>

                  <span class="c1">// 获取到该Channel关联的Buffer
</span><span class="c1"></span>                  <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuffer</span><span class="o">)</span><span class="n">key</span><span class="o">.</span><span class="na">attachment</span><span class="o">();</span>

                  <span class="c1">// 将通道中的数据读取到Buffer
</span><span class="c1"></span>                  <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;从客户端发送的数据&#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">array</span><span class="o">()));</span>
              <span class="o">}</span>

              <span class="c1">// 手动从集合中移除当前的 SelectionKey ，防止重复操作
</span><span class="c1"></span>              <span class="n">keyIterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">jdk.nashorn.internal.ir.CallNode</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NIOClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="c1">// 得到一个网络通道
</span><span class="c1"></span>      <span class="n">SocketChannel</span> <span class="n">socketChannel</span> <span class="o">=</span> <span class="n">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
      <span class="c1">// 设置非阻塞
</span><span class="c1"></span>      <span class="n">socketChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
      <span class="c1">// 提供服务器端的ip 和 端口
</span><span class="c1"></span>      <span class="n">InetSocketAddress</span> <span class="n">inetSocketAddress</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span> <span class="n">6666</span><span class="o">);</span>
      <span class="c1">// 连接服务器
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(!</span><span class="n">socketChannel</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">inetSocketAddress</span><span class="o">)){</span>
          <span class="k">while</span> <span class="o">(!</span><span class="n">socketChannel</span><span class="o">.</span><span class="na">finishConnect</span><span class="o">()){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;因为连接需要事件，客户端不会阻塞，可以做其它工作&#34;</span><span class="o">);</span>
          <span class="o">}</span>
      <span class="o">}</span>

      <span class="c1">// 如果连接成功，就发送数据‘
</span><span class="c1"></span>      <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="s">&#34;hello,韋&#34;</span><span class="o">;</span>
      <span class="c1">// 使用这种方式就不需要再去指定字节大小了，也不再浪费空间大小
</span><span class="c1"></span>      <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
      <span class="c1">// 发送数据,将Buffer数据写入channel
</span><span class="c1"></span>      <span class="n">socketChannel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
      <span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">.</span><span class="na">read</span><span class="o">();</span><span class="c1">// 使代码停止在此
</span><span class="c1"></span>  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910110433.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910110433.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910110433.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910110433.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910110433.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910110433.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910111115.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910111115.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910111115.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910111115.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910111115.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910111115.png" /></p>
<pre><code>总结：
1.服务器端创建serverSocketChannel，并设置监听端口和非阻塞
2.得到一个selector对象，并把serverSocketChannel注册到selector上，并设置关心事件为OP_ACCEPT
3.当客户端有连接产生时，先获取到关注的事件，在通过selector.selectedKeys() 返回关注事件的
集合(即注册到selector上key的集合)，并使用迭代器进行遍历
4.获取selectionKeys集合种的key来判断是什么事件，如果是连接事件，则用accept函数得到socketChannel，并将该
channel注册到selector上，同时设为非阻塞，并从集合种移除当前key，防止重复操作
5.如果监听到有事件发生，如果是读事件，则通过key获取到对应的channel，该channel与注册到selector上的channel是
一样的，读取完数据之后也要进行移除操作，防止重复操作
</code></pre>
<p><strong>疑问</strong>
为什么进行第一次连接时，服务器端对应的serverSocketChannel注册到selector上得到一个key，而第二个新客户端连接时，与第一次的key一致，不是每次执行完都移除了嘛？</p>
<pre><code>解答：
因为当有连接事件产生时，监听器会监听到是什么事件，然后通过selector.selectedKeys()返回关注事件的集合(即注册
到selector上key的集合)，进行完连接事件后就会使用remove函数对当前key进行移除，因为使用的hasnext()方法，防止进
行重复操作，因为当前的移除操作执行完毕后，当前该次循环也就结束了，当再次执行连接事件时，又会调用
selector.selectedKeys()函数获取key的集合，所以serverSocketChannel对应的key是一致的
</code></pre>
<h2 id="39selectionkey">3.9、SelectionKey</h2>
<ol>
<li>SelectionKey，表示<strong>Selector和网络通道的注册关系</strong>，共四种：
<ul>
<li>int OP_ACCEPT：有新的网络连接可以accept，值为16</li>
<li>int OP_CONNECT：代表连接已经建立，值为8</li>
<li>int OP_READ：代表读写操作，值为1</li>
<li>int OP_WRITE：代表写操作，值为4</li>
</ul>
</li>
<li>源码中
<ul>
<li>public static final int OP_READ = 1 &laquo; 0;</li>
<li>public static final int OP_WRITE = 1 &laquo; 2;</li>
<li>public static final int OP_CONNECT = 1 &laquo; 3;</li>
<li>public static final int OP_ACCEPT = 1 &laquo; 4;</li>
</ul>
</li>
<li>SelectionKey相关方法</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SelectionKey</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kd">abstract</span> <span class="n">Selector</span> <span class="nf">selector</span><span class="o">();</span><span class="c1">// 得到与之关联的Selector对象
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">abstract</span> <span class="n">SelectableChannel</span> <span class="nf">channel</span><span class="o">();</span><span class="c1">//得到与之关联的通道
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">final</span> <span class="n">Object</span> <span class="nf">attachment</span><span class="o">();</span><span class="c1">//得到与之关联的共享数据
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">abstract</span> <span class="n">SelectionKey</span> <span class="nf">interestOps</span><span class="o">(</span><span class="kt">int</span> <span class="n">ops</span><span class="o">);</span><span class="c1">//设置或改变监听事件，比如：原本是监听连接事件，你可以将其改为监听读事件，这个根据需求来定
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isAcceptable</span><span class="o">();</span><span class="c1">//是否可以accept
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isReadable</span><span class="o">();</span><span class="c1">//是否可以读
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isWriteable</span><span class="o">();</span><span class="c1">//是否可以写
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="310serversocketchannel">3.10、ServerSocketChannel</h2>
<ol>
<li>ServerSocketChannel在<strong>服务器端监听新的客户端Socket连接，产生一个SocketChannel</strong></li>
<li>相关方法</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ServerSocketChannel</span> <span class="kd">extends</span> <span class="n">AbstractSelectableChannel</span> <span class="kd">implements</span> <span class="n">NetworkChannel</span><span class="o">{</span>
		<span class="kd">public</span> <span class="kd">static</span> <span class="n">ServerSocketChannel</span> <span class="nf">open</span><span class="o">();</span><span class="c1">//得到一个ServerSocketChannel通道
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">final</span> <span class="n">ServerSocketChannel</span> <span class="nf">bind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">local</span><span class="o">);</span><span class="c1">//设置服务器端端口号
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">final</span> <span class="n">SelectableChannel</span> <span class="nf">configureBlocking</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">block</span><span class="o">);</span><span class="c1">//设置阻塞或非阻塞模式，取值false表示采用非阻塞模式
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">abstract</span> <span class="n">SocketChannel</span> <span class="nf">accept</span><span class="o">();</span><span class="c1">//接受一个连接，返回代表这个连接的通道对象
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">final</span> <span class="n">SelectionKey</span> <span class="nf">register</span><span class="o">(</span><span class="n">Selector</span> <span class="n">sel</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ops</span><span class="o">);</span><span class="c1">//注册一个选择器并设置监听事件
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="311socketchannel">3.11、SocketChannel</h2>
<ol>
<li>SocketChannel，网络IO通道，<strong>具体负责进行读写操作</strong>。NIO把缓冲区的数据写入通道，或者把通道里的数据读到缓冲区</li>
<li>相关方法</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SocketChannel</span> <span class="kd">extends</span> <span class="n">AbstractSelectableChannel</span> <span class="kd">implements</span> <span class="n">ByteChannel</span><span class="o">,</span> <span class="n">ScatteringByteChannel</span><span class="o">,</span> <span class="n">GatheringByteChannel</span><span class="o">,</span> <span class="n">NetworkChannel</span> <span class="o">{</span>
		<span class="kd">public</span> <span class="kd">static</span> <span class="n">SocketChannel</span> <span class="nf">open</span><span class="o">();</span><span class="c1">//得到一个Socket Channel通道
</span><span class="c1"></span>		<span class="kd">public</span> <span class="n">fianl</span> <span class="n">SelectableChannel</span> <span class="nf">configureBlocking</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">block</span><span class="o">);</span><span class="c1">// 设置阻塞或非阻塞模式，取值false表示采用非阻塞模式
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">remote</span><span class="o">);</span><span class="c1">//连接服务器
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">boolean</span> <span class="nf">finishConnect</span><span class="o">();</span><span class="c1">//如果上面的方法连接失败，接下来就要通过该方法完成连接操作
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kt">int</span> <span class="nf">write</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">src</span><span class="o">);</span><span class="c1">//往通道里面写数据
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kt">int</span> <span class="nf">read</span><span class="o">(</span><span class="n">ByteBuffer</span> <span class="n">dst</span><span class="o">);</span><span class="c1">//从通道里面读取数据
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">final</span> <span class="n">SelectionKey</span> <span class="nf">register</span><span class="o">(</span><span class="n">Selector</span> <span class="n">sel</span><span class="o">,</span><span class="kt">int</span> <span class="n">ops</span><span class="o">,</span><span class="n">Object</span> <span class="n">att</span><span class="o">);</span><span class="c1">//注册一个选择器并设置监听事件，最后一个参数可以设置共享数据
</span><span class="c1"></span>		<span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">close</span><span class="o">();</span><span class="c1">//关闭通道
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="312nio网络编程应用实例-群聊系统">3.12、NIO网络编程应用实例-群聊系统</h2>
<p>实例要求：</p>
<ol>
<li>编写一个搞NIO群聊系统，实现服务器端和客户端之间的数据简单通讯(非阻塞)</li>
<li>实现多人群聊</li>
<li>服务器端：可以监测用户上线、离线，并实现消息转发功能</li>
<li>客户端：通过Channel可以无阻塞发送消息给其它所有用户，同时可以接受到其它用户发送的消息(由服务器转发得到)</li>
<li>目的：进一步理解NIO非阻塞网络编程</li>
<li>示意图
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910211940.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910211940.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910211940.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910211940.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910211940.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910211940.png" /></li>
</ol>
<p><strong>服务器端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio.groupchat</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupChatServer</span> <span class="o">{</span>
    <span class="c1">// 定义属性
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Selector</span> <span class="n">selector</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">ServerSocketChannel</span> <span class="n">listenChannel</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">PORT</span><span class="o">=</span><span class="n">6667</span><span class="o">;</span>

    <span class="c1">// 构造器
</span><span class="c1"></span>    <span class="c1">// 初始化工作
</span><span class="c1"></span>    <span class="kd">public</span> <span class="nf">GroupChatServer</span><span class="o">(){</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 得到选择器
</span><span class="c1"></span>            <span class="n">selector</span> <span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="c1">// 得到ServerSocketChannel
</span><span class="c1"></span>            <span class="n">listenChannel</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
            <span class="c1">// 绑定端口
</span><span class="c1"></span>            <span class="n">listenChannel</span><span class="o">.</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">PORT</span><span class="o">));</span>
            <span class="c1">// 设置非阻塞模式
</span><span class="c1"></span>            <span class="n">listenChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="c1">// 将该listenChannel 注册到Selector
</span><span class="c1"></span>            <span class="n">listenChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 监听
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">listen</span><span class="o">(){</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 循环处理
</span><span class="c1"></span>            <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">){</span>
                <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
                <span class="k">if</span><span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">){</span> <span class="c1">// 有事件处理
</span><span class="c1"></span>                    <span class="c1">// 遍历得到selectionKey集合
</span><span class="c1"></span>                    <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
                    <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()){</span>
                        <span class="c1">// 取出selectionKey
</span><span class="c1"></span>                        <span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

                        <span class="c1">//根据key对应的通道发生的事件做相应的处理
</span><span class="c1"></span>                        <span class="k">if</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">()){</span>
                            <span class="n">SocketChannel</span> <span class="n">sc</span> <span class="o">=</span> <span class="n">listenChannel</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
                            <span class="n">sc</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
                            <span class="c1">// 将该sc注册到Selector
</span><span class="c1"></span>                            <span class="n">sc</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span><span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
                            <span class="c1">// 输出提示
</span><span class="c1"></span>                            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">sc</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;上线&#34;</span><span class="o">);</span>
                        <span class="o">}</span>

                        <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">()){</span><span class="c1">// 通道发送read事件，即通道是可读状态
</span><span class="c1"></span>                            <span class="c1">// 处理读事件(专门写方法)
</span><span class="c1"></span>                            <span class="n">readData</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
                        <span class="o">}</span>

                        <span class="c1">// 手动从集合中移除当前的 SelectionKey ，防止重复操作
</span><span class="c1"></span>                        <span class="n">iterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>  <span class="k">else</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;等待......&#34;</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>

        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>

        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 读取客户端数据 通过对应的key获取到对应的通道
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">readData</span><span class="o">(</span><span class="n">SelectionKey</span> <span class="n">key</span><span class="o">){</span>
        <span class="c1">// 定义channel属性
</span><span class="c1"></span>        <span class="n">SocketChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="c1">// 得到channel
</span><span class="c1"></span>            <span class="n">channel</span> <span class="o">=</span> <span class="o">(</span><span class="n">SocketChannel</span><span class="o">)</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
            <span class="c1">// 创建Buffer
</span><span class="c1"></span>            <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">1024</span><span class="o">);</span><span class="c1">//33
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="c1">// 根据count的值做处理
</span><span class="c1"></span>            <span class="k">if</span><span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">){</span>
                <span class="c1">// 把缓冲区的数据转成字符串
</span><span class="c1"></span>                <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">array</span><span class="o">());</span>
                <span class="c1">// 输出该消息
</span><span class="c1"></span>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;from 客户端：&#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>

                <span class="c1">// 向其它的客户端转发消息(去掉自己)，专门写一个方法来处理
</span><span class="c1"></span>                <span class="n">sendInfoToOtherClients</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span><span class="n">channel</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">channel</span><span class="o">.</span><span class="na">getRemoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; 离线了....&#34;</span><span class="o">);</span>
                <span class="c1">// 取消注册
</span><span class="c1"></span>                <span class="n">key</span><span class="o">.</span><span class="na">cancel</span><span class="o">();</span>
                <span class="c1">// 关闭通道
</span><span class="c1"></span>                <span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e1</span><span class="o">){</span>
                <span class="n">e1</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>

        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 转发消息给其它客户端(通道)
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendInfoToOtherClients</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">,</span><span class="n">SocketChannel</span> <span class="n">self</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器转发消息中..........&#34;</span><span class="o">);</span>
        <span class="c1">// 遍历 所有注册到Selector 上的 SocketChannel，并排除自身
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="n">SelectionKey</span> <span class="n">key</span><span class="o">:</span><span class="n">selector</span><span class="o">.</span><span class="na">keys</span><span class="o">()){</span>
            <span class="c1">// 通过key得到对应的 SocketChannel
</span><span class="c1"></span>            <span class="n">Channel</span> <span class="n">targetChannel</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>

            <span class="c1">// 排除自己
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">targetChannel</span> <span class="k">instanceof</span> <span class="n">SocketChannel</span> <span class="o">&amp;&amp;</span> <span class="n">targetChannel</span> <span class="o">!=</span> <span class="n">self</span><span class="o">){</span>
                <span class="c1">// 转型
</span><span class="c1"></span>                <span class="n">SocketChannel</span> <span class="n">dest</span> <span class="o">=</span> <span class="o">(</span><span class="n">SocketChannel</span><span class="o">)</span><span class="n">targetChannel</span><span class="o">;</span>
                <span class="c1">// 将msg存储到buffer
</span><span class="c1"></span>                <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
                <span class="c1">// 将buffer的数据写入通道
</span><span class="c1"></span>                <span class="n">dest</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>



    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// 创建服务器对象
</span><span class="c1"></span>        <span class="n">GroupChatServer</span> <span class="n">groupChatServer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GroupChatServer</span><span class="o">();</span>

        <span class="n">groupChatServer</span><span class="o">.</span><span class="na">listen</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio.groupchat</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SelectionKey</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.Selector</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupChatClient</span> <span class="o">{</span>
    <span class="c1">// 定义相关的属性
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">HOST</span> <span class="o">=</span> <span class="s">&#34;127.0.0.1&#34;</span><span class="o">;</span> <span class="c1">// 服务器的IP
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">PORT</span> <span class="o">=</span> <span class="n">6667</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Selector</span> <span class="n">selector</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">SocketChannel</span> <span class="n">socketChannel</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">username</span><span class="o">;</span>

    <span class="c1">// 构造器,完成初始化工作
</span><span class="c1"></span>    <span class="kd">public</span> <span class="nf">GroupChatClient</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">selector</span> <span class="o">=</span> <span class="n">Selector</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
        <span class="c1">// 连接服务器
</span><span class="c1"></span>        <span class="n">socketChannel</span> <span class="o">=</span> <span class="n">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">HOST</span><span class="o">,</span><span class="n">PORT</span><span class="o">));</span>
        <span class="c1">// 设置非阻塞
</span><span class="c1"></span>        <span class="n">socketChannel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="c1">// 将channel注册到selector
</span><span class="c1"></span>        <span class="n">socketChannel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
        <span class="c1">// 得到username
</span><span class="c1"></span>        <span class="n">username</span> <span class="o">=</span> <span class="n">socketChannel</span><span class="o">.</span><span class="na">getLocalAddress</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">username</span> <span class="o">+</span> <span class="s">&#34; is ok.....&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 向服务器发送消息
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">sendInfo</span><span class="o">(</span><span class="n">String</span> <span class="n">info</span><span class="o">){</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">username</span> <span class="o">+</span> <span class="s">&#34;说：&#34;</span> <span class="o">+</span> <span class="n">info</span><span class="o">;</span>

        <span class="k">try</span><span class="o">{</span>
            <span class="n">socketChannel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// 读取从服务器端回复的消息
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">readInfo</span><span class="o">(){</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">readChannels</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">readChannels</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">){</span>
                <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
                <span class="k">while</span> <span class="o">(</span><span class="n">iterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()){</span>
                    <span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">()){</span>
                        <span class="n">SocketChannel</span> <span class="n">channel</span> <span class="o">=</span> <span class="o">(</span><span class="n">SocketChannel</span><span class="o">)</span><span class="n">key</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
                        <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">1024</span><span class="o">);</span>
                        <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
                        <span class="c1">// 将读取到的数据转化为字符串
</span><span class="c1"></span>                        <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buffer</span><span class="o">.</span><span class="na">array</span><span class="o">());</span>
                        <span class="c1">// 输出消息并去掉头尾空格
</span><span class="c1"></span>                        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">trim</span><span class="o">());</span>
                    <span class="o">}</span>
                    <span class="c1">// 手动从集合中移除当前的 SelectionKey ，防止重复操作
</span><span class="c1"></span>                    <span class="n">iterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="c1">//                System.out.println(&#34;没有可以用的通道....&#34;);
</span><span class="c1"></span>            <span class="o">}</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="c1">// 启动我们的客户端
</span><span class="c1"></span>        <span class="n">GroupChatClient</span> <span class="n">chatClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GroupChatClient</span><span class="o">();</span>

        <span class="c1">// 启动一个线程,每隔3秒，读取从服务器端发送的数据
</span><span class="c1"></span>        <span class="k">new</span> <span class="n">Thread</span><span class="o">(){</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
                    <span class="n">chatClient</span><span class="o">.</span><span class="na">readInfo</span><span class="o">();</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">sleep</span><span class="o">(</span><span class="n">3000</span><span class="o">);</span>
                    <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">){</span>
                        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}.</span><span class="na">start</span><span class="o">();</span>

        <span class="c1">// 发送数据给服务器端
</span><span class="c1"></span>        <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">scanner</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">()){</span>
            <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
            <span class="n">chatClient</span><span class="o">.</span><span class="na">sendInfo</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>注意：这里面得到一个通道时，记得设置为非阻塞模式；其次，这个里面的离线部分没理解清楚，参考B站一位评论
</code></pre>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910212227.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910212227.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910212227.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910212227.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910212227.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910212227.png" /></p>
<h2 id="313nio与零拷贝">3.13、NIO与零拷贝</h2>
<h3 id="3131零拷贝基本介绍">3.13.1、零拷贝基本介绍</h3>
<ol>
<li>零拷贝是网络编程的关键，很多性能优化都离不开。</li>
<li>在Java程序中，常用的零拷贝有mmap(内存映射)和sendFile。那么，他们在OS里面，到底是怎么样的一个设计？我们分析mmap和sendFile这两个零拷贝</li>
<li>另外我们看下NIO中如何使用零拷贝</li>
</ol>
<h3 id="3132传统io">3.13.2、传统IO</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215929.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215929.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215929.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215929.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215929.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215929.png" /></p>
<h3 id="3133mmap优化">3.13.3、mmap优化</h3>
<ol>
<li>mmap<strong>通过内存映射</strong>，将文件映射到内核缓冲区，同时，用户空间可以共享内核空间的数据。这样，在进行网络传输时，就可以减少内核空间到用户控件的拷贝次数</li>
<li>mmap示意图
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910220324.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910220324.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910220324.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910220324.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910220324.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910220324.png" /></li>
</ol>
<h3 id="3134sendfile优化">3.13.4、sendFile优化</h3>
<ol>
<li>
<p>Linux2.1版本提供了sendFile函数，其基本原理如下：数据根本不经过用户态，直接从内核缓冲区进入到Socket Buffer，同时，由于和用户态完全无关，就减少了一次上下文切换</p>
</li>
<li>
<p>示意图和小结
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215124.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215124.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215124.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215124.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215124.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215124.png" /></p>
<p>提示：零拷贝从操作系统角度看是没有CPU拷贝</p>
</li>
<li>
<p>Linux在2.4版本中，做了一些修改，避免了从<strong>内核缓冲区</strong>拷贝到<strong>Socket buffer</strong>的操作，直接拷贝到<strong>协议栈</strong>，从而再一次减少了数据拷贝，具体如下图
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215425.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215425.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215425.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215425.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215425.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210910215425.png" /></p>
<p>注意：这里其实有一次CPU拷贝kernel buffer -&gt; socket buffer，但是，拷贝的信息很少，比如length，offset，消耗低，可以忽略不计</p>
</li>
</ol>
<h3 id="3135零拷贝的再次理解">3.13.5、零拷贝的再次理解</h3>
<ol>
<li>我们说零拷贝是从操作系统的角度来说的。因为内核缓冲器之间，没有数据是重复的(只有kernel buffer 有一份数据)</li>
<li>零拷贝不仅仅带来更少的数据复制，还能带来其它的性能又是，例如更少的上下文切换，更少的CPU缓存伪共享以及无CPU校验和计算</li>
</ol>
<h3 id="3136mmap和sendfile的区别">3.13.6、mmap和sendFile的区别</h3>
<ol>
<li>mmap适合小数据量读写，sendFile适合大文件传输</li>
<li>mmap需要<strong>4</strong>次上下文切换，<strong>3</strong>次数据拷贝；sendFile需要<strong>3</strong>次上下文切换，<strong>最少2</strong>次数据拷贝</li>
<li>sendFile可以利用DMA方式，减少CPU拷贝，mmap则不能(必须从内核拷贝到Socket缓冲区)</li>
</ol>
<h2 id="314零拷贝实例">3.14、零拷贝实例</h2>
<p>案例要求：</p>
<ol>
<li>使用传统的IO方法传递一个大文件</li>
<li>使用NIO零拷贝方式传递(transferTo)一个大文件</li>
<li>看看两种传递方式耗时时间分别是多少</li>
</ol>
<h3 id="3141传统io方式">3.14.1、传统IO方式</h3>
<p><strong>服务器端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio.zerocopy</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.DataInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OldIOServer</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ServerSocket</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">7001</span><span class="o">);</span>

        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">serverSocket</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
            <span class="n">DataInputStream</span> <span class="n">dataInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>

            <span class="k">try</span> <span class="o">{</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">byteArray</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">4096</span><span class="o">];</span>

                <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">readCount</span> <span class="o">=</span> <span class="n">dataInputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">byteArray</span><span class="o">,</span> <span class="n">0</span><span class="o">,</span> <span class="n">byteArray</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>

                    <span class="k">if</span> <span class="o">(-</span><span class="n">1</span> <span class="o">==</span> <span class="n">readCount</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">ex</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio.zerocopy</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.DataOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OldIOClient</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="n">7001</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="s">&#34;protoc-3.6.1-win32.zip&#34;</span><span class="o">;</span>
        <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">fileName</span><span class="o">);</span>

        <span class="n">DataOutputStream</span> <span class="n">dataOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>

        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">4096</span><span class="o">];</span>
        <span class="kt">long</span> <span class="n">readCount</span><span class="o">;</span>
        <span class="kt">long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

        <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>

        <span class="k">while</span> <span class="o">((</span><span class="n">readCount</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">&gt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">readCount</span><span class="o">;</span>
            <span class="n">dataOutputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;发送总字节数： &#34;</span> <span class="o">+</span> <span class="n">total</span> <span class="o">+</span> <span class="s">&#34;, 耗时： &#34;</span> <span class="o">+</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">startTime</span><span class="o">));</span>

        <span class="n">dataOutputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>结果图：
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161411.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161411.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161411.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161411.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161411.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161411.png" /></p>
<h3 id="3142transferto">3.14.2、transferTo</h3>
<p><strong>服务器端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio.zerocopy</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.ServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewIOServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
    <span class="n">ServerSocketChannel</span> <span class="n">serverSocketChannel</span> <span class="o">=</span> <span class="n">ServerSocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
    <span class="n">InetSocketAddress</span> <span class="n">inetSocketAddress</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="n">7001</span><span class="o">);</span>
    <span class="n">ServerSocket</span> <span class="n">serverSocket</span> <span class="o">=</span> <span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">socket</span><span class="o">();</span>
    <span class="n">serverSocket</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">inetSocketAddress</span><span class="o">);</span>

    <span class="c1">//创建Buffer
</span><span class="c1"></span>    <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="n">4096</span><span class="o">);</span>

    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
      <span class="n">SocketChannel</span> <span class="n">socketChannel</span> <span class="o">=</span> <span class="n">serverSocketChannel</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>

      <span class="kt">int</span> <span class="n">readCount</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

      <span class="k">while</span> <span class="o">(-</span><span class="n">1</span> <span class="o">!=</span> <span class="n">readCount</span><span class="o">){</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">readCount</span> <span class="o">=</span> <span class="n">socketChannel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="c1">// 将buffer倒带，因为这个buffer这次使用后下次还需使用
</span><span class="c1"></span>        <span class="n">buffer</span><span class="o">.</span><span class="na">rewind</span><span class="o">();</span><span class="c1">// 使 position = 0 mark=-1 作废
</span><span class="c1"></span>      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.nio.zerocopy</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.FileInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.InetSocketAddress</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.FileChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.channels.SocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NewIOClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="n">SocketChannel</span> <span class="n">socketChannel</span> <span class="o">=</span> <span class="n">SocketChannel</span><span class="o">.</span><span class="na">open</span><span class="o">();</span>
      <span class="n">socketChannel</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="n">InetSocketAddress</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span><span class="n">7001</span><span class="o">));</span>
      <span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="s">&#34;protoc-3.6.1-win32.zip&#34;</span><span class="o">;</span>

      <span class="c1">// 得到一个文件channel
</span><span class="c1"></span>      <span class="n">FileChannel</span> <span class="n">fileChannel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileInputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">).</span><span class="na">getChannel</span><span class="o">();</span>

      <span class="c1">// 准备发送
</span><span class="c1"></span>      <span class="kt">long</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>

      <span class="c1">// 在Linux下，一个transferTo 方法就可以完成传输
</span><span class="c1"></span>      <span class="c1">// 在windows下，一次调用transferTo只能发送8M文件，就需要分段传输文件，而且要注意传输位置
</span><span class="c1"></span>      <span class="kt">long</span> <span class="n">transferCount</span> <span class="o">=</span> <span class="n">fileChannel</span><span class="o">.</span><span class="na">transferTo</span><span class="o">(</span><span class="n">0</span><span class="o">,</span> <span class="n">fileChannel</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">socketChannel</span><span class="o">);</span>

      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;发送的总的字节数 =&#34;</span> <span class="o">+</span> <span class="n">transferCount</span> <span class="o">+</span> <span class="s">&#34; 耗时：&#34;</span><span class="o">+(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()-</span><span class="n">startTime</span><span class="o">));</span>

      <span class="c1">// 关闭通道
</span><span class="c1"></span>      <span class="n">fileChannel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>结果图：
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161735.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161735.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161735.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161735.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161735.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911161735.png" /></p>
<h2 id="315java-aio基本介绍">3.15、Java AIO基本介绍</h2>
<ol>
<li>JDK7引入了Asynchronous I/O，即AIO。在进行I/O编程中，常用到两种模式：Reactor和Proactor。Java 的NIO就是Reactor，当有时间触发时，服务器端得到通知，进行相应的处理</li>
<li>AIO即NIO2.0，叫做异步不阻塞的IO。即AIO引入异步通道的概念，采用了Proactor模式，简化了程序编写，有效的请求才启动线程，它的特点时先由操作系统完成后才通知服务端程序启动线程区处理，一般适用于连接数较多且连接时间较长的应用</li>
<li>目前AIO还没有广泛应用，Netty也是基于NIO，而不是AIO，因此我们就不详解AIO了，有兴趣的同学可以参考<a href="http://www.52im.net/thread-306-1-1.html" target="_blank" rel="noopener noreffer">Java新一代网络编程模型AIO原理及Linux系统AIO介绍</a></li>
</ol>
<h2 id="316bionioaio对比表">3.16、BIO、NIO、AIO对比表</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911164234.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911164234.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911164234.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911164234.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911164234.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911164234.png" /></p>
<p><strong>举例说明</strong></p>
<ol>
<li><strong>同步阻塞</strong>：到理发店理发，就一直等理发师，知道轮到自己理发</li>
<li><strong>同步非阻塞</strong>：到理发店理发，发现前面有其它人理发，给理发师说下，先干其它事情，一会过来看是否轮到自己</li>
<li><strong>异步非阻塞</strong>：给理发师打电话，让理发师上门服务，自己干其它事情，理发师自己来家给你理发</li>
</ol>
<h1 id="4netty概述">4、Netty概述</h1>
<h2 id="41原生nio存在的问题">4.1、原生NIO存在的问题</h2>
<ol>
<li>NIO的类库和API复杂，使用麻烦：需要熟练掌握Selector、ServerSocketChannel、SocketChannel、ByteBuffer等</li>
<li>需要具备其它的额外技能：要熟悉Java多线程编程，因为NIO编程涉及到Reactor模式，你必须对多线程和网络编程非常熟悉，才能编写出高质量的NIO程序</li>
<li>开发工作量和难度都非常大：例如客户端面临断连重连、网络闪断、半包读写、失败缓存、网络拥塞和异常流的处理等等</li>
<li>JDK NIO的BUG：例如臭名昭著的 Epoll Bug，它会导致Selector空轮询，最终导致CPU100%。直到JDK 1.7 版本该问题仍旧存在，没有被根本解决</li>
</ol>
<h2 id="42netty官网说明">4.2、Netty官网说明</h2>
<p><a href="https://netty.io/" target="_blank" rel="noopener noreffer">Netty官网</a></p>
<p>Netty is <em>an asynchronous event-driven network application framework</em><br>
for rapid development of maintainable high performance protocol servers &amp; clients.
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911172202.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911172202.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911172202.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911172202.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911172202.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210911172202.png" /></p>
<h2 id="43netty的优点">4.3、Netty的优点</h2>
<p>Netty对JDK自带的NIO的API进行了封装，解决了上述问题</p>
<ol>
<li>设计优雅：适用于各种传输类型的统一API阻塞和非阻塞Socket；基于灵活且可扩展的事件模型，可以清晰的分离关注点；高度可定制的线程模型，单线程，一个或多个线程池</li>
<li>使用方便：详细记录的Javadoc，用户指南和实例；没有其它依赖项，JDK 5(Netty 3.x)或6 (Netty 4.x)就足够了</li>
<li><strong>高性能、吞吐量更高：延迟耕地；减少资源消耗；最小化不必要的内存复制</strong></li>
<li>安全：完整的SSL/TLS和StartTLS支持</li>
<li>社区活跃、不断更新、版本迭代周期端，发现的Bug可以被及时修复，同时，更多的性功能会被加入</li>
</ol>
<h2 id="44版本说明">4.4、版本说明</h2>
<ol>
<li>netty版本分别为netty3.x、netty4.x和netty5.x</li>
<li>因为netty5出现重大Bug，已经被官网废弃了，目前推荐使用的是Netty4.x的稳定版本</li>
<li>目前在官网可下载的版本netty3.x、netty4.0.x和netty4.1.x</li>
<li><a href="https://github.com/netty/netty/releases" target="_blank" rel="noopener noreffer">Netty下载地址</a></li>
</ol>
<h1 id="5netty高性能框架设计">5、Netty高性能框架设计</h1>
<h2 id="51线程模型基本介绍">5.1、线程模型基本介绍</h2>
<ol>
<li>不同的线程模式，对程序的性能有很大影响，为了搞清楚Netty线程模式，我们来系统的讲解下各个线程模式，最后看看Netty线程模型有什么优越性</li>
<li>目前存在的线程模型有：<strong>传统阻塞I/O服务模型</strong>、<strong>Reactor模式</strong></li>
<li><strong>根据Reactor的数量和处理资源池线程数量的不同，有三种典型的实现</strong>
<ul>
<li>单Reactor 单线程</li>
<li>单Reactor 多线程</li>
<li>主从Reactor 多线程</li>
</ul>
</li>
<li>Netty线程模式(Netty主要基于<strong>主从Reactor多线程模型</strong>做了一定的改进，其中主从Reactor多线程模型有多个Reactor)</li>
</ol>
<h2 id="52传统阻塞io服务模型">5.2、传统阻塞I/O服务模型</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912095422.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912095422.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912095422.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912095422.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912095422.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912095422.png" /></p>
<h3 id="521工作原理图">5.2.1、工作原理图</h3>
<p>黄色的框表示对象，蓝色的框表示线程，白色的框表示方法(API)</p>
<h3 id="522模型特点">5.2.2、模型特点</h3>
<ol>
<li>采用阻塞IO模式获取输入的数据</li>
<li>每个连接都需要独立的线程完成数据的输入，业务处理，数据返回</li>
</ol>
<h3 id="523问题分析">5.2.3、问题分析</h3>
<ol>
<li>当并发数很大，就会创建大量的线程，占用很大系统资源</li>
<li>连接创建后，如果当前线程暂时没有数可读，该线程会阻塞在read操作，造成线程资源浪费</li>
</ol>
<h2 id="53reactor模式">5.3、Reactor模式</h2>
<h3 id="531针对传统阻塞io服务模型的2个缺点解决方案">5.3.1、针对传统阻塞I/O服务模型的2个缺点，解决方案</h3>
<ol>
<li>
<p>基于I/O复用模型：多个连接公用一个阻塞对象，应用程序只需在一个阻塞对象等待，无需阻塞等待所有连接。当某个连接有新的数据可以处理时，操作系统通知应用程序，线程从阻塞状态返回，开始进行业务处理</p>
<p>Reactor 对应的叫法：1、反应器模式 2、分发者模式(Dispatcher) 3、通知者模式(notifier)</p>
</li>
<li>
<p>基于线程池复用线程资源：不必再为每个连接创建线程，将连接完成后的业务处理任务分配给线程进行处理，一个线程可以处理多个连接的业务
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102218.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102218.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102218.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102218.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102218.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102218.png" /></p>
</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102940.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102940.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102940.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102940.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102940.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912102940.png" /></p>
<pre><code>I/O复用结合线程池，就是Reactor模式基本设计思想，如图：
1. Reactor模式，通过一个或多个输入同时传递给服务处理器的模式(基于事件驱动)
2. 服务器端程序处理传入的多个请求，并将他们同步分派到相应的处理线程，因此Reactor模式也叫Dispatcher模式
3. Reactor模式使用IO复用监听，收到事件后，分发给某个线程(进程)，这点就是网络服务器高并发处理关键
</code></pre>
<h3 id="532reactor模式中核心组成">5.3.2、Reactor模式中核心组成：</h3>
<ol>
<li>Reactor：Reactor在一个单独的线程中运行，负责监听和分发事件，分发给适当的处理程序来对IO事件做出反应。它就像公司的电话接线员，它接听来自客户的电话并将线路转移到适当的联系人</li>
<li>Handlers：处理程序执行I/O事件要完成的实际事件，类似于客户想要与之交谈的公司中的实际官员。Reactor通过调度适当的处理程序来响应I/O事件，处理程序执行非阻塞操作</li>
</ol>
<h3 id="533reactor模式分类">5.3.3、Reactor模式分类：</h3>
<p>根据Reactor的数量和处理资源池线程数量的不同，有三种典型的实现</p>
<ul>
<li>单Reactor 单线程</li>
<li>单Reactor 多线程</li>
<li>主从Reactor 多线程</li>
</ul>
<h2 id="54单reactor-单线程">5.4、单Reactor 单线程</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912110418.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912110418.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912110418.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912110418.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912110418.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912110418.png" /></p>
<p>前面所写的NIO群聊系统就是一个单Reactor 单线程模式</p>
<h3 id="541方案说明">5.4.1、方案说明</h3>
<ol>
<li>Select是前面I/O复用模型介绍的标准网络编程API，可以实现应用程序通过一个阻塞对象监听多路连接请求</li>
<li>Reactor对象通过Select监听客户端请求事件，收到事件后通过Dispatch进行分发</li>
<li>如果是建立连接请求事件，则由Acceptor通过Accept处理连接请求，然后创建一个Handler对象处理连接完成后的后续业务处理</li>
<li>如果不是建立连接事件，则Reactor会分发调用对应的Handler来响应</li>
<li>Handler会完成Read-&gt;业务处理-&gt;Send的完整业务流程</li>
</ol>
<p>结合实例；服务器端用一个线程通过多路复用搞定所有的IO操作(包括连接、读、写等)，编码简单，清晰明了，但是如果客户端连接数量较多，将无法支撑，前面的NIO群聊系统就属于这种类型</p>
<h3 id="542方案优缺点分析">5.4.2、方案优缺点分析</h3>
<ol>
<li><strong>优点</strong>：模型简单，没有多线程、进行通信、竞争的问题，全部都在一个线程中完成</li>
<li><strong>缺点</strong>：性能问题，只有一个线程，无法完全发挥多核CPU的性能。Handler在处理某个连接上的业务时，整个进程无法处理其它连接事件，很容易导致性能瓶颈</li>
<li><strong>缺点</strong>：可靠性问题，线程意外终止，过着进入死循环，会导致整个系统通信模块不可以，不能接收和处理外部消息，造成节点故障</li>
<li><strong>使用场景</strong>：客户端的数量有限，业务处理非常快速，比如Redis在业务处理的时间复杂度O(1)的情况</li>
</ol>
<h2 id="55单reactor-多线程">5.5、单Reactor 多线程</h2>
<p>工作原理示意图：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912115652.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912115652.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912115652.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912115652.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912115652.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912115652.png" /></p>
<h3 id="551方案说明">5.5.1、方案说明：</h3>
<ol>
<li>Reactor对象通过select监控客户端请求事件，收到事件后，通过Dispatch进行分发</li>
<li>如果是建立连接请求，则由Acceptor通过Accept处理连接请求，然后创建一个Handler对象处理完成连接后的各种事件</li>
<li>如果不是连接请求，则由Reactor分发调用连接对应的Handler来处理</li>
<li>Handler只负责响应事件，不做具体的业务处理，通过read读取数据后，会分发给后面的worker线程池的某个线程处理业务</li>
<li>worker线程池会分配独立的线程完成真正的业务，并将结果返回给handler</li>
<li>handler收到响应后，通过send将结果返回给client</li>
</ol>
<h3 id="552方案优缺点分析">5.5.2、方案优缺点分析：</h3>
<ol>
<li><strong>优点</strong>：可以充分的利用多核CPU的处理能力</li>
<li><strong>缺点</strong>：多线程数据共享和访问比较复杂，Reactor处理所有事件的监听和响应，在单线程运行，在高并发场景容易出现性能瓶颈</li>
</ol>
<h2 id="56主从reactor-多线程">5.6、主从Reactor 多线程</h2>
<p>工作原理示意图：
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912123810.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912123810.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912123810.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912123810.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912123810.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912123810.png" /></p>
<h3 id="561方案说明">5.6.1、方案说明：</h3>
<ol>
<li>Reactor主线程MainReactor对象通过select监听事件，收到事件后，通过Acceptor处理连接事件</li>
<li>当Acceptor处理连接事件后，MainReactor将连接分配给SubReactor</li>
<li>SubReactor将连接加入到连接队列进行监听，并创建handler进行各种事件处理</li>
<li>当有新的事件发生时，SubReactor就会调用对应的handler处理</li>
<li>handler通过read读取数据，分发给后面的worker线程池处理</li>
<li>worker线程池分配独立worker线程进行业务处理，并返回结果</li>
<li>handler收到响应结果后，再通过send将结果返回给client</li>
<li><strong>Reactor主线程可以对应多个Reactor子线程，即MainReactor可以关联多个SubReactor</strong></li>
</ol>
<h3 id="562方案优缺点说明">5.6.2、方案优缺点说明</h3>
<p>1.优点：父线程与子线程的数据交互简单职责明确，父线程只需要接收新连接，子线程完成后续的业务处理</p>
<p>2.优点：父线程与子线程的数据交互简单，Reactor主线程只需要把新连接传给子线程，子线程无需返回数据</p>
<p>3.缺点：编程复杂度较高</p>
<h2 id="57reactor模式小结">5.7、Reactor模式小结</h2>
<pre><code>1. 单Reactor 单线程，前台接待员和服务员是同一个人，全程为顾客服务
2. 单Reactor 多线程，1个前台接待员，多个服务员，接待员只负责接待
3. 主从Reactor 多线程，一个礼仪，多个前台接待员，多个服务生，礼仪负责将顾客领进门，然后交给接待员接待，服务员负责服务
</code></pre>
<p><strong>Reactor模式具有以下优点：</strong></p>
<ol>
<li>响应快，不必为单个同步事件所阻塞，因为它有多个<code>SubReactor</code>，这个阻塞了，它也可以通过下一个SubReactor来进行处理，虽然Reactor本身依然是同步的</li>
<li>可以最大程度的避免复杂的多线程及同步问题，并且避免了多线程/进程的切换开销</li>
<li>扩展性好，可以方便的通过增加Reactor实例个数来充分利用CPU资源</li>
<li>复用性好，Reactor模型本身与具体事件处理逻辑无关，具有很高的复用性？？？？？？</li>
</ol>
<h2 id="58netty模型">5.8、Netty模型</h2>
<h3 id="581工作原理示意图1-简单版">5.8.1、工作原理示意图1-简单版</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153424.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153424.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153424.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153424.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153424.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153424.png" /></p>
<ol>
<li>BossGroup线程维护Selector，只关注Accept</li>
<li>当接收到Accept事件后，获取对应的<code>SockerChannel</code>，进一步封装成<code>NIOSocketChannel</code>并注册到<code>WorkerGroup线程(事件循环)</code>，并进行维护</li>
<li>当WorkerGroup线程监听到注册到selector中的通道发生自己感兴趣的事件后，就进行处理(由handler处理)，<strong>注意：handler已经加入到通道中了</strong></li>
</ol>
<h3 id="582工作原理示意图2-进阶版">5.8.2、工作原理示意图2-进阶版</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153853.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153853.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153853.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153853.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153853.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912153853.png" /></p>
<pre><code>这里就很像我们之前的主从Reactor，BossGroup中有多个MainReactor
</code></pre>
<h3 id="583工作原理示意图3-详细版">5.8.3、工作原理示意图3-详细版</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912161512.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912161512.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912161512.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912161512.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912161512.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210912161512.png" /></p>
<ol>
<li>Netty抽象出两组线程池BossGroup：专门负责接收客户端的连接，WorkGroup：专门负责网络的读写</li>
<li>BossGroup和WorkGroup类型都是<code>NioEventLoopGroup</code></li>
<li>NioEventLoopGroup相当于一个事件循环组，这个组中含有多个事件循环，每一个事件循环是NioEventLoop</li>
<li>NioEventLoop表示一个不断循环执行处理任务的线程，每个NioEventLoop都有一个<code>Selector</code>，用于监听绑定在其上的socket的网络通讯</li>
<li>NioEventLoopGroup可以有多个线程，即可以含有多个NioEventLoop</li>
<li>每个Boss NioEventLoop循环执行的步骤有3步
<ol>
<li>轮询accept事件</li>
<li>处理accept事件，与client建立连接，生成<code>NioSocketChannel</code>，<code>并将其注册到某个WorkerNioEventLoop</code>上的<code>Selector</code></li>
<li>处理任务队列的任务，即runAllTasks</li>
</ol>
</li>
<li>每个WorkerNioEventLoop循环执行的步骤
<ol>
<li>轮询read，write事件</li>
<li>处理I/O事件，即read、write事件，在对应的<code>NioSocketChannel</code>上处理</li>
<li>处理任务队列的任务，即runAllTasks</li>
</ol>
</li>
<li>每个WorkerNioEventLoop处理业务时，会使用<code>pipeline(管道)</code>，<code>pipeline中包含了channel</code>，即通过pipeline可以获取到对应<code>通道</code>,管道中维护了很多的<code>处理器</code></li>
</ol>
<h3 id="584netty快速入门实例-tcp服务">5.8.4、Netty快速入门实例-TCP服务</h3>
<ol>
<li>实例要求：使用IDEA创建Netty项目</li>
<li>Netty服务器在6668端口监听，客户端能发送消息给服务器&quot;hello,服务器&quot;</li>
<li>服务器可以回复消息给客户端&quot;hello,客户器&quot;</li>
<li>目的：对Netty线程模型有一个初步认识</li>
<li>说明：创建Maven项目，并引入Netty包</li>
</ol>
<p><strong>Bootstrap执行流程</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100204.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100204.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100204.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100204.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100204.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100204.png" /></p>
<pre><code>ChannelFuture 在Netty中的所有的I/O操作都是异步执行的，这就意味着任何一个I/O操作会立刻返
回，不保证在调用结束的时候操作会执行完成。因此，会返回一个ChannelFuture的实例，通过这个实
例可以获取当前I/O操作的状态。
当我们要关闭 channel 时，可以调用 `channel.close()` 方法进行关闭。但是该方法也是一个异步方法。
真正的关闭操作并不是在调用该方法的线程中执行的，而是在 NIO 线程中执行真正的关闭操作
</code></pre>
<p><strong>服务器端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.simple</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="cm">/*
</span><span class="cm">       * 说明
</span><span class="cm">       * 1.创建两个线程组 bossGroup 和 workerGroup
</span><span class="cm">       * 2.bossGroup 只是处理连接请求，真正的和客户端业务处理，会交给 workerGroup 完成
</span><span class="cm">       * 3.两个线程组都是无线循环
</span><span class="cm">       */</span>
      <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>
      <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span> <span class="o">{</span>
          <span class="c1">// 创建服务器的启动对象，配置参数
</span><span class="c1"></span>          <span class="n">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>

          <span class="c1">// 使用链式编程来进行设置
</span><span class="c1"></span>          <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span><span class="n">workerGroup</span><span class="o">)</span><span class="c1">// 设置两个线程组
</span><span class="c1"></span>                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span><span class="c1">// 使用NioSocketChannel作为服务器的通道实现类型
</span><span class="c1"></span>                  <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span><span class="n">128</span><span class="o">)</span><span class="c1">// 设置线程队列等待连接个数
</span><span class="c1"></span>                  <span class="o">.</span><span class="na">childOption</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_KEEPALIVE</span><span class="o">,</span><span class="kc">true</span><span class="o">)</span><span class="c1">// 设置保持活动连接状态
</span><span class="c1"></span>                  <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span> <span class="c1">// 创建一个通道初始化对象(匿名对象)
</span><span class="c1"></span>                      <span class="c1">// 向workerGroup中EventLoop所关联的通道对应的pipeline设置处理器
</span><span class="c1"></span>                      <span class="nd">@Override</span>
                      <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                          <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">NettyServerHandler</span><span class="o">());</span>
                      <span class="o">}</span>
                  <span class="o">});</span><span class="c1">// 给我们的workerGroup的 EventLoop对应的管道设置处理器
</span><span class="c1"></span>
          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器 is ready&#34;</span><span class="o">);</span>

          <span class="cm">/*
</span><span class="cm">           * ChannelFuture 在Netty中的所有的I/O操作都是异步执行的，这就意味着任何一个I/O操作会立刻返回，不保证
</span><span class="cm">		   * 在调用结束的时候操作会执行完成。因此，会返回一个ChannelFuture的实例，通过这个实例可以获取当前I/O操
</span><span class="cm">		   * 作的状态。
</span><span class="cm">           */</span>

          <span class="c1">// 绑定一个端口，并且同步，生成了一个ChannelFuture 对象
</span><span class="c1"></span>          <span class="c1">// 启动服务器(并绑定端口)
</span><span class="c1"></span>          <span class="c1">// 为什么使用同步？因为Netty是基于异步操作的，如果不使用同步，可能服务器还未启动就执行下面的语句了，就会产生异常
</span><span class="c1"></span>          <span class="n">ChannelFuture</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">6668</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

          <span class="c1">// 对关闭通道进行监听(只有当你有一个关闭通道这样的事件发生时，才会去进行处理)
</span><span class="c1"></span>          <span class="c1">// 这里为什么也需要使用同步？因为不适用同步，他就会跳过这个语句直接执行finally中的语句关闭线程组了
</span><span class="c1"></span>		  <span class="c1">// closeFuture().sync() 不是用于关闭 Channel ，而是允许你阻塞直到 Channel 关闭，然后执行一些额外的操作  
</span><span class="c1"></span>		  <span class="c1">// 它有一个监听的作用，当通道关闭的时候，它会返回一个 ChannelFuture,这个里面包含了IO操作的状态
</span><span class="c1"></span>          <span class="n">cf</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
          <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
          <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务器端Handler</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.simple</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span><span class="o">;</span>

<span class="cm">/*
</span><span class="cm"> * 说明
</span><span class="cm"> * 1.我们自定义一个Handler需要继承netty规定好的某个HandlerAdapter(规范)
</span><span class="cm"> * 2.这时我们自定义一个Handler，才能称之为一个handler
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServerHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
    <span class="cm">/*
</span><span class="cm">     * 读取数据(这里我们可以读取客户端发送的数据)
</span><span class="cm">     * 1.ChannelHandlerContext ctx：上下文对象，含有管道pipeline(业务逻辑处理)，通道channel(数据读写处理)，地址
</span><span class="cm">     * 2.Object msg：就是客户端发送的数据，默认时Object类型
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;server ctx =&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">);</span>
        <span class="c1">// 将msg转化成一个ByteBuf
</span><span class="c1"></span>        <span class="c1">// ByteBuf时Netty提供的，不是NIO的ByteBuffer
</span><span class="c1"></span>        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端发送的消息是：&#34;</span> <span class="o">+</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端地址：&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// 数据读取完毕返回给客户端的消息
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// writeAndFlush 是 write方法 + flush方法
</span><span class="c1"></span>        <span class="c1">// 将数据写入到缓冲区，并刷新
</span><span class="c1"></span>        <span class="c1">// 一般讲，我们对这个发送的数据需要进行编码
</span><span class="c1"></span>        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">&#34;hello,客户端&#34;</span><span class="o">,</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// 当出现异常时，一般是需要关闭通道
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.simple</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="c1">// 客户端需要一个事件循环组
</span><span class="c1"></span>      <span class="n">EventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span> <span class="o">{</span>
          <span class="c1">// 创建一个客户端启动对象
</span><span class="c1"></span>          <span class="c1">// 注意客户端使用的不是ServerBootstrap，而是Bootstrap
</span><span class="c1"></span>          <span class="n">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>

          <span class="c1">// 设置相关参数,链式编程
</span><span class="c1"></span>          <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span> <span class="c1">// 设置线程组
</span><span class="c1"></span>                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 设置客户端通道的实现类型(将来使用反射处理)
</span><span class="c1"></span>                  <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                      <span class="nd">@Override</span>
                      <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                          <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">NettyClientHandler</span><span class="o">());</span><span class="c1">// 加入自己的处理器
</span><span class="c1"></span>                      <span class="o">}</span>
                  <span class="o">});</span>
          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端 is ok&#34;</span><span class="o">);</span>

          <span class="c1">// 启动客户端去连接服务器端
</span><span class="c1"></span>          <span class="c1">// 关于 ChannelFuture 后面要分析，涉及到Netty的异步模型
</span><span class="c1"></span>          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span> <span class="n">6668</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

          <span class="c1">// 给关闭通道进行监听(sync是让其为阻塞到通道关闭后做额外的操作)
</span><span class="c1"></span>          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
      <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
          <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端Handler</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.simple</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClientHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
    <span class="c1">// 当通道就绪时，就会触发该方法
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;client &#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">);</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">&#34;hello,Server&#34;</span><span class="o">,</span> <span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// 当通道有读取事件时，会触发
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;输出服务器回复的消息：&#34;</span> <span class="o">+</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器端的地址：&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="585任务队列中的task有3种典型使用场景">5.8.5、任务队列中的Task有3种典型使用场景</h3>
<ol>
<li>用户程序自定义的普通任务(使用线程睡眠来解释)</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="c1">// 比如这里我们有一个非常耗费时间的业务-&gt;异步执行-&gt; 提交到该channel对应的NIOEventLoop的taskQueue中
</span><span class="c1"></span><span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">()</span>
	<span class="o">.</span><span class="na">eventLoop</span><span class="o">()</span>
	<span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
		  <span class="nd">@Override</span>
		  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
			  <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">10</span> <span class="o">*</span> <span class="n">1000</span><span class="o">);</span>
			  <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">&#34;hello,客户端2&#34;</span><span class="o">,</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;发生异常&#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
			<span class="o">}</span>
		  <span class="o">}</span>
		<span class="o">});</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100759.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100759.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100759.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100759.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100759.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915100759.png" /></p>
<ol start="2">
<li>用户自定义定时任务</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="c1">// 解决方案2：用户自定义定时任务
</span><span class="c1"></span>        <span class="cm">/*
</span><span class="cm">         * 使用scheduled，先执行taskQueue，执行完毕后再执行scheduled。并且scheduled里的延迟时间是从taskQueue执行第一个任务的时候开始计算的
</span><span class="cm">         * 如果你写了Thread.sleep()，那么就会按照该设置的延时加上schedule中设置的时间总和
</span><span class="cm">         */</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">schedule</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">5</span> <span class="o">*</span> <span class="n">1000</span><span class="o">);</span>
                    <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">&#34;hello,客户端3&#34;</span><span class="o">,</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;发生异常&#34;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">},</span><span class="n">15</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915111616.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915111616.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915111616.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915111616.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915111616.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915111616.png" /></p>
<ol start="3">
<li>
<p>非当前Reactor线程调用Channel的各种方法</p>
<pre><code> 例如在推送系统的业务线程里面，根据用户的表示，找到对应的Channel引用，然后调用Write类方法
 向该用户推送消息，就会进入到这种场景。最终的Write会提交到任务队列中后被异步消费
</code></pre>
</li>
</ol>
<p>方案再说明：</p>
<ol>
<li>Netty抽象出两组<strong>线程池</strong>，BossGroup专门负责接收客户端连接，WorkerGroup专门负责网络读写操作。</li>
<li>NioEventLoop表示一个不断循环执行处理任务的线程，每个NioEventLoop都有一个selector，用于监听绑定在其上的socket网络通道。</li>
<li>NioEventLoop内部采用串行化设计，从消息的读取-&gt;解码-&gt;处理-&gt;编码-&gt;发送，始终由IO线程NioEventLoop负责</li>
</ol>
<ul>
<li>NioEventLoopGroup下包含多个NioEventLoop</li>
<li>每个NioEventLoop中包含一个Selector，一个taskQueue</li>
<li>每个NioEventLoop的Selector上可以注册监听多个NioSocketChannel</li>
<li>每个NioSocketChannel只会绑定在唯一的NioEventLoop上</li>
<li>每个NioSocketChannel都会绑定有一个自己的ChannelPipeline</li>
</ul>
<h2 id="59异步模型">5.9、异步模型</h2>
<h3 id="591基本介绍">5.9.1、基本介绍</h3>
<ol>
<li>异步的概念和同步相对。当一个异步过程调用发出后，调用者不能立刻得到结果。实际处理这个调用的组件在完成后，通过状态、通知和回调来通知调用者</li>
<li><strong>Netty中的IO操作是异步的</strong>，包括Bind、Write、Connect等操作会简单的返回一个ChannelFuture</li>
<li>调用者并不能立刻获得结果，而是通过Future-Listener机制，用户可以方便的主动获取或者通过通知机制获得IO操作结果</li>
<li>Netty的异步模型是建立在future和callback之上的，callback就是回调。重点说Future，它的核心思想是：假设一个方法fun，计算过程可能非常耗时，等待fun返回显然不合适。那么可以在调用fun 的时候，立马返回一个Future，后续可以通过Future去监控方法fun的处理过程(即：Future-Listener机制)</li>
</ol>
<h3 id="592future说明">5.9.2、Future说明</h3>
<ol>
<li>表示<strong>异步的执行结果</strong>，可以通过它提供的方法来检测执行是否完成</li>
<li>ChannelFuture是一个接口：public interface ChannelFuture ,我们可以添加监听器，当监听的事件发生时，就会通知到监听器</li>
<li><strong>案例说明</strong></li>
</ol>
<h3 id="593工作原理示意图">5.9.3、工作原理示意图</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183944.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183944.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183944.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183944.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183944.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183944.png" />
<strong>说明:</strong></p>
<ol>
<li>在使用Netty进行编程时，拦截操作和转换出入站数据只需要提供 callback 或利用 future 即可。这使得<strong>链式操作</strong>简单、高效，并有利于编写可重用的、通用的代码。</li>
<li>Netty框架的目标就是让你的业务逻辑从网络基础应用编码中分离出来、解脱出来</li>
</ol>
<h3 id="594future-listener机制">5.9.4、Future-Listener机制</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915161318.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915161318.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915161318.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915161318.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915161318.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915161318.png" /></p>
<p><strong>举例说明：</strong></p>
<p>演示：绑定端口是异步操作，当绑定操作处理完，将会调用相应的监听器处理逻辑</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="n">cf</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	  <span class="k">if</span><span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">()){</span>
		  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;监听端口 6668成功&#34;</span><span class="o">);</span>
	  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;监听端口 6668失败&#34;</span><span class="o">);</span>
	  <span class="o">}</span>
  <span class="o">}</span>
<span class="o">});</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>小结：相比传统阻塞I/O，执行I/O操作后线程会被阻塞住，直到操作完成；异步处理的好处是不会造成
线程阻塞，线程在I/O操作期间可以执行别的程序，在高并发情况下会更稳定和更高的吞吐量
</code></pre>
<h2 id="510快速入门实例-http服务">5.10、快速入门实例-HTTP服务</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183154.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183154.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183154.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183154.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183154.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915183154.png" /></p>
<p><strong>服务器端</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-JAVA" data-lang="JAVA"><span class="kn">package</span> <span class="nn">com.clover.netty.http</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

      <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>
      <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span> <span class="o">{</span>
          <span class="n">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>

          <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span><span class="n">workerGroup</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">TestServerInitializer</span><span class="o">());</span>

          <span class="c1">// 注意：谷歌浏览器使用6668端口可能无法访问，可能存在安全验证，换一个端口就好
</span><span class="c1"></span>          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">15989</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
      <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
          <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
          <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>向管道加入处理器</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.http</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpServerCodec</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestServerInitializer</span> <span class="kd">extends</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 向管道加入处理器
</span><span class="c1"></span>        <span class="c1">// 得到管道
</span><span class="c1"></span>        <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>

        <span class="c1">// 加入一个netty提供的httpServerCodec(编解码器)
</span><span class="c1"></span>        <span class="cm">/*
</span><span class="cm">         * HttpServerCodec说明
</span><span class="cm">         * 1.HttpServerCodec 是netty提供处理Http的 编-解码器
</span><span class="cm">         */</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;MyHttpServerCodec&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">HttpServerCodec</span><span class="o">());</span>

        <span class="c1">// 2.增加一个自定的handler
</span><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;MyTestHttpServerHandler&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">TestHttpServerHandler</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>自定义handler</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.http</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>

<span class="cm">/*
</span><span class="cm"> * 说明
</span><span class="cm"> * 1.SimpleChannelInboundHandler 是 ChannelInboundHandlerAdapter的子类
</span><span class="cm"> * 2.HttpObject 客户端和服务器端相互通讯的数据被封装成HttpObject
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestHttpServerHandler</span> <span class="kd">extends</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">HttpObject</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="c1">// channelRead0读取客户端数据
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">HttpObject</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 判断msg 是不是 httprequest请求
</span><span class="c1"></span>        <span class="k">if</span><span class="o">(</span> <span class="n">msg</span> <span class="k">instanceof</span> <span class="n">HttpRequest</span><span class="o">){</span>

            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;pipeline hascode =&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">hashCode</span><span class="o">()+</span> <span class="s">&#34; TestHttpServerHandler hascode =&#34;</span> <span class="o">+</span><span class="k">this</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>

            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;msg 类型=&#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">getClass</span><span class="o">());</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端地址&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>

            <span class="c1">// 将msg转化为HttpRequest
</span><span class="c1"></span>            <span class="n">HttpRequest</span> <span class="n">httpRequest</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpRequest</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
            <span class="c1">//获取uri，过滤指定资源
</span><span class="c1"></span>            <span class="n">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URI</span><span class="o">(</span><span class="n">httpRequest</span><span class="o">.</span><span class="na">uri</span><span class="o">());</span>
            <span class="k">if</span><span class="o">(</span><span class="s">&#34;/favicon.ico&#34;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">uri</span><span class="o">.</span><span class="na">getPath</span><span class="o">())){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;请求了 favicon.ico，不做响应&#34;</span><span class="o">);</span>
                <span class="k">return</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="c1">// 回复信息给浏览器,需要满足http协议
</span><span class="c1"></span>            <span class="n">ByteBuf</span> <span class="n">content</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">&#34;hello，我是服务器&#34;</span><span class="o">,</span> <span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>

            <span class="c1">// 构造一个http的响应，即httpResponse
</span><span class="c1"></span>            <span class="n">FullHttpResponse</span> <span class="n">response</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultFullHttpResponse</span><span class="o">(</span><span class="n">HttpVersion</span><span class="o">.</span><span class="na">HTTP_1_1</span><span class="o">,</span> <span class="n">HttpResponseStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">,</span> <span class="n">content</span><span class="o">);</span>

            <span class="cm">/*
</span><span class="cm">             * 注意：如果中文乱码，则需要在 CONTENT_TYPE 中，修改为text/plain;charset=utf-8，或者直接将CharsetUtil.UTF_8改为UTF_16
</span><span class="cm">             */</span>
            <span class="n">response</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="n">HttpHeaderNames</span><span class="o">.</span><span class="na">CONTENT_TYPE</span><span class="o">,</span><span class="s">&#34;text/plain;charset=utf-8&#34;</span><span class="o">);</span>
            <span class="n">response</span><span class="o">.</span><span class="na">headers</span><span class="o">().</span><span class="na">set</span><span class="o">(</span><span class="n">HttpHeaderNames</span><span class="o">.</span><span class="na">CONTENT_LENGTH</span><span class="o">,</span><span class="n">content</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">());</span>

            <span class="c1">// 将构建好的response返回
</span><span class="c1"></span>            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">response</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>http不是一个长连接，用完即断掉
当你有多个浏览器连接服务器时，每个连接对应的pipeline和handler都是唯一的、不一样的，不是公用一个pipeline和handler
浏览器刷新时也会产生一个新的pipeline和handler，这是因为http协议原因所导致的，与TCP协议还是有区别的
</code></pre>
<h1 id="6核心模块组件">6、核心模块组件</h1>
<h2 id="61bootstrapserverbootstrap">6.1、Bootstrap、ServerBootstrap</h2>
<ol>
<li>Bootstrap 意思是引导，一个 Netty 应用通常由一个 Bootstrap 开始，主要作用是配置整个 Netty 程序，串联各个组件，Netty中<code>Bootstrap</code> 类是<code>客户端程序</code>的启动引导类，<code>ServerBootstrap</code>是<code>服务端</code>启动引导类</li>
<li>常见的方法有
<ul>
<li>public ServerBootstrap group(EventLoopGroup parentGroup, EventLoopGroup childGroup)，该方法用于服务器端，用来设置两个 EventLoop</li>
<li>public B group(EventLoopGroup group) ，该方法用于客户端，用来设置一个 EventLoop</li>
<li>public B channel(Class&lt;&gt; channelClass)，该方法用来设置一个服务器端的通道实现</li>
<li>public &lt;&gt; B option(ChannelOption&lt;&gt; option, T value)，用来给 ServerChannel 添加配置</li>
<li>public &lt;&gt; ServerBootstrap childOption(ChannelOption&lt;&gt; childOption, T value)，用来给接收到的通道添加配置</li>
<li>public ServerBootstrap childHandler(ChannelHandler childHandler)，该方法用来设置业务处理类(自定义的 handler)</li>
<li>public ChannelFuture bind(int inetPort) ，该方法用于服务器端，用来设置占用的端口号</li>
<li>public ChannelFuture connect(String inetHost, int inetPort) ，该方法用于客户端，用来连接服务器端</li>
</ul>
</li>
</ol>
<h2 id="62futurechannelfuture">6.2、Future、ChannelFuture</h2>
<ol>
<li><strong>Netty 中所有的 IO 操作都是异步的</strong>，不能立刻得知消息是否被正确处理。但是<strong>可以过一会等它执行完成或者直接注册一个监听</strong>，具体的实现就是通过<code>Future 和 ChannelFutures</code>，他们可以注册一个监听，当操作执行成功或失败时监听会自动触发注册的监听事件</li>
<li>常见的方法有
<ul>
<li>Channel channel()，返回当前正在进行 IO 操作的通道</li>
<li>ChannelFuture sync()，等待同步操作执行完毕</li>
</ul>
</li>
</ol>
<h2 id="63channel">6.3、Channel</h2>
<ol>
<li>Netty 网络通信的组件，能够用于执行网络 I/O 操作</li>
<li>通过Channel 可获得当前网络连接的通道的状态</li>
<li>通过Channel 可获得 网络连接的配置参数 （例如接收缓冲区大小）</li>
<li><strong>Channel 提供异步的网络 I/O 操作(如建立连接，读写，绑定端口)</strong>，异步调用意味着任何 I/O 调用都将立即返回，并且不保证在调用结束时所请求的 I/O 操作已完成</li>
<li>调用立即返回一个 ChannelFuture 实例，通过注册监听器到 ChannelFuture 上，可以 监控I/O 操作成功、失败或取消时回调通知调用方</li>
<li>支持关联 I/O 操作与对应的处理程序</li>
<li>不同协议、不同的阻塞类型的连接都有不同的 Channel 类型与之对应，常用的 Channel 类型:
<ul>
<li>NioSocketChannel，异步的客户端 TCP Socket 连接。</li>
<li>NioServerSocketChannel，异步的服务器端 TCP Socket 连接。</li>
<li>NioDatagram Channel，异步的 UDP 连接。</li>
<li>NioSctpChannel，异步的客户端 Sctp 连接。</li>
<li>NioSctpServerChannel，异步的 Sctp 服务器端连接，这些通道涵盖了 UDP 和 TCP 网络 IO 以及文件 IO。</li>
</ul>
</li>
</ol>
<h2 id="64selector">6.4、Selector</h2>
<ol>
<li>Netty 基于 Selector 对象实现 I/O 多路复用，通过 Selector 一个线程可以监听多个连接的 Channel 事件</li>
<li>当向一个 Selector 中注册 Channel 后，<strong>Selector 内部的机制就可以自动不断地查询(Select) 这些注册的 Channel 是否有已就绪的 I/O 事件（例如可读，可写，网络连接完成等）</strong>，这样程序就可以很简单地使用一个线程高效地管理多个 Channel</li>
</ol>
<h2 id="65channelhandler-及其实现类">6.5、ChannelHandler 及其实现类</h2>
<ol>
<li>
<p>ChannelHandler 是一个接口，处理 I/O 事件或拦截 I/O 操作，并将其转发到其 ChannelPipeline(业务处理链)中的下一个处理程序</p>
</li>
<li>
<p>ChannelHandler 本身并没有提供很多方法，因为这个接口有许多的方法需要实现，方便使用期间，可以继承它的子类</p>
</li>
<li>
<p><strong>ChannelHandler 及其实现类一览图</strong>
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915220803.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915220803.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915220803.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915220803.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915220803.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210915220803.png" /></p>
<ul>
<li>ChannelInboundHandler 用于处理入站 I/O 事件</li>
<li>ChannelOutboundHandler 用于处理出站 I/O 操作</li>
</ul>
<p><code>适配器</code></p>
<ul>
<li>ChannelInboundHandlerAdapter 用于处理入站 I/O 事件</li>
<li>ChannelOutboundHandlerAdapter 用于处理出站 I/O 操作</li>
<li>ChannelDuplexHandler 用于处理入站和出站事件</li>
</ul>
</li>
<li>
<p>我们经常需要自定义一个 Handler 类去继承 ChannelInboundHandlerAdapter，然后通过重写相应方法实现业务逻辑，我们接下来看看一般都需要重写哪些方</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Channel</span> <span class="n">InboundHandlerAdapter</span> <span class="kd">extends</span> <span class="n">Channel</span> <span class="n">HandlerAdapter</span> 
<span class="kd">implements</span> <span class="n">Channel</span> <span class="n">InboundHandler</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="n">Channel</span> <span class="nf">InboundHandlerAdapter</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRegistered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRegistered</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelUnregistered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelUnregistered</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//通道就绪事件
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelInactive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelInactive</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">//通道读取数据事件
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="c1">//数据读取完毕事件
</span><span class="c1"></span>	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="c1">//数据读取完毕事件
</span><span class="c1"></span>	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">userEventTriggered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">evt</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">fireUserEventTriggered</span><span class="o">(</span><span class="n">evt</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelWritabilityChanged</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">fireChannelWritabilityChanged</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="c1">//通道发生异常事件
</span><span class="c1"></span>	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">fireExceptionCaught</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="66pipeline和channelpipeline">6.6、Pipeline和ChannelPipeline</h2>
<p><strong>ChannelPipeline 是一个重点：</strong></p>
<ol>
<li>ChannelPipeline 是一个 Handler 的集合，它负责处理和拦截 inbound 或者 outbound 的事件和操作，相当于一个贯穿 Netty 的链。(<strong>也可以这样理解：ChannelPipeline 是保存 ChannelHandler 的 List，用于处理或拦截 Channel 的入站事件和出站操作</strong>)</li>
<li>ChannelPipeline 实现了一种高级形式的拦截过滤器模式，使用户可以完全控制事件的处理方式，以及 Channel 中各个的 ChannelHandler 如何相互交互</li>
<li>在 Netty 中每个 Channel 都有且仅有一个 ChannelPipeline 与之对应，它们的组成关系如下
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916102025.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916102025.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916102025.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916102025.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916102025.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916102025.png" />
<ul>
<li>一个 Channel 包含了一个 ChannelPipeline，而 ChannelPipeline 中又维护了一个由 ChannelHandlerContext 组成的双向链表，并且每个 ChannelHandlerContext 中又关联着一个 ChannelHandler</li>
<li>入站事件和出站事件在一个双向链表中，<code>入站事件</code>会<strong>从链表 head 往后传递</strong>到最后一个入站的 handler，<code>出站事件</code>会<strong>从链表 tail 往前传递</strong>到最前一个出站的 handler，两种类型的 handler 互不干扰</li>
</ul>
</li>
<li>常用方法
<ul>
<li>Channel Pipeline addFirst(ChannelHandler&hellip; handlers)，把一个业务处理类（handler）添加到链中的第一个位置</li>
<li>Channel Pipeline addLast(ChannelHandler&hellip; handlers)，把一个业务处理类（handler）添加到链中的最后一个位置</li>
</ul>
</li>
</ol>
<h2 id="67channelhandlercontext">6.7、ChannelHandlerContext</h2>
<ol>
<li>保存 Channel 相关的所有上下文信息，同时关联一个 ChannelHandler 对象</li>
<li>即 ChannelHandlerContext 中包含一个具体的事件处理器 ChannelHandler ， 同时ChannelHandlerContext 中也绑定了对应的 pipeline 和 Channel 的信息，方便对 ChannelHandler进行调用</li>
<li>常用方法
<ul>
<li>ChannelFuture close()，关闭通道</li>
<li>ChannelOutboundInvoker flush()，刷新</li>
<li>ChannelFuture writeAndFlush(Object msg) ， 将数据写到 ChannelPipeline 中当前ChannelHandler 的下一个 ChannelHandler 开始处理 <strong>(出站)</strong></li>
</ul>
</li>
</ol>
<h2 id="68channeloption">6.8、ChannelOption</h2>
<ol>
<li>Netty 在创建 Channel 实例后,一般都需要设置 ChannelOption 参数</li>
<li>ChannelOption 参数如下:
<ul>
<li><strong>ChannelOption.SO_BACKLOG</strong>
<ul>
<li>对应TCP/IP协议 listen 函数中的 backlog 参数，用来初始化服务器可连接队列大小。服务端处理客户端连接请求是顺序处理的，所以同一时间只能处理一个客户端连接。多个客户端来的时候，服务端将不能处理的客户端连接请求放在队列中等待处理，backlog参数指定了队列的大小</li>
</ul>
</li>
<li><strong>ChannelOption.SO_KEEPALIVE</strong>
<ul>
<li>一直保持连接活动状态</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="69eventloopgroup-和其实现类-nioeventloopgroup">6.9、EventLoopGroup 和其实现类 NioEventLoopGroup</h2>
<ol>
<li>EventLoopGroup 是一组 EventLoop 的抽象，Netty为了更好的利用多核 CPU 资源，一般会有多个 EventLoop 同时工作，每个 EventLoop 维护着一个Selector实例</li>
<li>EventLoopGroup 提供 next 接口，可以从组里面按照一定规则获取其中一个 EventLoop来处理任务。在 Netty 服务器端编程中，我们一般都需要提供两个 EventLoopGroup，例如：BossEventLoopGroup 和 WorkerEventLoopGroup</li>
<li>通常一个服务端口即一个 ServerSocketChannel 对应一个 Selector 和一个 EventLoop 线程。BossEventLoopGroup 负责接收客户端的连接并将 SocketChannel 交给 WorkerEventLoopGroup 来进行 IO 处理，如下图所示
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916111322.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916111322.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916111322.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916111322.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916111322.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916111322.png" />
<ul>
<li>BossEventLoopGroup 通常是一个单线程的 EventLoop，EventLoop 维护着一个注册了ServerSocketChannel 的 Selector 实例，BossEventLoop 不断轮询Selector 将连接事件分离出来</li>
<li>通常是OP_ACCEPT 事件，然后将接收到的 SocketChannel 交给 WorkerEventLoopGroup</li>
<li>WorkerEventLoopGroup 会由 next 选择其中一个 EventLoop来将这个SocketChannel 注册到其维护的 Selector 并对其后续的 IO 事件进行处理</li>
</ul>
</li>
<li>常用方法
<ul>
<li>public NioEventLoopGroup()，构造方法</li>
<li>public Future&lt;&gt; shutdownGracefully()，断开连接，关闭线程</li>
</ul>
</li>
</ol>
<h2 id="610unpooled类">6.10、Unpooled类</h2>
<ol>
<li>Netty 提供一个专门用来<code>操作缓冲区</code>(<strong>即Netty的数据容器</strong>)的工具类</li>
<li>常用方法如下所示
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">//通过给定的数据和字符编码返回一个 ByteBuf 对象（类似于 NIO 中的 ByteBuffer 但有区别）
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">static</span> <span class="n">ByteBuf</span> <span class="nf">copiedBuffer</span><span class="o">(</span><span class="n">CharSequence</span> <span class="n">string</span><span class="o">,</span> <span class="n">Charset</span> <span class="n">charset</span><span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>举例说明Unpooled 获取 Netty的数据容器ByteBuf 的基本使用 <code>(案例说明)</code>
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916215409.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916215409.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916215409.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916215409.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916215409.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210916215409.png" /></li>
</ol>
<p><strong>实例代码一</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.buf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyByteBuf01</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// 先创建一个ByteBuf
</span><span class="c1"></span>      <span class="cm">/*
</span><span class="cm">       * 说明
</span><span class="cm">       * 1.创建对象，该对象包含一个数组array，是一个byte[10]类型的数组
</span><span class="cm">       * 2.在netty的buffer中，不需要使用flip反转
</span><span class="cm">       *    底层维护了 readerIndex 和 writerIndex
</span><span class="cm">       * 3.通过 readerIndex 和 writerIndex 和 capacity ，将buffer分成三个区域
</span><span class="cm">       * 0---readerIndex，已经读取的区域
</span><span class="cm">       * readerIndex --- writerIndex，可以读取的区域
</span><span class="cm">       * writerIndex --- 0，可写的区域
</span><span class="cm">       */</span>
      <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">buffer</span><span class="o">(</span><span class="n">10</span><span class="o">);</span>

      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
          <span class="n">buf</span><span class="o">.</span><span class="na">writeByte</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;capacity=&#34;</span> <span class="o">+</span> <span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span>

    <span class="c1">// 输出
</span><span class="c1"></span>    <span class="c1">//      for (int i = 0; i &lt; buf.capacity(); i++){
</span><span class="c1"></span>    <span class="c1">//          // 这种方法是通过下标获取对应的值，不会使readerIndex改变值
</span><span class="c1"></span>    <span class="c1">//          System.out.println(buf.getByte(i));
</span><span class="c1"></span>    <span class="c1">//      }
</span><span class="c1"></span>
      <span class="c1">// 改变readerIndex的输出方式
</span><span class="c1"></span>      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">readByte</span><span class="o">());</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>实例代码二</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.buf</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyByteBuf02</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">//创建ByteBuf
</span><span class="c1"></span>      <span class="cm">/*
</span><span class="cm">       * 说明
</span><span class="cm">       * 第一个参数代表写入内容，第二个代表内容的字符集编码
</span><span class="cm">       */</span>
      <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">&#34;hello,world!&#34;</span><span class="o">,</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">));</span>

      <span class="c1">// 使用相关的方法
</span><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">hasArray</span><span class="o">()){</span>
          <span class="c1">// 获取buf的数组
</span><span class="c1"></span>          <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">array</span><span class="o">();</span>

          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">content</span><span class="o">,</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;bytebuf=&#34;</span> <span class="o">+</span> <span class="n">buf</span><span class="o">);</span>

          <span class="c1">// 获取数组位移偏移量
</span><span class="c1"></span>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">arrayOffset</span><span class="o">());</span><span class="c1">// 0
</span><span class="c1"></span>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">readerIndex</span><span class="o">());</span><span class="c1">// 0
</span><span class="c1"></span>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">writerIndex</span><span class="o">());</span><span class="c1">// 12
</span><span class="c1"></span>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">capacity</span><span class="o">());</span><span class="c1">// 36
</span><span class="c1"></span>
          <span class="c1">//System.out.println(buf.readByte());// 104 这是h代表的ASCII码
</span><span class="c1"></span>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">getByte</span><span class="o">(</span><span class="n">0</span><span class="o">));</span><span class="c1">// 104 这是h代表的ASCII码
</span><span class="c1"></span>
          <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">();</span><span class="c1">// 获取可读字节数
</span><span class="c1"></span>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;len=&#34;</span> <span class="o">+</span> <span class="n">len</span><span class="o">);</span><span class="c1">// 如果在前面没有使用readbyte读取数据，则不会对可读字节产生影响，如果使用就会有影响
</span><span class="c1"></span>
          <span class="c1">// 使用for循环取出各个字节
</span><span class="c1"></span>          <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">buf</span><span class="o">.</span><span class="na">getByte</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
          <span class="o">}</span>

          <span class="c1">// 按照某个范围读取
</span><span class="c1"></span>          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">getCharSequence</span><span class="o">(</span><span class="n">0</span><span class="o">,</span><span class="n">4</span><span class="o">,</span><span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">)));</span>
          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">buf</span><span class="o">.</span><span class="na">getCharSequence</span><span class="o">(</span><span class="n">4</span><span class="o">,</span><span class="n">6</span><span class="o">,</span><span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">)));</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="611群聊系统升级">6.11、群聊系统升级</h2>
<ol>
<li>编写一个 Netty 群聊系统，实现服务器端和客户端之间的数据简单通讯（非阻塞）</li>
<li>实现多人群聊</li>
<li>服务器端：可以监测用户上线，离线，并实现消息转发功能</li>
<li>客户端：通过channel 可以无阻塞发送消息给其它所有用户，同时可以接受其它用户发送的消息(由服务器转发得到)</li>
<li>目的：进一步理解Netty非阻塞网络编程机制</li>
</ol>
<p><strong>服务器端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.groupchat</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringEncoder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupChatServer</span> <span class="o">{</span>
    <span class="c1">// 监听端口
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">GroupChatServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">){</span>
        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

        <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

        <span class="k">try</span><span class="o">{</span>
            <span class="n">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>

            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span><span class="n">workerGroup</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span><span class="n">128</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">childOption</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_KEEPALIVE</span><span class="o">,</span><span class="kc">true</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                            <span class="c1">// 获取到pipeline
</span><span class="c1"></span>                            <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
                            <span class="c1">// 向pipeline中加入解码器
</span><span class="c1"></span>                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;decoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">StringDecoder</span><span class="o">());</span>
                            <span class="c1">// 向pipeline中加入编码器
</span><span class="c1"></span>                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;encoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">StringEncoder</span><span class="o">());</span>
                            <span class="c1">// 加入自己的业务处理handler
</span><span class="c1"></span>                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">GroupChatServerHandler</span><span class="o">());</span>
                        <span class="o">}</span>
                    <span class="o">});</span>

            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;netty 服务器启动&#34;</span><span class="o">);</span>
            <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

            <span class="c1">// 监听关闭事件
</span><span class="c1"></span>            <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>

    <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">new</span> <span class="n">GroupChatServer</span><span class="o">(</span><span class="n">7000</span><span class="o">).</span><span class="na">run</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务器端handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.groupchat</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.Channel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.group.ChannelGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.group.DefaultChannelGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.concurrent.GlobalEventExecutor</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.text.SimpleDateFormat</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupChatServerHandler</span> <span class="kd">extends</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// 定义一个channel组，管理所有的channel
</span><span class="c1"></span>    <span class="c1">// GlobalEventExecutor.INSTANCE 是全局的事件执行器，是一个单例
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ChannelGroup</span> <span class="n">channelGroup</span><span class="o">=</span> <span class="k">new</span> <span class="n">DefaultChannelGroup</span><span class="o">(</span><span class="n">GlobalEventExecutor</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">);</span>
    <span class="n">SimpleDateFormat</span> <span class="n">sdf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class="o">);</span><span class="c1">// 输出接收消息时的时间
</span><span class="c1"></span>
    <span class="c1">// handlerAdded表示连接建立，一旦连接，第一个被执行
</span><span class="c1"></span>    <span class="c1">// 将当前channel加入到channelGroup
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
        <span class="cm">/*
</span><span class="cm">         * 将该客户端加入聊天的信息推送给其它在线的客户端
</span><span class="cm">         * 该方法会将channelGroup中所有的channel遍历一遍，并发送消息，我们不需要自己遍历
</span><span class="cm">         */</span>
        <span class="n">channelGroup</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">&#34;[客户端]&#34;</span> <span class="o">+</span> <span class="n">channel</span><span class="o">.</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; 加入聊天&#34;</span> <span class="o">+</span> <span class="n">sdf</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">())</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span><span class="o">);</span>
        <span class="n">channelGroup</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 表示断开连接了,将xxx客户离开信息推送给当前在线的客户
</span><span class="c1"></span>    <span class="c1">// 只要触发了handlerRemoved函数就会自动在channelGroup中移除自己，不需要自己手动去清除
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerRemoved</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
        <span class="n">channelGroup</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">&#34;[客户端]&#34;</span> <span class="o">+</span> <span class="n">channel</span><span class="o">.</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;离开了\n&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelGroup size =&#34;</span> <span class="o">+</span> <span class="n">channelGroup</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// 表示channel处于活动状态，可以提示xx上线
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">()+</span> <span class="s">&#34;上线了~&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 表示channel处于非活动状态，可以提示xx离线
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelInactive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">()+</span> <span class="s">&#34;离线了~&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 读取数据
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 获取到当前的channel
</span><span class="c1"></span>        <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
        <span class="c1">// 这个时候我们需要遍历channelGroup，根据不同的情况回送不同的消息，主要是为了剔除自己
</span><span class="c1"></span>        <span class="n">channelGroup</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span> <span class="n">ch</span> <span class="o">-&gt;{</span>
            <span class="c1">// 不是当前的channel，就直接转发消息
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">channel</span> <span class="o">!=</span><span class="n">ch</span><span class="o">){</span>
                <span class="c1">// 将当前channel通道的信息转发给ch，即channelGroup中遍历出来的某一个channel
</span><span class="c1"></span>                <span class="n">ch</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">&#34;[客户]&#34;</span> <span class="o">+</span> <span class="n">channel</span><span class="o">.</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;发送了消息：&#34;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">ch</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="s">&#34;[自己]发送了消息&#34;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span> <span class="s">&#34;\n&#34;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 关闭通道
</span><span class="c1"></span>        <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">先执行</span> <span class="n">handlerAdd</span> <span class="n">再执行</span> <span class="n">handlerActive</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.groupchat</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringEncoder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Scanner</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupChatClient</span> <span class="o">{</span>
    <span class="c1">// 属性
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">host</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">GroupChatClient</span><span class="o">(</span><span class="n">String</span> <span class="n">host</span><span class="o">,</span> <span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">host</span> <span class="o">=</span> <span class="n">host</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">EventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>

            <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                            <span class="c1">// 得到pipeline
</span><span class="c1"></span>                            <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
                            <span class="c1">// 加入相关的handler
</span><span class="c1"></span>                            <span class="c1">// 向pipeline中加入解码器
</span><span class="c1"></span>                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;decoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">StringDecoder</span><span class="o">());</span>
                            <span class="c1">// 向pipeline中加入编码器
</span><span class="c1"></span>                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;encoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">StringEncoder</span><span class="o">());</span>
                            <span class="c1">// 加入自定义的handler
</span><span class="c1"></span>                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">GroupChatClientHandler</span><span class="o">());</span>
                        <span class="o">}</span>
                    <span class="o">});</span>

            <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
            <span class="c1">// 得到channel
</span><span class="c1"></span>            <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----------&#34;</span> <span class="o">+</span> <span class="n">channel</span><span class="o">.</span><span class="na">localAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;-------------&#34;</span><span class="o">);</span>

            <span class="c1">// 需要输入信息，因此我需要一个扫描器
</span><span class="c1"></span>            <span class="n">Scanner</span> <span class="n">scanner</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
            <span class="k">while</span><span class="o">(</span><span class="n">scanner</span><span class="o">.</span><span class="na">hasNextLine</span><span class="o">()){</span>
                <span class="n">String</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="na">nextLine</span><span class="o">();</span>
                <span class="c1">// 通过channel发送信息到服务器端
</span><span class="c1"></span>                <span class="n">channel</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s">&#34;\r\n&#34;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
            <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="k">new</span> <span class="n">GroupChatClient</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span><span class="n">7000</span><span class="o">).</span><span class="na">run</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.groupchat</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GroupChatClientHandler</span> <span class="kd">extends</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">trim</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="612netty心跳检测机制案例">6.12、Netty心跳检测机制案例</h2>
<p>实例要求：</p>
<ol>
<li>编写一个 Netty心跳检测机制案例, 当服务器超过3秒没有读时，就提示读空闲</li>
<li>当服务器超过5秒没有写操作时，就提示写空闲</li>
<li>实现当服务器超过7秒没有读或者写操作时，就提示读写空闲</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.heartbeat</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.timeout.IdleStateHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="c1">// 创建两个线程组
</span><span class="c1"></span>      <span class="n">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
      <span class="n">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span> <span class="o">{</span>

          <span class="n">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>

          <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span><span class="n">workerGroup</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">LoggingHandler</span><span class="o">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span> <span class="c1">// 在我们的bossGroup中增加一个日志处理器
</span><span class="c1"></span>                  <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                      <span class="nd">@Override</span>
                      <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                          <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
                          <span class="c1">// 加入一个netty提供的处理器 IdleStateHandler
</span><span class="c1"></span>                          <span class="cm">/*
</span><span class="cm">                           * 说明
</span><span class="cm">                           * 1.IdleStateHandler 是netty提供的处理空闲状态的处理器
</span><span class="cm">                           * 2.long readerIdleTime : 表示多长时间没有读，就会发送一个心跳检测包检测是否连接
</span><span class="cm">                           * 3.long writerIdleTime : 表示多长时间没有写，就会发送一个心跳检测包检测是否连接
</span><span class="cm">                           * 4.long allIdleTime : 表示多长时间没有读写，就会发送一个心跳检测包检测是否连接
</span><span class="cm">                           * 5.当IdleStateHandler触发后，就会传递给换到的下一个handler去处理，通过调用(触发)下一个handler的userEventTriggered
</span><span class="cm">                           *   在该方法中去处理IdleStateHandler(读空闲，写空闲，读写空闲)
</span><span class="cm">                           * 6.如果是0表示不检测，所以如果全是0，则相当于没添加这个 IdleStateHandler，连接是个普通的短连接。
</span><span class="cm">                           */</span>
                          <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">IdleStateHandler</span><span class="o">(</span><span class="n">3</span><span class="o">,</span><span class="n">5</span><span class="o">,</span><span class="n">7</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">));</span>
                          <span class="c1">// 加入一个对空闲检测进一步处理的handler(自定义)
</span><span class="c1"></span>                          <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyServerHandler</span><span class="o">());</span>
                      <span class="o">}</span>
                  <span class="o">});</span>
          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">7000</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

      <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
          <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
          <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.heartbeat</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.timeout.IdleStateEvent</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServerHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
    <span class="cm">/*
</span><span class="cm">     * @param ctx 上下文
</span><span class="cm">     * @param evt 事件
</span><span class="cm">     * @throws Exception
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">userEventTriggered</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">evt</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">evt</span> <span class="k">instanceof</span> <span class="n">IdleStateEvent</span><span class="o">){</span>
            <span class="c1">// 将evt向下转型 IdleStateEvent
</span><span class="c1"></span>            <span class="n">IdleStateEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="o">(</span><span class="n">IdleStateEvent</span><span class="o">)</span> <span class="n">evt</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">eventType</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">state</span><span class="o">()){</span>
                <span class="k">case</span> <span class="n">READER_IDLE</span><span class="o">:</span>
                    <span class="n">eventType</span> <span class="o">=</span> <span class="s">&#34;读空闲&#34;</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="n">WRITER_IDLE</span><span class="o">:</span>
                    <span class="n">eventType</span> <span class="o">=</span> <span class="s">&#34;写空闲&#34;</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">case</span> <span class="n">ALL_IDLE</span><span class="o">:</span>
                    <span class="n">eventType</span> <span class="o">=</span> <span class="s">&#34;读写空闲&#34;</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;---超时事件---&#34;</span> <span class="o">+</span> <span class="n">eventType</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器开始做相应的处理&#34;</span><span class="o">);</span>

            <span class="c1">// 如果发生空闲，我们关闭通道，结果显示就只会显示一次空闲后就不在显示了
</span><span class="c1"></span>            <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="613netty-通过websocket编程实现服务器和客户端长连接">6.13、Netty 通过WebSocket编程实现服务器和客户端长连接</h2>
<p>实例要求：</p>
<ol>
<li>Http协议是无状态的, 浏览器和服务器间的请求响应一次，下一次会重新创建连接</li>
<li>要求：实现基于webSocket的长连接的全双工的交互</li>
<li>改变Http协议多次请求的约束，实现长连接了， 服务器可以发送消息给浏览器</li>
<li>客户端浏览器和服务器端会相互感知，比如服务器关闭了，浏览器会感知，同样浏览器关闭了，服务器会感知</li>
<li>运行界面如下</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210923093240.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210923093240.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210923093240.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210923093240.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210923093240.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210923093240.png" /></p>
<p><strong>服务器端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.websocket</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpObjectAggregator</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.HttpServerCodec</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.stream.ChunkedWriteHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="c1">// 创建两个线程组
</span><span class="c1"></span>      <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
      <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span><span class="o">{</span>

          <span class="n">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>

          <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span><span class="n">workerGroup</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">LoggingHandler</span><span class="o">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span>
                  <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                      <span class="nd">@Override</span>
                      <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                          <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>

                          <span class="c1">// 因为基于http协议，使用http的编码和解码器
</span><span class="c1"></span>                          <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpServerCodec</span><span class="o">());</span>
                          <span class="c1">// 是以块方式写，添加ChunkedWriteHandler处理器
</span><span class="c1"></span>                          <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ChunkedWriteHandler</span><span class="o">());</span>

                          <span class="cm">/*
</span><span class="cm">                           * 说明
</span><span class="cm">                           * 1.http数据在传输过程中是分段，HttpObjectAggregator，作用就是可将多个段聚合
</span><span class="cm">                           * 2.这就是为什么，当浏览器发送大量数据时，就会发出多次http请求
</span><span class="cm">                           */</span>
                          <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">HttpObjectAggregator</span><span class="o">(</span><span class="n">8192</span><span class="o">));</span>
                          <span class="cm">/*
</span><span class="cm">                           * 说明
</span><span class="cm">                           * 1.对应的websocket，它的数据是以 帧(frame) 形式传递
</span><span class="cm">                           * 2.可以看到WebSocketFrame 下面有六个子类
</span><span class="cm">                           * 3.浏览器请求时 ws://localhost:7000/xxx 表示请求的qurl
</span><span class="cm">                           * 4.WebSocketServerProtocolHandler 核心功能是将http协议升级为ws协议，即保持长连接
</span><span class="cm">                           * 5.是通过一个 状态码 101
</span><span class="cm">                           */</span>
                          <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">WebSocketServerProtocolHandler</span><span class="o">(</span><span class="s">&#34;/hello&#34;</span><span class="o">));</span>

                          <span class="c1">// 自定义的handler，处理业务逻辑
</span><span class="c1"></span>                          <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyTextWebSocketFrameHandler</span><span class="o">());</span>
                      <span class="o">}</span>
                  <span class="o">});</span>

          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">7000</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

      <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
          <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
          <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>对应的handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.websocket</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.http.websocketx.TextWebSocketFrame</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDateTime</span><span class="o">;</span>

<span class="c1">// 这里 TextWebSocketFrame 类型，表示一个文本帧(frame)
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyTextWebSocketFrameHandler</span> <span class="kd">extends</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">TextWebSocketFrame</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">TextWebSocketFrame</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器收到消息：&#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">text</span><span class="o">());</span>

        <span class="c1">// 回复浏览器消息
</span><span class="c1"></span>        <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="k">new</span> <span class="n">TextWebSocketFrame</span><span class="o">(</span><span class="s">&#34;服务器时间：&#34;</span> <span class="o">+</span> <span class="n">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; &#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="na">text</span><span class="o">()));</span>
    <span class="o">}</span>

    <span class="c1">// 当web客户端连接后，就会触发这个方法
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// id 表示唯一的值，LongText 这个值是唯一的，ShortText 这个值不是唯一的
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;handlerAdded 被调用了&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">id</span><span class="o">().</span><span class="na">asLongText</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;handlerAdded 被调用了&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">id</span><span class="o">().</span><span class="na">asShortText</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handlerRemoved</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;handlerRemoved 被调用了&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">id</span><span class="o">().</span><span class="na">asLongText</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;异常发生&#34;</span> <span class="o">+</span> <span class="n">cause</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span><span class="c1">// 关闭连接
</span><span class="c1"></span>    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html"><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&#34;en&#34;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Title<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>
    <span class="c1">// 判断当前浏览器是否支持websocket
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">WebSocket</span><span class="p">){</span>
        <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s2">&#34;ws://localhost:7000/hello&#34;</span><span class="p">);</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">rt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;responseText&#34;</span><span class="p">);</span>
            <span class="nx">rt</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">rt</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s2">&#34;\n&#34;</span> <span class="o">+</span> <span class="nx">ev</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="c1">// 相当于连接开启(感知到连接开启)
</span><span class="c1"></span>        <span class="nx">socket</span><span class="p">.</span><span class="nx">onopen</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">rt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;responseText&#34;</span><span class="p">);</span>
            <span class="nx">rt</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s2">&#34;连接开启了...&#34;</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="c1">// 相当于连接关闭(感知到连接关闭)
</span><span class="c1"></span>        <span class="nx">socket</span><span class="p">.</span><span class="nx">onclose</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">rt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;responseText&#34;</span><span class="p">);</span>
            <span class="nx">rt</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">rt</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s2">&#34;\n&#34;</span> <span class="o">+</span> <span class="s2">&#34;连接关闭了...&#34;</span><span class="p">;</span>
        <span class="p">};</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;当前浏览器不支持webSocket&#34;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 发送消息到服务器
</span><span class="c1"></span>    <span class="kd">function</span> <span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 先判断websocket是否创建好
</span><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">socket</span><span class="p">){</span>
            <span class="k">return</span> <span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">){</span>
            <span class="c1">// 通过socket发送消息
</span><span class="c1"></span>            <span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;连接未开启...&#34;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onsubmit</span><span class="o">=</span><span class="s">&#34;return false&#34;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;message&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;height: 300px;width: 300px&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;button&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;发送消息&#34;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&#34;send(this.form.message.value)&#34;</span><span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">textarea</span> <span class="na">id</span><span class="o">=</span><span class="s">&#34;responseText&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;height: 300px;width: 300px&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">textarea</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;button&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;清空内容&#34;</span> <span class="na">onclick</span><span class="o">=</span><span class="s">&#34;document.getElementById(&#39;responseText&#39;).value=&#39;&#39;&#34;</span><span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="7google-protobuf">7、Google Protobuf</h1>
<h2 id="71编码和解码的基本介绍">7.1、编码和解码的基本介绍</h2>
<ol>
<li>编写网络应用程序时，因为数据在网络种传输的都是二进制字节码数据，在发送数据时就需要编码，接收数据时就需要解码</li>
<li>codec(编解码器)的组成部分有两个：decoder(解码器)和encoder(编码器)。encoder负责把业务数据转换成字节码数据，decoder负责把字节码数据转换成业务数据</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924174143.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924174143.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924174143.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924174143.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924174143.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924174143.png" /></p>
<h2 id="72netty-本身的编码解码的机制和问题分析">7.2、Netty 本身的编码解码的机制和问题分析</h2>
<ol>
<li>
<p>Netty 自身提供了一些 codec(编解码器)</p>
</li>
<li>
<p>Netty 提供的编码器</p>
<ul>
<li><code>StringEncoder</code>，对字符串数据进行编码</li>
<li><code>ObjectEncoder</code>，对 Java 对象进行编码</li>
</ul>
</li>
<li>
<p>Netty 提供的解码器</p>
<ul>
<li><code>StringDecoder</code>, 对字符串数据进行解码</li>
<li><code>ObjectDecoder</code>，对 Java 对象进行解码</li>
</ul>
</li>
<li>
<p>Netty 本身自带的 ObjectDecoder 和 ObjectEncoder 可以用来实现 POJO 对象或各种业务对象的编码和解码，<strong>底层使用的仍是 Java 序列化技术</strong> , 而Java 序列化技术本身效率就不高，存在如下问题</p>
<ul>
<li>无法跨语言</li>
<li>序列化后的体积太大，是二进制编码的 5 倍多</li>
<li>序列化性能太低</li>
</ul>
<p>=&gt; 引出新的解决方案[Google的Protobuf]</p>
</li>
</ol>
<h2 id="73protobuf">7.3、Protobuf</h2>
<h3 id="731protobuf基本介绍和使用示意图">7.3.1、Protobuf基本介绍和使用示意图</h3>
<ol>
<li>
<p>Protobuf 是 Google 发布的开源项目，全称 Google Protocol Buffers，是一种轻便高效的结构化数据存储格式，可以用于结构化数据串行化，或者说序列化。它很适合做数据存储或 <strong>RPC(远程过程调用  remote procedure call)数据交换格式</strong>。</p>
<p>目前很多公司 http+json -&gt; tcp+protobuf</p>
</li>
<li>
<p><a href="https://developers.google.com/protocol-buffers/docs/proto" target="_blank" rel="noopener noreffer">参考文档:语言指南</a></p>
</li>
<li>
<p>Protobuf 是以 message 的方式来管理数据的</p>
</li>
<li>
<p>支持跨平台、跨语言，即<strong>客户端和服务器端可以是不同的语言编写的</strong> (支持目前绝大多数语言，例如 C++、C#、Java、python 等)</p>
</li>
<li>
<p>高性能，高可靠性</p>
</li>
<li>
<p>使用 protobuf 编译器能自动生成代码，Protobuf 是将类的定义使用<code>.proto</code>文件进行描述。说明，在idea 中编写 .proto 文件时，会自动提示是否下载 .ptotot 编写插件. 可以让语法高亮</p>
</li>
<li>
<p>然后通过 <code>protoc.exe 编译器</code>根据.proto 自动生成.java 文件</p>
</li>
<li>
<p>protobuf 使用示意图</p>
</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924175929.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924175929.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924175929.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924175929.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924175929.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924175929.png" /></p>
<h2 id="74protobuf快速入门实例1">7.4、Protobuf快速入门实例1</h2>
<p>编写程序，使用Protobuf完成如下功能</p>
<ol>
<li>客户端可以发送一个Student  PoJo 对象到服务器 (通过 Protobuf 编码)</li>
<li>服务端能接收Student PoJo 对象，并显示信息(通过 Protobuf 解码)</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924222204.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924222204.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924222204.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924222204.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924222204.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210924222204.png" /></p>
<p><strong>ProtoBuf：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="o">;</span><span class="c1">// 版本
</span><span class="c1"></span><span class="n">option</span> <span class="n">java_outer_classname</span> <span class="o">=</span> <span class="s">&#34;StudentPOJO&#34;</span><span class="o">;</span><span class="c1">// 生成的外部类名，同时也是文件名
</span><span class="c1">// protobuf使用message管理数据
</span><span class="c1"></span><span class="n">message</span> <span class="n">Student</span><span class="o">{</span>
  <span class="c1">// 会在StudentPOJO外部类中生成一个内部类Student，它是真正发送的POJO对象
</span><span class="c1"></span>  <span class="n">int32</span> <span class="n">id</span> <span class="o">=</span><span class="n">1</span><span class="o">;</span> <span class="c1">// Student类中有一个属性 名字为 id ，类型为int32(protobuf类型)，1表示属性序号，不是值
</span><span class="c1"></span>  <span class="n">string</span> <span class="n">name</span> <span class="o">=</span><span class="n">2</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>ProtoBuf生成的xxx.java：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span><span class="lnt">422
</span><span class="lnt">423
</span><span class="lnt">424
</span><span class="lnt">425
</span><span class="lnt">426
</span><span class="lnt">427
</span><span class="lnt">428
</span><span class="lnt">429
</span><span class="lnt">430
</span><span class="lnt">431
</span><span class="lnt">432
</span><span class="lnt">433
</span><span class="lnt">434
</span><span class="lnt">435
</span><span class="lnt">436
</span><span class="lnt">437
</span><span class="lnt">438
</span><span class="lnt">439
</span><span class="lnt">440
</span><span class="lnt">441
</span><span class="lnt">442
</span><span class="lnt">443
</span><span class="lnt">444
</span><span class="lnt">445
</span><span class="lnt">446
</span><span class="lnt">447
</span><span class="lnt">448
</span><span class="lnt">449
</span><span class="lnt">450
</span><span class="lnt">451
</span><span class="lnt">452
</span><span class="lnt">453
</span><span class="lnt">454
</span><span class="lnt">455
</span><span class="lnt">456
</span><span class="lnt">457
</span><span class="lnt">458
</span><span class="lnt">459
</span><span class="lnt">460
</span><span class="lnt">461
</span><span class="lnt">462
</span><span class="lnt">463
</span><span class="lnt">464
</span><span class="lnt">465
</span><span class="lnt">466
</span><span class="lnt">467
</span><span class="lnt">468
</span><span class="lnt">469
</span><span class="lnt">470
</span><span class="lnt">471
</span><span class="lnt">472
</span><span class="lnt">473
</span><span class="lnt">474
</span><span class="lnt">475
</span><span class="lnt">476
</span><span class="lnt">477
</span><span class="lnt">478
</span><span class="lnt">479
</span><span class="lnt">480
</span><span class="lnt">481
</span><span class="lnt">482
</span><span class="lnt">483
</span><span class="lnt">484
</span><span class="lnt">485
</span><span class="lnt">486
</span><span class="lnt">487
</span><span class="lnt">488
</span><span class="lnt">489
</span><span class="lnt">490
</span><span class="lnt">491
</span><span class="lnt">492
</span><span class="lnt">493
</span><span class="lnt">494
</span><span class="lnt">495
</span><span class="lnt">496
</span><span class="lnt">497
</span><span class="lnt">498
</span><span class="lnt">499
</span><span class="lnt">500
</span><span class="lnt">501
</span><span class="lnt">502
</span><span class="lnt">503
</span><span class="lnt">504
</span><span class="lnt">505
</span><span class="lnt">506
</span><span class="lnt">507
</span><span class="lnt">508
</span><span class="lnt">509
</span><span class="lnt">510
</span><span class="lnt">511
</span><span class="lnt">512
</span><span class="lnt">513
</span><span class="lnt">514
</span><span class="lnt">515
</span><span class="lnt">516
</span><span class="lnt">517
</span><span class="lnt">518
</span><span class="lnt">519
</span><span class="lnt">520
</span><span class="lnt">521
</span><span class="lnt">522
</span><span class="lnt">523
</span><span class="lnt">524
</span><span class="lnt">525
</span><span class="lnt">526
</span><span class="lnt">527
</span><span class="lnt">528
</span><span class="lnt">529
</span><span class="lnt">530
</span><span class="lnt">531
</span><span class="lnt">532
</span><span class="lnt">533
</span><span class="lnt">534
</span><span class="lnt">535
</span><span class="lnt">536
</span><span class="lnt">537
</span><span class="lnt">538
</span><span class="lnt">539
</span><span class="lnt">540
</span><span class="lnt">541
</span><span class="lnt">542
</span><span class="lnt">543
</span><span class="lnt">544
</span><span class="lnt">545
</span><span class="lnt">546
</span><span class="lnt">547
</span><span class="lnt">548
</span><span class="lnt">549
</span><span class="lnt">550
</span><span class="lnt">551
</span><span class="lnt">552
</span><span class="lnt">553
</span><span class="lnt">554
</span><span class="lnt">555
</span><span class="lnt">556
</span><span class="lnt">557
</span><span class="lnt">558
</span><span class="lnt">559
</span><span class="lnt">560
</span><span class="lnt">561
</span><span class="lnt">562
</span><span class="lnt">563
</span><span class="lnt">564
</span><span class="lnt">565
</span><span class="lnt">566
</span><span class="lnt">567
</span><span class="lnt">568
</span><span class="lnt">569
</span><span class="lnt">570
</span><span class="lnt">571
</span><span class="lnt">572
</span><span class="lnt">573
</span><span class="lnt">574
</span><span class="lnt">575
</span><span class="lnt">576
</span><span class="lnt">577
</span><span class="lnt">578
</span><span class="lnt">579
</span><span class="lnt">580
</span><span class="lnt">581
</span><span class="lnt">582
</span><span class="lnt">583
</span><span class="lnt">584
</span><span class="lnt">585
</span><span class="lnt">586
</span><span class="lnt">587
</span><span class="lnt">588
</span><span class="lnt">589
</span><span class="lnt">590
</span><span class="lnt">591
</span><span class="lnt">592
</span><span class="lnt">593
</span><span class="lnt">594
</span><span class="lnt">595
</span><span class="lnt">596
</span><span class="lnt">597
</span><span class="lnt">598
</span><span class="lnt">599
</span><span class="lnt">600
</span><span class="lnt">601
</span><span class="lnt">602
</span><span class="lnt">603
</span><span class="lnt">604
</span><span class="lnt">605
</span><span class="lnt">606
</span><span class="lnt">607
</span><span class="lnt">608
</span><span class="lnt">609
</span><span class="lnt">610
</span><span class="lnt">611
</span><span class="lnt">612
</span><span class="lnt">613
</span><span class="lnt">614
</span><span class="lnt">615
</span><span class="lnt">616
</span><span class="lnt">617
</span><span class="lnt">618
</span><span class="lnt">619
</span><span class="lnt">620
</span><span class="lnt">621
</span><span class="lnt">622
</span><span class="lnt">623
</span><span class="lnt">624
</span><span class="lnt">625
</span><span class="lnt">626
</span><span class="lnt">627
</span><span class="lnt">628
</span><span class="lnt">629
</span><span class="lnt">630
</span><span class="lnt">631
</span><span class="lnt">632
</span><span class="lnt">633
</span><span class="lnt">634
</span><span class="lnt">635
</span><span class="lnt">636
</span><span class="lnt">637
</span><span class="lnt">638
</span><span class="lnt">639
</span><span class="lnt">640
</span><span class="lnt">641
</span><span class="lnt">642
</span><span class="lnt">643
</span><span class="lnt">644
</span><span class="lnt">645
</span><span class="lnt">646
</span><span class="lnt">647
</span><span class="lnt">648
</span><span class="lnt">649
</span><span class="lnt">650
</span><span class="lnt">651
</span><span class="lnt">652
</span><span class="lnt">653
</span><span class="lnt">654
</span><span class="lnt">655
</span><span class="lnt">656
</span><span class="lnt">657
</span><span class="lnt">658
</span><span class="lnt">659
</span><span class="lnt">660
</span><span class="lnt">661
</span><span class="lnt">662
</span><span class="lnt">663
</span><span class="lnt">664
</span><span class="lnt">665
</span><span class="lnt">666
</span><span class="lnt">667
</span><span class="lnt">668
</span><span class="lnt">669
</span><span class="lnt">670
</span><span class="lnt">671
</span><span class="lnt">672
</span><span class="lnt">673
</span><span class="lnt">674
</span><span class="lnt">675
</span><span class="lnt">676
</span><span class="lnt">677
</span><span class="lnt">678
</span><span class="lnt">679
</span><span class="lnt">680
</span><span class="lnt">681
</span><span class="lnt">682
</span><span class="lnt">683
</span><span class="lnt">684
</span><span class="lnt">685
</span><span class="lnt">686
</span><span class="lnt">687
</span><span class="lnt">688
</span><span class="lnt">689
</span><span class="lnt">690
</span><span class="lnt">691
</span><span class="lnt">692
</span><span class="lnt">693
</span><span class="lnt">694
</span><span class="lnt">695
</span><span class="lnt">696
</span><span class="lnt">697
</span><span class="lnt">698
</span><span class="lnt">699
</span><span class="lnt">700
</span><span class="lnt">701
</span><span class="lnt">702
</span><span class="lnt">703
</span><span class="lnt">704
</span><span class="lnt">705
</span><span class="lnt">706
</span><span class="lnt">707
</span><span class="lnt">708
</span><span class="lnt">709
</span><span class="lnt">710
</span><span class="lnt">711
</span><span class="lnt">712
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.codec</span><span class="o">;</span>
<span class="c1">// Generated by the protocol buffer compiler.  DO NOT EDIT!
</span><span class="c1">// source: Student.proto
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">StudentPOJO</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nf">StudentPOJO</span><span class="o">()</span> <span class="o">{}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerAllExtensions</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerAllExtensions</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">registerAllExtensions</span><span class="o">(</span>
        <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span><span class="o">)</span> <span class="n">registry</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StudentOrBuilder</span> <span class="kd">extends</span>
      <span class="c1">// @@protoc_insertion_point(interface_extends:Student)
</span><span class="c1"></span>      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">MessageOrBuilder</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * 会在StudentPOJO外部类中生成一个内部类Student，它是真正发送的POJO对象
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;int32 id = 1;&lt;/code&gt;
</span><span class="cm">     * @return The id.
</span><span class="cm">     */</span>
    <span class="kt">int</span> <span class="nf">getId</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">     * @return The name.
</span><span class="cm">     */</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">     * @return The bytes for name.
</span><span class="cm">     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
        <span class="nf">getNameBytes</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="cm">/**
</span><span class="cm">   * &lt;pre&gt;
</span><span class="cm">   * protobuf使用message管理数据
</span><span class="cm">   * &lt;/pre&gt;
</span><span class="cm">   *
</span><span class="cm">   * Protobuf type {@code Student}
</span><span class="cm">   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="kd">extends</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span> <span class="kd">implements</span>
      <span class="c1">// @@protoc_insertion_point(message_implements:Student)
</span><span class="c1"></span>      <span class="n">StudentOrBuilder</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
    <span class="c1">// Use Student.newBuilder() to construct.
</span><span class="c1"></span>    <span class="kd">private</span> <span class="nf">Student</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">builder</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="nf">Student</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">name_</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">&#34;unused&#34;</span><span class="o">})</span>
    <span class="kd">protected</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="nf">newInstance</span><span class="o">(</span>
        <span class="n">UnusedPrivateParameter</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">Student</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span>
    <span class="nf">getUnknownFields</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="nf">Student</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">extensionRegistry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NullPointerException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">unknownFields</span> <span class="o">=</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readTag</span><span class="o">();</span>
          <span class="k">switch</span> <span class="o">(</span><span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">0</span><span class="o">:</span>
              <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">8</span><span class="o">:</span> <span class="o">{</span>

              <span class="n">id_</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readInt32</span><span class="o">();</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="n">18</span><span class="o">:</span> <span class="o">{</span>
              <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readStringRequireUtf8</span><span class="o">();</span>

              <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">default</span><span class="o">:</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">parseUnknownField</span><span class="o">(</span>
                  <span class="n">input</span><span class="o">,</span> <span class="n">unknownFields</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">,</span> <span class="n">tag</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="o">}</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span><span class="o">(</span>
            <span class="n">e</span><span class="o">).</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span> <span class="o">=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">makeExtensionsImmutable</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
        <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
        <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">internal_static_Student_fieldAccessorTable</span>
          <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
              <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ID_FIELD_NUMBER</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id_</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * 会在StudentPOJO外部类中生成一个内部类Student，它时真正发送的POJO对象
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;int32 id = 1;&lt;/code&gt;
</span><span class="cm">     * @return The id.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">id_</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NAME_FIELD_NUMBER</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">     * @return The name.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span> 
            <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">     * @return The bytes for name.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
        <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span> 
            <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
                <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">byte</span> <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">byte</span> <span class="n">isInitialized</span> <span class="o">=</span> <span class="n">memoizedIsInitialized</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="n">1</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

      <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeTo</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span> <span class="n">output</span><span class="o">)</span>
                        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">id_</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeInt32</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">id_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">unknownFields</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSerializedSize</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">memoizedSize</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="k">return</span> <span class="n">size</span><span class="o">;</span>

      <span class="n">size</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">id_</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeInt32Size</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">id_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">computeStringSize</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">size</span> <span class="o">+=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">getSerializedSize</span><span class="o">();</span>
      <span class="n">memoizedSize</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">getId</span><span class="o">()</span>
          <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getName</span><span class="o">()</span>
          <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">unknownFields</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">memoizedHashCode</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">memoizedHashCode</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">41</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">19</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getDescriptor</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">ID_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getId</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">NAME_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getName</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">29</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">memoizedHashCode</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">newBuilderForType</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">newBuilder</span><span class="o">();</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Builder</span> <span class="nf">newBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Builder</span> <span class="nf">newBuilder</span><span class="o">(</span><span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">prototype</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">prototype</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">toBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="n">DEFAULT_INSTANCE</span>
          <span class="o">?</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">protected</span> <span class="n">Builder</span> <span class="nf">newBuilderForType</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">builder</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * protobuf使用message管理数据
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * Protobuf type {@code Student}
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="kd">extends</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="n">Builder</span><span class="o">&gt;</span> <span class="kd">implements</span>
        <span class="c1">// @@protoc_insertion_point(builder_implements:Student)
</span><span class="c1"></span>        <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">StudentOrBuilder</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
          <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
          <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">internal_static_Student_fieldAccessorTable</span>
            <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
                <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// Construct using StudentPOJO.Student.newBuilder()
</span><span class="c1"></span>      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="kd">private</span> <span class="kt">void</span> <span class="nf">maybeForceBuilderInitialization</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
                <span class="o">.</span><span class="na">alwaysUseFieldBuilders</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
          <span class="nf">getDescriptorForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">result</span> <span class="o">=</span> <span class="n">buildPartial</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">result</span><span class="o">.</span><span class="na">isInitialized</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="n">newUninitializedMessageException</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">buildPartial</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">id_</span> <span class="o">=</span> <span class="n">id_</span><span class="o">;</span>
        <span class="n">result</span><span class="o">.</span><span class="na">name_</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="n">onBuilt</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearField</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearOneof</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">OneofDescriptor</span> <span class="n">oneof</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearOneof</span><span class="o">(</span><span class="n">oneof</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setRepeatedField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">addRepeatedField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">addRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Message</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">mergeFrom</span><span class="o">((</span><span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span><span class="n">other</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">other</span><span class="o">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="o">==</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">setId</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="na">name_</span><span class="o">;</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">);</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
          <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">parsedMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parsePartialFrom</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="o">(</span><span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">e</span><span class="o">.</span><span class="na">getUnfinishedMessage</span><span class="o">();</span>
          <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">unwrapIOException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">parsedMessage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mergeFrom</span><span class="o">(</span><span class="n">parsedMessage</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kt">int</span> <span class="n">id_</span> <span class="o">;</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * 会在StudentPOJO外部类中生成一个内部类Student，它时真正发送的POJO对象
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
</span><span class="cm">       * @return The id.
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * 会在StudentPOJO外部类中生成一个内部类Student，它时真正发送的POJO对象
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
</span><span class="cm">       * @param value The id to set.
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="n">id_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * 会在StudentPOJO外部类中生成一个内部类Student，它时真正发送的POJO对象
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearId</span><span class="o">()</span> <span class="o">{</span>
        
        <span class="n">id_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">       * @return The name.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span>
              <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">       * @return The bytes for name.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
          <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span> 
              <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
                  <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">       * @param value The name to set.
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setName</span><span class="o">(</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
  <span class="o">}</span>
  
        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearName</span><span class="o">()</span> <span class="o">{</span>
        
        <span class="n">name_</span> <span class="o">=</span> <span class="n">getDefaultInstance</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">       * @param value The bytes for name to set.
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setNameBytes</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="n">checkByteStringIsUtf8</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        
        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="n">Builder</span> <span class="nf">setUnknownFields</span><span class="o">(</span>
          <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="n">Builder</span> <span class="nf">mergeUnknownFields</span><span class="o">(</span>
          <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>


      <span class="c1">// @@protoc_insertion_point(builder_scope:Student)
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="c1">// @@protoc_insertion_point(class_scope:Student)
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="kd">static</span> <span class="o">{</span>
      <span class="n">DEFAULT_INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstance</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span>
        <span class="n">PARSER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">AbstractParser</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Student</span> <span class="nf">parsePartialFrom</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
          <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Student</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="nf">parser</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="nf">getParserForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="n">internal_static_Student_descriptor</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> 
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
      <span class="n">internal_static_Student_fieldAccessorTable</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
      <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">descriptor</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span>  <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
      <span class="n">descriptor</span><span class="o">;</span>
  <span class="kd">static</span> <span class="o">{</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]</span> <span class="n">descriptorData</span> <span class="o">=</span> <span class="o">{</span>
      <span class="s">&#34;\n\rStudent.proto\&#34;#\n\007Student\022\n\n\002id\030\001 \001(\005\022\014&#34;</span> <span class="o">+</span>
      <span class="s">&#34;\n\004name\030\002 \001(\tB\rB\013StudentPOJOb\006proto3&#34;</span>
    <span class="o">};</span>
    <span class="n">descriptor</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
      <span class="o">.</span><span class="na">internalBuildGeneratedFileFrom</span><span class="o">(</span><span class="n">descriptorData</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span><span class="o">[]</span> <span class="o">{</span>
        <span class="o">});</span>
    <span class="n">internal_static_Student_descriptor</span> <span class="o">=</span>
      <span class="n">getDescriptor</span><span class="o">().</span><span class="na">getMessageTypes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="n">internal_static_Student_fieldAccessorTable</span> <span class="o">=</span> <span class="k">new</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span><span class="o">(</span>
        <span class="n">internal_static_Student_descriptor</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">&#34;Id&#34;</span><span class="o">,</span> <span class="s">&#34;Name&#34;</span><span class="o">,</span> <span class="o">});</span>
  <span class="o">}</span>

  <span class="c1">// @@protoc_insertion_point(outer_class_scope)
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务器端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.codec</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.protobuf.ProtobufDecoder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="cm">/*
</span><span class="cm">       * 说明
</span><span class="cm">       * 1.创建两个线程组 bossGroup 和 workerGroup
</span><span class="cm">       * 2.bossGroup 只是处理连接请求，真正的和客户端业务处理，会交给 workerGroup 完成
</span><span class="cm">       * 3.两个线程组都是无线循环
</span><span class="cm">       */</span>
      <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>
      <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span> <span class="o">{</span>
          <span class="c1">// 创建服务器的启动对象，配置参数
</span><span class="c1"></span>          <span class="n">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>

          <span class="c1">// 使用链式编程来进行设置
</span><span class="c1"></span>          <span class="n">bootstrap</span>
              <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span> <span class="c1">// 设置两个线程组
</span><span class="c1"></span>              <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 使用NioServerSocketChannel作为服务器的通道实现类型
</span><span class="c1"></span>              <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="n">128</span><span class="o">)</span> <span class="c1">// 设置线程队列等待连接个数
</span><span class="c1"></span>              <span class="o">.</span><span class="na">childOption</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_KEEPALIVE</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// 设置保持活动连接状态
</span><span class="c1"></span>              <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span>
                  <span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span> <span class="c1">// 创建一个通道初始化对象(匿名对象)
</span><span class="c1"></span>                    <span class="c1">// 向workerGroup中EventLoop所关联的通道对应的pipeline设置处理器
</span><span class="c1"></span>                    <span class="nd">@Override</span>
                    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                        <span class="c1">// 在pipeline中加入ProtoBufDecoder
</span><span class="c1"></span>                        <span class="c1">// 指定对哪种对象进行解码
</span><span class="c1"></span>                        <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;decoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">ProtobufDecoder</span><span class="o">(</span><span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">()));</span>

                        <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">NettyServerHandler</span><span class="o">());</span>
                        <span class="c1">// 可以使用一个集合管理SocketChannel，在推送消息时，可以将业务加到各个Channel对应的NIOEventLoop的taskQueue 或者 scheduleTaskQueue
</span><span class="c1"></span>                        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户SocketChannel hashcode=&#34;</span> <span class="o">+</span> <span class="n">ch</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
                    <span class="o">}</span>
                  <span class="o">});</span> <span class="c1">// 给我们的workerGroup的 EventLoop对应的管道设置处理器
</span><span class="c1"></span>
          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器 is ready&#34;</span><span class="o">);</span>

          <span class="cm">/*
</span><span class="cm">           * ChannelFuture 在Netty中的所有的I/O操作都是异步执行的，这就意味着任何一个I/O操作会立刻返回，不保证在调用结束的时候操作会执行完成。因此，会返回一个ChannelFuture的实例，通过这个实例可以获取当前I/O操作的状态。
</span><span class="cm">           */</span>

          <span class="c1">// 绑定一个端口，并且同步，生成了一个ChannelFuture 对象
</span><span class="c1"></span>          <span class="c1">// 启动服务器(并绑定端口)
</span><span class="c1"></span>          <span class="c1">// 为什么使用同步？因为Netty是基于异步操作的，如果不使用同步，可能服务器还未启动就执行下面的语句了，就会产生异常
</span><span class="c1"></span>          <span class="n">ChannelFuture</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">6668</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

          <span class="c1">// 给cf注册监听器，监控我们关心的事件
</span><span class="c1"></span>          <span class="n">cf</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
              <span class="nd">@Override</span>
              <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                  <span class="k">if</span><span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">()){</span>
                      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;监听端口 6668成功&#34;</span><span class="o">);</span>
                  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;监听端口 6668失败&#34;</span><span class="o">);</span>
                  <span class="o">}</span>
              <span class="o">}</span>
          <span class="o">});</span>

          <span class="c1">// 对关闭通道进行监听(只有当你有一个关闭通道这样的事件发生时，才会去进行处理)
</span><span class="c1"></span>          <span class="c1">// 这里为什么也需要使用同步？因为不适用同步，他就会跳过这个语句直接执行finally中的语句关闭线程组了
</span><span class="c1"></span>          <span class="n">cf</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
          <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
          <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务器端handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.codec</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="cm">/*
</span><span class="cm"> * 说明
</span><span class="cm"> * 1.我们自定义一个Handler需要继承netty规定好的某个HandlerAdapter(规范)
</span><span class="cm"> * 2.这时我们自定义一个Handler，才能称之为一个handler
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServerHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
    <span class="cm">/*
</span><span class="cm">     * 读取数据(这里我们可以读取客户端发送的数据)
</span><span class="cm">     * 1.ChannelHandlerContext ctx：上下文对象，含有管道pipeline(业务逻辑处理)，通道channel(数据读写处理)，地址
</span><span class="cm">     * 2.Object msg：就是客户端发送的数据，默认是Object类型
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 读取客户端发送的StudentPOJO.Student
</span><span class="c1"></span>        <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="o">(</span><span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>

    	<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端发送的数据 id =&#34;</span> <span class="o">+</span> <span class="n">student</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;名字=&#34;</span> <span class="o">+</span> <span class="n">student</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="c1">// 数据读取完毕返回给客户端的消息
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// writeAndFlush 是 write方法 + flush方法
</span><span class="c1"></span>        <span class="c1">// 将数据写入到缓冲区，并刷新
</span><span class="c1"></span>        <span class="c1">// 一般讲，我们对这个发送的数据需要进行编码
</span><span class="c1"></span>        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">&#34;hello,客户端1&#34;</span><span class="o">,</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// 当出现异常时，一般是需要关闭通道
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.codec</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.protobuf.ProtobufEncoder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="c1">// 客户端需要一个事件循环组
</span><span class="c1"></span>      <span class="n">EventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span> <span class="o">{</span>
          <span class="c1">// 创建一个客户端启动对象
</span><span class="c1"></span>          <span class="c1">// 注意客户端使用的不是ServerBootstrap，而是Bootstrap
</span><span class="c1"></span>          <span class="n">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>

          <span class="c1">// 设置相关参数,链式编程
</span><span class="c1"></span>          <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span> <span class="c1">// 设置线程组
</span><span class="c1"></span>                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 设置客户端通道的实现类型(将来使用反射处理)
</span><span class="c1"></span>                  <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                      <span class="nd">@Override</span>
                      <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                          <span class="c1">// 在pipeline中加入我们的编码器ProtoBufEncoder
</span><span class="c1"></span>                          <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;encoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">ProtobufEncoder</span><span class="o">());</span>

                          <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">NettyClientHandler</span><span class="o">());</span><span class="c1">// 加入自己的处理器
</span><span class="c1"></span>                      <span class="o">}</span>
                  <span class="o">});</span>
          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端 is ok&#34;</span><span class="o">);</span>

          <span class="c1">// 启动客户端去连接服务器端
</span><span class="c1"></span>          <span class="c1">// 关于 ChannelFuture 后面要分析，涉及到Netty的异步模型
</span><span class="c1"></span>          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span> <span class="n">6668</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

          <span class="c1">// 给关闭通道进行监听(sync是让其为非阻塞？？？？？？)
</span><span class="c1"></span>          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
      <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
          <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.codec</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClientHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
    <span class="c1">// 当通道就绪时，就会触发该方法
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 发送一个Student对象到服务器
</span><span class="c1"></span>        <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="n">StudentPOJO</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setId</span><span class="o">(</span><span class="n">4</span><span class="o">).</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;林冲&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>

        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">student</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 当通道有读取事件时，会触发
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;输出服务器回复的消息：&#34;</span> <span class="o">+</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器端的地址：&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="75protobuf快速入门实例2">7.5、Protobuf快速入门实例2</h2>
<p>编写程序，使用Protobuf完成如下功能</p>
<ol>
<li>客户端可以随机发送Student  PoJo/ Worker PoJo 对象到服务器 (通过 Protobuf 编码)</li>
<li>服务端能接收Student PoJo/ Worker PoJo 对象(需要判断是哪种类型)，并显示信息(通过 Protobuf 解码)</li>
</ol>
<p><strong>ProtoBuf：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="n">syntax</span> <span class="o">=</span> <span class="s">&#34;proto3&#34;</span><span class="o">;</span>
<span class="n">option</span> <span class="n">optimize_for</span> <span class="o">=</span> <span class="n">SPEED</span><span class="o">;</span>  <span class="c1">// 加快解析
</span><span class="c1"></span><span class="n">option</span> <span class="n">java_package</span> <span class="o">=</span> <span class="s">&#34;com.clover.netty.codec2&#34;</span><span class="o">;</span><span class="c1">// 指定生成到哪个包下
</span><span class="c1"></span><span class="n">option</span> <span class="n">java_outer_classname</span> <span class="o">=</span> <span class="s">&#34;MyDataInfo&#34;</span><span class="o">;</span> <span class="c1">// 指定外部类名称
</span><span class="c1"></span>
<span class="c1">// protobuf 可以使用message管理其它的message
</span><span class="c1"></span><span class="n">message</span> <span class="n">MyMessage</span><span class="o">{</span>
  <span class="c1">// 定义一个枚举类型
</span><span class="c1"></span>  <span class="kd">enum</span> <span class="n">DateType</span> <span class="o">{</span>
    <span class="n">StudentType</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span><span class="c1">// 在proto3中，要求enmu下属性的编号从0开始
</span><span class="c1"></span>    <span class="n">WorkerType</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="c1">// 用data_type来标识传的是哪一个枚举类型
</span><span class="c1"></span>  <span class="n">DateType</span> <span class="n">data_type</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>

  <span class="c1">// 表示每次枚举类型最多只能出现Student、Worker中的一个，节省空间
</span><span class="c1"></span>  <span class="n">oneof</span> <span class="n">dataBody</span> <span class="o">{</span>
    <span class="n">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
    <span class="n">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="n">message</span> <span class="n">Student</span><span class="o">{</span>
  <span class="n">int32</span> <span class="n">id</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span><span class="c1">// Student类的属性
</span><span class="c1"></span>  <span class="n">string</span> <span class="n">name</span> <span class="o">=</span><span class="n">2</span><span class="o">;</span><span class="c1">// Student类的属性
</span><span class="c1"></span><span class="o">}</span>

<span class="n">message</span> <span class="n">Worker</span><span class="o">{</span>
  <span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
  <span class="n">int32</span> <span class="n">age</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>ProtoBuf生成的xxx.java：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">   1
</span><span class="lnt">   2
</span><span class="lnt">   3
</span><span class="lnt">   4
</span><span class="lnt">   5
</span><span class="lnt">   6
</span><span class="lnt">   7
</span><span class="lnt">   8
</span><span class="lnt">   9
</span><span class="lnt">  10
</span><span class="lnt">  11
</span><span class="lnt">  12
</span><span class="lnt">  13
</span><span class="lnt">  14
</span><span class="lnt">  15
</span><span class="lnt">  16
</span><span class="lnt">  17
</span><span class="lnt">  18
</span><span class="lnt">  19
</span><span class="lnt">  20
</span><span class="lnt">  21
</span><span class="lnt">  22
</span><span class="lnt">  23
</span><span class="lnt">  24
</span><span class="lnt">  25
</span><span class="lnt">  26
</span><span class="lnt">  27
</span><span class="lnt">  28
</span><span class="lnt">  29
</span><span class="lnt">  30
</span><span class="lnt">  31
</span><span class="lnt">  32
</span><span class="lnt">  33
</span><span class="lnt">  34
</span><span class="lnt">  35
</span><span class="lnt">  36
</span><span class="lnt">  37
</span><span class="lnt">  38
</span><span class="lnt">  39
</span><span class="lnt">  40
</span><span class="lnt">  41
</span><span class="lnt">  42
</span><span class="lnt">  43
</span><span class="lnt">  44
</span><span class="lnt">  45
</span><span class="lnt">  46
</span><span class="lnt">  47
</span><span class="lnt">  48
</span><span class="lnt">  49
</span><span class="lnt">  50
</span><span class="lnt">  51
</span><span class="lnt">  52
</span><span class="lnt">  53
</span><span class="lnt">  54
</span><span class="lnt">  55
</span><span class="lnt">  56
</span><span class="lnt">  57
</span><span class="lnt">  58
</span><span class="lnt">  59
</span><span class="lnt">  60
</span><span class="lnt">  61
</span><span class="lnt">  62
</span><span class="lnt">  63
</span><span class="lnt">  64
</span><span class="lnt">  65
</span><span class="lnt">  66
</span><span class="lnt">  67
</span><span class="lnt">  68
</span><span class="lnt">  69
</span><span class="lnt">  70
</span><span class="lnt">  71
</span><span class="lnt">  72
</span><span class="lnt">  73
</span><span class="lnt">  74
</span><span class="lnt">  75
</span><span class="lnt">  76
</span><span class="lnt">  77
</span><span class="lnt">  78
</span><span class="lnt">  79
</span><span class="lnt">  80
</span><span class="lnt">  81
</span><span class="lnt">  82
</span><span class="lnt">  83
</span><span class="lnt">  84
</span><span class="lnt">  85
</span><span class="lnt">  86
</span><span class="lnt">  87
</span><span class="lnt">  88
</span><span class="lnt">  89
</span><span class="lnt">  90
</span><span class="lnt">  91
</span><span class="lnt">  92
</span><span class="lnt">  93
</span><span class="lnt">  94
</span><span class="lnt">  95
</span><span class="lnt">  96
</span><span class="lnt">  97
</span><span class="lnt">  98
</span><span class="lnt">  99
</span><span class="lnt"> 100
</span><span class="lnt"> 101
</span><span class="lnt"> 102
</span><span class="lnt"> 103
</span><span class="lnt"> 104
</span><span class="lnt"> 105
</span><span class="lnt"> 106
</span><span class="lnt"> 107
</span><span class="lnt"> 108
</span><span class="lnt"> 109
</span><span class="lnt"> 110
</span><span class="lnt"> 111
</span><span class="lnt"> 112
</span><span class="lnt"> 113
</span><span class="lnt"> 114
</span><span class="lnt"> 115
</span><span class="lnt"> 116
</span><span class="lnt"> 117
</span><span class="lnt"> 118
</span><span class="lnt"> 119
</span><span class="lnt"> 120
</span><span class="lnt"> 121
</span><span class="lnt"> 122
</span><span class="lnt"> 123
</span><span class="lnt"> 124
</span><span class="lnt"> 125
</span><span class="lnt"> 126
</span><span class="lnt"> 127
</span><span class="lnt"> 128
</span><span class="lnt"> 129
</span><span class="lnt"> 130
</span><span class="lnt"> 131
</span><span class="lnt"> 132
</span><span class="lnt"> 133
</span><span class="lnt"> 134
</span><span class="lnt"> 135
</span><span class="lnt"> 136
</span><span class="lnt"> 137
</span><span class="lnt"> 138
</span><span class="lnt"> 139
</span><span class="lnt"> 140
</span><span class="lnt"> 141
</span><span class="lnt"> 142
</span><span class="lnt"> 143
</span><span class="lnt"> 144
</span><span class="lnt"> 145
</span><span class="lnt"> 146
</span><span class="lnt"> 147
</span><span class="lnt"> 148
</span><span class="lnt"> 149
</span><span class="lnt"> 150
</span><span class="lnt"> 151
</span><span class="lnt"> 152
</span><span class="lnt"> 153
</span><span class="lnt"> 154
</span><span class="lnt"> 155
</span><span class="lnt"> 156
</span><span class="lnt"> 157
</span><span class="lnt"> 158
</span><span class="lnt"> 159
</span><span class="lnt"> 160
</span><span class="lnt"> 161
</span><span class="lnt"> 162
</span><span class="lnt"> 163
</span><span class="lnt"> 164
</span><span class="lnt"> 165
</span><span class="lnt"> 166
</span><span class="lnt"> 167
</span><span class="lnt"> 168
</span><span class="lnt"> 169
</span><span class="lnt"> 170
</span><span class="lnt"> 171
</span><span class="lnt"> 172
</span><span class="lnt"> 173
</span><span class="lnt"> 174
</span><span class="lnt"> 175
</span><span class="lnt"> 176
</span><span class="lnt"> 177
</span><span class="lnt"> 178
</span><span class="lnt"> 179
</span><span class="lnt"> 180
</span><span class="lnt"> 181
</span><span class="lnt"> 182
</span><span class="lnt"> 183
</span><span class="lnt"> 184
</span><span class="lnt"> 185
</span><span class="lnt"> 186
</span><span class="lnt"> 187
</span><span class="lnt"> 188
</span><span class="lnt"> 189
</span><span class="lnt"> 190
</span><span class="lnt"> 191
</span><span class="lnt"> 192
</span><span class="lnt"> 193
</span><span class="lnt"> 194
</span><span class="lnt"> 195
</span><span class="lnt"> 196
</span><span class="lnt"> 197
</span><span class="lnt"> 198
</span><span class="lnt"> 199
</span><span class="lnt"> 200
</span><span class="lnt"> 201
</span><span class="lnt"> 202
</span><span class="lnt"> 203
</span><span class="lnt"> 204
</span><span class="lnt"> 205
</span><span class="lnt"> 206
</span><span class="lnt"> 207
</span><span class="lnt"> 208
</span><span class="lnt"> 209
</span><span class="lnt"> 210
</span><span class="lnt"> 211
</span><span class="lnt"> 212
</span><span class="lnt"> 213
</span><span class="lnt"> 214
</span><span class="lnt"> 215
</span><span class="lnt"> 216
</span><span class="lnt"> 217
</span><span class="lnt"> 218
</span><span class="lnt"> 219
</span><span class="lnt"> 220
</span><span class="lnt"> 221
</span><span class="lnt"> 222
</span><span class="lnt"> 223
</span><span class="lnt"> 224
</span><span class="lnt"> 225
</span><span class="lnt"> 226
</span><span class="lnt"> 227
</span><span class="lnt"> 228
</span><span class="lnt"> 229
</span><span class="lnt"> 230
</span><span class="lnt"> 231
</span><span class="lnt"> 232
</span><span class="lnt"> 233
</span><span class="lnt"> 234
</span><span class="lnt"> 235
</span><span class="lnt"> 236
</span><span class="lnt"> 237
</span><span class="lnt"> 238
</span><span class="lnt"> 239
</span><span class="lnt"> 240
</span><span class="lnt"> 241
</span><span class="lnt"> 242
</span><span class="lnt"> 243
</span><span class="lnt"> 244
</span><span class="lnt"> 245
</span><span class="lnt"> 246
</span><span class="lnt"> 247
</span><span class="lnt"> 248
</span><span class="lnt"> 249
</span><span class="lnt"> 250
</span><span class="lnt"> 251
</span><span class="lnt"> 252
</span><span class="lnt"> 253
</span><span class="lnt"> 254
</span><span class="lnt"> 255
</span><span class="lnt"> 256
</span><span class="lnt"> 257
</span><span class="lnt"> 258
</span><span class="lnt"> 259
</span><span class="lnt"> 260
</span><span class="lnt"> 261
</span><span class="lnt"> 262
</span><span class="lnt"> 263
</span><span class="lnt"> 264
</span><span class="lnt"> 265
</span><span class="lnt"> 266
</span><span class="lnt"> 267
</span><span class="lnt"> 268
</span><span class="lnt"> 269
</span><span class="lnt"> 270
</span><span class="lnt"> 271
</span><span class="lnt"> 272
</span><span class="lnt"> 273
</span><span class="lnt"> 274
</span><span class="lnt"> 275
</span><span class="lnt"> 276
</span><span class="lnt"> 277
</span><span class="lnt"> 278
</span><span class="lnt"> 279
</span><span class="lnt"> 280
</span><span class="lnt"> 281
</span><span class="lnt"> 282
</span><span class="lnt"> 283
</span><span class="lnt"> 284
</span><span class="lnt"> 285
</span><span class="lnt"> 286
</span><span class="lnt"> 287
</span><span class="lnt"> 288
</span><span class="lnt"> 289
</span><span class="lnt"> 290
</span><span class="lnt"> 291
</span><span class="lnt"> 292
</span><span class="lnt"> 293
</span><span class="lnt"> 294
</span><span class="lnt"> 295
</span><span class="lnt"> 296
</span><span class="lnt"> 297
</span><span class="lnt"> 298
</span><span class="lnt"> 299
</span><span class="lnt"> 300
</span><span class="lnt"> 301
</span><span class="lnt"> 302
</span><span class="lnt"> 303
</span><span class="lnt"> 304
</span><span class="lnt"> 305
</span><span class="lnt"> 306
</span><span class="lnt"> 307
</span><span class="lnt"> 308
</span><span class="lnt"> 309
</span><span class="lnt"> 310
</span><span class="lnt"> 311
</span><span class="lnt"> 312
</span><span class="lnt"> 313
</span><span class="lnt"> 314
</span><span class="lnt"> 315
</span><span class="lnt"> 316
</span><span class="lnt"> 317
</span><span class="lnt"> 318
</span><span class="lnt"> 319
</span><span class="lnt"> 320
</span><span class="lnt"> 321
</span><span class="lnt"> 322
</span><span class="lnt"> 323
</span><span class="lnt"> 324
</span><span class="lnt"> 325
</span><span class="lnt"> 326
</span><span class="lnt"> 327
</span><span class="lnt"> 328
</span><span class="lnt"> 329
</span><span class="lnt"> 330
</span><span class="lnt"> 331
</span><span class="lnt"> 332
</span><span class="lnt"> 333
</span><span class="lnt"> 334
</span><span class="lnt"> 335
</span><span class="lnt"> 336
</span><span class="lnt"> 337
</span><span class="lnt"> 338
</span><span class="lnt"> 339
</span><span class="lnt"> 340
</span><span class="lnt"> 341
</span><span class="lnt"> 342
</span><span class="lnt"> 343
</span><span class="lnt"> 344
</span><span class="lnt"> 345
</span><span class="lnt"> 346
</span><span class="lnt"> 347
</span><span class="lnt"> 348
</span><span class="lnt"> 349
</span><span class="lnt"> 350
</span><span class="lnt"> 351
</span><span class="lnt"> 352
</span><span class="lnt"> 353
</span><span class="lnt"> 354
</span><span class="lnt"> 355
</span><span class="lnt"> 356
</span><span class="lnt"> 357
</span><span class="lnt"> 358
</span><span class="lnt"> 359
</span><span class="lnt"> 360
</span><span class="lnt"> 361
</span><span class="lnt"> 362
</span><span class="lnt"> 363
</span><span class="lnt"> 364
</span><span class="lnt"> 365
</span><span class="lnt"> 366
</span><span class="lnt"> 367
</span><span class="lnt"> 368
</span><span class="lnt"> 369
</span><span class="lnt"> 370
</span><span class="lnt"> 371
</span><span class="lnt"> 372
</span><span class="lnt"> 373
</span><span class="lnt"> 374
</span><span class="lnt"> 375
</span><span class="lnt"> 376
</span><span class="lnt"> 377
</span><span class="lnt"> 378
</span><span class="lnt"> 379
</span><span class="lnt"> 380
</span><span class="lnt"> 381
</span><span class="lnt"> 382
</span><span class="lnt"> 383
</span><span class="lnt"> 384
</span><span class="lnt"> 385
</span><span class="lnt"> 386
</span><span class="lnt"> 387
</span><span class="lnt"> 388
</span><span class="lnt"> 389
</span><span class="lnt"> 390
</span><span class="lnt"> 391
</span><span class="lnt"> 392
</span><span class="lnt"> 393
</span><span class="lnt"> 394
</span><span class="lnt"> 395
</span><span class="lnt"> 396
</span><span class="lnt"> 397
</span><span class="lnt"> 398
</span><span class="lnt"> 399
</span><span class="lnt"> 400
</span><span class="lnt"> 401
</span><span class="lnt"> 402
</span><span class="lnt"> 403
</span><span class="lnt"> 404
</span><span class="lnt"> 405
</span><span class="lnt"> 406
</span><span class="lnt"> 407
</span><span class="lnt"> 408
</span><span class="lnt"> 409
</span><span class="lnt"> 410
</span><span class="lnt"> 411
</span><span class="lnt"> 412
</span><span class="lnt"> 413
</span><span class="lnt"> 414
</span><span class="lnt"> 415
</span><span class="lnt"> 416
</span><span class="lnt"> 417
</span><span class="lnt"> 418
</span><span class="lnt"> 419
</span><span class="lnt"> 420
</span><span class="lnt"> 421
</span><span class="lnt"> 422
</span><span class="lnt"> 423
</span><span class="lnt"> 424
</span><span class="lnt"> 425
</span><span class="lnt"> 426
</span><span class="lnt"> 427
</span><span class="lnt"> 428
</span><span class="lnt"> 429
</span><span class="lnt"> 430
</span><span class="lnt"> 431
</span><span class="lnt"> 432
</span><span class="lnt"> 433
</span><span class="lnt"> 434
</span><span class="lnt"> 435
</span><span class="lnt"> 436
</span><span class="lnt"> 437
</span><span class="lnt"> 438
</span><span class="lnt"> 439
</span><span class="lnt"> 440
</span><span class="lnt"> 441
</span><span class="lnt"> 442
</span><span class="lnt"> 443
</span><span class="lnt"> 444
</span><span class="lnt"> 445
</span><span class="lnt"> 446
</span><span class="lnt"> 447
</span><span class="lnt"> 448
</span><span class="lnt"> 449
</span><span class="lnt"> 450
</span><span class="lnt"> 451
</span><span class="lnt"> 452
</span><span class="lnt"> 453
</span><span class="lnt"> 454
</span><span class="lnt"> 455
</span><span class="lnt"> 456
</span><span class="lnt"> 457
</span><span class="lnt"> 458
</span><span class="lnt"> 459
</span><span class="lnt"> 460
</span><span class="lnt"> 461
</span><span class="lnt"> 462
</span><span class="lnt"> 463
</span><span class="lnt"> 464
</span><span class="lnt"> 465
</span><span class="lnt"> 466
</span><span class="lnt"> 467
</span><span class="lnt"> 468
</span><span class="lnt"> 469
</span><span class="lnt"> 470
</span><span class="lnt"> 471
</span><span class="lnt"> 472
</span><span class="lnt"> 473
</span><span class="lnt"> 474
</span><span class="lnt"> 475
</span><span class="lnt"> 476
</span><span class="lnt"> 477
</span><span class="lnt"> 478
</span><span class="lnt"> 479
</span><span class="lnt"> 480
</span><span class="lnt"> 481
</span><span class="lnt"> 482
</span><span class="lnt"> 483
</span><span class="lnt"> 484
</span><span class="lnt"> 485
</span><span class="lnt"> 486
</span><span class="lnt"> 487
</span><span class="lnt"> 488
</span><span class="lnt"> 489
</span><span class="lnt"> 490
</span><span class="lnt"> 491
</span><span class="lnt"> 492
</span><span class="lnt"> 493
</span><span class="lnt"> 494
</span><span class="lnt"> 495
</span><span class="lnt"> 496
</span><span class="lnt"> 497
</span><span class="lnt"> 498
</span><span class="lnt"> 499
</span><span class="lnt"> 500
</span><span class="lnt"> 501
</span><span class="lnt"> 502
</span><span class="lnt"> 503
</span><span class="lnt"> 504
</span><span class="lnt"> 505
</span><span class="lnt"> 506
</span><span class="lnt"> 507
</span><span class="lnt"> 508
</span><span class="lnt"> 509
</span><span class="lnt"> 510
</span><span class="lnt"> 511
</span><span class="lnt"> 512
</span><span class="lnt"> 513
</span><span class="lnt"> 514
</span><span class="lnt"> 515
</span><span class="lnt"> 516
</span><span class="lnt"> 517
</span><span class="lnt"> 518
</span><span class="lnt"> 519
</span><span class="lnt"> 520
</span><span class="lnt"> 521
</span><span class="lnt"> 522
</span><span class="lnt"> 523
</span><span class="lnt"> 524
</span><span class="lnt"> 525
</span><span class="lnt"> 526
</span><span class="lnt"> 527
</span><span class="lnt"> 528
</span><span class="lnt"> 529
</span><span class="lnt"> 530
</span><span class="lnt"> 531
</span><span class="lnt"> 532
</span><span class="lnt"> 533
</span><span class="lnt"> 534
</span><span class="lnt"> 535
</span><span class="lnt"> 536
</span><span class="lnt"> 537
</span><span class="lnt"> 538
</span><span class="lnt"> 539
</span><span class="lnt"> 540
</span><span class="lnt"> 541
</span><span class="lnt"> 542
</span><span class="lnt"> 543
</span><span class="lnt"> 544
</span><span class="lnt"> 545
</span><span class="lnt"> 546
</span><span class="lnt"> 547
</span><span class="lnt"> 548
</span><span class="lnt"> 549
</span><span class="lnt"> 550
</span><span class="lnt"> 551
</span><span class="lnt"> 552
</span><span class="lnt"> 553
</span><span class="lnt"> 554
</span><span class="lnt"> 555
</span><span class="lnt"> 556
</span><span class="lnt"> 557
</span><span class="lnt"> 558
</span><span class="lnt"> 559
</span><span class="lnt"> 560
</span><span class="lnt"> 561
</span><span class="lnt"> 562
</span><span class="lnt"> 563
</span><span class="lnt"> 564
</span><span class="lnt"> 565
</span><span class="lnt"> 566
</span><span class="lnt"> 567
</span><span class="lnt"> 568
</span><span class="lnt"> 569
</span><span class="lnt"> 570
</span><span class="lnt"> 571
</span><span class="lnt"> 572
</span><span class="lnt"> 573
</span><span class="lnt"> 574
</span><span class="lnt"> 575
</span><span class="lnt"> 576
</span><span class="lnt"> 577
</span><span class="lnt"> 578
</span><span class="lnt"> 579
</span><span class="lnt"> 580
</span><span class="lnt"> 581
</span><span class="lnt"> 582
</span><span class="lnt"> 583
</span><span class="lnt"> 584
</span><span class="lnt"> 585
</span><span class="lnt"> 586
</span><span class="lnt"> 587
</span><span class="lnt"> 588
</span><span class="lnt"> 589
</span><span class="lnt"> 590
</span><span class="lnt"> 591
</span><span class="lnt"> 592
</span><span class="lnt"> 593
</span><span class="lnt"> 594
</span><span class="lnt"> 595
</span><span class="lnt"> 596
</span><span class="lnt"> 597
</span><span class="lnt"> 598
</span><span class="lnt"> 599
</span><span class="lnt"> 600
</span><span class="lnt"> 601
</span><span class="lnt"> 602
</span><span class="lnt"> 603
</span><span class="lnt"> 604
</span><span class="lnt"> 605
</span><span class="lnt"> 606
</span><span class="lnt"> 607
</span><span class="lnt"> 608
</span><span class="lnt"> 609
</span><span class="lnt"> 610
</span><span class="lnt"> 611
</span><span class="lnt"> 612
</span><span class="lnt"> 613
</span><span class="lnt"> 614
</span><span class="lnt"> 615
</span><span class="lnt"> 616
</span><span class="lnt"> 617
</span><span class="lnt"> 618
</span><span class="lnt"> 619
</span><span class="lnt"> 620
</span><span class="lnt"> 621
</span><span class="lnt"> 622
</span><span class="lnt"> 623
</span><span class="lnt"> 624
</span><span class="lnt"> 625
</span><span class="lnt"> 626
</span><span class="lnt"> 627
</span><span class="lnt"> 628
</span><span class="lnt"> 629
</span><span class="lnt"> 630
</span><span class="lnt"> 631
</span><span class="lnt"> 632
</span><span class="lnt"> 633
</span><span class="lnt"> 634
</span><span class="lnt"> 635
</span><span class="lnt"> 636
</span><span class="lnt"> 637
</span><span class="lnt"> 638
</span><span class="lnt"> 639
</span><span class="lnt"> 640
</span><span class="lnt"> 641
</span><span class="lnt"> 642
</span><span class="lnt"> 643
</span><span class="lnt"> 644
</span><span class="lnt"> 645
</span><span class="lnt"> 646
</span><span class="lnt"> 647
</span><span class="lnt"> 648
</span><span class="lnt"> 649
</span><span class="lnt"> 650
</span><span class="lnt"> 651
</span><span class="lnt"> 652
</span><span class="lnt"> 653
</span><span class="lnt"> 654
</span><span class="lnt"> 655
</span><span class="lnt"> 656
</span><span class="lnt"> 657
</span><span class="lnt"> 658
</span><span class="lnt"> 659
</span><span class="lnt"> 660
</span><span class="lnt"> 661
</span><span class="lnt"> 662
</span><span class="lnt"> 663
</span><span class="lnt"> 664
</span><span class="lnt"> 665
</span><span class="lnt"> 666
</span><span class="lnt"> 667
</span><span class="lnt"> 668
</span><span class="lnt"> 669
</span><span class="lnt"> 670
</span><span class="lnt"> 671
</span><span class="lnt"> 672
</span><span class="lnt"> 673
</span><span class="lnt"> 674
</span><span class="lnt"> 675
</span><span class="lnt"> 676
</span><span class="lnt"> 677
</span><span class="lnt"> 678
</span><span class="lnt"> 679
</span><span class="lnt"> 680
</span><span class="lnt"> 681
</span><span class="lnt"> 682
</span><span class="lnt"> 683
</span><span class="lnt"> 684
</span><span class="lnt"> 685
</span><span class="lnt"> 686
</span><span class="lnt"> 687
</span><span class="lnt"> 688
</span><span class="lnt"> 689
</span><span class="lnt"> 690
</span><span class="lnt"> 691
</span><span class="lnt"> 692
</span><span class="lnt"> 693
</span><span class="lnt"> 694
</span><span class="lnt"> 695
</span><span class="lnt"> 696
</span><span class="lnt"> 697
</span><span class="lnt"> 698
</span><span class="lnt"> 699
</span><span class="lnt"> 700
</span><span class="lnt"> 701
</span><span class="lnt"> 702
</span><span class="lnt"> 703
</span><span class="lnt"> 704
</span><span class="lnt"> 705
</span><span class="lnt"> 706
</span><span class="lnt"> 707
</span><span class="lnt"> 708
</span><span class="lnt"> 709
</span><span class="lnt"> 710
</span><span class="lnt"> 711
</span><span class="lnt"> 712
</span><span class="lnt"> 713
</span><span class="lnt"> 714
</span><span class="lnt"> 715
</span><span class="lnt"> 716
</span><span class="lnt"> 717
</span><span class="lnt"> 718
</span><span class="lnt"> 719
</span><span class="lnt"> 720
</span><span class="lnt"> 721
</span><span class="lnt"> 722
</span><span class="lnt"> 723
</span><span class="lnt"> 724
</span><span class="lnt"> 725
</span><span class="lnt"> 726
</span><span class="lnt"> 727
</span><span class="lnt"> 728
</span><span class="lnt"> 729
</span><span class="lnt"> 730
</span><span class="lnt"> 731
</span><span class="lnt"> 732
</span><span class="lnt"> 733
</span><span class="lnt"> 734
</span><span class="lnt"> 735
</span><span class="lnt"> 736
</span><span class="lnt"> 737
</span><span class="lnt"> 738
</span><span class="lnt"> 739
</span><span class="lnt"> 740
</span><span class="lnt"> 741
</span><span class="lnt"> 742
</span><span class="lnt"> 743
</span><span class="lnt"> 744
</span><span class="lnt"> 745
</span><span class="lnt"> 746
</span><span class="lnt"> 747
</span><span class="lnt"> 748
</span><span class="lnt"> 749
</span><span class="lnt"> 750
</span><span class="lnt"> 751
</span><span class="lnt"> 752
</span><span class="lnt"> 753
</span><span class="lnt"> 754
</span><span class="lnt"> 755
</span><span class="lnt"> 756
</span><span class="lnt"> 757
</span><span class="lnt"> 758
</span><span class="lnt"> 759
</span><span class="lnt"> 760
</span><span class="lnt"> 761
</span><span class="lnt"> 762
</span><span class="lnt"> 763
</span><span class="lnt"> 764
</span><span class="lnt"> 765
</span><span class="lnt"> 766
</span><span class="lnt"> 767
</span><span class="lnt"> 768
</span><span class="lnt"> 769
</span><span class="lnt"> 770
</span><span class="lnt"> 771
</span><span class="lnt"> 772
</span><span class="lnt"> 773
</span><span class="lnt"> 774
</span><span class="lnt"> 775
</span><span class="lnt"> 776
</span><span class="lnt"> 777
</span><span class="lnt"> 778
</span><span class="lnt"> 779
</span><span class="lnt"> 780
</span><span class="lnt"> 781
</span><span class="lnt"> 782
</span><span class="lnt"> 783
</span><span class="lnt"> 784
</span><span class="lnt"> 785
</span><span class="lnt"> 786
</span><span class="lnt"> 787
</span><span class="lnt"> 788
</span><span class="lnt"> 789
</span><span class="lnt"> 790
</span><span class="lnt"> 791
</span><span class="lnt"> 792
</span><span class="lnt"> 793
</span><span class="lnt"> 794
</span><span class="lnt"> 795
</span><span class="lnt"> 796
</span><span class="lnt"> 797
</span><span class="lnt"> 798
</span><span class="lnt"> 799
</span><span class="lnt"> 800
</span><span class="lnt"> 801
</span><span class="lnt"> 802
</span><span class="lnt"> 803
</span><span class="lnt"> 804
</span><span class="lnt"> 805
</span><span class="lnt"> 806
</span><span class="lnt"> 807
</span><span class="lnt"> 808
</span><span class="lnt"> 809
</span><span class="lnt"> 810
</span><span class="lnt"> 811
</span><span class="lnt"> 812
</span><span class="lnt"> 813
</span><span class="lnt"> 814
</span><span class="lnt"> 815
</span><span class="lnt"> 816
</span><span class="lnt"> 817
</span><span class="lnt"> 818
</span><span class="lnt"> 819
</span><span class="lnt"> 820
</span><span class="lnt"> 821
</span><span class="lnt"> 822
</span><span class="lnt"> 823
</span><span class="lnt"> 824
</span><span class="lnt"> 825
</span><span class="lnt"> 826
</span><span class="lnt"> 827
</span><span class="lnt"> 828
</span><span class="lnt"> 829
</span><span class="lnt"> 830
</span><span class="lnt"> 831
</span><span class="lnt"> 832
</span><span class="lnt"> 833
</span><span class="lnt"> 834
</span><span class="lnt"> 835
</span><span class="lnt"> 836
</span><span class="lnt"> 837
</span><span class="lnt"> 838
</span><span class="lnt"> 839
</span><span class="lnt"> 840
</span><span class="lnt"> 841
</span><span class="lnt"> 842
</span><span class="lnt"> 843
</span><span class="lnt"> 844
</span><span class="lnt"> 845
</span><span class="lnt"> 846
</span><span class="lnt"> 847
</span><span class="lnt"> 848
</span><span class="lnt"> 849
</span><span class="lnt"> 850
</span><span class="lnt"> 851
</span><span class="lnt"> 852
</span><span class="lnt"> 853
</span><span class="lnt"> 854
</span><span class="lnt"> 855
</span><span class="lnt"> 856
</span><span class="lnt"> 857
</span><span class="lnt"> 858
</span><span class="lnt"> 859
</span><span class="lnt"> 860
</span><span class="lnt"> 861
</span><span class="lnt"> 862
</span><span class="lnt"> 863
</span><span class="lnt"> 864
</span><span class="lnt"> 865
</span><span class="lnt"> 866
</span><span class="lnt"> 867
</span><span class="lnt"> 868
</span><span class="lnt"> 869
</span><span class="lnt"> 870
</span><span class="lnt"> 871
</span><span class="lnt"> 872
</span><span class="lnt"> 873
</span><span class="lnt"> 874
</span><span class="lnt"> 875
</span><span class="lnt"> 876
</span><span class="lnt"> 877
</span><span class="lnt"> 878
</span><span class="lnt"> 879
</span><span class="lnt"> 880
</span><span class="lnt"> 881
</span><span class="lnt"> 882
</span><span class="lnt"> 883
</span><span class="lnt"> 884
</span><span class="lnt"> 885
</span><span class="lnt"> 886
</span><span class="lnt"> 887
</span><span class="lnt"> 888
</span><span class="lnt"> 889
</span><span class="lnt"> 890
</span><span class="lnt"> 891
</span><span class="lnt"> 892
</span><span class="lnt"> 893
</span><span class="lnt"> 894
</span><span class="lnt"> 895
</span><span class="lnt"> 896
</span><span class="lnt"> 897
</span><span class="lnt"> 898
</span><span class="lnt"> 899
</span><span class="lnt"> 900
</span><span class="lnt"> 901
</span><span class="lnt"> 902
</span><span class="lnt"> 903
</span><span class="lnt"> 904
</span><span class="lnt"> 905
</span><span class="lnt"> 906
</span><span class="lnt"> 907
</span><span class="lnt"> 908
</span><span class="lnt"> 909
</span><span class="lnt"> 910
</span><span class="lnt"> 911
</span><span class="lnt"> 912
</span><span class="lnt"> 913
</span><span class="lnt"> 914
</span><span class="lnt"> 915
</span><span class="lnt"> 916
</span><span class="lnt"> 917
</span><span class="lnt"> 918
</span><span class="lnt"> 919
</span><span class="lnt"> 920
</span><span class="lnt"> 921
</span><span class="lnt"> 922
</span><span class="lnt"> 923
</span><span class="lnt"> 924
</span><span class="lnt"> 925
</span><span class="lnt"> 926
</span><span class="lnt"> 927
</span><span class="lnt"> 928
</span><span class="lnt"> 929
</span><span class="lnt"> 930
</span><span class="lnt"> 931
</span><span class="lnt"> 932
</span><span class="lnt"> 933
</span><span class="lnt"> 934
</span><span class="lnt"> 935
</span><span class="lnt"> 936
</span><span class="lnt"> 937
</span><span class="lnt"> 938
</span><span class="lnt"> 939
</span><span class="lnt"> 940
</span><span class="lnt"> 941
</span><span class="lnt"> 942
</span><span class="lnt"> 943
</span><span class="lnt"> 944
</span><span class="lnt"> 945
</span><span class="lnt"> 946
</span><span class="lnt"> 947
</span><span class="lnt"> 948
</span><span class="lnt"> 949
</span><span class="lnt"> 950
</span><span class="lnt"> 951
</span><span class="lnt"> 952
</span><span class="lnt"> 953
</span><span class="lnt"> 954
</span><span class="lnt"> 955
</span><span class="lnt"> 956
</span><span class="lnt"> 957
</span><span class="lnt"> 958
</span><span class="lnt"> 959
</span><span class="lnt"> 960
</span><span class="lnt"> 961
</span><span class="lnt"> 962
</span><span class="lnt"> 963
</span><span class="lnt"> 964
</span><span class="lnt"> 965
</span><span class="lnt"> 966
</span><span class="lnt"> 967
</span><span class="lnt"> 968
</span><span class="lnt"> 969
</span><span class="lnt"> 970
</span><span class="lnt"> 971
</span><span class="lnt"> 972
</span><span class="lnt"> 973
</span><span class="lnt"> 974
</span><span class="lnt"> 975
</span><span class="lnt"> 976
</span><span class="lnt"> 977
</span><span class="lnt"> 978
</span><span class="lnt"> 979
</span><span class="lnt"> 980
</span><span class="lnt"> 981
</span><span class="lnt"> 982
</span><span class="lnt"> 983
</span><span class="lnt"> 984
</span><span class="lnt"> 985
</span><span class="lnt"> 986
</span><span class="lnt"> 987
</span><span class="lnt"> 988
</span><span class="lnt"> 989
</span><span class="lnt"> 990
</span><span class="lnt"> 991
</span><span class="lnt"> 992
</span><span class="lnt"> 993
</span><span class="lnt"> 994
</span><span class="lnt"> 995
</span><span class="lnt"> 996
</span><span class="lnt"> 997
</span><span class="lnt"> 998
</span><span class="lnt"> 999
</span><span class="lnt">1000
</span><span class="lnt">1001
</span><span class="lnt">1002
</span><span class="lnt">1003
</span><span class="lnt">1004
</span><span class="lnt">1005
</span><span class="lnt">1006
</span><span class="lnt">1007
</span><span class="lnt">1008
</span><span class="lnt">1009
</span><span class="lnt">1010
</span><span class="lnt">1011
</span><span class="lnt">1012
</span><span class="lnt">1013
</span><span class="lnt">1014
</span><span class="lnt">1015
</span><span class="lnt">1016
</span><span class="lnt">1017
</span><span class="lnt">1018
</span><span class="lnt">1019
</span><span class="lnt">1020
</span><span class="lnt">1021
</span><span class="lnt">1022
</span><span class="lnt">1023
</span><span class="lnt">1024
</span><span class="lnt">1025
</span><span class="lnt">1026
</span><span class="lnt">1027
</span><span class="lnt">1028
</span><span class="lnt">1029
</span><span class="lnt">1030
</span><span class="lnt">1031
</span><span class="lnt">1032
</span><span class="lnt">1033
</span><span class="lnt">1034
</span><span class="lnt">1035
</span><span class="lnt">1036
</span><span class="lnt">1037
</span><span class="lnt">1038
</span><span class="lnt">1039
</span><span class="lnt">1040
</span><span class="lnt">1041
</span><span class="lnt">1042
</span><span class="lnt">1043
</span><span class="lnt">1044
</span><span class="lnt">1045
</span><span class="lnt">1046
</span><span class="lnt">1047
</span><span class="lnt">1048
</span><span class="lnt">1049
</span><span class="lnt">1050
</span><span class="lnt">1051
</span><span class="lnt">1052
</span><span class="lnt">1053
</span><span class="lnt">1054
</span><span class="lnt">1055
</span><span class="lnt">1056
</span><span class="lnt">1057
</span><span class="lnt">1058
</span><span class="lnt">1059
</span><span class="lnt">1060
</span><span class="lnt">1061
</span><span class="lnt">1062
</span><span class="lnt">1063
</span><span class="lnt">1064
</span><span class="lnt">1065
</span><span class="lnt">1066
</span><span class="lnt">1067
</span><span class="lnt">1068
</span><span class="lnt">1069
</span><span class="lnt">1070
</span><span class="lnt">1071
</span><span class="lnt">1072
</span><span class="lnt">1073
</span><span class="lnt">1074
</span><span class="lnt">1075
</span><span class="lnt">1076
</span><span class="lnt">1077
</span><span class="lnt">1078
</span><span class="lnt">1079
</span><span class="lnt">1080
</span><span class="lnt">1081
</span><span class="lnt">1082
</span><span class="lnt">1083
</span><span class="lnt">1084
</span><span class="lnt">1085
</span><span class="lnt">1086
</span><span class="lnt">1087
</span><span class="lnt">1088
</span><span class="lnt">1089
</span><span class="lnt">1090
</span><span class="lnt">1091
</span><span class="lnt">1092
</span><span class="lnt">1093
</span><span class="lnt">1094
</span><span class="lnt">1095
</span><span class="lnt">1096
</span><span class="lnt">1097
</span><span class="lnt">1098
</span><span class="lnt">1099
</span><span class="lnt">1100
</span><span class="lnt">1101
</span><span class="lnt">1102
</span><span class="lnt">1103
</span><span class="lnt">1104
</span><span class="lnt">1105
</span><span class="lnt">1106
</span><span class="lnt">1107
</span><span class="lnt">1108
</span><span class="lnt">1109
</span><span class="lnt">1110
</span><span class="lnt">1111
</span><span class="lnt">1112
</span><span class="lnt">1113
</span><span class="lnt">1114
</span><span class="lnt">1115
</span><span class="lnt">1116
</span><span class="lnt">1117
</span><span class="lnt">1118
</span><span class="lnt">1119
</span><span class="lnt">1120
</span><span class="lnt">1121
</span><span class="lnt">1122
</span><span class="lnt">1123
</span><span class="lnt">1124
</span><span class="lnt">1125
</span><span class="lnt">1126
</span><span class="lnt">1127
</span><span class="lnt">1128
</span><span class="lnt">1129
</span><span class="lnt">1130
</span><span class="lnt">1131
</span><span class="lnt">1132
</span><span class="lnt">1133
</span><span class="lnt">1134
</span><span class="lnt">1135
</span><span class="lnt">1136
</span><span class="lnt">1137
</span><span class="lnt">1138
</span><span class="lnt">1139
</span><span class="lnt">1140
</span><span class="lnt">1141
</span><span class="lnt">1142
</span><span class="lnt">1143
</span><span class="lnt">1144
</span><span class="lnt">1145
</span><span class="lnt">1146
</span><span class="lnt">1147
</span><span class="lnt">1148
</span><span class="lnt">1149
</span><span class="lnt">1150
</span><span class="lnt">1151
</span><span class="lnt">1152
</span><span class="lnt">1153
</span><span class="lnt">1154
</span><span class="lnt">1155
</span><span class="lnt">1156
</span><span class="lnt">1157
</span><span class="lnt">1158
</span><span class="lnt">1159
</span><span class="lnt">1160
</span><span class="lnt">1161
</span><span class="lnt">1162
</span><span class="lnt">1163
</span><span class="lnt">1164
</span><span class="lnt">1165
</span><span class="lnt">1166
</span><span class="lnt">1167
</span><span class="lnt">1168
</span><span class="lnt">1169
</span><span class="lnt">1170
</span><span class="lnt">1171
</span><span class="lnt">1172
</span><span class="lnt">1173
</span><span class="lnt">1174
</span><span class="lnt">1175
</span><span class="lnt">1176
</span><span class="lnt">1177
</span><span class="lnt">1178
</span><span class="lnt">1179
</span><span class="lnt">1180
</span><span class="lnt">1181
</span><span class="lnt">1182
</span><span class="lnt">1183
</span><span class="lnt">1184
</span><span class="lnt">1185
</span><span class="lnt">1186
</span><span class="lnt">1187
</span><span class="lnt">1188
</span><span class="lnt">1189
</span><span class="lnt">1190
</span><span class="lnt">1191
</span><span class="lnt">1192
</span><span class="lnt">1193
</span><span class="lnt">1194
</span><span class="lnt">1195
</span><span class="lnt">1196
</span><span class="lnt">1197
</span><span class="lnt">1198
</span><span class="lnt">1199
</span><span class="lnt">1200
</span><span class="lnt">1201
</span><span class="lnt">1202
</span><span class="lnt">1203
</span><span class="lnt">1204
</span><span class="lnt">1205
</span><span class="lnt">1206
</span><span class="lnt">1207
</span><span class="lnt">1208
</span><span class="lnt">1209
</span><span class="lnt">1210
</span><span class="lnt">1211
</span><span class="lnt">1212
</span><span class="lnt">1213
</span><span class="lnt">1214
</span><span class="lnt">1215
</span><span class="lnt">1216
</span><span class="lnt">1217
</span><span class="lnt">1218
</span><span class="lnt">1219
</span><span class="lnt">1220
</span><span class="lnt">1221
</span><span class="lnt">1222
</span><span class="lnt">1223
</span><span class="lnt">1224
</span><span class="lnt">1225
</span><span class="lnt">1226
</span><span class="lnt">1227
</span><span class="lnt">1228
</span><span class="lnt">1229
</span><span class="lnt">1230
</span><span class="lnt">1231
</span><span class="lnt">1232
</span><span class="lnt">1233
</span><span class="lnt">1234
</span><span class="lnt">1235
</span><span class="lnt">1236
</span><span class="lnt">1237
</span><span class="lnt">1238
</span><span class="lnt">1239
</span><span class="lnt">1240
</span><span class="lnt">1241
</span><span class="lnt">1242
</span><span class="lnt">1243
</span><span class="lnt">1244
</span><span class="lnt">1245
</span><span class="lnt">1246
</span><span class="lnt">1247
</span><span class="lnt">1248
</span><span class="lnt">1249
</span><span class="lnt">1250
</span><span class="lnt">1251
</span><span class="lnt">1252
</span><span class="lnt">1253
</span><span class="lnt">1254
</span><span class="lnt">1255
</span><span class="lnt">1256
</span><span class="lnt">1257
</span><span class="lnt">1258
</span><span class="lnt">1259
</span><span class="lnt">1260
</span><span class="lnt">1261
</span><span class="lnt">1262
</span><span class="lnt">1263
</span><span class="lnt">1264
</span><span class="lnt">1265
</span><span class="lnt">1266
</span><span class="lnt">1267
</span><span class="lnt">1268
</span><span class="lnt">1269
</span><span class="lnt">1270
</span><span class="lnt">1271
</span><span class="lnt">1272
</span><span class="lnt">1273
</span><span class="lnt">1274
</span><span class="lnt">1275
</span><span class="lnt">1276
</span><span class="lnt">1277
</span><span class="lnt">1278
</span><span class="lnt">1279
</span><span class="lnt">1280
</span><span class="lnt">1281
</span><span class="lnt">1282
</span><span class="lnt">1283
</span><span class="lnt">1284
</span><span class="lnt">1285
</span><span class="lnt">1286
</span><span class="lnt">1287
</span><span class="lnt">1288
</span><span class="lnt">1289
</span><span class="lnt">1290
</span><span class="lnt">1291
</span><span class="lnt">1292
</span><span class="lnt">1293
</span><span class="lnt">1294
</span><span class="lnt">1295
</span><span class="lnt">1296
</span><span class="lnt">1297
</span><span class="lnt">1298
</span><span class="lnt">1299
</span><span class="lnt">1300
</span><span class="lnt">1301
</span><span class="lnt">1302
</span><span class="lnt">1303
</span><span class="lnt">1304
</span><span class="lnt">1305
</span><span class="lnt">1306
</span><span class="lnt">1307
</span><span class="lnt">1308
</span><span class="lnt">1309
</span><span class="lnt">1310
</span><span class="lnt">1311
</span><span class="lnt">1312
</span><span class="lnt">1313
</span><span class="lnt">1314
</span><span class="lnt">1315
</span><span class="lnt">1316
</span><span class="lnt">1317
</span><span class="lnt">1318
</span><span class="lnt">1319
</span><span class="lnt">1320
</span><span class="lnt">1321
</span><span class="lnt">1322
</span><span class="lnt">1323
</span><span class="lnt">1324
</span><span class="lnt">1325
</span><span class="lnt">1326
</span><span class="lnt">1327
</span><span class="lnt">1328
</span><span class="lnt">1329
</span><span class="lnt">1330
</span><span class="lnt">1331
</span><span class="lnt">1332
</span><span class="lnt">1333
</span><span class="lnt">1334
</span><span class="lnt">1335
</span><span class="lnt">1336
</span><span class="lnt">1337
</span><span class="lnt">1338
</span><span class="lnt">1339
</span><span class="lnt">1340
</span><span class="lnt">1341
</span><span class="lnt">1342
</span><span class="lnt">1343
</span><span class="lnt">1344
</span><span class="lnt">1345
</span><span class="lnt">1346
</span><span class="lnt">1347
</span><span class="lnt">1348
</span><span class="lnt">1349
</span><span class="lnt">1350
</span><span class="lnt">1351
</span><span class="lnt">1352
</span><span class="lnt">1353
</span><span class="lnt">1354
</span><span class="lnt">1355
</span><span class="lnt">1356
</span><span class="lnt">1357
</span><span class="lnt">1358
</span><span class="lnt">1359
</span><span class="lnt">1360
</span><span class="lnt">1361
</span><span class="lnt">1362
</span><span class="lnt">1363
</span><span class="lnt">1364
</span><span class="lnt">1365
</span><span class="lnt">1366
</span><span class="lnt">1367
</span><span class="lnt">1368
</span><span class="lnt">1369
</span><span class="lnt">1370
</span><span class="lnt">1371
</span><span class="lnt">1372
</span><span class="lnt">1373
</span><span class="lnt">1374
</span><span class="lnt">1375
</span><span class="lnt">1376
</span><span class="lnt">1377
</span><span class="lnt">1378
</span><span class="lnt">1379
</span><span class="lnt">1380
</span><span class="lnt">1381
</span><span class="lnt">1382
</span><span class="lnt">1383
</span><span class="lnt">1384
</span><span class="lnt">1385
</span><span class="lnt">1386
</span><span class="lnt">1387
</span><span class="lnt">1388
</span><span class="lnt">1389
</span><span class="lnt">1390
</span><span class="lnt">1391
</span><span class="lnt">1392
</span><span class="lnt">1393
</span><span class="lnt">1394
</span><span class="lnt">1395
</span><span class="lnt">1396
</span><span class="lnt">1397
</span><span class="lnt">1398
</span><span class="lnt">1399
</span><span class="lnt">1400
</span><span class="lnt">1401
</span><span class="lnt">1402
</span><span class="lnt">1403
</span><span class="lnt">1404
</span><span class="lnt">1405
</span><span class="lnt">1406
</span><span class="lnt">1407
</span><span class="lnt">1408
</span><span class="lnt">1409
</span><span class="lnt">1410
</span><span class="lnt">1411
</span><span class="lnt">1412
</span><span class="lnt">1413
</span><span class="lnt">1414
</span><span class="lnt">1415
</span><span class="lnt">1416
</span><span class="lnt">1417
</span><span class="lnt">1418
</span><span class="lnt">1419
</span><span class="lnt">1420
</span><span class="lnt">1421
</span><span class="lnt">1422
</span><span class="lnt">1423
</span><span class="lnt">1424
</span><span class="lnt">1425
</span><span class="lnt">1426
</span><span class="lnt">1427
</span><span class="lnt">1428
</span><span class="lnt">1429
</span><span class="lnt">1430
</span><span class="lnt">1431
</span><span class="lnt">1432
</span><span class="lnt">1433
</span><span class="lnt">1434
</span><span class="lnt">1435
</span><span class="lnt">1436
</span><span class="lnt">1437
</span><span class="lnt">1438
</span><span class="lnt">1439
</span><span class="lnt">1440
</span><span class="lnt">1441
</span><span class="lnt">1442
</span><span class="lnt">1443
</span><span class="lnt">1444
</span><span class="lnt">1445
</span><span class="lnt">1446
</span><span class="lnt">1447
</span><span class="lnt">1448
</span><span class="lnt">1449
</span><span class="lnt">1450
</span><span class="lnt">1451
</span><span class="lnt">1452
</span><span class="lnt">1453
</span><span class="lnt">1454
</span><span class="lnt">1455
</span><span class="lnt">1456
</span><span class="lnt">1457
</span><span class="lnt">1458
</span><span class="lnt">1459
</span><span class="lnt">1460
</span><span class="lnt">1461
</span><span class="lnt">1462
</span><span class="lnt">1463
</span><span class="lnt">1464
</span><span class="lnt">1465
</span><span class="lnt">1466
</span><span class="lnt">1467
</span><span class="lnt">1468
</span><span class="lnt">1469
</span><span class="lnt">1470
</span><span class="lnt">1471
</span><span class="lnt">1472
</span><span class="lnt">1473
</span><span class="lnt">1474
</span><span class="lnt">1475
</span><span class="lnt">1476
</span><span class="lnt">1477
</span><span class="lnt">1478
</span><span class="lnt">1479
</span><span class="lnt">1480
</span><span class="lnt">1481
</span><span class="lnt">1482
</span><span class="lnt">1483
</span><span class="lnt">1484
</span><span class="lnt">1485
</span><span class="lnt">1486
</span><span class="lnt">1487
</span><span class="lnt">1488
</span><span class="lnt">1489
</span><span class="lnt">1490
</span><span class="lnt">1491
</span><span class="lnt">1492
</span><span class="lnt">1493
</span><span class="lnt">1494
</span><span class="lnt">1495
</span><span class="lnt">1496
</span><span class="lnt">1497
</span><span class="lnt">1498
</span><span class="lnt">1499
</span><span class="lnt">1500
</span><span class="lnt">1501
</span><span class="lnt">1502
</span><span class="lnt">1503
</span><span class="lnt">1504
</span><span class="lnt">1505
</span><span class="lnt">1506
</span><span class="lnt">1507
</span><span class="lnt">1508
</span><span class="lnt">1509
</span><span class="lnt">1510
</span><span class="lnt">1511
</span><span class="lnt">1512
</span><span class="lnt">1513
</span><span class="lnt">1514
</span><span class="lnt">1515
</span><span class="lnt">1516
</span><span class="lnt">1517
</span><span class="lnt">1518
</span><span class="lnt">1519
</span><span class="lnt">1520
</span><span class="lnt">1521
</span><span class="lnt">1522
</span><span class="lnt">1523
</span><span class="lnt">1524
</span><span class="lnt">1525
</span><span class="lnt">1526
</span><span class="lnt">1527
</span><span class="lnt">1528
</span><span class="lnt">1529
</span><span class="lnt">1530
</span><span class="lnt">1531
</span><span class="lnt">1532
</span><span class="lnt">1533
</span><span class="lnt">1534
</span><span class="lnt">1535
</span><span class="lnt">1536
</span><span class="lnt">1537
</span><span class="lnt">1538
</span><span class="lnt">1539
</span><span class="lnt">1540
</span><span class="lnt">1541
</span><span class="lnt">1542
</span><span class="lnt">1543
</span><span class="lnt">1544
</span><span class="lnt">1545
</span><span class="lnt">1546
</span><span class="lnt">1547
</span><span class="lnt">1548
</span><span class="lnt">1549
</span><span class="lnt">1550
</span><span class="lnt">1551
</span><span class="lnt">1552
</span><span class="lnt">1553
</span><span class="lnt">1554
</span><span class="lnt">1555
</span><span class="lnt">1556
</span><span class="lnt">1557
</span><span class="lnt">1558
</span><span class="lnt">1559
</span><span class="lnt">1560
</span><span class="lnt">1561
</span><span class="lnt">1562
</span><span class="lnt">1563
</span><span class="lnt">1564
</span><span class="lnt">1565
</span><span class="lnt">1566
</span><span class="lnt">1567
</span><span class="lnt">1568
</span><span class="lnt">1569
</span><span class="lnt">1570
</span><span class="lnt">1571
</span><span class="lnt">1572
</span><span class="lnt">1573
</span><span class="lnt">1574
</span><span class="lnt">1575
</span><span class="lnt">1576
</span><span class="lnt">1577
</span><span class="lnt">1578
</span><span class="lnt">1579
</span><span class="lnt">1580
</span><span class="lnt">1581
</span><span class="lnt">1582
</span><span class="lnt">1583
</span><span class="lnt">1584
</span><span class="lnt">1585
</span><span class="lnt">1586
</span><span class="lnt">1587
</span><span class="lnt">1588
</span><span class="lnt">1589
</span><span class="lnt">1590
</span><span class="lnt">1591
</span><span class="lnt">1592
</span><span class="lnt">1593
</span><span class="lnt">1594
</span><span class="lnt">1595
</span><span class="lnt">1596
</span><span class="lnt">1597
</span><span class="lnt">1598
</span><span class="lnt">1599
</span><span class="lnt">1600
</span><span class="lnt">1601
</span><span class="lnt">1602
</span><span class="lnt">1603
</span><span class="lnt">1604
</span><span class="lnt">1605
</span><span class="lnt">1606
</span><span class="lnt">1607
</span><span class="lnt">1608
</span><span class="lnt">1609
</span><span class="lnt">1610
</span><span class="lnt">1611
</span><span class="lnt">1612
</span><span class="lnt">1613
</span><span class="lnt">1614
</span><span class="lnt">1615
</span><span class="lnt">1616
</span><span class="lnt">1617
</span><span class="lnt">1618
</span><span class="lnt">1619
</span><span class="lnt">1620
</span><span class="lnt">1621
</span><span class="lnt">1622
</span><span class="lnt">1623
</span><span class="lnt">1624
</span><span class="lnt">1625
</span><span class="lnt">1626
</span><span class="lnt">1627
</span><span class="lnt">1628
</span><span class="lnt">1629
</span><span class="lnt">1630
</span><span class="lnt">1631
</span><span class="lnt">1632
</span><span class="lnt">1633
</span><span class="lnt">1634
</span><span class="lnt">1635
</span><span class="lnt">1636
</span><span class="lnt">1637
</span><span class="lnt">1638
</span><span class="lnt">1639
</span><span class="lnt">1640
</span><span class="lnt">1641
</span><span class="lnt">1642
</span><span class="lnt">1643
</span><span class="lnt">1644
</span><span class="lnt">1645
</span><span class="lnt">1646
</span><span class="lnt">1647
</span><span class="lnt">1648
</span><span class="lnt">1649
</span><span class="lnt">1650
</span><span class="lnt">1651
</span><span class="lnt">1652
</span><span class="lnt">1653
</span><span class="lnt">1654
</span><span class="lnt">1655
</span><span class="lnt">1656
</span><span class="lnt">1657
</span><span class="lnt">1658
</span><span class="lnt">1659
</span><span class="lnt">1660
</span><span class="lnt">1661
</span><span class="lnt">1662
</span><span class="lnt">1663
</span><span class="lnt">1664
</span><span class="lnt">1665
</span><span class="lnt">1666
</span><span class="lnt">1667
</span><span class="lnt">1668
</span><span class="lnt">1669
</span><span class="lnt">1670
</span><span class="lnt">1671
</span><span class="lnt">1672
</span><span class="lnt">1673
</span><span class="lnt">1674
</span><span class="lnt">1675
</span><span class="lnt">1676
</span><span class="lnt">1677
</span><span class="lnt">1678
</span><span class="lnt">1679
</span><span class="lnt">1680
</span><span class="lnt">1681
</span><span class="lnt">1682
</span><span class="lnt">1683
</span><span class="lnt">1684
</span><span class="lnt">1685
</span><span class="lnt">1686
</span><span class="lnt">1687
</span><span class="lnt">1688
</span><span class="lnt">1689
</span><span class="lnt">1690
</span><span class="lnt">1691
</span><span class="lnt">1692
</span><span class="lnt">1693
</span><span class="lnt">1694
</span><span class="lnt">1695
</span><span class="lnt">1696
</span><span class="lnt">1697
</span><span class="lnt">1698
</span><span class="lnt">1699
</span><span class="lnt">1700
</span><span class="lnt">1701
</span><span class="lnt">1702
</span><span class="lnt">1703
</span><span class="lnt">1704
</span><span class="lnt">1705
</span><span class="lnt">1706
</span><span class="lnt">1707
</span><span class="lnt">1708
</span><span class="lnt">1709
</span><span class="lnt">1710
</span><span class="lnt">1711
</span><span class="lnt">1712
</span><span class="lnt">1713
</span><span class="lnt">1714
</span><span class="lnt">1715
</span><span class="lnt">1716
</span><span class="lnt">1717
</span><span class="lnt">1718
</span><span class="lnt">1719
</span><span class="lnt">1720
</span><span class="lnt">1721
</span><span class="lnt">1722
</span><span class="lnt">1723
</span><span class="lnt">1724
</span><span class="lnt">1725
</span><span class="lnt">1726
</span><span class="lnt">1727
</span><span class="lnt">1728
</span><span class="lnt">1729
</span><span class="lnt">1730
</span><span class="lnt">1731
</span><span class="lnt">1732
</span><span class="lnt">1733
</span><span class="lnt">1734
</span><span class="lnt">1735
</span><span class="lnt">1736
</span><span class="lnt">1737
</span><span class="lnt">1738
</span><span class="lnt">1739
</span><span class="lnt">1740
</span><span class="lnt">1741
</span><span class="lnt">1742
</span><span class="lnt">1743
</span><span class="lnt">1744
</span><span class="lnt">1745
</span><span class="lnt">1746
</span><span class="lnt">1747
</span><span class="lnt">1748
</span><span class="lnt">1749
</span><span class="lnt">1750
</span><span class="lnt">1751
</span><span class="lnt">1752
</span><span class="lnt">1753
</span><span class="lnt">1754
</span><span class="lnt">1755
</span><span class="lnt">1756
</span><span class="lnt">1757
</span><span class="lnt">1758
</span><span class="lnt">1759
</span><span class="lnt">1760
</span><span class="lnt">1761
</span><span class="lnt">1762
</span><span class="lnt">1763
</span><span class="lnt">1764
</span><span class="lnt">1765
</span><span class="lnt">1766
</span><span class="lnt">1767
</span><span class="lnt">1768
</span><span class="lnt">1769
</span><span class="lnt">1770
</span><span class="lnt">1771
</span><span class="lnt">1772
</span><span class="lnt">1773
</span><span class="lnt">1774
</span><span class="lnt">1775
</span><span class="lnt">1776
</span><span class="lnt">1777
</span><span class="lnt">1778
</span><span class="lnt">1779
</span><span class="lnt">1780
</span><span class="lnt">1781
</span><span class="lnt">1782
</span><span class="lnt">1783
</span><span class="lnt">1784
</span><span class="lnt">1785
</span><span class="lnt">1786
</span><span class="lnt">1787
</span><span class="lnt">1788
</span><span class="lnt">1789
</span><span class="lnt">1790
</span><span class="lnt">1791
</span><span class="lnt">1792
</span><span class="lnt">1793
</span><span class="lnt">1794
</span><span class="lnt">1795
</span><span class="lnt">1796
</span><span class="lnt">1797
</span><span class="lnt">1798
</span><span class="lnt">1799
</span><span class="lnt">1800
</span><span class="lnt">1801
</span><span class="lnt">1802
</span><span class="lnt">1803
</span><span class="lnt">1804
</span><span class="lnt">1805
</span><span class="lnt">1806
</span><span class="lnt">1807
</span><span class="lnt">1808
</span><span class="lnt">1809
</span><span class="lnt">1810
</span><span class="lnt">1811
</span><span class="lnt">1812
</span><span class="lnt">1813
</span><span class="lnt">1814
</span><span class="lnt">1815
</span><span class="lnt">1816
</span><span class="lnt">1817
</span><span class="lnt">1818
</span><span class="lnt">1819
</span><span class="lnt">1820
</span><span class="lnt">1821
</span><span class="lnt">1822
</span><span class="lnt">1823
</span><span class="lnt">1824
</span><span class="lnt">1825
</span><span class="lnt">1826
</span><span class="lnt">1827
</span><span class="lnt">1828
</span><span class="lnt">1829
</span><span class="lnt">1830
</span><span class="lnt">1831
</span><span class="lnt">1832
</span><span class="lnt">1833
</span><span class="lnt">1834
</span><span class="lnt">1835
</span><span class="lnt">1836
</span><span class="lnt">1837
</span><span class="lnt">1838
</span><span class="lnt">1839
</span><span class="lnt">1840
</span><span class="lnt">1841
</span><span class="lnt">1842
</span><span class="lnt">1843
</span><span class="lnt">1844
</span><span class="lnt">1845
</span><span class="lnt">1846
</span><span class="lnt">1847
</span><span class="lnt">1848
</span><span class="lnt">1849
</span><span class="lnt">1850
</span><span class="lnt">1851
</span><span class="lnt">1852
</span><span class="lnt">1853
</span><span class="lnt">1854
</span><span class="lnt">1855
</span><span class="lnt">1856
</span><span class="lnt">1857
</span><span class="lnt">1858
</span><span class="lnt">1859
</span><span class="lnt">1860
</span><span class="lnt">1861
</span><span class="lnt">1862
</span><span class="lnt">1863
</span><span class="lnt">1864
</span><span class="lnt">1865
</span><span class="lnt">1866
</span><span class="lnt">1867
</span><span class="lnt">1868
</span><span class="lnt">1869
</span><span class="lnt">1870
</span><span class="lnt">1871
</span><span class="lnt">1872
</span><span class="lnt">1873
</span><span class="lnt">1874
</span><span class="lnt">1875
</span><span class="lnt">1876
</span><span class="lnt">1877
</span><span class="lnt">1878
</span><span class="lnt">1879
</span><span class="lnt">1880
</span><span class="lnt">1881
</span><span class="lnt">1882
</span><span class="lnt">1883
</span><span class="lnt">1884
</span><span class="lnt">1885
</span><span class="lnt">1886
</span><span class="lnt">1887
</span><span class="lnt">1888
</span><span class="lnt">1889
</span><span class="lnt">1890
</span><span class="lnt">1891
</span><span class="lnt">1892
</span><span class="lnt">1893
</span><span class="lnt">1894
</span><span class="lnt">1895
</span><span class="lnt">1896
</span><span class="lnt">1897
</span><span class="lnt">1898
</span><span class="lnt">1899
</span><span class="lnt">1900
</span><span class="lnt">1901
</span><span class="lnt">1902
</span><span class="lnt">1903
</span><span class="lnt">1904
</span><span class="lnt">1905
</span><span class="lnt">1906
</span><span class="lnt">1907
</span><span class="lnt">1908
</span><span class="lnt">1909
</span><span class="lnt">1910
</span><span class="lnt">1911
</span><span class="lnt">1912
</span><span class="lnt">1913
</span><span class="lnt">1914
</span><span class="lnt">1915
</span><span class="lnt">1916
</span><span class="lnt">1917
</span><span class="lnt">1918
</span><span class="lnt">1919
</span><span class="lnt">1920
</span><span class="lnt">1921
</span><span class="lnt">1922
</span><span class="lnt">1923
</span><span class="lnt">1924
</span><span class="lnt">1925
</span><span class="lnt">1926
</span><span class="lnt">1927
</span><span class="lnt">1928
</span><span class="lnt">1929
</span><span class="lnt">1930
</span><span class="lnt">1931
</span><span class="lnt">1932
</span><span class="lnt">1933
</span><span class="lnt">1934
</span><span class="lnt">1935
</span><span class="lnt">1936
</span><span class="lnt">1937
</span><span class="lnt">1938
</span><span class="lnt">1939
</span><span class="lnt">1940
</span><span class="lnt">1941
</span><span class="lnt">1942
</span><span class="lnt">1943
</span><span class="lnt">1944
</span><span class="lnt">1945
</span><span class="lnt">1946
</span><span class="lnt">1947
</span><span class="lnt">1948
</span><span class="lnt">1949
</span><span class="lnt">1950
</span><span class="lnt">1951
</span><span class="lnt">1952
</span><span class="lnt">1953
</span><span class="lnt">1954
</span><span class="lnt">1955
</span><span class="lnt">1956
</span><span class="lnt">1957
</span><span class="lnt">1958
</span><span class="lnt">1959
</span><span class="lnt">1960
</span><span class="lnt">1961
</span><span class="lnt">1962
</span><span class="lnt">1963
</span><span class="lnt">1964
</span><span class="lnt">1965
</span><span class="lnt">1966
</span><span class="lnt">1967
</span><span class="lnt">1968
</span><span class="lnt">1969
</span><span class="lnt">1970
</span><span class="lnt">1971
</span><span class="lnt">1972
</span><span class="lnt">1973
</span><span class="lnt">1974
</span><span class="lnt">1975
</span><span class="lnt">1976
</span><span class="lnt">1977
</span><span class="lnt">1978
</span><span class="lnt">1979
</span><span class="lnt">1980
</span><span class="lnt">1981
</span><span class="lnt">1982
</span><span class="lnt">1983
</span><span class="lnt">1984
</span><span class="lnt">1985
</span><span class="lnt">1986
</span><span class="lnt">1987
</span><span class="lnt">1988
</span><span class="lnt">1989
</span><span class="lnt">1990
</span><span class="lnt">1991
</span><span class="lnt">1992
</span><span class="lnt">1993
</span><span class="lnt">1994
</span><span class="lnt">1995
</span><span class="lnt">1996
</span><span class="lnt">1997
</span><span class="lnt">1998
</span><span class="lnt">1999
</span><span class="lnt">2000
</span><span class="lnt">2001
</span><span class="lnt">2002
</span><span class="lnt">2003
</span><span class="lnt">2004
</span><span class="lnt">2005
</span><span class="lnt">2006
</span><span class="lnt">2007
</span><span class="lnt">2008
</span><span class="lnt">2009
</span><span class="lnt">2010
</span><span class="lnt">2011
</span><span class="lnt">2012
</span><span class="lnt">2013
</span><span class="lnt">2014
</span><span class="lnt">2015
</span><span class="lnt">2016
</span><span class="lnt">2017
</span><span class="lnt">2018
</span><span class="lnt">2019
</span><span class="lnt">2020
</span><span class="lnt">2021
</span><span class="lnt">2022
</span><span class="lnt">2023
</span><span class="lnt">2024
</span><span class="lnt">2025
</span><span class="lnt">2026
</span><span class="lnt">2027
</span><span class="lnt">2028
</span><span class="lnt">2029
</span><span class="lnt">2030
</span><span class="lnt">2031
</span><span class="lnt">2032
</span><span class="lnt">2033
</span><span class="lnt">2034
</span><span class="lnt">2035
</span><span class="lnt">2036
</span><span class="lnt">2037
</span><span class="lnt">2038
</span><span class="lnt">2039
</span><span class="lnt">2040
</span><span class="lnt">2041
</span><span class="lnt">2042
</span><span class="lnt">2043
</span><span class="lnt">2044
</span><span class="lnt">2045
</span><span class="lnt">2046
</span><span class="lnt">2047
</span><span class="lnt">2048
</span><span class="lnt">2049
</span><span class="lnt">2050
</span><span class="lnt">2051
</span><span class="lnt">2052
</span><span class="lnt">2053
</span><span class="lnt">2054
</span><span class="lnt">2055
</span><span class="lnt">2056
</span><span class="lnt">2057
</span><span class="lnt">2058
</span><span class="lnt">2059
</span><span class="lnt">2060
</span><span class="lnt">2061
</span><span class="lnt">2062
</span><span class="lnt">2063
</span><span class="lnt">2064
</span><span class="lnt">2065
</span><span class="lnt">2066
</span><span class="lnt">2067
</span><span class="lnt">2068
</span><span class="lnt">2069
</span><span class="lnt">2070
</span><span class="lnt">2071
</span><span class="lnt">2072
</span><span class="lnt">2073
</span><span class="lnt">2074
</span><span class="lnt">2075
</span><span class="lnt">2076
</span><span class="lnt">2077
</span><span class="lnt">2078
</span><span class="lnt">2079
</span><span class="lnt">2080
</span><span class="lnt">2081
</span><span class="lnt">2082
</span><span class="lnt">2083
</span><span class="lnt">2084
</span><span class="lnt">2085
</span><span class="lnt">2086
</span><span class="lnt">2087
</span><span class="lnt">2088
</span><span class="lnt">2089
</span><span class="lnt">2090
</span><span class="lnt">2091
</span><span class="lnt">2092
</span><span class="lnt">2093
</span><span class="lnt">2094
</span><span class="lnt">2095
</span><span class="lnt">2096
</span><span class="lnt">2097
</span><span class="lnt">2098
</span><span class="lnt">2099
</span><span class="lnt">2100
</span><span class="lnt">2101
</span><span class="lnt">2102
</span><span class="lnt">2103
</span><span class="lnt">2104
</span><span class="lnt">2105
</span><span class="lnt">2106
</span><span class="lnt">2107
</span><span class="lnt">2108
</span><span class="lnt">2109
</span><span class="lnt">2110
</span><span class="lnt">2111
</span><span class="lnt">2112
</span><span class="lnt">2113
</span><span class="lnt">2114
</span><span class="lnt">2115
</span><span class="lnt">2116
</span><span class="lnt">2117
</span><span class="lnt">2118
</span><span class="lnt">2119
</span><span class="lnt">2120
</span><span class="lnt">2121
</span><span class="lnt">2122
</span><span class="lnt">2123
</span><span class="lnt">2124
</span><span class="lnt">2125
</span><span class="lnt">2126
</span><span class="lnt">2127
</span><span class="lnt">2128
</span><span class="lnt">2129
</span><span class="lnt">2130
</span><span class="lnt">2131
</span><span class="lnt">2132
</span><span class="lnt">2133
</span><span class="lnt">2134
</span><span class="lnt">2135
</span><span class="lnt">2136
</span><span class="lnt">2137
</span><span class="lnt">2138
</span><span class="lnt">2139
</span><span class="lnt">2140
</span><span class="lnt">2141
</span><span class="lnt">2142
</span><span class="lnt">2143
</span><span class="lnt">2144
</span><span class="lnt">2145
</span><span class="lnt">2146
</span><span class="lnt">2147
</span><span class="lnt">2148
</span><span class="lnt">2149
</span><span class="lnt">2150
</span><span class="lnt">2151
</span><span class="lnt">2152
</span><span class="lnt">2153
</span><span class="lnt">2154
</span><span class="lnt">2155
</span><span class="lnt">2156
</span><span class="lnt">2157
</span><span class="lnt">2158
</span><span class="lnt">2159
</span><span class="lnt">2160
</span><span class="lnt">2161
</span><span class="lnt">2162
</span><span class="lnt">2163
</span><span class="lnt">2164
</span><span class="lnt">2165
</span><span class="lnt">2166
</span><span class="lnt">2167
</span><span class="lnt">2168
</span><span class="lnt">2169
</span><span class="lnt">2170
</span><span class="lnt">2171
</span><span class="lnt">2172
</span><span class="lnt">2173
</span><span class="lnt">2174
</span><span class="lnt">2175
</span><span class="lnt">2176
</span><span class="lnt">2177
</span><span class="lnt">2178
</span><span class="lnt">2179
</span><span class="lnt">2180
</span><span class="lnt">2181
</span><span class="lnt">2182
</span><span class="lnt">2183
</span><span class="lnt">2184
</span><span class="lnt">2185
</span><span class="lnt">2186
</span><span class="lnt">2187
</span><span class="lnt">2188
</span><span class="lnt">2189
</span><span class="lnt">2190
</span><span class="lnt">2191
</span><span class="lnt">2192
</span><span class="lnt">2193
</span><span class="lnt">2194
</span><span class="lnt">2195
</span><span class="lnt">2196
</span><span class="lnt">2197
</span><span class="lnt">2198
</span><span class="lnt">2199
</span><span class="lnt">2200
</span><span class="lnt">2201
</span><span class="lnt">2202
</span><span class="lnt">2203
</span><span class="lnt">2204
</span><span class="lnt">2205
</span><span class="lnt">2206
</span><span class="lnt">2207
</span><span class="lnt">2208
</span><span class="lnt">2209
</span><span class="lnt">2210
</span><span class="lnt">2211
</span><span class="lnt">2212
</span><span class="lnt">2213
</span><span class="lnt">2214
</span><span class="lnt">2215
</span><span class="lnt">2216
</span><span class="lnt">2217
</span><span class="lnt">2218
</span><span class="lnt">2219
</span><span class="lnt">2220
</span><span class="lnt">2221
</span><span class="lnt">2222
</span><span class="lnt">2223
</span><span class="lnt">2224
</span><span class="lnt">2225
</span><span class="lnt">2226
</span><span class="lnt">2227
</span><span class="lnt">2228
</span><span class="lnt">2229
</span><span class="lnt">2230
</span><span class="lnt">2231
</span><span class="lnt">2232
</span><span class="lnt">2233
</span><span class="lnt">2234
</span><span class="lnt">2235
</span><span class="lnt">2236
</span><span class="lnt">2237
</span><span class="lnt">2238
</span><span class="lnt">2239
</span><span class="lnt">2240
</span><span class="lnt">2241
</span><span class="lnt">2242
</span><span class="lnt">2243
</span><span class="lnt">2244
</span><span class="lnt">2245
</span><span class="lnt">2246
</span><span class="lnt">2247
</span><span class="lnt">2248
</span><span class="lnt">2249
</span><span class="lnt">2250
</span><span class="lnt">2251
</span><span class="lnt">2252
</span><span class="lnt">2253
</span><span class="lnt">2254
</span><span class="lnt">2255
</span><span class="lnt">2256
</span><span class="lnt">2257
</span><span class="lnt">2258
</span><span class="lnt">2259
</span><span class="lnt">2260
</span><span class="lnt">2261
</span><span class="lnt">2262
</span><span class="lnt">2263
</span><span class="lnt">2264
</span><span class="lnt">2265
</span><span class="lnt">2266
</span><span class="lnt">2267
</span><span class="lnt">2268
</span><span class="lnt">2269
</span><span class="lnt">2270
</span><span class="lnt">2271
</span><span class="lnt">2272
</span><span class="lnt">2273
</span><span class="lnt">2274
</span><span class="lnt">2275
</span><span class="lnt">2276
</span><span class="lnt">2277
</span><span class="lnt">2278
</span><span class="lnt">2279
</span><span class="lnt">2280
</span><span class="lnt">2281
</span><span class="lnt">2282
</span><span class="lnt">2283
</span><span class="lnt">2284
</span><span class="lnt">2285
</span><span class="lnt">2286
</span><span class="lnt">2287
</span><span class="lnt">2288
</span><span class="lnt">2289
</span><span class="lnt">2290
</span><span class="lnt">2291
</span><span class="lnt">2292
</span><span class="lnt">2293
</span><span class="lnt">2294
</span><span class="lnt">2295
</span><span class="lnt">2296
</span><span class="lnt">2297
</span><span class="lnt">2298
</span><span class="lnt">2299
</span><span class="lnt">2300
</span><span class="lnt">2301
</span><span class="lnt">2302
</span><span class="lnt">2303
</span><span class="lnt">2304
</span><span class="lnt">2305
</span><span class="lnt">2306
</span><span class="lnt">2307
</span><span class="lnt">2308
</span><span class="lnt">2309
</span><span class="lnt">2310
</span><span class="lnt">2311
</span><span class="lnt">2312
</span><span class="lnt">2313
</span><span class="lnt">2314
</span><span class="lnt">2315
</span><span class="lnt">2316
</span><span class="lnt">2317
</span><span class="lnt">2318
</span><span class="lnt">2319
</span><span class="lnt">2320
</span><span class="lnt">2321
</span><span class="lnt">2322
</span><span class="lnt">2323
</span><span class="lnt">2324
</span><span class="lnt">2325
</span><span class="lnt">2326
</span><span class="lnt">2327
</span><span class="lnt">2328
</span><span class="lnt">2329
</span><span class="lnt">2330
</span><span class="lnt">2331
</span><span class="lnt">2332
</span><span class="lnt">2333
</span><span class="lnt">2334
</span><span class="lnt">2335
</span><span class="lnt">2336
</span><span class="lnt">2337
</span><span class="lnt">2338
</span><span class="lnt">2339
</span><span class="lnt">2340
</span><span class="lnt">2341
</span><span class="lnt">2342
</span><span class="lnt">2343
</span><span class="lnt">2344
</span><span class="lnt">2345
</span><span class="lnt">2346
</span><span class="lnt">2347
</span><span class="lnt">2348
</span><span class="lnt">2349
</span><span class="lnt">2350
</span><span class="lnt">2351
</span><span class="lnt">2352
</span><span class="lnt">2353
</span><span class="lnt">2354
</span><span class="lnt">2355
</span><span class="lnt">2356
</span><span class="lnt">2357
</span><span class="lnt">2358
</span><span class="lnt">2359
</span><span class="lnt">2360
</span><span class="lnt">2361
</span><span class="lnt">2362
</span><span class="lnt">2363
</span><span class="lnt">2364
</span><span class="lnt">2365
</span><span class="lnt">2366
</span><span class="lnt">2367
</span><span class="lnt">2368
</span><span class="lnt">2369
</span><span class="lnt">2370
</span><span class="lnt">2371
</span><span class="lnt">2372
</span><span class="lnt">2373
</span><span class="lnt">2374
</span><span class="lnt">2375
</span><span class="lnt">2376
</span><span class="lnt">2377
</span><span class="lnt">2378
</span><span class="lnt">2379
</span><span class="lnt">2380
</span><span class="lnt">2381
</span><span class="lnt">2382
</span><span class="lnt">2383
</span><span class="lnt">2384
</span><span class="lnt">2385
</span><span class="lnt">2386
</span><span class="lnt">2387
</span><span class="lnt">2388
</span><span class="lnt">2389
</span><span class="lnt">2390
</span><span class="lnt">2391
</span><span class="lnt">2392
</span><span class="lnt">2393
</span><span class="lnt">2394
</span><span class="lnt">2395
</span><span class="lnt">2396
</span><span class="lnt">2397
</span><span class="lnt">2398
</span><span class="lnt">2399
</span><span class="lnt">2400
</span><span class="lnt">2401
</span><span class="lnt">2402
</span><span class="lnt">2403
</span><span class="lnt">2404
</span><span class="lnt">2405
</span><span class="lnt">2406
</span><span class="lnt">2407
</span><span class="lnt">2408
</span><span class="lnt">2409
</span><span class="lnt">2410
</span><span class="lnt">2411
</span><span class="lnt">2412
</span><span class="lnt">2413
</span><span class="lnt">2414
</span><span class="lnt">2415
</span><span class="lnt">2416
</span><span class="lnt">2417
</span><span class="lnt">2418
</span><span class="lnt">2419
</span><span class="lnt">2420
</span><span class="lnt">2421
</span><span class="lnt">2422
</span><span class="lnt">2423
</span><span class="lnt">2424
</span><span class="lnt">2425
</span><span class="lnt">2426
</span><span class="lnt">2427
</span><span class="lnt">2428
</span><span class="lnt">2429
</span><span class="lnt">2430
</span><span class="lnt">2431
</span><span class="lnt">2432
</span><span class="lnt">2433
</span><span class="lnt">2434
</span><span class="lnt">2435
</span><span class="lnt">2436
</span><span class="lnt">2437
</span><span class="lnt">2438
</span><span class="lnt">2439
</span><span class="lnt">2440
</span><span class="lnt">2441
</span><span class="lnt">2442
</span><span class="lnt">2443
</span><span class="lnt">2444
</span><span class="lnt">2445
</span><span class="lnt">2446
</span><span class="lnt">2447
</span><span class="lnt">2448
</span><span class="lnt">2449
</span><span class="lnt">2450
</span><span class="lnt">2451
</span><span class="lnt">2452
</span><span class="lnt">2453
</span><span class="lnt">2454
</span><span class="lnt">2455
</span><span class="lnt">2456
</span><span class="lnt">2457
</span><span class="lnt">2458
</span><span class="lnt">2459
</span><span class="lnt">2460
</span><span class="lnt">2461
</span><span class="lnt">2462
</span><span class="lnt">2463
</span><span class="lnt">2464
</span><span class="lnt">2465
</span><span class="lnt">2466
</span><span class="lnt">2467
</span><span class="lnt">2468
</span><span class="lnt">2469
</span><span class="lnt">2470
</span><span class="lnt">2471
</span><span class="lnt">2472
</span><span class="lnt">2473
</span><span class="lnt">2474
</span><span class="lnt">2475
</span><span class="lnt">2476
</span><span class="lnt">2477
</span><span class="lnt">2478
</span><span class="lnt">2479
</span><span class="lnt">2480
</span><span class="lnt">2481
</span><span class="lnt">2482
</span><span class="lnt">2483
</span><span class="lnt">2484
</span><span class="lnt">2485
</span><span class="lnt">2486
</span><span class="lnt">2487
</span><span class="lnt">2488
</span><span class="lnt">2489
</span><span class="lnt">2490
</span><span class="lnt">2491
</span><span class="lnt">2492
</span><span class="lnt">2493
</span><span class="lnt">2494
</span><span class="lnt">2495
</span><span class="lnt">2496
</span><span class="lnt">2497
</span><span class="lnt">2498
</span><span class="lnt">2499
</span><span class="lnt">2500
</span><span class="lnt">2501
</span><span class="lnt">2502
</span><span class="lnt">2503
</span><span class="lnt">2504
</span><span class="lnt">2505
</span><span class="lnt">2506
</span><span class="lnt">2507
</span><span class="lnt">2508
</span><span class="lnt">2509
</span><span class="lnt">2510
</span><span class="lnt">2511
</span><span class="lnt">2512
</span><span class="lnt">2513
</span><span class="lnt">2514
</span><span class="lnt">2515
</span><span class="lnt">2516
</span><span class="lnt">2517
</span><span class="lnt">2518
</span><span class="lnt">2519
</span><span class="lnt">2520
</span><span class="lnt">2521
</span><span class="lnt">2522
</span><span class="lnt">2523
</span><span class="lnt">2524
</span><span class="lnt">2525
</span><span class="lnt">2526
</span><span class="lnt">2527
</span><span class="lnt">2528
</span><span class="lnt">2529
</span><span class="lnt">2530
</span><span class="lnt">2531
</span><span class="lnt">2532
</span><span class="lnt">2533
</span><span class="lnt">2534
</span><span class="lnt">2535
</span><span class="lnt">2536
</span><span class="lnt">2537
</span><span class="lnt">2538
</span><span class="lnt">2539
</span><span class="lnt">2540
</span><span class="lnt">2541
</span><span class="lnt">2542
</span><span class="lnt">2543
</span><span class="lnt">2544
</span><span class="lnt">2545
</span><span class="lnt">2546
</span><span class="lnt">2547
</span><span class="lnt">2548
</span><span class="lnt">2549
</span><span class="lnt">2550
</span><span class="lnt">2551
</span><span class="lnt">2552
</span><span class="lnt">2553
</span><span class="lnt">2554
</span><span class="lnt">2555
</span><span class="lnt">2556
</span><span class="lnt">2557
</span><span class="lnt">2558
</span><span class="lnt">2559
</span><span class="lnt">2560
</span><span class="lnt">2561
</span><span class="lnt">2562
</span><span class="lnt">2563
</span><span class="lnt">2564
</span><span class="lnt">2565
</span><span class="lnt">2566
</span><span class="lnt">2567
</span><span class="lnt">2568
</span><span class="lnt">2569
</span><span class="lnt">2570
</span><span class="lnt">2571
</span><span class="lnt">2572
</span><span class="lnt">2573
</span><span class="lnt">2574
</span><span class="lnt">2575
</span><span class="lnt">2576
</span><span class="lnt">2577
</span><span class="lnt">2578
</span><span class="lnt">2579
</span><span class="lnt">2580
</span><span class="lnt">2581
</span><span class="lnt">2582
</span><span class="lnt">2583
</span><span class="lnt">2584
</span><span class="lnt">2585
</span><span class="lnt">2586
</span><span class="lnt">2587
</span><span class="lnt">2588
</span><span class="lnt">2589
</span><span class="lnt">2590
</span><span class="lnt">2591
</span><span class="lnt">2592
</span><span class="lnt">2593
</span><span class="lnt">2594
</span><span class="lnt">2595
</span><span class="lnt">2596
</span><span class="lnt">2597
</span><span class="lnt">2598
</span><span class="lnt">2599
</span><span class="lnt">2600
</span><span class="lnt">2601
</span><span class="lnt">2602
</span><span class="lnt">2603
</span><span class="lnt">2604
</span><span class="lnt">2605
</span><span class="lnt">2606
</span><span class="lnt">2607
</span><span class="lnt">2608
</span><span class="lnt">2609
</span><span class="lnt">2610
</span><span class="lnt">2611
</span><span class="lnt">2612
</span><span class="lnt">2613
</span><span class="lnt">2614
</span><span class="lnt">2615
</span><span class="lnt">2616
</span><span class="lnt">2617
</span><span class="lnt">2618
</span><span class="lnt">2619
</span><span class="lnt">2620
</span><span class="lnt">2621
</span><span class="lnt">2622
</span><span class="lnt">2623
</span><span class="lnt">2624
</span><span class="lnt">2625
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="c1">// Generated by the protocol buffer compiler.  DO NOT EDIT!
</span><span class="c1">// source: Student.proto
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nn">com.clover.netty.codec2</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MyDataInfo</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nf">MyDataInfo</span><span class="o">()</span> <span class="o">{}</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerAllExtensions</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">registerAllExtensions</span><span class="o">(</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">registerAllExtensions</span><span class="o">(</span>
        <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span><span class="o">)</span> <span class="n">registry</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MyMessageOrBuilder</span> <span class="kd">extends</span>
      <span class="c1">// @@protoc_insertion_point(interface_extends:MyMessage)
</span><span class="c1"></span>      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">MessageOrBuilder</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * 用data_type来标识传的是哪一个枚举类型
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;.MyMessage.DateType data_type = 1;&lt;/code&gt;
</span><span class="cm">     * @return The enum numeric value on the wire for dataType.
</span><span class="cm">     */</span>
    <span class="kt">int</span> <span class="nf">getDataTypeValue</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * 用data_type来标识传的是哪一个枚举类型
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;.MyMessage.DateType data_type = 1;&lt;/code&gt;
</span><span class="cm">     * @return The dataType.
</span><span class="cm">     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span> <span class="nf">getDataType</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">     * @return Whether the student field is set.
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">hasStudent</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">     * @return The student.
</span><span class="cm">     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getStudent</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span> <span class="nf">getStudentOrBuilder</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">     * @return Whether the worker field is set.
</span><span class="cm">     */</span>
    <span class="kt">boolean</span> <span class="nf">hasWorker</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">     * @return The worker.
</span><span class="cm">     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getWorker</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span> <span class="nf">getWorkerOrBuilder</span><span class="o">();</span>

    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DataBodyCase</span> <span class="nf">getDataBodyCase</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="cm">/**
</span><span class="cm">   * &lt;pre&gt;
</span><span class="cm">   * protobuf 可以使用message管理其它的message
</span><span class="cm">   * &lt;/pre&gt;
</span><span class="cm">   *
</span><span class="cm">   * Protobuf type {@code MyMessage}
</span><span class="cm">   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MyMessage</span> <span class="kd">extends</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span> <span class="kd">implements</span>
      <span class="c1">// @@protoc_insertion_point(message_implements:MyMessage)
</span><span class="c1"></span>      <span class="n">MyMessageOrBuilder</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
    <span class="c1">// Use MyMessage.newBuilder() to construct.
</span><span class="c1"></span>    <span class="kd">private</span> <span class="nf">MyMessage</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">builder</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="nf">MyMessage</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">dataType_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">&#34;unused&#34;</span><span class="o">})</span>
    <span class="kd">protected</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="nf">newInstance</span><span class="o">(</span>
        <span class="n">UnusedPrivateParameter</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">MyMessage</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span>
    <span class="nf">getUnknownFields</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="nf">MyMessage</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">extensionRegistry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NullPointerException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">unknownFields</span> <span class="o">=</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readTag</span><span class="o">();</span>
          <span class="k">switch</span> <span class="o">(</span><span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">0</span><span class="o">:</span>
              <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">8</span><span class="o">:</span> <span class="o">{</span>
              <span class="kt">int</span> <span class="n">rawValue</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readEnum</span><span class="o">();</span>

              <span class="n">dataType_</span> <span class="o">=</span> <span class="n">rawValue</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="n">18</span><span class="o">:</span> <span class="o">{</span>
              <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span> <span class="n">subBuilder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">subBuilder</span> <span class="o">=</span> <span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">).</span><span class="na">toBuilder</span><span class="o">();</span>
              <span class="o">}</span>
              <span class="n">dataBody_</span> <span class="o">=</span>
                  <span class="n">input</span><span class="o">.</span><span class="na">readMessage</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">parser</span><span class="o">(),</span> <span class="n">extensionRegistry</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">subBuilder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">subBuilder</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
                <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">subBuilder</span><span class="o">.</span><span class="na">buildPartial</span><span class="o">();</span>
              <span class="o">}</span>
              <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="n">26</span><span class="o">:</span> <span class="o">{</span>
              <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span> <span class="n">subBuilder</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">subBuilder</span> <span class="o">=</span> <span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">).</span><span class="na">toBuilder</span><span class="o">();</span>
              <span class="o">}</span>
              <span class="n">dataBody_</span> <span class="o">=</span>
                  <span class="n">input</span><span class="o">.</span><span class="na">readMessage</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">parser</span><span class="o">(),</span> <span class="n">extensionRegistry</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">subBuilder</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">subBuilder</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
                <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">subBuilder</span><span class="o">.</span><span class="na">buildPartial</span><span class="o">();</span>
              <span class="o">}</span>
              <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">default</span><span class="o">:</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">parseUnknownField</span><span class="o">(</span>
                  <span class="n">input</span><span class="o">,</span> <span class="n">unknownFields</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">,</span> <span class="n">tag</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="o">}</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span><span class="o">(</span>
            <span class="n">e</span><span class="o">).</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span> <span class="o">=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">makeExtensionsImmutable</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
        <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_MyMessage_descriptor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
        <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_MyMessage_fieldAccessorTable</span>
          <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
              <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * 定义一个枚举类型
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * Protobuf enum {@code MyMessage.DateType}
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="n">DateType</span>
        <span class="kd">implements</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ProtocolMessageEnum</span> <span class="o">{</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * 在proto3中，要求enmu下属性的编号从0开始
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;StudentType = 0;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="n">StudentType</span><span class="o">(</span><span class="n">0</span><span class="o">),</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;WorkerType = 1;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="n">WorkerType</span><span class="o">(</span><span class="n">1</span><span class="o">),</span>
      <span class="n">UNRECOGNIZED</span><span class="o">(-</span><span class="n">1</span><span class="o">),</span>
      <span class="o">;</span>

      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * 在proto3中，要求enmu下属性的编号从0开始
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;StudentType = 0;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">StudentType_VALUE</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;WorkerType = 1;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WorkerType_VALUE</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>


      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getNumber</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">UNRECOGNIZED</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalArgumentException</span><span class="o">(</span>
              <span class="s">&#34;Can&#39;t get the number of an unknown enum value.&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="cm">/**
</span><span class="cm">       * @param value The numeric wire value of the corresponding enum entry.
</span><span class="cm">       * @return The enum associated with the given numeric wire value.
</span><span class="cm">       * @deprecated Use {@link #forNumber(int)} instead.
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Deprecated</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="n">DateType</span> <span class="nf">valueOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">forNumber</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="cm">/**
</span><span class="cm">       * @param value The numeric wire value of the corresponding enum entry.
</span><span class="cm">       * @return The enum associated with the given numeric wire value.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="n">DateType</span> <span class="nf">forNumber</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">case</span> <span class="n">0</span><span class="o">:</span> <span class="k">return</span> <span class="n">StudentType</span><span class="o">;</span>
          <span class="k">case</span> <span class="n">1</span><span class="o">:</span> <span class="k">return</span> <span class="n">WorkerType</span><span class="o">;</span>
          <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Internal</span><span class="o">.</span><span class="na">EnumLiteMap</span><span class="o">&lt;</span><span class="n">DateType</span><span class="o">&gt;</span>
          <span class="nf">internalGetValueMap</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">internalValueMap</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Internal</span><span class="o">.</span><span class="na">EnumLiteMap</span><span class="o">&lt;</span>
          <span class="n">DateType</span><span class="o">&gt;</span> <span class="n">internalValueMap</span> <span class="o">=</span>
            <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Internal</span><span class="o">.</span><span class="na">EnumLiteMap</span><span class="o">&lt;</span><span class="n">DateType</span><span class="o">&gt;()</span> <span class="o">{</span>
              <span class="kd">public</span> <span class="n">DateType</span> <span class="nf">findValueByNumber</span><span class="o">(</span><span class="kt">int</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">DateType</span><span class="o">.</span><span class="na">forNumber</span><span class="o">(</span><span class="n">number</span><span class="o">);</span>
              <span class="o">}</span>
            <span class="o">};</span>

      <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">EnumValueDescriptor</span>
          <span class="nf">getValueDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span> <span class="o">==</span> <span class="n">UNRECOGNIZED</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalStateException</span><span class="o">(</span>
              <span class="s">&#34;Can&#39;t get the descriptor of an unrecognized enum value.&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">getDescriptor</span><span class="o">().</span><span class="na">getValues</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">ordinal</span><span class="o">());</span>
      <span class="o">}</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">EnumDescriptor</span>
          <span class="nf">getDescriptorForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">getDescriptor</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">EnumDescriptor</span>
          <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">().</span><span class="na">getEnumTypes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">DateType</span><span class="o">[]</span> <span class="n">VALUES</span> <span class="o">=</span> <span class="n">values</span><span class="o">();</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="n">DateType</span> <span class="nf">valueOf</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">EnumValueDescriptor</span> <span class="n">desc</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">desc</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">!=</span> <span class="n">getDescriptor</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">IllegalArgumentException</span><span class="o">(</span>
            <span class="s">&#34;EnumValueDescriptor is not for this type.&#34;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">desc</span><span class="o">.</span><span class="na">getIndex</span><span class="o">()</span> <span class="o">==</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">UNRECOGNIZED</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">VALUES</span><span class="o">[</span><span class="n">desc</span><span class="o">.</span><span class="na">getIndex</span><span class="o">()];</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>

      <span class="kd">private</span> <span class="nf">DateType</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="c1">// @@protoc_insertion_point(enum_scope:MyMessage.DateType)
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">dataBody_</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="n">DataBodyCase</span>
        <span class="kd">implements</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Internal</span><span class="o">.</span><span class="na">EnumLite</span><span class="o">,</span>
            <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">AbstractMessage</span><span class="o">.</span><span class="na">InternalOneOfEnum</span> <span class="o">{</span>
      <span class="n">STUDENT</span><span class="o">(</span><span class="n">2</span><span class="o">),</span>
      <span class="n">WORKER</span><span class="o">(</span><span class="n">3</span><span class="o">),</span>
      <span class="n">DATABODY_NOT_SET</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
      <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">value</span><span class="o">;</span>
      <span class="kd">private</span> <span class="nf">DataBodyCase</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * @param value The number of the enum to look for.
</span><span class="cm">       * @return The enum associated with the given number.
</span><span class="cm">       * @deprecated Use {@link #forNumber(int)} instead.
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Deprecated</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="n">DataBodyCase</span> <span class="nf">valueOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">forNumber</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="kd">static</span> <span class="n">DataBodyCase</span> <span class="nf">forNumber</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">value</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">case</span> <span class="n">2</span><span class="o">:</span> <span class="k">return</span> <span class="n">STUDENT</span><span class="o">;</span>
          <span class="k">case</span> <span class="n">3</span><span class="o">:</span> <span class="k">return</span> <span class="n">WORKER</span><span class="o">;</span>
          <span class="k">case</span> <span class="n">0</span><span class="o">:</span> <span class="k">return</span> <span class="n">DATABODY_NOT_SET</span><span class="o">;</span>
          <span class="k">default</span><span class="o">:</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getNumber</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="n">DataBodyCase</span>
    <span class="nf">getDataBodyCase</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DataBodyCase</span><span class="o">.</span><span class="na">forNumber</span><span class="o">(</span>
          <span class="n">dataBodyCase_</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">DATA_TYPE_FIELD_NUMBER</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">dataType_</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * 用data_type来标识传的是哪一个枚举类型
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;.MyMessage.DateType data_type = 1;&lt;/code&gt;
</span><span class="cm">     * @return The enum numeric value on the wire for dataType.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getDataTypeValue</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">dataType_</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * 用data_type来标识传的是哪一个枚举类型
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;.MyMessage.DateType data_type = 1;&lt;/code&gt;
</span><span class="cm">     * @return The dataType.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span> <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span> <span class="nf">getDataType</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;deprecation&#34;</span><span class="o">)</span>
      <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span> <span class="n">result</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">dataType_</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span><span class="o">.</span><span class="na">UNRECOGNIZED</span> <span class="o">:</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">STUDENT_FIELD_NUMBER</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">     * @return Whether the student field is set.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasStudent</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">     * @return The student.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getStudent</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span> <span class="nf">getStudentOrBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">WORKER_FIELD_NUMBER</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">     * @return Whether the worker field is set.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasWorker</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">     * @return The worker.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getWorker</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span> <span class="nf">getWorkerOrBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">byte</span> <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">byte</span> <span class="n">isInitialized</span> <span class="o">=</span> <span class="n">memoizedIsInitialized</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="n">1</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

      <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeTo</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span> <span class="n">output</span><span class="o">)</span>
                        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataType_</span> <span class="o">!=</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span><span class="o">.</span><span class="na">StudentType</span><span class="o">.</span><span class="na">getNumber</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeEnum</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">dataType_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeMessage</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeMessage</span><span class="o">(</span><span class="n">3</span><span class="o">,</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">unknownFields</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSerializedSize</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">memoizedSize</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="k">return</span> <span class="n">size</span><span class="o">;</span>

      <span class="n">size</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataType_</span> <span class="o">!=</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span><span class="o">.</span><span class="na">StudentType</span><span class="o">.</span><span class="na">getNumber</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeEnumSize</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">dataType_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeMessageSize</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeMessageSize</span><span class="o">(</span><span class="n">3</span><span class="o">,</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">size</span> <span class="o">+=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">getSerializedSize</span><span class="o">();</span>
      <span class="n">memoizedSize</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">dataType_</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">dataType_</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getDataBodyCase</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getDataBodyCase</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">switch</span> <span class="o">(</span><span class="n">dataBodyCase_</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">2</span><span class="o">:</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">getStudent</span><span class="o">()</span>
              <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getStudent</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">3</span><span class="o">:</span>
          <span class="k">if</span> <span class="o">(!</span><span class="n">getWorker</span><span class="o">()</span>
              <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getWorker</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">0</span><span class="o">:</span>
        <span class="k">default</span><span class="o">:</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">unknownFields</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">memoizedHashCode</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">memoizedHashCode</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">41</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">19</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getDescriptor</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">DATA_TYPE_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">dataType_</span><span class="o">;</span>
      <span class="k">switch</span> <span class="o">(</span><span class="n">dataBodyCase_</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">2</span><span class="o">:</span>
          <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">STUDENT_FIELD_NUMBER</span><span class="o">;</span>
          <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getStudent</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">3</span><span class="o">:</span>
          <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">WORKER_FIELD_NUMBER</span><span class="o">;</span>
          <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getWorker</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
          <span class="k">break</span><span class="o">;</span>
        <span class="k">case</span> <span class="n">0</span><span class="o">:</span>
        <span class="k">default</span><span class="o">:</span>
      <span class="o">}</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">29</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">memoizedHashCode</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">newBuilderForType</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">newBuilder</span><span class="o">();</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Builder</span> <span class="nf">newBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Builder</span> <span class="nf">newBuilder</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">prototype</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">prototype</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">toBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="n">DEFAULT_INSTANCE</span>
          <span class="o">?</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">protected</span> <span class="n">Builder</span> <span class="nf">newBuilderForType</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">builder</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * protobuf 可以使用message管理其它的message
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * Protobuf type {@code MyMessage}
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="kd">extends</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="n">Builder</span><span class="o">&gt;</span> <span class="kd">implements</span>
        <span class="c1">// @@protoc_insertion_point(builder_implements:MyMessage)
</span><span class="c1"></span>        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessageOrBuilder</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
          <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_MyMessage_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
          <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_MyMessage_fieldAccessorTable</span>
            <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
                <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// Construct using com.clover.netty.codec2.MyDataInfo.MyMessage.newBuilder()
</span><span class="c1"></span>      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="kd">private</span> <span class="kt">void</span> <span class="nf">maybeForceBuilderInitialization</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
                <span class="o">.</span><span class="na">alwaysUseFieldBuilders</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">dataType_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
          <span class="nf">getDescriptorForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_MyMessage_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">result</span> <span class="o">=</span> <span class="n">buildPartial</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">result</span><span class="o">.</span><span class="na">isInitialized</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="n">newUninitializedMessageException</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">buildPartial</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">dataType_</span> <span class="o">=</span> <span class="n">dataType_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">dataBody_</span> <span class="o">=</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">dataBody_</span> <span class="o">=</span> <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">dataBody_</span> <span class="o">=</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">result</span><span class="o">.</span><span class="na">dataBody_</span> <span class="o">=</span> <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">result</span><span class="o">.</span><span class="na">dataBodyCase_</span> <span class="o">=</span> <span class="n">dataBodyCase_</span><span class="o">;</span>
        <span class="n">onBuilt</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearField</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearOneof</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">OneofDescriptor</span> <span class="n">oneof</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearOneof</span><span class="o">(</span><span class="n">oneof</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setRepeatedField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">addRepeatedField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">addRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Message</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">mergeFrom</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">)</span><span class="n">other</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">other</span><span class="o">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="o">==</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">dataType_</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">setDataTypeValue</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getDataTypeValue</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">switch</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getDataBodyCase</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">case</span> <span class="n">STUDENT</span><span class="o">:</span> <span class="o">{</span>
            <span class="n">mergeStudent</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getStudent</span><span class="o">());</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">case</span> <span class="n">WORKER</span><span class="o">:</span> <span class="o">{</span>
            <span class="n">mergeWorker</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getWorker</span><span class="o">());</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">case</span> <span class="n">DATABODY_NOT_SET</span><span class="o">:</span> <span class="o">{</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">);</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
          <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">parsedMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parsePartialFrom</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">)</span> <span class="n">e</span><span class="o">.</span><span class="na">getUnfinishedMessage</span><span class="o">();</span>
          <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">unwrapIOException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">parsedMessage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mergeFrom</span><span class="o">(</span><span class="n">parsedMessage</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kd">private</span> <span class="kt">int</span> <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
      <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">dataBody_</span><span class="o">;</span>
      <span class="kd">public</span> <span class="n">DataBodyCase</span>
          <span class="nf">getDataBodyCase</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">DataBodyCase</span><span class="o">.</span><span class="na">forNumber</span><span class="o">(</span>
            <span class="n">dataBodyCase_</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearDataBody</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>


      <span class="kd">private</span> <span class="kt">int</span> <span class="n">dataType_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * 用data_type来标识传的是哪一个枚举类型
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;.MyMessage.DateType data_type = 1;&lt;/code&gt;
</span><span class="cm">       * @return The enum numeric value on the wire for dataType.
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Override</span> <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getDataTypeValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dataType_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * 用data_type来标识传的是哪一个枚举类型
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;.MyMessage.DateType data_type = 1;&lt;/code&gt;
</span><span class="cm">       * @param value The enum numeric value on the wire for dataType to set.
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setDataTypeValue</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="n">dataType_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * 用data_type来标识传的是哪一个枚举类型
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;.MyMessage.DateType data_type = 1;&lt;/code&gt;
</span><span class="cm">       * @return The dataType.
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span> <span class="nf">getDataType</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;deprecation&#34;</span><span class="o">)</span>
        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span> <span class="n">result</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">dataType_</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span><span class="o">.</span><span class="na">UNRECOGNIZED</span> <span class="o">:</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * 用data_type来标识传的是哪一个枚举类型
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;.MyMessage.DateType data_type = 1;&lt;/code&gt;
</span><span class="cm">       * @param value The dataType to set.
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setDataType</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
        <span class="o">}</span>
        
        <span class="n">dataType_</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="na">getNumber</span><span class="o">();</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * 用data_type来标识传的是哪一个枚举类型
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;.MyMessage.DateType data_type = 1;&lt;/code&gt;
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearDataType</span><span class="o">()</span> <span class="o">{</span>
        
        <span class="n">dataType_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
          <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span><span class="o">&gt;</span> <span class="n">studentBuilder_</span><span class="o">;</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">       * @return Whether the student field is set.
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasStudent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">       * @return The student.
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getStudent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setStudent</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setStudent</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builderForValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">builderForValue</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">builderForValue</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeStudent</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span> <span class="o">&amp;&amp;</span>
              <span class="n">dataBody_</span> <span class="o">!=</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">)</span>
                <span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">value</span><span class="o">).</span><span class="na">buildPartial</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearStudent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">onChanged</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">getStudentBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">getStudentFieldBuilder</span><span class="o">().</span><span class="na">getBuilder</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span> <span class="nf">getStudentOrBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">studentBuilder_</span><span class="o">.</span><span class="na">getMessageOrBuilder</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Student student = 2;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">private</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
          <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span><span class="o">&gt;</span> 
          <span class="nf">getStudentFieldBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">studentBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(!(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">2</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="n">studentBuilder_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
              <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span><span class="o">&gt;(</span>
                  <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">,</span>
                  <span class="n">getParentForChildren</span><span class="o">(),</span>
                  <span class="n">isClean</span><span class="o">());</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();;</span>
        <span class="k">return</span> <span class="n">studentBuilder_</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
          <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span><span class="o">&gt;</span> <span class="n">workerBuilder_</span><span class="o">;</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">       * @return Whether the worker field is set.
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasWorker</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">       * @return The worker.
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getWorker</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">getMessage</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setWorker</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setWorker</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builderForValue</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">builderForValue</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">builderForValue</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeWorker</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span> <span class="o">&amp;&amp;</span>
              <span class="n">dataBody_</span> <span class="o">!=</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">)</span>
                <span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">value</span><span class="o">).</span><span class="na">buildPartial</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
          <span class="o">}</span>
          <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">setMessage</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearWorker</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">onChanged</span><span class="o">();</span>
          <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span> <span class="nf">getWorkerBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">getWorkerFieldBuilder</span><span class="o">().</span><span class="na">getBuilder</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span> <span class="nf">getWorkerOrBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">workerBuilder_</span><span class="o">.</span><span class="na">getMessageOrBuilder</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;.Worker worker = 3;&lt;/code&gt;
</span><span class="cm">       */</span>
      <span class="kd">private</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
          <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span><span class="o">&gt;</span> 
          <span class="nf">getWorkerFieldBuilder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">workerBuilder_</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(!(</span><span class="n">dataBodyCase_</span> <span class="o">==</span> <span class="n">3</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">dataBody_</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
          <span class="o">}</span>
          <span class="n">workerBuilder_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">SingleFieldBuilderV3</span><span class="o">&lt;</span>
              <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span><span class="o">&gt;(</span>
                  <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">dataBody_</span><span class="o">,</span>
                  <span class="n">getParentForChildren</span><span class="o">(),</span>
                  <span class="n">isClean</span><span class="o">());</span>
          <span class="n">dataBody_</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">dataBodyCase_</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();;</span>
        <span class="k">return</span> <span class="n">workerBuilder_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="n">Builder</span> <span class="nf">setUnknownFields</span><span class="o">(</span>
          <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="n">Builder</span> <span class="nf">mergeUnknownFields</span><span class="o">(</span>
          <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>


      <span class="c1">// @@protoc_insertion_point(builder_scope:MyMessage)
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="c1">// @@protoc_insertion_point(class_scope:MyMessage)
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="kd">static</span> <span class="o">{</span>
      <span class="n">DEFAULT_INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">getDefaultInstance</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">MyMessage</span><span class="o">&gt;</span>
        <span class="n">PARSER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">AbstractParser</span><span class="o">&lt;</span><span class="n">MyMessage</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">MyMessage</span> <span class="nf">parsePartialFrom</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
          <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">MyMessage</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">MyMessage</span><span class="o">&gt;</span> <span class="nf">parser</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">MyMessage</span><span class="o">&gt;</span> <span class="nf">getParserForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">StudentOrBuilder</span> <span class="kd">extends</span>
      <span class="c1">// @@protoc_insertion_point(interface_extends:Student)
</span><span class="c1"></span>      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">MessageOrBuilder</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * Student类的属性
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;int32 id = 1;&lt;/code&gt;
</span><span class="cm">     * @return The id.
</span><span class="cm">     */</span>
    <span class="kt">int</span> <span class="nf">getId</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * Student类的属性
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">     * @return The name.
</span><span class="cm">     */</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * Student类的属性
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">     * @return The bytes for name.
</span><span class="cm">     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
        <span class="nf">getNameBytes</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="cm">/**
</span><span class="cm">   * Protobuf type {@code Student}
</span><span class="cm">   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Student</span> <span class="kd">extends</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span> <span class="kd">implements</span>
      <span class="c1">// @@protoc_insertion_point(message_implements:Student)
</span><span class="c1"></span>      <span class="n">StudentOrBuilder</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
    <span class="c1">// Use Student.newBuilder() to construct.
</span><span class="c1"></span>    <span class="kd">private</span> <span class="nf">Student</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">builder</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="nf">Student</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">name_</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">&#34;unused&#34;</span><span class="o">})</span>
    <span class="kd">protected</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="nf">newInstance</span><span class="o">(</span>
        <span class="n">UnusedPrivateParameter</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">Student</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span>
    <span class="nf">getUnknownFields</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="nf">Student</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">extensionRegistry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NullPointerException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">unknownFields</span> <span class="o">=</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readTag</span><span class="o">();</span>
          <span class="k">switch</span> <span class="o">(</span><span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">0</span><span class="o">:</span>
              <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">8</span><span class="o">:</span> <span class="o">{</span>

              <span class="n">id_</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readInt32</span><span class="o">();</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="n">18</span><span class="o">:</span> <span class="o">{</span>
              <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readStringRequireUtf8</span><span class="o">();</span>

              <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">default</span><span class="o">:</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">parseUnknownField</span><span class="o">(</span>
                  <span class="n">input</span><span class="o">,</span> <span class="n">unknownFields</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">,</span> <span class="n">tag</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="o">}</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span><span class="o">(</span>
            <span class="n">e</span><span class="o">).</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span> <span class="o">=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">makeExtensionsImmutable</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
        <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
        <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Student_fieldAccessorTable</span>
          <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
              <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ID_FIELD_NUMBER</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id_</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * Student类的属性
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;int32 id = 1;&lt;/code&gt;
</span><span class="cm">     * @return The id.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">id_</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NAME_FIELD_NUMBER</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * Student类的属性
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">     * @return The name.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span> 
            <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;pre&gt;
</span><span class="cm">     * Student类的属性
</span><span class="cm">     * &lt;/pre&gt;
</span><span class="cm">     *
</span><span class="cm">     * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">     * @return The bytes for name.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
        <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span> 
            <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
                <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">byte</span> <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">byte</span> <span class="n">isInitialized</span> <span class="o">=</span> <span class="n">memoizedIsInitialized</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="n">1</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

      <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeTo</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span> <span class="n">output</span><span class="o">)</span>
                        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">id_</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeInt32</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">id_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="n">2</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">unknownFields</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSerializedSize</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">memoizedSize</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="k">return</span> <span class="n">size</span><span class="o">;</span>

      <span class="n">size</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">id_</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeInt32Size</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">id_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">computeStringSize</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">size</span> <span class="o">+=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">getSerializedSize</span><span class="o">();</span>
      <span class="n">memoizedSize</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(</span><span class="n">getId</span><span class="o">()</span>
          <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getName</span><span class="o">()</span>
          <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">unknownFields</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">memoizedHashCode</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">memoizedHashCode</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">41</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">19</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getDescriptor</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">ID_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getId</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">NAME_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getName</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">29</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">memoizedHashCode</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">newBuilderForType</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">newBuilder</span><span class="o">();</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Builder</span> <span class="nf">newBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Builder</span> <span class="nf">newBuilder</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">prototype</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">prototype</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">toBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="n">DEFAULT_INSTANCE</span>
          <span class="o">?</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">protected</span> <span class="n">Builder</span> <span class="nf">newBuilderForType</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">builder</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * Protobuf type {@code Student}
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="kd">extends</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="n">Builder</span><span class="o">&gt;</span> <span class="kd">implements</span>
        <span class="c1">// @@protoc_insertion_point(builder_implements:Student)
</span><span class="c1"></span>        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">StudentOrBuilder</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
          <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
          <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Student_fieldAccessorTable</span>
            <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
                <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// Construct using com.clover.netty.codec2.MyDataInfo.Student.newBuilder()
</span><span class="c1"></span>      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="kd">private</span> <span class="kt">void</span> <span class="nf">maybeForceBuilderInitialization</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
                <span class="o">.</span><span class="na">alwaysUseFieldBuilders</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

        <span class="n">name_</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
          <span class="nf">getDescriptorForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Student_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">result</span> <span class="o">=</span> <span class="n">buildPartial</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">result</span><span class="o">.</span><span class="na">isInitialized</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="n">newUninitializedMessageException</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">buildPartial</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">id_</span> <span class="o">=</span> <span class="n">id_</span><span class="o">;</span>
        <span class="n">result</span><span class="o">.</span><span class="na">name_</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="n">onBuilt</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearField</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearOneof</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">OneofDescriptor</span> <span class="n">oneof</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearOneof</span><span class="o">(</span><span class="n">oneof</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setRepeatedField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">addRepeatedField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">addRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Message</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">mergeFrom</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span><span class="n">other</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">other</span><span class="o">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="o">==</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">setId</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="na">name_</span><span class="o">;</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">);</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
          <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">parsedMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parsePartialFrom</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">)</span> <span class="n">e</span><span class="o">.</span><span class="na">getUnfinishedMessage</span><span class="o">();</span>
          <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">unwrapIOException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">parsedMessage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mergeFrom</span><span class="o">(</span><span class="n">parsedMessage</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kt">int</span> <span class="n">id_</span> <span class="o">;</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * Student类的属性
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
</span><span class="cm">       * @return The id.
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * Student类的属性
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
</span><span class="cm">       * @param value The id to set.
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="n">id_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * Student类的属性
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;int32 id = 1;&lt;/code&gt;
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearId</span><span class="o">()</span> <span class="o">{</span>
        
        <span class="n">id_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * Student类的属性
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">       * @return The name.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span>
              <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * Student类的属性
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">       * @return The bytes for name.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
          <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span> 
              <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
                  <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * Student类的属性
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">       * @param value The name to set.
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setName</span><span class="o">(</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
  <span class="o">}</span>
  
        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * Student类的属性
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearName</span><span class="o">()</span> <span class="o">{</span>
        
        <span class="n">name_</span> <span class="o">=</span> <span class="n">getDefaultInstance</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;pre&gt;
</span><span class="cm">       * Student类的属性
</span><span class="cm">       * &lt;/pre&gt;
</span><span class="cm">       *
</span><span class="cm">       * &lt;code&gt;string name = 2;&lt;/code&gt;
</span><span class="cm">       * @param value The bytes for name to set.
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setNameBytes</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="n">checkByteStringIsUtf8</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        
        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="n">Builder</span> <span class="nf">setUnknownFields</span><span class="o">(</span>
          <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="n">Builder</span> <span class="nf">mergeUnknownFields</span><span class="o">(</span>
          <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>


      <span class="c1">// @@protoc_insertion_point(builder_scope:Student)
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="c1">// @@protoc_insertion_point(class_scope:Student)
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="kd">static</span> <span class="o">{</span>
      <span class="n">DEFAULT_INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstance</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span>
        <span class="n">PARSER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">AbstractParser</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Student</span> <span class="nf">parsePartialFrom</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
          <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Student</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="nf">parser</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="nf">getParserForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">WorkerOrBuilder</span> <span class="kd">extends</span>
      <span class="c1">// @@protoc_insertion_point(interface_extends:Worker)
</span><span class="c1"></span>      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">MessageOrBuilder</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;string name = 1;&lt;/code&gt;
</span><span class="cm">     * @return The name.
</span><span class="cm">     */</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">();</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;string name = 1;&lt;/code&gt;
</span><span class="cm">     * @return The bytes for name.
</span><span class="cm">     */</span>
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
        <span class="nf">getNameBytes</span><span class="o">();</span>

    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;int32 age = 2;&lt;/code&gt;
</span><span class="cm">     * @return The age.
</span><span class="cm">     */</span>
    <span class="kt">int</span> <span class="nf">getAge</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="cm">/**
</span><span class="cm">   * Protobuf type {@code Worker}
</span><span class="cm">   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">extends</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span> <span class="kd">implements</span>
      <span class="c1">// @@protoc_insertion_point(message_implements:Worker)
</span><span class="c1"></span>      <span class="n">WorkerOrBuilder</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="n">0L</span><span class="o">;</span>
    <span class="c1">// Use Worker.newBuilder() to construct.
</span><span class="c1"></span>    <span class="kd">private</span> <span class="nf">Worker</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;?&gt;</span> <span class="n">builder</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">super</span><span class="o">(</span><span class="n">builder</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="nf">Worker</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">name_</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="nd">@SuppressWarnings</span><span class="o">({</span><span class="s">&#34;unused&#34;</span><span class="o">})</span>
    <span class="kd">protected</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="nf">newInstance</span><span class="o">(</span>
        <span class="n">UnusedPrivateParameter</span> <span class="n">unused</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span>
    <span class="nf">getUnknownFields</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">private</span> <span class="nf">Worker</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">extensionRegistry</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">NullPointerException</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">Builder</span> <span class="n">unknownFields</span> <span class="o">=</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">();</span>
      <span class="k">try</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="n">done</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">done</span><span class="o">)</span> <span class="o">{</span>
          <span class="kt">int</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readTag</span><span class="o">();</span>
          <span class="k">switch</span> <span class="o">(</span><span class="n">tag</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">case</span> <span class="n">0</span><span class="o">:</span>
              <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="k">case</span> <span class="n">10</span><span class="o">:</span> <span class="o">{</span>
              <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readStringRequireUtf8</span><span class="o">();</span>

              <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">case</span> <span class="n">16</span><span class="o">:</span> <span class="o">{</span>

              <span class="n">age_</span> <span class="o">=</span> <span class="n">input</span><span class="o">.</span><span class="na">readInt32</span><span class="o">();</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">default</span><span class="o">:</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(!</span><span class="n">parseUnknownField</span><span class="o">(</span>
                  <span class="n">input</span><span class="o">,</span> <span class="n">unknownFields</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">,</span> <span class="n">tag</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">done</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
              <span class="o">}</span>
              <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span><span class="o">(</span>
            <span class="n">e</span><span class="o">).</span><span class="na">setUnfinishedMessage</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">unknownFields</span> <span class="o">=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
        <span class="n">makeExtensionsImmutable</span><span class="o">();</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
        <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Worker_descriptor</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
        <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Worker_fieldAccessorTable</span>
          <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
              <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NAME_FIELD_NUMBER</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;string name = 1;&lt;/code&gt;
</span><span class="cm">     * @return The name.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span> 
            <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;string name = 1;&lt;/code&gt;
</span><span class="cm">     * @return The bytes for name.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
        <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
      <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span> 
            <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
                <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">AGE_FIELD_NUMBER</span> <span class="o">=</span> <span class="n">2</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">age_</span><span class="o">;</span>
    <span class="cm">/**
</span><span class="cm">     * &lt;code&gt;int32 age = 2;&lt;/code&gt;
</span><span class="cm">     * @return The age.
</span><span class="cm">     */</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">age_</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">byte</span> <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="o">-</span><span class="n">1</span><span class="o">;</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">byte</span> <span class="n">isInitialized</span> <span class="o">=</span> <span class="n">memoizedIsInitialized</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="n">1</span><span class="o">)</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">isInitialized</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>

      <span class="n">memoizedIsInitialized</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">writeTo</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span> <span class="n">output</span><span class="o">)</span>
                        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">writeString</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="n">1</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">age_</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">output</span><span class="o">.</span><span class="na">writeInt32</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">age_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">unknownFields</span><span class="o">.</span><span class="na">writeTo</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSerializedSize</span><span class="o">()</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">memoizedSize</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">size</span> <span class="o">!=</span> <span class="o">-</span><span class="n">1</span><span class="o">)</span> <span class="k">return</span> <span class="n">size</span><span class="o">;</span>

      <span class="n">size</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">getNameBytes</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">computeStringSize</span><span class="o">(</span><span class="n">1</span><span class="o">,</span> <span class="n">name_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">age_</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedOutputStream</span>
          <span class="o">.</span><span class="na">computeInt32Size</span><span class="o">(</span><span class="n">2</span><span class="o">,</span> <span class="n">age_</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">size</span> <span class="o">+=</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">getSerializedSize</span><span class="o">();</span>
      <span class="n">memoizedSize</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">size</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="o">(</span><span class="kd">final</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">obj</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="k">this</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="k">if</span> <span class="o">(!(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">obj</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">other</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">obj</span><span class="o">;</span>

      <span class="k">if</span> <span class="o">(!</span><span class="n">getName</span><span class="o">()</span>
          <span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">getAge</span><span class="o">()</span>
          <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="na">getAge</span><span class="o">())</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">(!</span><span class="n">unknownFields</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">))</span> <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">memoizedHashCode</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">memoizedHashCode</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">41</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">19</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getDescriptor</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">NAME_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getName</span><span class="o">().</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">37</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">AGE_FIELD_NUMBER</span><span class="o">;</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">53</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">getAge</span><span class="o">();</span>
      <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">29</span> <span class="o">*</span> <span class="n">hash</span><span class="o">)</span> <span class="o">+</span> <span class="n">unknownFields</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
      <span class="n">memoizedHashCode</span> <span class="o">=</span> <span class="n">hash</span><span class="o">;</span>
      <span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parseFrom</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseDelimitedFrom</span><span class="o">(</span>
        <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">InputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseDelimitedWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">parseFrom</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
          <span class="o">.</span><span class="na">parseWithIOException</span><span class="o">(</span><span class="n">PARSER</span><span class="o">,</span> <span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">newBuilderForType</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">newBuilder</span><span class="o">();</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Builder</span> <span class="nf">newBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Builder</span> <span class="nf">newBuilder</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">prototype</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">.</span><span class="na">toBuilder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">prototype</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">toBuilder</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">this</span> <span class="o">==</span> <span class="n">DEFAULT_INSTANCE</span>
          <span class="o">?</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">()</span> <span class="o">:</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">().</span><span class="na">mergeFrom</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">protected</span> <span class="n">Builder</span> <span class="nf">newBuilderForType</span><span class="o">(</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Builder</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">builder</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="cm">/**
</span><span class="cm">     * Protobuf type {@code Worker}
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="kd">extends</span>
        <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="n">Builder</span><span class="o">&gt;</span> <span class="kd">implements</span>
        <span class="c1">// @@protoc_insertion_point(builder_implements:Worker)
</span><span class="c1"></span>        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">WorkerOrBuilder</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
          <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Worker_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">protected</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
          <span class="nf">internalGetFieldAccessorTable</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Worker_fieldAccessorTable</span>
            <span class="o">.</span><span class="na">ensureFieldAccessorsInitialized</span><span class="o">(</span>
                <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="c1">// Construct using com.clover.netty.codec2.MyDataInfo.Worker.newBuilder()
</span><span class="c1"></span>      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="nf">Builder</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">BuilderParent</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
        <span class="n">maybeForceBuilderInitialization</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="kd">private</span> <span class="kt">void</span> <span class="nf">maybeForceBuilderInitialization</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span>
                <span class="o">.</span><span class="na">alwaysUseFieldBuilders</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clear</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
        <span class="n">name_</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>

        <span class="n">age_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
          <span class="nf">getDescriptorForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">internal_static_Worker_descriptor</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">result</span> <span class="o">=</span> <span class="n">buildPartial</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">result</span><span class="o">.</span><span class="na">isInitialized</span><span class="o">())</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="n">newUninitializedMessageException</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">buildPartial</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
        <span class="n">result</span><span class="o">.</span><span class="na">name_</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="n">result</span><span class="o">.</span><span class="na">age_</span> <span class="o">=</span> <span class="n">age_</span><span class="o">;</span>
        <span class="n">onBuilt</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clone</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clone</span><span class="o">();</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearField</span><span class="o">(</span><span class="n">field</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearOneof</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">OneofDescriptor</span> <span class="n">oneof</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">clearOneof</span><span class="o">(</span><span class="n">oneof</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setRepeatedField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">index</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">addRepeatedField</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FieldDescriptor</span> <span class="n">field</span><span class="o">,</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">addRepeatedField</span><span class="o">(</span><span class="n">field</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Message</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="k">instanceof</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">mergeFrom</span><span class="o">((</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span><span class="n">other</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">mergeFrom</span><span class="o">(</span><span class="n">other</span><span class="o">);</span>
          <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">other</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span> <span class="o">==</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">())</span> <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">other</span><span class="o">.</span><span class="na">getName</span><span class="o">().</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="na">name_</span><span class="o">;</span>
          <span class="n">onChanged</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getAge</span><span class="o">()</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">setAge</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">unknownFields</span><span class="o">);</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">isInitialized</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">mergeFrom</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
          <span class="kd">throws</span> <span class="n">java</span><span class="o">.</span><span class="na">io</span><span class="o">.</span><span class="na">IOException</span> <span class="o">{</span>
        <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">parsedMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="n">PARSER</span><span class="o">.</span><span class="na">parsePartialFrom</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">parsedMessage</span> <span class="o">=</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">)</span> <span class="n">e</span><span class="o">.</span><span class="na">getUnfinishedMessage</span><span class="o">();</span>
          <span class="k">throw</span> <span class="n">e</span><span class="o">.</span><span class="na">unwrapIOException</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">parsedMessage</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mergeFrom</span><span class="o">(</span><span class="n">parsedMessage</span><span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">name_</span> <span class="o">=</span> <span class="s">&#34;&#34;</span><span class="o">;</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;string name = 1;&lt;/code&gt;
</span><span class="cm">       * @return The name.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">))</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">bs</span> <span class="o">=</span>
              <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">s</span> <span class="o">=</span> <span class="n">bs</span><span class="o">.</span><span class="na">toStringUtf8</span><span class="o">();</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">s</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">s</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;string name = 1;&lt;/code&gt;
</span><span class="cm">       * @return The bytes for name.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span>
          <span class="nf">getNameBytes</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">Object</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">name_</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ref</span> <span class="k">instanceof</span> <span class="n">String</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">b</span> <span class="o">=</span> 
              <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">.</span><span class="na">copyFromUtf8</span><span class="o">(</span>
                  <span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">)</span> <span class="n">ref</span><span class="o">);</span>
          <span class="n">name_</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
          <span class="k">return</span> <span class="n">b</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="k">return</span> <span class="o">(</span><span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span><span class="o">)</span> <span class="n">ref</span><span class="o">;</span>
        <span class="o">}</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;string name = 1;&lt;/code&gt;
</span><span class="cm">       * @param value The name to set.
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setName</span><span class="o">(</span>
          <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
  <span class="o">}</span>
  
        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;string name = 1;&lt;/code&gt;
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearName</span><span class="o">()</span> <span class="o">{</span>
        
        <span class="n">name_</span> <span class="o">=</span> <span class="n">getDefaultInstance</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;string name = 1;&lt;/code&gt;
</span><span class="cm">       * @param value The bytes for name to set.
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setNameBytes</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ByteString</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="n">checkByteStringIsUtf8</span><span class="o">(</span><span class="n">value</span><span class="o">);</span>
        
        <span class="n">name_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>

      <span class="kd">private</span> <span class="kt">int</span> <span class="n">age_</span> <span class="o">;</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;int32 age = 2;&lt;/code&gt;
</span><span class="cm">       * @return The age.
</span><span class="cm">       */</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getAge</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">age_</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;int32 age = 2;&lt;/code&gt;
</span><span class="cm">       * @param value The age to set.
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">setAge</span><span class="o">(</span><span class="kt">int</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
        
        <span class="n">age_</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="cm">/**
</span><span class="cm">       * &lt;code&gt;int32 age = 2;&lt;/code&gt;
</span><span class="cm">       * @return This builder for chaining.
</span><span class="cm">       */</span>
      <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">clearAge</span><span class="o">()</span> <span class="o">{</span>
        
        <span class="n">age_</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
        <span class="n">onChanged</span><span class="o">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="n">Builder</span> <span class="nf">setUnknownFields</span><span class="o">(</span>
          <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">setUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="kd">final</span> <span class="n">Builder</span> <span class="nf">mergeUnknownFields</span><span class="o">(</span>
          <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">UnknownFieldSet</span> <span class="n">unknownFields</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">mergeUnknownFields</span><span class="o">(</span><span class="n">unknownFields</span><span class="o">);</span>
      <span class="o">}</span>


      <span class="c1">// @@protoc_insertion_point(builder_scope:Worker)
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="c1">// @@protoc_insertion_point(class_scope:Worker)
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="kd">static</span> <span class="o">{</span>
      <span class="n">DEFAULT_INSTANCE</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getDefaultInstance</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;</span>
        <span class="n">PARSER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">AbstractParser</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;()</span> <span class="o">{</span>
      <span class="nd">@java.lang.Override</span>
      <span class="kd">public</span> <span class="n">Worker</span> <span class="nf">parsePartialFrom</span><span class="o">(</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">CodedInputStream</span> <span class="n">input</span><span class="o">,</span>
          <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">ExtensionRegistryLite</span> <span class="n">extensionRegistry</span><span class="o">)</span>
          <span class="kd">throws</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">InvalidProtocolBufferException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">(</span><span class="n">input</span><span class="o">,</span> <span class="n">extensionRegistry</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">};</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;</span> <span class="nf">parser</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Parser</span><span class="o">&lt;</span><span class="n">Worker</span><span class="o">&gt;</span> <span class="nf">getParserForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">PARSER</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@java.lang.Override</span>
    <span class="kd">public</span> <span class="n">com</span><span class="o">.</span><span class="na">clover</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">codec2</span><span class="o">.</span><span class="na">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="nf">getDefaultInstanceForType</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">DEFAULT_INSTANCE</span><span class="o">;</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="n">internal_static_MyMessage_descriptor</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> 
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
      <span class="n">internal_static_MyMessage_fieldAccessorTable</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="n">internal_static_Student_descriptor</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> 
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
      <span class="n">internal_static_Student_fieldAccessorTable</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">Descriptor</span>
    <span class="n">internal_static_Worker_descriptor</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> 
    <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span>
      <span class="n">internal_static_Worker_fieldAccessorTable</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
      <span class="nf">getDescriptor</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">descriptor</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span>  <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
      <span class="n">descriptor</span><span class="o">;</span>
  <span class="kd">static</span> <span class="o">{</span>
    <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]</span> <span class="n">descriptorData</span> <span class="o">=</span> <span class="o">{</span>
      <span class="s">&#34;\n\rStudent.proto\&#34;\244\001\n\tMyMessage\022&amp;\n\tdata_ty&#34;</span> <span class="o">+</span>
      <span class="s">&#34;pe\030\001 \001(\0162\023.MyMessage.DateType\022\033\n\007student&#34;</span> <span class="o">+</span>
      <span class="s">&#34;\030\002 \001(\0132\010.StudentH\000\022\031\n\006worker\030\003 \001(\0132\007.Wor&#34;</span> <span class="o">+</span>
      <span class="s">&#34;kerH\000\&#34;+\n\010DateType\022\017\n\013StudentType\020\000\022\016\n\nWo&#34;</span> <span class="o">+</span>
      <span class="s">&#34;rkerType\020\001B\n\n\010dataBody\&#34;#\n\007Student\022\n\n\002id\030&#34;</span> <span class="o">+</span>
      <span class="s">&#34;\001 \001(\005\022\014\n\004name\030\002 \001(\t\&#34;#\n\006Worker\022\014\n\004name\030\001 &#34;</span> <span class="o">+</span>
      <span class="s">&#34;\001(\t\022\013\n\003age\030\002 \001(\005B\&#39;\n\027com.clover.netty.cod&#34;</span> <span class="o">+</span>
      <span class="s">&#34;ec2B\nMyDataInfoH\001b\006proto3&#34;</span>
    <span class="o">};</span>
    <span class="n">descriptor</span> <span class="o">=</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span>
      <span class="o">.</span><span class="na">internalBuildGeneratedFileFrom</span><span class="o">(</span><span class="n">descriptorData</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span><span class="o">[]</span> <span class="o">{</span>
        <span class="o">});</span>
    <span class="n">internal_static_MyMessage_descriptor</span> <span class="o">=</span>
      <span class="n">getDescriptor</span><span class="o">().</span><span class="na">getMessageTypes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="n">internal_static_MyMessage_fieldAccessorTable</span> <span class="o">=</span> <span class="k">new</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span><span class="o">(</span>
        <span class="n">internal_static_MyMessage_descriptor</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">&#34;DataType&#34;</span><span class="o">,</span> <span class="s">&#34;Student&#34;</span><span class="o">,</span> <span class="s">&#34;Worker&#34;</span><span class="o">,</span> <span class="s">&#34;DataBody&#34;</span><span class="o">,</span> <span class="o">});</span>
    <span class="n">internal_static_Student_descriptor</span> <span class="o">=</span>
      <span class="n">getDescriptor</span><span class="o">().</span><span class="na">getMessageTypes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
    <span class="n">internal_static_Student_fieldAccessorTable</span> <span class="o">=</span> <span class="k">new</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span><span class="o">(</span>
        <span class="n">internal_static_Student_descriptor</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">&#34;Id&#34;</span><span class="o">,</span> <span class="s">&#34;Name&#34;</span><span class="o">,</span> <span class="o">});</span>
    <span class="n">internal_static_Worker_descriptor</span> <span class="o">=</span>
      <span class="n">getDescriptor</span><span class="o">().</span><span class="na">getMessageTypes</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
    <span class="n">internal_static_Worker_fieldAccessorTable</span> <span class="o">=</span> <span class="k">new</span>
      <span class="n">com</span><span class="o">.</span><span class="na">google</span><span class="o">.</span><span class="na">protobuf</span><span class="o">.</span><span class="na">GeneratedMessageV3</span><span class="o">.</span><span class="na">FieldAccessorTable</span><span class="o">(</span>
        <span class="n">internal_static_Worker_descriptor</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">String</span><span class="o">[]</span> <span class="o">{</span> <span class="s">&#34;Name&#34;</span><span class="o">,</span> <span class="s">&#34;Age&#34;</span><span class="o">,</span> <span class="o">});</span>
  <span class="o">}</span>

  <span class="c1">// @@protoc_insertion_point(outer_class_scope)
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务器端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.codec2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.netty.codec.StudentPOJO</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.protobuf.ProtobufDecoder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="cm">/*
</span><span class="cm">       * 说明
</span><span class="cm">       * 1.创建两个线程组 bossGroup 和 workerGroup
</span><span class="cm">       * 2.bossGroup 只是处理连接请求，真正的和客户端业务处理，会交给 workerGroup 完成
</span><span class="cm">       * 3.两个线程组都是无线循环
</span><span class="cm">       */</span>
      <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>
      <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span> <span class="o">{</span>
          <span class="c1">// 创建服务器的启动对象，配置参数
</span><span class="c1"></span>          <span class="n">ServerBootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>

          <span class="c1">// 使用链式编程来进行设置
</span><span class="c1"></span>          <span class="n">bootstrap</span>
              <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span> <span class="c1">// 设置两个线程组
</span><span class="c1"></span>              <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 使用NioSocketChannel作为服务器的通道实现类型
</span><span class="c1"></span>              <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="n">128</span><span class="o">)</span> <span class="c1">// 设置线程队列等待连接个数
</span><span class="c1"></span>              <span class="o">.</span><span class="na">childOption</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_KEEPALIVE</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// 设置保持活动连接状态
</span><span class="c1"></span>              <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span>
                  <span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span> <span class="c1">// 创建一个通道初始化对象(匿名对象)
</span><span class="c1"></span>                    <span class="c1">// 向workerGroup中EventLoop所关联的通道对应的pipeline设置处理器
</span><span class="c1"></span>                    <span class="nd">@Override</span>
                    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                        <span class="c1">// 在pipeline中加入ProtoBufDecoder
</span><span class="c1"></span>                        <span class="c1">// 指定对哪种对象进行解码
</span><span class="c1"></span>                        <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;decoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">ProtobufDecoder</span><span class="o">(</span><span class="n">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">getDefaultInstance</span><span class="o">()));</span>

                        <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">NettyServerHandler</span><span class="o">());</span>
                        <span class="c1">// 可以使用一个集合管理SocketChannel，在推送消息时，可以将业务加到各个Channel对应的NIOEventLoop的taskQueue 或者 scheduleTaskQueue
</span><span class="c1"></span>                        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户SocketChannel hashcode=&#34;</span> <span class="o">+</span> <span class="n">ch</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
                    <span class="o">}</span>
                  <span class="o">});</span> <span class="c1">// 给我们的workerGroup的 EventLoop对应的管道设置处理器
</span><span class="c1"></span>
          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器 is ready&#34;</span><span class="o">);</span>

          <span class="cm">/*
</span><span class="cm">           * ChannelFuture 在Netty中的所有的I/O操作都是异步执行的，这就意味着任何一个I/O操作会立刻返回，不保证在调用结束的时候操作会执行完成。因此，会返回一个ChannelFuture的实例，通过这个实例可以获取当前I/O操作的状态。
</span><span class="cm">           */</span>

          <span class="c1">// 绑定一个端口，并且同步，生成了一个ChannelFuture 对象
</span><span class="c1"></span>          <span class="c1">// 启动服务器(并绑定端口)
</span><span class="c1"></span>          <span class="c1">// 为什么使用同步？因为Netty是基于异步操作的，如果不使用同步，可能服务器还未启动就执行下面的语句了，就会产生异常
</span><span class="c1"></span>          <span class="n">ChannelFuture</span> <span class="n">cf</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">6668</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

          <span class="c1">// 给cf注册监听器，监控我们关心的事件
</span><span class="c1"></span>          <span class="n">cf</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
              <span class="nd">@Override</span>
              <span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                  <span class="k">if</span><span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">()){</span>
                      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;监听端口 6668成功&#34;</span><span class="o">);</span>
                  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                      <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;监听端口 6668失败&#34;</span><span class="o">);</span>
                  <span class="o">}</span>
              <span class="o">}</span>
          <span class="o">});</span>

          <span class="c1">// 对关闭通道进行监听(只有当你有一个关闭通道这样的事件发生时，才会去进行处理)
</span><span class="c1"></span>          <span class="c1">// 这里为什么也需要使用同步？因为不适用同步，他就会跳过这个语句直接执行finally中的语句关闭线程组了
</span><span class="c1"></span>          <span class="n">cf</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
          <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
          <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务器端handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.codec2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.netty.codec.StudentPOJO</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span><span class="o">;</span>

<span class="cm">/*
</span><span class="cm"> * 说明
</span><span class="cm"> * 1.我们自定义一个Handler需要继承netty规定好的某个HandlerAdapter(规范)
</span><span class="cm"> * 2.这时我们自定义一个Handler，才能称之为一个handler
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServerHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
    <span class="cm">/*
</span><span class="cm">     * 读取数据(这里我们可以读取客户端发送的数据)
</span><span class="cm">     * 1.ChannelHandlerContext ctx：上下文对象，含有管道pipeline(业务逻辑处理)，通道channel(数据读写处理)，地址
</span><span class="cm">     * 2.Object msg：就是客户端发送的数据，默认时Object类型
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 读取客户端发送的MyDataInfo.MyMessage
</span><span class="c1"></span>        <span class="n">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">myMessage</span> <span class="o">=</span> <span class="o">(</span><span class="n">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>

        <span class="c1">// 根据dataType来显示不同的信息
</span><span class="c1"></span>        <span class="n">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span> <span class="n">dataType</span> <span class="o">=</span> <span class="n">myMessage</span><span class="o">.</span><span class="na">getDataType</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dataType</span> <span class="o">==</span> <span class="n">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span><span class="o">.</span><span class="na">StudentType</span><span class="o">){</span>
            <span class="n">MyDataInfo</span><span class="o">.</span><span class="na">Student</span> <span class="n">student</span> <span class="o">=</span> <span class="n">myMessage</span><span class="o">.</span><span class="na">getStudent</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;学生 id =&#34;</span> <span class="o">+</span> <span class="n">student</span><span class="o">.</span><span class="na">getId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;名字=&#34;</span> <span class="o">+</span> <span class="n">student</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span><span class="o">(</span><span class="n">dataType</span> <span class="o">==</span> <span class="n">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span><span class="o">.</span><span class="na">WorkerType</span><span class="o">){</span>
            <span class="n">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="n">myMessage</span><span class="o">.</span><span class="na">getWorker</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;工人 名字 =&#34;</span> <span class="o">+</span> <span class="n">worker</span><span class="o">.</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;年龄=&#34;</span> <span class="o">+</span> <span class="n">worker</span><span class="o">.</span><span class="na">getAge</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;传输的类型不正确，需要检测！！！&#34;</span><span class="o">);</span>
        <span class="o">}</span>

<span class="c1">//    System.out.println(&#34;客户端发送的数据 id =&#34; + myMessage.getId() + &#34;名字=&#34; + student.getName());
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="c1">// 数据读取完毕返回给客户端的消息
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// writeAndFlush 是 write方法 + flush方法
</span><span class="c1"></span>        <span class="c1">// 将数据写入到缓冲区，并刷新
</span><span class="c1"></span>        <span class="c1">// 一般讲，我们对这个发送的数据需要进行编码
</span><span class="c1"></span>        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">&#34;hello,客户端1&#34;</span><span class="o">,</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="c1">// 当出现异常时，一般是需要关闭通道
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.codec2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.protobuf.ProtobufEncoder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="c1">// 客户端需要一个事件循环组
</span><span class="c1"></span>      <span class="n">EventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span> <span class="o">{</span>
          <span class="c1">// 创建一个客户端启动对象
</span><span class="c1"></span>          <span class="c1">// 注意客户端使用的不是ServerBootstrap，而是Bootstrap
</span><span class="c1"></span>          <span class="n">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>

          <span class="c1">// 设置相关参数,链式编程
</span><span class="c1"></span>          <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span> <span class="c1">// 设置线程组
</span><span class="c1"></span>                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 设置客户端通道的实现类型(将来使用反射处理)
</span><span class="c1"></span>                  <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                      <span class="nd">@Override</span>
                      <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                          <span class="c1">// 在pipeline中加入我们的编码器ProtoBufEncoder
</span><span class="c1"></span>                          <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;encoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">ProtobufEncoder</span><span class="o">());</span>

                          <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">NettyClientHandler</span><span class="o">());</span><span class="c1">// 加入自己的处理器
</span><span class="c1"></span>                      <span class="o">}</span>
                  <span class="o">});</span>
          <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端 is ok&#34;</span><span class="o">);</span>

          <span class="c1">// 启动客户端去连接服务器端
</span><span class="c1"></span>          <span class="c1">// 关于 ChannelFuture 后面要分析，涉及到Netty的异步模型
</span><span class="c1"></span>          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span> <span class="n">6668</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

          <span class="c1">// 给关闭通道进行监听(sync是让其为非阻塞？？？？？？)
</span><span class="c1"></span>          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
      <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
          <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.codec2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.netty.codec.StudentPOJO</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClientHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
    <span class="c1">// 当通道就绪时，就会触发该方法
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 随机的发送Student或者Worker对象到服务器
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
        <span class="n">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span> <span class="n">myMessage</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="k">if</span><span class="o">(</span><span class="n">0</span> <span class="o">==</span> <span class="n">random</span><span class="o">){</span>
            <span class="c1">// 发送一个Student对象
</span><span class="c1"></span>            <span class="n">myMessage</span> <span class="o">=</span> <span class="n">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setDataType</span><span class="o">(</span><span class="n">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span><span class="o">.</span><span class="na">StudentType</span><span class="o">).</span><span class="na">setStudent</span><span class="o">(</span><span class="n">MyDataInfo</span><span class="o">.</span><span class="na">Student</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setId</span><span class="o">(</span><span class="n">0</span><span class="o">).</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;威少&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// 发送一个Worker对象
</span><span class="c1"></span>            <span class="n">myMessage</span> <span class="o">=</span> <span class="n">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setDataType</span><span class="o">(</span><span class="n">MyDataInfo</span><span class="o">.</span><span class="na">MyMessage</span><span class="o">.</span><span class="na">DateType</span><span class="o">.</span><span class="na">WorkerType</span><span class="o">).</span><span class="na">setWorker</span><span class="o">(</span><span class="n">MyDataInfo</span><span class="o">.</span><span class="na">Worker</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setAge</span><span class="o">(</span><span class="n">18</span><span class="o">).</span><span class="na">setName</span><span class="o">(</span><span class="s">&#34;科比&#34;</span><span class="o">).</span><span class="na">build</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">myMessage</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 当通道有读取事件时，会触发
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;输出服务器回复的消息：&#34;</span> <span class="o">+</span> <span class="n">buf</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">CharsetUtil</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器端的地址：&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="8netty编解码器和handler的调用机制">8、Netty编解码器和handler的调用机制</h1>
<h2 id="81基本说明">8.1、基本说明</h2>
<ol>
<li>netty的组件设计：Netty的主要组件有Channel、EventLoop、ChannelFuture、ChannelHandler、ChannelPipe等</li>
<li>ChannelHandler充当了<strong>处理入站和出站数据</strong>的<code>应用程序逻辑的容器</code>。例如，实现<code>ChannelInboundHandler接口</code>（或ChannelInboundHandlerAdapter），你就可以接收<code>入站事件</code>和数据，这些数据会被业务逻辑处理。当要给客户端发送响应时，也可以从ChannelInboundHandler冲刷数据。业务逻辑通常写在一个或者多个ChannelInboundHandler中。<code>ChannelOutboundHandler</code>原理一样，只不过它是用来处理<code>出站数据</code>的</li>
<li>ChannelPipeline提供了ChannelHandler链的容器。<strong>以客户端应用程序为例</strong>，如果事件的运动方向是<code>从客户端到服务端的</code>，那么我们称这些事件为<code>出站</code>的，即客户端发送给服务端的数据会通过pipeline中的一系列<code>ChannelOutboundHandler</code>，并被这些Handler处理，<code>反之则称为入站的</code></li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925095810.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925095810.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925095810.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925095810.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925095810.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925095810.png" /></p>
<pre><code>从不同角度来看，说法不是一样的
出站对应编码，入站对应解码
出站对应写，入站对应读
</code></pre>
<h2 id="82编码解码器">8.2、编码解码器</h2>
<ol>
<li>当Netty发送或者接受一个消息的时候，就将会发生一次数据转换。<code>入站消息会被解码</code>：从字节转换为另一种格式（比如java对象）；<code>如果是出站消息，它会被编码成字节</code></li>
<li>Netty提供一系列实用的编解码器，他们都实现了ChannelInboundHadnler或者ChannelOutboundHandler接口。在这些类中，channelRead方法已经被重写了。<strong>以入站为例</strong>，对于每个从入站Channel读取的消息，这个方法会被调用。随后，它将调用由解码器所提供的decode()方法进行解码，并将已经解码的字节转发给ChannelPipeline中的下一个ChannelInboundHandler</li>
</ol>
<h2 id="83解码器-bytetomessagedecoder">8.3、解码器-ByteToMessageDecoder</h2>
<ol>
<li>关系继承图</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112845.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112845.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112845.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112845.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112845.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112845.png" /></p>
<ol start="2">
<li>由于不可能知道远程节点是否会一次性发送一个完整的信息，<strong>tcp有可能出现粘包拆包的问题</strong>，这个类会对入站数据进行缓冲，直到它准备好被处理</li>
<li>一个关于ByteToMessageDecoder实例分析</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ToIntegerDecoder</span> <span class="kd">extends</span> <span class="n">ByteToMessageDecoder</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> 
<span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">4</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">这个例子</span><span class="err">，</span><span class="n">每次入站从ByteBuf中读取4字节</span><span class="err">，</span><span class="n">将其解码为一个int</span><span class="err">，</span><span class="n">然后将它添加到下一个List中</span><span class="err">。</span><span class="n">当没有更多元素可以</span>
<span class="n">被添加到该List中时</span><span class="err">，</span><span class="n">它的内容将会被发送给下一个ChannelInboundHandler</span><span class="err">。</span><span class="n">int在被添加到List中时</span><span class="err">，</span><span class="n">会被自动装箱为</span>
<span class="n">Integer</span><span class="err">。</span><span class="n">在调用readInt</span><span class="o">()</span><span class="n">方法前必须验证所输入的ByteBuf是否具有足够的数据</span>
<span class="n">2</span><span class="err">、</span> <span class="n">decode</span> <span class="n">执行分析图</span> <span class="o">[</span><span class="n">示意图</span><span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112518.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112518.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112518.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112518.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112518.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925112518.png" /></p>
<h2 id="84netty的handler链的调用机制">8.4、Netty的handler链的调用机制</h2>
<p>实例要求:</p>
<ol>
<li>使用自定义的编码器和解码器来说明Netty的handler 调用机制，客户端发送long -&gt; 服务器，服务端发送long -&gt; 客户端</li>
<li>案例演示</li>
<li>结论
<ul>
<li>不论解码器handler 还是 编码器handler 即接收的消息类型必须与待处理的消息类型一致，否则该handler不会被执行</li>
<li>在解码器进行数据解码时，需要判断缓存区(ByteBuf)的数据是否足够，否则接收到的结果会与期望结果不一致</li>
</ul>
</li>
</ol>
<p><strong>服务器端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.inboundhandlerandoutboundhandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
      <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span><span class="o">{</span>

          <span class="n">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
          <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span><span class="n">workerGroup</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">MyServerInitializer</span><span class="o">());</span><span class="c1">// 自定义一个初始化类
</span><span class="c1"></span>
          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">11864</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

      <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
          <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
          <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务器端自定义初始化类：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.inboundhandlerandoutboundhandler</span><span class="o">;</span>


<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServerInitializer</span> <span class="kd">extends</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 获取到pipeline
</span><span class="c1"></span>        <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>

        <span class="c1">// 加入相关的handler
</span><span class="c1"></span>        <span class="c1">// 入栈的handler进行解码 MyByteToLongDecoder
</span><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;decoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">MyByteToLongDecoder2</span><span class="o">());</span>

        <span class="c1">// 这是一个出站的编码器(出战handler)
</span><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;encoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">MyLongToByteEncoder</span><span class="o">());</span>

        <span class="c1">// 加入自定义handler
</span><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyServerHandler</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>解码器：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.inboundhandlerandoutboundhandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.ByteToMessageDecoder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyByteToLongDecoder</span> <span class="kd">extends</span> <span class="n">ByteToMessageDecoder</span> <span class="o">{</span>
    <span class="cm">/*
</span><span class="cm">     * decode 会根据接收的数据，被调用多次，直到没有新的元素被添加到list
</span><span class="cm">     * 或者是ByteBuf 没有更多的可读字节为止
</span><span class="cm">     * 如果list out不为空，就会将list的内容传递给下一个channelinboundhandler处理，该处理器的方法也会被调用多次
</span><span class="cm">     *
</span><span class="cm">     * ctx 上下文集合
</span><span class="cm">     * in 入栈的Bytebuf
</span><span class="cm">     * out List集合，将解码后的数据传给下一个handler
</span><span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;MyByteToLongDecoder 被调用&#34;</span><span class="o">);</span>
        <span class="c1">// 因为 long 8个字节,需要判断有8个字节才能读取一个long
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()</span> <span class="o">&gt;=</span><span class="n">8</span><span class="o">){</span>
            <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">readLong</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务器端自定义handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.inboundhandlerandoutboundhandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServerHandler</span> <span class="kd">extends</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Long</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;从客户端：&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;读取到long&#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>

        <span class="c1">// 给客户端回送数据
</span><span class="c1"></span>        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">98765L</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.inboundhandlerandoutboundhandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

      <span class="n">EventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span><span class="o">{</span>

          <span class="n">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>

          <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClientInitializer</span><span class="o">());</span><span class="c1">// 自定义一个初始化类
</span><span class="c1"></span>
          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="n">11864</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

      <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
          <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端自定义初始化类：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.inboundhandlerandoutboundhandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyClientInitializer</span> <span class="kd">extends</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>

        <span class="c1">// 加入一个出站的handler，对数据进行编码
</span><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;encoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">MyLongToByteEncoder</span><span class="o">());</span>

        <span class="c1">// 这是一个入站的解码器(入站handler)
</span><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="s">&#34;decoder&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">MyByteToLongDecoder2</span><span class="o">());</span>

        <span class="c1">// 加入一个自定义的handler，处理业务逻辑
</span><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClientHandler</span><span class="o">());</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>编码器：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.inboundhandlerandoutboundhandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.MessageToByteEncoder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyLongToByteEncoder</span> <span class="kd">extends</span> <span class="n">MessageToByteEncoder</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// 编码的方法
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Long</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;MyLongToByteEncoder 中 encoder 被调用&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;msg =&#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeLong</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端自定义handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.inboundhandlerandoutboundhandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyClientHandler</span> <span class="kd">extends</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Long</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器的IP=&#34;</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">remoteAddress</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器回送的消息&#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 重写 channelActive 发送数据
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;MyClientHandler 发送数据&#34;</span><span class="o">);</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">123456L</span><span class="o">);</span><span class="c1">// 发送的是一个long
</span><span class="c1"></span>
        <span class="c1">// 分析
</span><span class="c1"></span>        <span class="c1">// 1.&#34;abcdabcdabcdabcd&#34; 是16个字节
</span><span class="c1"></span>        <span class="c1">// 2.该处理器的前一个handler是 MyLongToByteEncoder
</span><span class="c1"></span>        <span class="c1">// 3.MyLongToByteEncoder 父类是 MessageToByteEncoder
</span><span class="c1"></span>        <span class="c1">// 4.  父类MessageToByteEncoder有一个这样的方法
</span><span class="c1"></span>        <span class="c1">// 5.因此我们在编写encoder时，要注意类传入的数据类型和处理的数据类型一致
</span><span class="c1"></span>        <span class="cm">/*
</span><span class="cm">        // 判断当前的msg是不是应该处理的类型，如果是就去进行encode方法，如果不是就跳过encode处理
</span><span class="cm">         if (acceptOutboundMessage(msg)) {
</span><span class="cm">                @SuppressWarnings(&#34;unchecked&#34;)
</span><span class="cm">                I cast = (I) msg;
</span><span class="cm">                buf = allocateBuffer(ctx, cast, preferDirect);
</span><span class="cm">                try {
</span><span class="cm">                    encode(ctx, cast, buf);
</span><span class="cm">                } finally {
</span><span class="cm">                    ReferenceCountUtil.release(cast);
</span><span class="cm">                }
</span><span class="cm">
</span><span class="cm">                if (buf.isReadable()) {
</span><span class="cm">                    ctx.write(buf, promise);
</span><span class="cm">                } else {
</span><span class="cm">                    buf.release();
</span><span class="cm">                    ctx.write(Unpooled.EMPTY_BUFFER, promise);
</span><span class="cm">                }
</span><span class="cm">                buf = null;
</span><span class="cm">            } else {
</span><span class="cm">                ctx.write(msg, promise);
</span><span class="cm">            }
</span><span class="cm">         */</span>
<span class="c1">//        ctx.writeAndFlush(Unpooled.copiedBuffer(&#34;abcdabcdabcdabcd&#34;, CharsetUtil.UTF_8));
</span><span class="c1"></span>    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>分析：
1.从下面两张截图以及代码分析，它对应的执行流程与我们所画的流程是一致的 
</code></pre>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163900.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163900.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163900.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163900.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163900.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163900.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163846.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163846.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163846.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163846.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163846.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163846.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925154324.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925154324.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925154324.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925154324.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925154324.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925154324.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925173051.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925173051.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925173051.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925173051.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925173051.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925173051.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925161418.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925161418.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925161418.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925161418.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925161418.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925161418.png" /></p>
<h2 id="85解码器-replayingdecoder">8.5、解码器-ReplayingDecoder</h2>
<ol>
<li>public abstract class ReplayingDecoder&lt; S &gt; extends ByteToMessageDecoder</li>
<li>ReplayingDecoder扩展了ByteToMessageDecoder类，使用这个类，我们不必调用readableBytes()方法。<strong>参数S指定了用户状态管理的类型，其中Void代表不需要状态管理</strong></li>
<li><strong>应用实例</strong>：使用ReplayingDecoder 编写解码器，对前面的案例进行简化 [案例演示]</li>
<li>ReplayingDecoder使用方便，但它也有一些局限性：
<ul>
<li>并不是所有的 ByteBuf 操作都被支持，如果调用了一个不被支持的方法，将会抛出一个 UnsupportedOperationException</li>
<li>ReplayingDecoder 在某些情况下可能稍慢于 ByteToMessageDecoder，例如<strong>网络缓慢并且消息格式复杂时，消息会被拆成了多个碎片，速度变慢</strong></li>
</ul>
</li>
</ol>
<p><strong>案例演示：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.netty.inboundhandlerandoutboundhandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.ReplayingDecoder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyByteToLongDecoder2</span> <span class="kd">extends</span> <span class="n">ReplayingDecoder</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;MyByteToLongDecoder 被调用&#34;</span><span class="o">);</span>
        <span class="c1">// 在ReplayingDecoder 中不需要判断数据是否足够获取，内部会进行处理判断
</span><span class="c1"></span>        <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">in</span><span class="o">.</span><span class="na">readLong</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="86其它编解码器">8.6、其它编解码器</h2>
<ol>
<li><code>LineBasedFrameDecoder</code>：这个类在Netty内部也有使用，它使用行尾控制字符（\n或者\r\n）作为分隔符来解析数据</li>
<li><code>DelimiterBasedFrameDecoder</code>：使用自定义的特殊字符作为消息的分隔符</li>
<li><code>HttpObjectDecoder</code>：一个HTTP数据的解码器</li>
<li><code>LengthFieldBasedFrameDecoder</code>：通过指定长度来标识整包消息，这样就可以自动的处理黏包和半包消息</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163347.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163347.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163347.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163347.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163347.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925163347.png" /></p>
<h1 id="9tcp-粘包和拆包-及解决方案">9、TCP 粘包和拆包 及解决方案</h1>
<h2 id="91tcp-粘包和拆包基本介绍">9.1、TCP 粘包和拆包基本介绍</h2>
<ol>
<li>TCP是<code>面向连接的</code>，<code>面向流的</code>，<code>提供高可靠性服务</code>。收发两端（客户端和服务器端）都要有一一成对的socket，因此，发送端为了将多个发给接收端的包，更有效的发给对方，使用了优化方法（Nagle算法），将多次间隔较小且数据量小的数据，合并成一个大的数据块，然后进行封包。这样做虽然提高了效率，但是接收端就难于分辨出完整的数据包了，<strong>因为面向流的通信是无消息保护边界的</strong></li>
<li>由于TCP无消息保护边界, 需要在接收端处理消息边界问题，也就是我们所说的<code>粘包、拆包问题</code>, 看一张图</li>
<li>TCP粘包、拆包图解</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925174505.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925174505.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925174505.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925174505.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925174505.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925174505.png" /></p>
<p>假设客户端分别发送了两个数据包D1和D2给服务端，由于服务端一次读取到字节数是不定的，故可能存在以下四种情况：</p>
<ol>
<li>服务端分两次读取到了两个独立的数据包分别是D1和D2，没有粘包和拆包</li>
<li>服务端一次接受到了两个数据包，D1和D2粘合在一起，称之为TCP粘包</li>
<li>服务端分两次读取到了数据包，第一次读取到了完整的D1包和D2包的部分内容，第二次读取到了D2包的剩余内容，这称之为TCP拆包</li>
<li>服务端分两次读取到了数据包，第一次读取到了D1包的部分内容D1_1，第二次读取到了D1包的剩余部分内容D1_2和完整的D2包。</li>
</ol>
<h2 id="92tcp粘包和拆包案例">9.2、TCP粘包和拆包案例</h2>
<p>在编写Netty 程序时，如果没有做处理，就会发生粘包和拆包的问题</p>
<p>具体案例：</p>
<p><strong>服务端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
      <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span><span class="o">{</span>

          <span class="n">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
          <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span><span class="n">workerGroup</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">MyServerInitializer</span><span class="o">());</span><span class="c1">// 自定义一个初始化类
</span><span class="c1"></span>
          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">11864</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

      <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
          <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
          <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务端初始化类：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServerInitializer</span> <span class="kd">extends</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>

        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyServerHandler</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务器端自定义handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServerHandler</span> <span class="kd">extends</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 将msg转换为一个字节数组
</span><span class="c1"></span>        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">msg</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()];</span>

        <span class="n">msg</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>

        <span class="c1">// 将buf转成字符串
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">));</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器接收到数据 &#34;</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器端接收到消息量=&#34;</span> <span class="o">+</span> <span class="o">(++</span><span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">));</span>

        <span class="c1">// 服务器回送数据给客户端,回送一个随机Id
</span><span class="c1"></span>        <span class="n">ByteBuf</span> <span class="n">responseByteBuf</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; &#34;</span><span class="o">,</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">));</span>

        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">responseByteBuf</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

      <span class="n">EventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span><span class="o">{</span>

          <span class="n">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>

          <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClientInitializer</span><span class="o">());</span><span class="c1">// 自定义一个初始化类
</span><span class="c1"></span>
          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="n">11864</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

      <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
          <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端初始化类：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyClientInitializer</span> <span class="kd">extends</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 获取pipeline
</span><span class="c1"></span>        <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>

        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClientHandler</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端端自定义handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.tcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyClientHandler</span> <span class="kd">extends</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">ByteBuf</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 使用客户端发送10条数据，hello，server 编号
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">10</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
            <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">(</span><span class="s">&#34;hello,server&#34;</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">));</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">msg</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()];</span>

        <span class="n">msg</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">buf</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">buf</span><span class="o">,</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">));</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端接收到消息=&#34;</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端接收消息数量=&#34;</span> <span class="o">+</span> <span class="o">(++</span><span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213044.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213044.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213044.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213044.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213044.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213044.png" /></p>
<h2 id="93tcp粘包和拆包解决方案">9.3、TCP粘包和拆包解决方案</h2>
<ol>
<li>使用自定义协议 + 编解码器 来解决</li>
<li>关键就是要解决 <strong>服务器端每次读取数据长度的问题,</strong> 这个问题解决，就不会出现服务器多读或少读数据的问题，从而避免的TCP 粘包、拆包</li>
</ol>
<p>看一个具体的实例:</p>
<ol>
<li>要求客户端发送 5 个 Message 对象, 客户端每次发送一个 Message 对象</li>
<li>服务器端每次接收一个Message, 分5次进行解码， 每读取到 一个Message , 会回复一个Message 对象 给客户端</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213516.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213516.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213516.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213516.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213516.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925213516.png" /></p>
<p><strong>协议类：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.protocoltcp</span><span class="o">;</span>

<span class="c1">// 协议包
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MessageProtocol</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">len</span><span class="o">;</span><span class="c1">// 定义长度，关键
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span><span class="o">;</span><span class="c1">// 要发送的内容
</span><span class="c1"></span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getLen</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">len</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setLen</span><span class="o">(</span><span class="kt">int</span> <span class="n">len</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">len</span> <span class="o">=</span> <span class="n">len</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">getContent</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setContent</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.protocoltcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServer</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
      <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
      <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span><span class="o">{</span>

          <span class="n">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
          <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span><span class="n">workerGroup</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">MyServerInitializer</span><span class="o">());</span><span class="c1">// 自定义一个初始化类
</span><span class="c1"></span>
          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">11864</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

      <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
          <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
          <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务端初始化类：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.protocoltcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServerInitializer</span> <span class="kd">extends</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>

        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyMessageEncoder</span><span class="o">());</span><span class="c1">// 编码器
</span><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyMessageDecoder</span><span class="o">());</span><span class="c1">// 解码器
</span><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyServerHandler</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>解码器：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.protocoltcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.ReplayingDecoder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyMessageDecoder</span> <span class="kd">extends</span> <span class="n">ReplayingDecoder</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">decode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">in</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;MyMessageDecoder decode方法被调用&#34;</span><span class="o">);</span>
        <span class="c1">// 这里需要将得到的二进制字节码进行转换，转换为MessageProtocol数据包(对象)
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">in</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>

        <span class="c1">// 通过得到字节的长度来获取到对应的内容
</span><span class="c1"></span>        <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">length</span><span class="o">];</span>
        <span class="n">in</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>

        <span class="c1">// 封装成MessageProtocol对象，放入list中，传递给下一个handler进行业务处理
</span><span class="c1"></span>        <span class="n">MessageProtocol</span> <span class="n">messageProtocol</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageProtocol</span><span class="o">();</span>
        <span class="n">messageProtocol</span><span class="o">.</span><span class="na">setLen</span><span class="o">(</span><span class="n">length</span><span class="o">);</span>
        <span class="n">messageProtocol</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">messageProtocol</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务器端自定义handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.protocoltcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="c1">// 处理业务的handler
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServerHandler</span> <span class="kd">extends</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">MessageProtocol</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">MessageProtocol</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 接收到数据并处理
</span><span class="c1"></span>        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getLen</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务端接收到信息如下：&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;长度 =&#34;</span> <span class="o">+</span> <span class="n">len</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;内容 =&#34;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">content</span><span class="o">,</span><span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">)));</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务器接收到消息包数量 =&#34;</span> <span class="o">+</span> <span class="o">(++</span><span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">));</span>

        <span class="c1">// 回复消息
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">responseContent</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">responseContentBytes</span> <span class="o">=</span> <span class="n">responseContent</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">responseLength</span> <span class="o">=</span> <span class="n">responseContent</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">)).</span><span class="na">length</span><span class="o">;</span>

        <span class="c1">// 构建一个协议包
</span><span class="c1"></span>        <span class="n">MessageProtocol</span> <span class="n">messageProtocol</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageProtocol</span><span class="o">();</span>
        <span class="n">messageProtocol</span><span class="o">.</span><span class="na">setLen</span><span class="o">(</span><span class="n">responseLength</span><span class="o">);</span>
        <span class="n">messageProtocol</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">responseContentBytes</span><span class="o">);</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">messageProtocol</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.protocoltcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyClient</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>

      <span class="n">EventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

      <span class="k">try</span><span class="o">{</span>

          <span class="n">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>

          <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                  <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClientInitializer</span><span class="o">());</span><span class="c1">// 自定义一个初始化类
</span><span class="c1"></span>
          <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&#34;localhost&#34;</span><span class="o">,</span> <span class="n">11864</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

          <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

      <span class="o">}</span> <span class="k">finally</span><span class="o">{</span>
          <span class="n">group</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端初始化类：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.protocoltcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyClientInitializer</span> <span class="kd">extends</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 获取pipeline
</span><span class="c1"></span>        <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>

        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyMessageDecoder</span><span class="o">());</span><span class="c1">// 解码器
</span><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyMessageEncoder</span><span class="o">());</span><span class="c1">// 编码器
</span><span class="c1"></span>        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">MyClientHandler</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>编码器：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.protocoltcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.MessageToByteEncoder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyMessageEncoder</span> <span class="kd">extends</span> <span class="n">MessageToByteEncoder</span><span class="o">&lt;</span><span class="n">MessageProtocol</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">MessageProtocol</span> <span class="n">msg</span><span class="o">,</span> <span class="n">ByteBuf</span> <span class="n">out</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;MyMessageEncoder encode方法被调用&#34;</span><span class="o">);</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getLen</span><span class="o">());</span>
        <span class="n">out</span><span class="o">.</span><span class="na">writeBytes</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">getContent</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>客户端端自定义handler：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.protocoltcp</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.SimpleChannelInboundHandler</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyClientHandler</span> <span class="kd">extends</span> <span class="n">SimpleChannelInboundHandler</span><span class="o">&lt;</span><span class="n">MessageProtocol</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 使用客户端发送10条数据，clover,felix 编号
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">5</span><span class="o">;</span> <span class="n">i</span><span class="o">++){</span>
            <span class="n">String</span> <span class="n">mes</span> <span class="o">=</span> <span class="s">&#34;clover,felix&#34;</span><span class="o">;</span>
            <span class="c1">// 将mes做成一个字节数组
</span><span class="c1"></span>            <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">mes</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">));</span>
            <span class="c1">// 统计当前mes的长度
</span><span class="c1"></span>            <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="n">mes</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(</span><span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">)).</span><span class="na">length</span><span class="o">;</span>

            <span class="c1">// 创建协议包
</span><span class="c1"></span>            <span class="n">MessageProtocol</span> <span class="n">messageProtocol</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MessageProtocol</span><span class="o">();</span>
            <span class="n">messageProtocol</span><span class="o">.</span><span class="na">setLen</span><span class="o">(</span><span class="n">length</span><span class="o">);</span>
            <span class="n">messageProtocol</span><span class="o">.</span><span class="na">setContent</span><span class="o">(</span><span class="n">content</span><span class="o">);</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">messageProtocol</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">channelRead0</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">MessageProtocol</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>

        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getLen</span><span class="o">();</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">content</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">getContent</span><span class="o">();</span>

        <span class="n">String</span> <span class="n">message</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">content</span><span class="o">,</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">&#34;utf-8&#34;</span><span class="o">));</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端接收到消息如下：&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;长度：&#34;</span> <span class="o">+</span> <span class="n">len</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;内容：&#34;</span> <span class="o">+</span> <span class="n">message</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;客户端接收消息数量=&#34;</span> <span class="o">+</span> <span class="o">(++</span><span class="k">this</span><span class="o">.</span><span class="na">count</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;异常信息=&#34;</span> <span class="o">+</span> <span class="n">cause</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212549.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212549.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212549.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212549.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212549.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212549.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212607.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212607.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212607.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212607.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212607.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212607.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212618.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212618.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212618.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212618.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212618.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210925212618.png" /></p>
<h1 id="10netty核心源码剖析">10、Netty核心源码剖析</h1>
<h2 id="101基本说明">10.1、基本说明</h2>
<ol>
<li>只有看过Netty源码，才能说是真的掌握了Netty框架</li>
<li>在 io.netty.example 包下，有很多Netty源码案例，可以用来分析</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926102934.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926102934.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926102934.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926102934.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926102934.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926102934.png" /></p>
<h2 id="102netty-启动过程源码剖析">10.2、Netty 启动过程源码剖析</h2>
<h3 id="1021源码剖析目的">10.2.1、源码剖析目的</h3>
<p>用源码分析的方式走一下 Netty （服务器）的启动过程，更好的理解Netty 的整体设计和运行机制</p>
<h3 id="1022源码剖析">10.2.2、源码剖析</h3>
<p><strong>说明：</strong></p>
<ol>
<li>源码需要剖析到Netty 调用doBind方法， 追踪到 NioServerSocketChannel的doBind</li>
<li>并且要Debug 程序到 NioEventLoop类 的run代码 ，无限循环，在服务器端运行</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926103200.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926103200.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926103200.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926103200.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926103200.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926103200.png" /></p>
<h3 id="1023源码剖析过程">10.2.3、源码剖析过程</h3>
<h4 id="1demo源码的基本理解">1、demo源码的基本理解</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="cm">/*
</span><span class="cm"> * Copyright 2012 The Netty Project
</span><span class="cm"> *
</span><span class="cm"> * The Netty Project licenses this file to you under the Apache License,
</span><span class="cm"> * version 2.0 (the &#34;License&#34;); you may not use this file except in compliance
</span><span class="cm"> * with the License. You may obtain a copy of the License at:
</span><span class="cm"> *
</span><span class="cm"> *   http://www.apache.org/licenses/LICENSE-2.0
</span><span class="cm"> *
</span><span class="cm"> * Unless required by applicable law or agreed to in writing, software
</span><span class="cm"> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS, WITHOUT
</span><span class="cm"> * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
</span><span class="cm"> * License for the specific language governing permissions and limitations
</span><span class="cm"> * under the License.
</span><span class="cm"> */</span>
<span class="kn">package</span> <span class="nn">com.clover.netty.source.echo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LogLevel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.logging.LoggingHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.ssl.SslContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.ssl.SslContextBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.ssl.util.SelfSignedCertificate</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * Echoes back any received data from a client.
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">EchoServer</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">SSL</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;ssl&#34;</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">PORT</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&#34;port&#34;</span><span class="o">,</span> <span class="s">&#34;8007&#34;</span><span class="o">));</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// Configure SSL.
</span><span class="c1"></span>        <span class="kd">final</span> <span class="n">SslContext</span> <span class="n">sslCtx</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">SSL</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">SelfSignedCertificate</span> <span class="n">ssc</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SelfSignedCertificate</span><span class="o">();</span>
            <span class="n">sslCtx</span> <span class="o">=</span> <span class="n">SslContextBuilder</span><span class="o">.</span><span class="na">forServer</span><span class="o">(</span><span class="n">ssc</span><span class="o">.</span><span class="na">certificate</span><span class="o">(),</span> <span class="n">ssc</span><span class="o">.</span><span class="na">privateKey</span><span class="o">()).</span><span class="na">build</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">sslCtx</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// Configure the server.
</span><span class="c1"></span>        <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ServerBootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
            <span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
             <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
             <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="n">100</span><span class="o">)</span>
             <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">LoggingHandler</span><span class="o">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span>
             <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                 <span class="nd">@Override</span>
                 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                     <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
                     <span class="k">if</span> <span class="o">(</span><span class="n">sslCtx</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                         <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">sslCtx</span><span class="o">.</span><span class="na">newHandler</span><span class="o">(</span><span class="n">ch</span><span class="o">.</span><span class="na">alloc</span><span class="o">()));</span>
                     <span class="o">}</span>
                     <span class="c1">//p.addLast(new LoggingHandler(LogLevel.INFO));
</span><span class="c1"></span>                     <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">EchoServerHandler</span><span class="o">());</span>
                 <span class="o">}</span>
             <span class="o">});</span>

            <span class="c1">// Start the server.
</span><span class="c1"></span>            <span class="n">ChannelFuture</span> <span class="n">f</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">PORT</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>

            <span class="c1">// Wait until the server socket is closed.
</span><span class="c1"></span>            <span class="n">f</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// Shut down all event loops to terminate all threads.
</span><span class="c1"></span>            <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html">说明：
	1.先看启动类：main方法中，首先创建了关于SSL的配置类
	2.重点分析创建的两个EventLoopGroup对象
		EventLoopGroup bossGroup = new NioEventLoopGroup(1);
        EventLoopGroup workerGroup = new NioEventLoopGroup();
		1.这两个对象是整个Netty的核心对象，可以说，整个Netty的运作都依赖于他们。bossGroup用于接收TCP请求，它会将
		请求交给workerGroup，workerGroup会获取到真正的连接，然后和连接进行通信，比如读写解码编码等操作
		2.EventLoopGroup是事件循环组(线程组) 含有多个EventLoop，可以注册channel，
		用于在事件循环中去进行选择(和选择器相关)  [debug查看]
		3.new NioEventLoopGroup(1);这个1表示bossGroup事件组有一个线程你可以指定，如果new NioEventLoopGroup(); 
		不给参数，会有默认个线程cpu核数*2，即可以充分利用多核的优势
		DEFAULT_EVENT_LOOP_THREADS = Math.max(1, SystemPropertyUtil.getInt(
                &#34;io.netty.eventLoopThreads&#34;, NettyRuntime.availableProcessors() * 2));
	    4.会创建EventExecutor数组 children = new EventExecutor[nThreads]; [debug查看]
		5.每个元素的类型就是NioEventLoop，NioEventLoop 实现了 EventLoop 接口和 Executor 接口
		6.try代码块中创建了一个ServerBootstrap对象，它是一个引导类，用于启动服务器和引导整个程序的初始化
		(看下源码 allow easy bootstrap of {@link ServerChannel})，它和ServerChannel关联，而ServerChannel继承了
		Channel，有一些remoteAddress等	[debug查看] 随后，变量b调用了group方法将两个group放入自己的字段中，
		用于后期引导使用
		7.然后添加了一个channel，其中一个参数是Class对象，引导类将通过这个Class对象反射创建ChannelFactory。
		然后添加了一些TCP参数。[说明：Channel的创建在bind方法，可以Debug下bind，
		会找到channel = channelFactory.newChannel();]
		8.再添加了一个服务器专属的日志处理器handler
		9.再添加一个SocketChannel(不是ServerSocketChannel)的handler
		10.然后绑定端口并阻塞成功。
		11.最后main线程阻塞等待关闭
		12.finally块中的代码将在服务器关闭时优雅关闭所有资源
</code></pre></td></tr></table>
</div>
</div><p>第二点debug结果：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926105907.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926105907.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926105907.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926105907.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926105907.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926105907.png" /></p>
<p>第四点debug结果：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110610.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110610.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110610.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110610.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110610.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110610.png" /></p>
<p>第五点debug结果：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110707.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110707.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110707.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110707.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110707.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110707.png" /></p>
<p>第七点debug结果：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110938.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110938.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110938.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110938.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110938.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210926110938.png" /></p>
<h4 id="2服务器端处理器代码">2、服务器端处理器代码</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="cm">/*
</span><span class="cm"> * Copyright 2012 The Netty Project
</span><span class="cm"> *
</span><span class="cm"> * The Netty Project licenses this file to you under the Apache License,
</span><span class="cm"> * version 2.0 (the &#34;License&#34;); you may not use this file except in compliance
</span><span class="cm"> * with the License. You may obtain a copy of the License at:
</span><span class="cm"> *
</span><span class="cm"> *   http://www.apache.org/licenses/LICENSE-2.0
</span><span class="cm"> *
</span><span class="cm"> * Unless required by applicable law or agreed to in writing, software
</span><span class="cm"> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS, WITHOUT
</span><span class="cm"> * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
</span><span class="cm"> * License for the specific language governing permissions and limitations
</span><span class="cm"> * under the License.
</span><span class="cm"> */</span>
<span class="kn">package</span> <span class="nn">com.clover.netty.source.echo</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandler.Sharable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * Handler implementation for the echo server.
</span><span class="cm"> */</span>
<span class="nd">@Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoServerHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Close the connection when an exception is raised.
</span><span class="c1"></span>        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>说明：
1.这是一个普通的处理器类，用于处理客户端发送来的消息，在我们这里，我们简单的解析出客户端传过来的内容，
然后打印，最后发送字符串给客户端
</code></pre>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="cm">/**
</span><span class="cm"> * @param nThreads          使用的线程数，默认为core*2
</span><span class="cm"> * @param executor          执行器：如果传入null，则采用Netty默认的工厂模式和默认的执行器ThreadPerTaskExecutor
</span><span class="cm"> * @param chooserFactory    单例new DefaultEventExecutorChooserFactory()
</span><span class="cm"> * @param args              args在创建执行器的时候传入固定参数
</span><span class="cm"> */</span>
<span class="kd">protected</span> <span class="nf">MultithreadEventExecutorGroup</span><span class="o">(</span><span class="kt">int</span> <span class="n">nThreads</span><span class="o">,</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">,</span>
										<span class="n">EventExecutorChooserFactory</span> <span class="n">chooserFactory</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">nThreads</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&#34;nThreads: %d (expected: &gt; 0)&#34;</span><span class="o">,</span> <span class="n">nThreads</span><span class="o">));</span>
	<span class="o">}</span>
	
	<span class="c1">// 如果传入的执行器是空的则采用默认的线程工厂和默认的执行器
</span><span class="c1"></span>	<span class="k">if</span> <span class="o">(</span><span class="n">executor</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">executor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadPerTaskExecutor</span><span class="o">(</span><span class="n">newDefaultThreadFactory</span><span class="o">());</span>
	<span class="o">}</span>
	
	<span class="c1">// 创建指定线程数的执行器数组
</span><span class="c1"></span>	<span class="n">children</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventExecutor</span><span class="o">[</span><span class="n">nThreads</span><span class="o">];</span>

	<span class="c1">// 初始化线程数组
</span><span class="c1"></span>	<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nThreads</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
		<span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="c1">// 创建 NioEventLoop
</span><span class="c1"></span>			<span class="n">children</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">newChild</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
			<span class="n">success</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// TODO: Think about if this is a good exception type
</span><span class="c1"></span>			<span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;failed to create a child event loop&#34;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
			<span class="c1">// 如果创建失败，优雅关闭
</span><span class="c1"></span>			<span class="k">if</span> <span class="o">(!</span><span class="n">success</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="o">;</span> <span class="n">j</span> <span class="o">++)</span> <span class="o">{</span>
					<span class="n">children</span><span class="o">[</span><span class="n">j</span><span class="o">].</span><span class="na">shutdownGracefully</span><span class="o">();</span>
				<span class="o">}</span>

				<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">i</span><span class="o">;</span> <span class="n">j</span> <span class="o">++)</span> <span class="o">{</span>
					<span class="n">EventExecutor</span> <span class="n">e</span> <span class="o">=</span> <span class="n">children</span><span class="o">[</span><span class="n">j</span><span class="o">];</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="k">while</span> <span class="o">(!</span><span class="n">e</span><span class="o">.</span><span class="na">isTerminated</span><span class="o">())</span> <span class="o">{</span>
							<span class="n">e</span><span class="o">.</span><span class="na">awaitTermination</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
						<span class="o">}</span>
					<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">interrupted</span><span class="o">)</span> <span class="o">{</span>
						<span class="c1">// Let the caller handle the interruption.
</span><span class="c1"></span>						<span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">interrupt</span><span class="o">();</span>
						<span class="k">break</span><span class="o">;</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="n">chooser</span> <span class="o">=</span> <span class="n">chooserFactory</span><span class="o">.</span><span class="na">newChooser</span><span class="o">(</span><span class="n">children</span><span class="o">);</span>

	<span class="kd">final</span> <span class="n">FutureListener</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">terminationListener</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FutureListener</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">terminatedChildren</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">()</span> <span class="o">==</span> <span class="n">children</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">terminationFuture</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">};</span>

	<span class="c1">// 为每一个单例的线程池添加一个关闭监听器
</span><span class="c1"></span>	<span class="k">for</span> <span class="o">(</span><span class="n">EventExecutor</span> <span class="n">e</span><span class="o">:</span> <span class="n">children</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">e</span><span class="o">.</span><span class="na">terminationFuture</span><span class="o">().</span><span class="na">addListener</span><span class="o">(</span><span class="n">terminationListener</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="n">Set</span><span class="o">&lt;</span><span class="n">EventExecutor</span><span class="o">&gt;</span> <span class="n">childrenSet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedHashSet</span><span class="o">&lt;</span><span class="n">EventExecutor</span><span class="o">&gt;(</span><span class="n">children</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
	<span class="c1">// 将所有的单例线程池添加到一个HashSet中
</span><span class="c1"></span>	<span class="n">Collections</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">childrenSet</span><span class="o">,</span> <span class="n">children</span><span class="o">);</span>
	<span class="n">readonlyChildren</span> <span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">unmodifiableSet</span><span class="o">(</span><span class="n">childrenSet</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="3serverbootstrap基本使用情况">3、ServerBootstrap基本使用情况</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="n">ServerBootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
            <span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
             <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
             <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="n">100</span><span class="o">)</span>
             <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">LoggingHandler</span><span class="o">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span>
             <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                 <span class="nd">@Override</span>
                 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                     <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
                     <span class="k">if</span> <span class="o">(</span><span class="n">sslCtx</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                         <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">sslCtx</span><span class="o">.</span><span class="na">newHandler</span><span class="o">(</span><span class="n">ch</span><span class="o">.</span><span class="na">alloc</span><span class="o">()));</span>
                     <span class="o">}</span>
                     <span class="c1">//p.addLast(new LoggingHandler(LogLevel.INFO));
</span><span class="c1"></span>                     <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">EchoServerHandler</span><span class="o">());</span>
                 <span class="o">}</span>
             <span class="o">});</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>说明：
1.链式调用：group方法，将boss和worker传入，boss赋值给parentGroup属性，worker赋值给childGroup属性
2.channel方法传入NioServerSocketChannel class对象。会根据这个class创建channel对象
3.option 方法传入TCP参数，放在一个LinkedHashMap中
4.handler方法传一个一个handler，这个handler只专属于ServerSocketChannel而不是SocketChannel
5.childHandler传入一个handler，这个handler将会在每个客户端连接的时候调用。供SocketChannel使用
</code></pre>
<h4 id="4端口绑定的分析">4、端口绑定的分析</h4>
<h5 id="41服务器就是在这个bind方法里面启动完成的">4.1、服务器就是在这个bind方法里面启动完成的</h5>
<h5 id="42bind方法追踪到创建了一个端口对象并做了一些空判断核心代码dobind">4.2、bind方法，追踪到创建了一个端口对象，并做了一些空判断，核心代码doBind</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="cm">/**
</span><span class="cm"> * Create a new {@link Channel} and bind it.
</span><span class="cm"> */</span>
<span class="kd">public</span> <span class="n">ChannelFuture</span> <span class="nf">bind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">validate</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">localAddress</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;localAddress&#34;</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">doBind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="43dobind-源码剖析核心是两个方法-initandrefister-和-dobind">4.3、doBind 源码剖析，核心是两个方法 initAndRefister 和 doBind()</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="n">ChannelFuture</span> <span class="nf">doBind</span><span class="o">(</span><span class="kd">final</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="n">regFuture</span> <span class="o">=</span> <span class="n">initAndRegister</span><span class="o">();</span>
	<span class="kd">final</span> <span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">regFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">regFuture</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
		<span class="c1">// At this point we know that the registration was complete and successful.
</span><span class="c1"></span>		<span class="n">ChannelPromise</span> <span class="n">promise</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">newPromise</span><span class="o">();</span>
		
		<span class="cm">/*
</span><span class="cm">		 * 说明：执行doBind方法，完成对端口的绑定.
</span><span class="cm">		 */</span>
		<span class="n">doBind0</span><span class="o">(</span><span class="n">regFuture</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="c1">// Registration future is almost always fulfilled already, but just in case it&#39;s not.
</span><span class="c1"></span>		<span class="kd">final</span> <span class="n">PendingRegistrationPromise</span> <span class="n">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PendingRegistrationPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
		<span class="n">regFuture</span><span class="o">.</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
				<span class="n">Throwable</span> <span class="n">cause</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">cause</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">cause</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
					<span class="c1">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an
</span><span class="c1"></span>					<span class="c1">// IllegalStateException once we try to access the EventLoop of the Channel.
</span><span class="c1"></span>					<span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
				<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
					<span class="c1">// Registration was successful, so set the correct executor to use.
</span><span class="c1"></span>					<span class="c1">// See https://github.com/netty/netty/issues/2586
</span><span class="c1"></span>					<span class="n">promise</span><span class="o">.</span><span class="na">registered</span><span class="o">();</span>

					<span class="n">doBind0</span><span class="o">(</span><span class="n">regFuture</span><span class="o">,</span> <span class="n">channel</span><span class="o">,</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">});</span>
		<span class="k">return</span> <span class="n">promise</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="44分析说明-initandregister">4.4、分析说明 initAndRegister</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">initAndRegister</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">Channel</span> <span class="n">channel</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="c1">// 说明：channelFactory.newChannel() 方法的作用，通过 ServerBootstrap 的通道工厂反射创建一个NioServerSocketChannel，具体追踪源码可以得到以下结论
</span><span class="c1"></span>		<span class="cm">/*
</span><span class="cm">		 * 1.通过Nio的 SelectorProvider 的openServerSocketChannel 方法得到JDK的channel，目的是让Netty包装JDK的channel
</span><span class="cm">		 * 2.创建了一个唯一的ChannelId，创建了一个NioMessageUnsafe，用于操作消息，创建了一个DefaultChannelPipeline 管道，是个双向链表结构，用于过滤所有的进出的消息
</span><span class="cm">		 * 3.创建了一个NioServerSocketChannelConfig 对象，用于对外展示一些配置。channel = channelFactory.newChannel();//NioServerSocketChannel
</span><span class="cm">		 */</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">channelFactory</span><span class="o">.</span><span class="na">newChannel</span><span class="o">();</span>
		 <span class="c1">// 说明：init初始化这个NioServerSocketChannel，具体追踪源码可以得到如下结论
</span><span class="c1"></span>		 <span class="cm">/*
</span><span class="cm">		  * 1.init方法，这个是抽象方法(AbstractBootstrap类的)，由ServerBootstrap实现(可以追源码 // setChannelOptions(channel,option,logger))
</span><span class="cm">		  * 2.设置 NioServerSocketChannel 的TCP属性
</span><span class="cm">		  * 3.由于LinkedHashMap 是非线程安全的，使用同步进行处理
</span><span class="cm">		  * 4.对 NioServerSocketChannel 的ChannelPipeline 添加 ChannelInitializer 处理器
</span><span class="cm">		  * 5.可以看出，init方法的核心作用在和 ChannelPipeline 相关
</span><span class="cm">		  * 6.从 NioServerSocketChannel 的初始化过程中，我们知道，pipeline是一个双向链表，并且，它本身就初始化了 head 和 tail，这里调用了它的 addList 方法，也就是将整个 handler 插入到 tail 的前面，因为tail永远会在后面，需要做一些系统的固定工作
</span><span class="cm">		  */</span>
		<span class="n">init</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// channel can be null if newChannel crashed (eg SocketException(&#34;too many open files&#34;))
</span><span class="c1"></span>			<span class="n">channel</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">closeForcibly</span><span class="o">();</span>
			<span class="c1">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor
</span><span class="c1"></span>			<span class="k">return</span> <span class="k">new</span> <span class="n">DefaultChannelPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">GlobalEventExecutor</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">).</span><span class="na">setFailure</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor
</span><span class="c1"></span>		<span class="k">return</span> <span class="k">new</span> <span class="n">DefaultChannelPromise</span><span class="o">(</span><span class="k">new</span> <span class="n">FailedChannel</span><span class="o">(),</span> <span class="n">GlobalEventExecutor</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">).</span><span class="na">setFailure</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="n">ChannelFuture</span> <span class="n">regFuture</span> <span class="o">=</span> <span class="n">config</span><span class="o">().</span><span class="na">group</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">channel</span><span class="o">);</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">channel</span><span class="o">.</span><span class="na">isRegistered</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">channel</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">channel</span><span class="o">.</span><span class="na">unsafe</span><span class="o">().</span><span class="na">closeForcibly</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="c1">// If we are here and the promise is not failed, it&#39;s one of the following cases:
</span><span class="c1"></span>	<span class="c1">// 1) If we attempted registration from the event loop, the registration has been completed at this point.
</span><span class="c1"></span>	<span class="c1">//    i.e. It&#39;s safe to attempt bind() or connect() now because the channel has been registered.
</span><span class="c1"></span>	<span class="c1">// 2) If we attempted registration from the other thread, the registration request has been successfully
</span><span class="c1"></span>	<span class="c1">//    added to the event loop&#39;s task queue for later execution.
</span><span class="c1"></span>	<span class="c1">//    i.e. It&#39;s safe to attempt bind() or connect() now:
</span><span class="c1"></span>	<span class="c1">//         because bind() or connect() will be executed *after* the scheduled registration task is executed
</span><span class="c1"></span>	<span class="c1">//         because register(), bind(), and connect() are all bound to the same thread.
</span><span class="c1"></span>
	<span class="k">return</span> <span class="n">regFuture</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>说明：
1.基本说明：initAndRegister()初始化 NioServerSocketChannel 通道并注册各个handler，返回一个future
2.通过 ServerBootstrap 的通道工厂反射创建一个 NioServerSocketChannel
3.init初始化这个 NioServerSocketChannel
4.config().group().register(channel) 通过ServerBootstrap 的bossGroup 注册 NioServerSockerChannel
5.最后，返回这个异步执行的占位符即regFuture
</code></pre>
<h5 id="45init方法会调用-addlast现在进入到-addlast方法内查看">4.5、init方法会调用 addLast，现在进入到 addLast方法内查看</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">addLast</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">newCtx</span><span class="o">;</span>
	<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">checkMultiplicity</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>

		<span class="n">newCtx</span> <span class="o">=</span> <span class="n">newContext</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">filterName</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">handler</span><span class="o">),</span> <span class="n">handler</span><span class="o">);</span>

		<span class="n">addLast0</span><span class="o">(</span><span class="n">newCtx</span><span class="o">);</span>

		<span class="c1">// If the registered is false it means that the channel was not registered on an eventloop yet.
</span><span class="c1"></span>		<span class="c1">// In this case we add the context to the pipeline and add a task that will call
</span><span class="c1"></span>		<span class="c1">// ChannelHandler.handlerAdded(...) once the channel is registered.
</span><span class="c1"></span>		<span class="k">if</span> <span class="o">(!</span><span class="n">registered</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">newCtx</span><span class="o">.</span><span class="na">setAddPending</span><span class="o">();</span>
			<span class="n">callHandlerCallbackLater</span><span class="o">(</span><span class="n">newCtx</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
			<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">newCtx</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">newCtx</span><span class="o">.</span><span class="na">setAddPending</span><span class="o">();</span>
			<span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
				<span class="nd">@Override</span>
				<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
					<span class="n">callHandlerAdded0</span><span class="o">(</span><span class="n">newCtx</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">});</span>
			<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="n">callHandlerAdded0</span><span class="o">(</span><span class="n">newCtx</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>说明：
1.addLast 方法，在 DefaultChannelPipeline 类中
2.addLast 方法就是 pipeline 方法的核心
3.检查 handler 是否符合标准
4.创建一个 AbstractChannelHandlerContext 对象，这里说一下，ChannelHandlerContext 对象是 ChannelHandler 
和 ChannelPipeline 之间的关联，每当有 ChannelHandler添加到 Pipeline中时，都会创建Context。Context的主要功能
是管理它所关联的 Handler 和同一个Pipeline 中的其它 handler 之间的交互
5.将Context 添加到链表中。也就是追加到 tail 节点的前面
6.最后，同步或者异步或者晚点异步的调用 callHandlerAdded0(newCtx) 方法
</code></pre>
<h5 id="46前面说了-dobind-方法有两个重要的步骤initandregister说完解下来看-dobind0方法代码如下">4.6、前面说了 dobind 方法有两个重要的步骤，initAndRegister说完，解下来看 doBind0()方法，代码如下</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doBind0</span><span class="o">(</span>
		<span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="n">regFuture</span><span class="o">,</span> <span class="kd">final</span> <span class="n">Channel</span> <span class="n">channel</span><span class="o">,</span>
		<span class="kd">final</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>

	<span class="c1">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up
</span><span class="c1"></span>	<span class="c1">// the pipeline in its channelRegistered() implementation.
</span><span class="c1"></span>	<span class="n">channel</span><span class="o">.</span><span class="na">eventLoop</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
				<span class="c1">// bind方法这里下断点，进行调试 
</span><span class="c1"></span>				<span class="n">channel</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">).</span><span class="na">addListener</span><span class="o">(</span><span class="n">ChannelFutureListener</span><span class="o">.</span><span class="na">CLOSE_ON_FAILURE</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="n">regFuture</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">});</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>说明：</strong></p>
<p>1、该方法的参数 为initAndRegister 的 future，NioServerSocketChannel，端口地址，NioServerSocketChannel的promise</p>
<p>2、这里就可以根据前面下的断点，一直debug</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="c1">// 将调用 LoggingHandler 的invokeBind 方法，最后会追到 DefaultChannelPipeline 类的bind方法
</span><span class="c1">// 然后进入到 unsafe.bind 方法debug，注意，要追踪到
</span><span class="c1">// unsafe.bind()，要debug第二圈的时候才能看到
</span><span class="c1"></span><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">bind</span><span class="o">(</span>
		<span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span>
		<span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="n">unsafe</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
<span class="o">}</span>


<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">bind</span><span class="o">(</span><span class="kd">final</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
	<span class="o">.......</span>
	
	<span class="kt">boolean</span> <span class="n">wasActive</span> <span class="o">=</span> <span class="n">isActive</span><span class="o">();</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="c1">// 可以看到，这里最终的方法就是doBind 方法，执行成功后，执行通道的 fireChannelActive 方法，告诉所有的handler，已经成功绑定
</span><span class="c1"></span>		<span class="n">doBind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">);</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
		<span class="n">closeIfClosed</span><span class="o">();</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(!</span><span class="n">wasActive</span> <span class="o">&amp;&amp;</span> <span class="n">isActive</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">invokeLater</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
				<span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelActive</span><span class="o">();</span>
			<span class="o">}</span>
		<span class="o">});</span>
	<span class="o">}</span>

	<span class="n">safeSetSuccess</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>3、最终doBind 就会追踪到 NioServerSocketChannel 的doBind，说明 Netty 底层使用的是 Nio</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doBind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">PlatformDependent</span><span class="o">.</span><span class="na">javaVersion</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">7</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">javaChannel</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="na">getBacklog</span><span class="o">());</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="n">javaChannel</span><span class="o">().</span><span class="na">socket</span><span class="o">().</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="na">getBacklog</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>4、回到 bind 方法，最后一步：safeSetSuccess(promise)，告诉promise 任务成功了。其可以执行监听器的方法了。<strong>到此整个启动过程已经结束了</strong></p>
<h2 id="103netty接收请求过程源码剖析">10.3、Netty接收请求过程源码剖析</h2>
<h3 id="1031源码剖析目的">10.3.1、源码剖析目的</h3>
<ol>
<li>服务区启动后肯定要接受客户端请求并返回客户端想要的信息，下面源码分析Netty在启动之后是如何接受客户端请求的</li>
<li>在 io.netty.example下</li>
</ol>
<h3 id="1032源码剖析">10.3.2、源码剖析</h3>
<ol>
<li>从之前服务器启动的源码中，我们得知，服务器最终注册了一个Accept事件等待客户端连接。我们也知道，NioServerSockerChannel 将自己注册到了boss 单例线程池(reactor线程)上，也就是EventLoop</li>
<li>简单说下EventLoop的逻辑
<ul>
<li>EventLoop的作用是一个死循环，该循环中做三件事情</li>
</ul>
<ol>
<li>有条件的等待nio事件</li>
<li>处理nio事件</li>
<li>处理消息队列中的任务</li>
<li>仍用前面的项目来分析：进入到NioEventLoop 源码中后，在 private void processSelectedKey(SelectionKey k,AbstractNioChannel ch) 方法开始调试</li>
<li>最终我们要分析到AbstractNioChannel 的 doBeginRead 方法，当到这个方法时，针对于这个客户端的连接就完成了，接下来就可以监听读事件了</li>
</ol>
</li>
</ol>
<p><strong>源码分析过程</strong></p>
<p>1、断点位置 NioEventLoop 的如下方法 processSelectedKey</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="k">if</span> <span class="o">((</span><span class="n">readyOps</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span> <span class="o">|</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">))</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">||</span> <span class="n">readyOps</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>  
 <span class="n">unsafe</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>  <span class="c1">// 断点位置
</span><span class="c1"></span><span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>2、在浏览器输入ip+端口号，进行连接，即客户端发出请求</p>
<p>3、从断点我们可以看到，readyOps 是16，也就是 Accept 事件，说明浏览器请求已经进来了</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165049.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165049.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165049.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165049.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165049.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165049.png" /></p>
<p>4、这个 unsafe 是 boss 线程中 NioServerSocketChannel 继承了 AbstractNioMessageChannel 类中内部类 NioMessageUnsafe 对象，进入到  AbstractNioMessageChannel 类的内部类 NioMessageUnsafe 的read 方法中</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163128.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163128.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163128.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163128.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163128.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163128.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163111.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163111.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163111.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163111.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163111.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210930163111.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165312.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165312.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165312.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165312.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165312.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165312.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165724.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165724.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165724.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165724.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165724.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927165724.png" /></p>
<p>5、read 方法代码分析</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">assert</span> <span class="n">eventLoop</span><span class="o">().</span><span class="na">inEventLoop</span><span class="o">();</span>
	<span class="kd">final</span> <span class="n">ChannelConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">();</span>
	<span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">();</span>
	<span class="kd">final</span> <span class="n">RecvByteBufAllocator</span><span class="o">.</span><span class="na">Handle</span> <span class="n">allocHandle</span> <span class="o">=</span> <span class="n">unsafe</span><span class="o">().</span><span class="na">recvBufAllocHandle</span><span class="o">();</span>
	<span class="n">allocHandle</span><span class="o">.</span><span class="na">reset</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>

	<span class="kt">boolean</span> <span class="n">closed</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
	<span class="n">Throwable</span> <span class="n">exception</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="k">do</span> <span class="o">{</span>
				<span class="kt">int</span> <span class="n">localRead</span> <span class="o">=</span> <span class="n">doReadMessages</span><span class="o">(</span><span class="n">readBuf</span><span class="o">);</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">localRead</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
					<span class="k">break</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">localRead</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">closed</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
					<span class="k">break</span><span class="o">;</span>
				<span class="o">}</span>

				<span class="n">allocHandle</span><span class="o">.</span><span class="na">incMessagesRead</span><span class="o">(</span><span class="n">localRead</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">allocHandle</span><span class="o">.</span><span class="na">continueReading</span><span class="o">());</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">exception</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">readBuf</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="o">;</span> <span class="n">i</span> <span class="o">++)</span> <span class="o">{</span>
			<span class="n">readPending</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
			<span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">readBuf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
		<span class="o">}</span>
		<span class="n">readBuf</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
		<span class="n">allocHandle</span><span class="o">.</span><span class="na">readComplete</span><span class="o">();</span>
		<span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelReadComplete</span><span class="o">();</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">exception</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">closed</span> <span class="o">=</span> <span class="n">closeOnReadError</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>

			<span class="n">pipeline</span><span class="o">.</span><span class="na">fireExceptionCaught</span><span class="o">(</span><span class="n">exception</span><span class="o">);</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">closed</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">inputShutdown</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">isOpen</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">close</span><span class="o">(</span><span class="n">voidPromise</span><span class="o">());</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
		<span class="c1">// Check if there is a readPending which was not processed yet.
</span><span class="c1"></span>		<span class="c1">// This could be for two reasons:
</span><span class="c1"></span>		<span class="c1">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method
</span><span class="c1"></span>		<span class="c1">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method
</span><span class="c1"></span>		<span class="c1">//
</span><span class="c1"></span>		<span class="c1">// See https://github.com/netty/netty/issues/2254
</span><span class="c1"></span>		<span class="k">if</span> <span class="o">(!</span><span class="n">readPending</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">config</span><span class="o">.</span><span class="na">isAutoRead</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">removeReadOp</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="k">assert</span> <span class="n">eventLoop</span><span class="o">().</span><span class="na">inEventLoop</span><span class="o">();</span> <span class="n">检查该</span> <span class="n">eventloop线程是否是当前线程</span>
<span class="n">2</span><span class="err">、</span><span class="n">执行</span> <span class="n">doReadMessages</span> <span class="n">方法</span><span class="err">，</span><span class="n">并传入一个</span> <span class="n">readBuf</span> <span class="n">变量</span><span class="err">，</span><span class="n">这个变量是一个</span> <span class="n">List</span><span class="err">，</span><span class="n">也就是容器</span>
<span class="n">3</span><span class="err">、</span><span class="n">循环容器</span><span class="err">，</span><span class="n">执行</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">fireChannelRead</span><span class="o">(</span><span class="n">readBuf</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
<span class="n">4</span><span class="err">、</span><span class="n">doReadMessages</span> <span class="n">是读取</span> <span class="n">boss</span> <span class="n">线程中</span> <span class="n">NioServerSockerChannel</span> <span class="n">接收到的请求</span><span class="err">。</span><span class="n">并把这些请求放进容器</span>
<span class="n">5</span><span class="err">、</span><span class="n">循环遍历容器中的所有请求</span><span class="err">，</span><span class="n">调用</span> <span class="n">pipeline</span> <span class="n">的</span> <span class="n">fireChannelRead</span> <span class="n">方法</span><span class="err">，</span><span class="n">用于处理这些接受的请求或者其它事件</span><span class="err">，</span>
<span class="n">在</span> <span class="n">read</span> <span class="n">方法中</span><span class="err">，</span><span class="n">循环调用</span> <span class="n">ServerSocket</span> <span class="n">的</span> <span class="n">pipeline</span> <span class="n">的</span> <span class="n">fireChannelRead</span> <span class="n">方法</span><span class="err">，</span><span class="n">开始执行管道中</span> <span class="n">handler</span> <span class="n">的</span>
<span class="n">ChannelRead</span> <span class="n">方法进入</span>
</code></pre></td></tr></table>
</div>
</div><p>6、追踪 doReadMessages 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">int</span> <span class="nf">doReadMessages</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">buf</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="n">SocketChannel</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">SocketUtils</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">javaChannel</span><span class="o">());</span>

	<span class="k">try</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">buf</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">NioSocketChannel</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ch</span><span class="o">));</span>
			<span class="k">return</span> <span class="n">1</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to create a new channel from an accepted socket.&#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>

		<span class="k">try</span> <span class="o">{</span>
			<span class="n">ch</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t2</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Failed to close a socket.&#34;</span><span class="o">,</span> <span class="n">t2</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="k">return</span> <span class="n">0</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">通过</span> <span class="n">SocketUtils</span> <span class="n">工具类</span><span class="err">，</span><span class="n">调用</span> <span class="n">NioServerSockerChannel</span> <span class="n">内部封装的</span> <span class="n">serverSocketChannel</span> <span class="n">的</span> <span class="n">accept</span> <span class="n">方法</span><span class="err">，</span><span class="n">这是</span> <span class="n">NIO</span> <span class="n">做法</span>
<span class="n">2</span><span class="err">、</span><span class="n">获取到了一个</span> <span class="n">JDK</span> <span class="n">的</span> <span class="n">SocketChannel</span> <span class="err">，</span><span class="n">然后</span><span class="err">，</span><span class="n">使用</span> <span class="n">NioSocketChannel</span> <span class="n">进行封装</span><span class="err">。</span><span class="n">最后添加到容器中</span>
<span class="n">3</span><span class="err">、</span><span class="n">这样容器</span> <span class="n">buf</span> <span class="n">中就有了</span> <span class="n">NioSocketChannel</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927171237.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927171237.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927171237.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927171237.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927171237.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927171237.png" /></p>
<p>7、回到 read 方法，继续分析 循环执行 pipeline.fireChannelRead 方法</p>
<ol>
<li>前面分析 <code>doReadMessage</code> 方法的作用是<code>通过 ServerSocket 的 accept 方法获取到TCP连接</code>，然后<code>封装成 Netty 的 NioSocketChannel 对象</code>。最后添加到 容器中</li>
<li>在 read 方法中，<code>循环调用 ServerSocket 中 pipeline 的 fireChannelRead 方法</code>，开始执行管道中 handler 的ChannelRead 方法</li>
<li>经过debug多次，可以看到会<code>反复执行多个 handler 的 ChannelRead</code> ，我们知道， pipeline 里面有四个 handler ，分别是 <strong>Head</strong>，<strong>LoggingHandler</strong>，<strong>ServerBootstrapAcceptor</strong>，<strong>Tail</strong></li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927172454.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927172454.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927172454.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927172454.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927172454.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927172454.png" /></p>
<ol start="4">
<li>重点查看 <code>ServerBootstrapAcceptor</code> 。debug之后，断点会进入到 ServerBootstrapAcceptor中来，<code>查看 ServerBootstrapAcceptor 的 channelRead 方法</code>(要多次debug)</li>
<li>channelRead方法</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="nd">@SuppressWarnings</span><span class="o">(</span><span class="s">&#34;unchecked&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="n">Channel</span> <span class="n">child</span> <span class="o">=</span> <span class="o">(</span><span class="n">Channel</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>

	<span class="n">child</span><span class="o">.</span><span class="na">pipeline</span><span class="o">().</span><span class="na">addLast</span><span class="o">(</span><span class="n">childHandler</span><span class="o">);</span>

	<span class="n">setChannelOptions</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">childOptions</span><span class="o">,</span> <span class="n">logger</span><span class="o">);</span>

	<span class="k">for</span> <span class="o">(</span><span class="n">Entry</span><span class="o">&lt;</span><span class="n">AttributeKey</span><span class="o">&lt;?&gt;,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">e</span><span class="o">:</span> <span class="n">childAttrs</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">child</span><span class="o">.</span><span class="na">attr</span><span class="o">((</span><span class="n">AttributeKey</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;)</span> <span class="n">e</span><span class="o">.</span><span class="na">getKey</span><span class="o">()).</span><span class="na">set</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
	<span class="o">}</span>

	<span class="k">try</span> <span class="o">{</span>
		<span class="c1">// 将客户端连接注册到worker线程池
</span><span class="c1"></span>		<span class="n">childGroup</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">child</span><span class="o">).</span><span class="na">addListener</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelFutureListener</span><span class="o">()</span> <span class="o">{</span>
			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">operationComplete</span><span class="o">(</span><span class="n">ChannelFuture</span> <span class="n">future</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">future</span><span class="o">.</span><span class="na">isSuccess</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">forceClose</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">future</span><span class="o">.</span><span class="na">cause</span><span class="o">());</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">});</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">forceClose</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">msg</span> <span class="n">强转成</span> <span class="n">Channel</span><span class="err">，</span><span class="n">实际上就是</span> <span class="n">NioSocketChannel</span>
<span class="n">2</span><span class="err">、</span><span class="n">添加</span> <span class="n">NioSocketChannel</span> <span class="n">中</span> <span class="n">piprline</span> <span class="n">的</span> <span class="n">handler</span><span class="err">，</span><span class="n">就是我们</span> <span class="n">main</span> <span class="n">方法里面设置的</span> <span class="n">childHandler</span> <span class="n">方法里的</span>
<span class="n">3</span><span class="err">、</span><span class="n">设置</span> <span class="n">NioSocketChannel</span> <span class="n">的各种属性</span>
<span class="n">4</span><span class="err">、</span><span class="n">将该</span> <span class="n">NioSocketChannel</span> <span class="n">注册到</span> <span class="n">childGroup</span> <span class="n">中的一个</span> <span class="n">EventLoop</span> <span class="n">上</span><span class="err">，</span><span class="n">并添加一个监听器</span>
<span class="n">5</span><span class="err">、</span><span class="n">这个</span> <span class="n">childGroup</span> <span class="n">就是我们</span> <span class="n">main</span> <span class="n">方法创建的数组</span> <span class="n">workerGroup</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927173949.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927173949.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927173949.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927173949.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927173949.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210927173949.png" /></p>
<p>8、<strong>进入 register 方法查看(步步追踪)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="n">EventLoop</span> <span class="n">eventLoop</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">eventLoop</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;eventLoop&#34;</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">isRegistered</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span><span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;registered to an event loop already&#34;</span><span class="o">));</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(!</span><span class="n">isCompatible</span><span class="o">(</span><span class="n">eventLoop</span><span class="o">))</span> <span class="o">{</span>
		<span class="n">promise</span><span class="o">.</span><span class="na">setFailure</span><span class="o">(</span>
				<span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">&#34;incompatible event loop type: &#34;</span> <span class="o">+</span> <span class="n">eventLoop</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getName</span><span class="o">()));</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">eventLoop</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">;</span>

	<span class="k">if</span> <span class="o">(</span><span class="n">eventLoop</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
		<span class="c1">// 重点
</span><span class="c1"></span>		<span class="n">register0</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="n">eventLoop</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
				<span class="nd">@Override</span>
				<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
					<span class="n">register0</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">});</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
					<span class="s">&#34;Force-closing a channel whose registration task was not accepted by an event loop: {}&#34;</span><span class="o">,</span>
					<span class="n">AbstractChannel</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
			<span class="n">closeForcibly</span><span class="o">();</span>
			<span class="n">closeFuture</span><span class="o">.</span><span class="na">setClosed</span><span class="o">();</span>
			<span class="n">safeSetFailure</span><span class="o">(</span><span class="n">promise</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>9、最终会调用 doBeginRead 方法，也就是 AbstractNioChannel 类的方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doBeginRead</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
	<span class="c1">// Channel.read() or ChannelHandlerContext.read() was called
</span><span class="c1"></span>	<span class="kd">final</span> <span class="n">SelectionKey</span> <span class="n">selectionKey</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">selectionKey</span><span class="o">;</span>
	<span class="k">if</span> <span class="o">(!</span><span class="n">selectionKey</span><span class="o">.</span><span class="na">isValid</span><span class="o">())</span> <span class="o">{</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="n">readPending</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>

	<span class="kd">final</span> <span class="kt">int</span> <span class="n">interestOps</span> <span class="o">=</span> <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">((</span><span class="n">interestOps</span> <span class="o">&amp;</span> <span class="n">readInterestOp</span><span class="o">)</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">interestOps</span> <span class="o">|</span> <span class="n">readInterestOp</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>10、这个地方调试时，请把前面的断点都去掉，然后启动服务器就会停止在doBeginRead(需要先放过该断点，然后浏览器请求，才能看到效果)</p>
<p>11、执行到这里，针对于这个客户端的连接就完成了，接下来就可以监听事件了</p>
<h3 id="1033netty接受请求过程">10.3.3、Netty接受请求过程</h3>
<p><strong>总体流程：</strong></p>
<p>接受连接 &mdash;&gt; 创建一个新的 NioSocketChannel &mdash;&gt; 注册到一个 workerGroup 上 &mdash;&gt; 注册selectorRead 事件</p>
<ol>
<li>服务器轮询 Accept 事件，获取事件后<code>调用 unsafe 的 read 方法</code>，这个 <code>unsafe 是 ServerSocket 的内部类</code>，该方法内部由2部分组成</li>
<li><code>doReadMessages 用于创建 NioSocketChannel 对象</code>，该对象用于包装 JDK 生成的 NioSocketChannel 然后将封装好的对象放入容器中</li>
<li>随后执行 <code>pipeline.fireChannelRead 方法</code>，<code>并将自己绑定到一个 chooser 选择器选择</code>的 workerGroup 中的一个 EventLoop。并且注册一个0，表示注册成功，但并没有注册读（1）事件</li>
</ol>
<h2 id="104pipeline-handler-handlercontext创建源码剖析">10.4、Pipeline Handler HandlerContext创建源码剖析</h2>
<h3 id="1041源码剖析目的">10.4.1、源码剖析目的</h3>
<p>Netty 中的 <code>ChannelPipeline</code> 、 <code>ChannelHandler</code> 和 <code>ChannelHandlerContext</code> 是非常核心的组件, 我们从源码来分析Netty 是如何设计这三个核心组件的，并分析是如何创建和协调工作的</p>
<h3 id="1042源码剖析">10.4.2、源码剖析</h3>
<p>1、<strong>ChannelPipeline 、 ChannelHandler 和 ChannelHandlerContext 介绍</strong></p>
<pre><code>1.1 三者关系
1、每当 ServerSocket 创建一个新的连接，就会创建一个 Socket，对应的就是目标客户端
2、每一个新创建的 Socket 都将会分配一个全新的 ChannelPipeline (以下简称 pipeline)
3、每一个 ChannelPipeline 内部都含有多个 ChannelHandlerContext (以下简称 Context)
4、他们一起组成了双向链表，这些 Context 用于包装我们调用 addLast 方法时添加的 ChannelHandler (以下简称handler)
</code></pre>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928101618.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928101618.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928101618.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928101618.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928101618.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928101618.png" /></p>
<pre><code>1、上图中：ChannelSocket 和 ChannelPipeline 是一对一的关联关系，而 pipeline 内部的多个 Context 形成了链表，
Context 只是对 Handler 的封装
2、当一个请求进来的时候，会进入 Socket 对应的pipeline，并经过 pipeline 所有的 handler 对，就是设计模式中的过滤器模式
</code></pre>
<p>2、<strong>ChannelPipeline 作用及设计</strong></p>
<pre><code>1、pipeline 的接口设计
</code></pre>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102007.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102007.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102007.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102007.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102007.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102007.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102253.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102253.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102253.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102253.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102253.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102253.png" /></p>
<p>该接口继承了 inBound、outBound、Iterable 接口，表示它可以调用<strong>数据出站的方法和入站的方法</strong>，同时也能遍历内部的链表，它的几个代表性的方法，基本上都是针对 handler 链表的插入、追加、删除、替换操作，类似是一个 LinkeList。同时，也能返回 channel (也就是socket)</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102550.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102550.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102550.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102550.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102550.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928102550.png" /></p>
<p><strong>对上图的解释和说明</strong></p>
<ul>
<li>这是一个 handler 的 list，handler 用于处理或拦截入站事件和出站事件，pipeline 实现了过滤器的高级形式，方便用户控制事件如何处理以及 handler 在 pipeline 中如何交互</li>
<li>上图描述了一个典型的 handler 在 pipeline 中处理I/O 事件的方式，IO 事件由 inboundHandler 或者 outboundHandler 处理，并通过调用 <code>ChannelHandlerContext.fireChannelRead</code> 方法转发给其最近的处理程序</li>
<li>入站事件由入站处理程序以自下而上的方向处理，如图所示，入站处理程序通常处理由图底部的 IO 线程生成入站数据，入站数据通常从如 <code>SocketChannel.read(ByteBuffer)</code> 获取</li>
<li>通常一个 pipeline 有多个 handler，例如，一个典型的服务器在每个通道的管道中都会有以下处理程序
<ul>
<li>协议解码器  &ndash; 将二进制数据转换为Java对象</li>
<li>协议编码器  &ndash; 将Java对象转换为二进制数据</li>
<li>业务逻辑处理程序 &ndash; <strong>执行实际业务逻辑</strong></li>
</ul>
</li>
<li><code>你的业务程序不能将线程阻塞，会影响 IO 速度，进而影响整个 Netty 程序的性能。如果你的业务程序很快，就可以放在 IO 线程中，反之，你需要异步执行，如之前的3中Task；或者在添加 handler 的时候添加一个线程池</code>，例如
<ul>
<li>pipeline.addLast(group,&ldquo;handler&rdquo;,new MyBusinessLogicHandler())</li>
</ul>
</li>
</ul>
<p>3、 <strong>ChannelHandler 作用及设计</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ChannelHandler</span> <span class="o">{</span>
	<span class="c1">//  当 ChannelHandler 添加 pipeline 时被调用
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">handlerAdded</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
	<span class="c1">// 当 从pipeline 中移除时调用
</span><span class="c1"></span>    <span class="kt">void</span> <span class="nf">handlerRemoved</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
	<span class="c1">// 当处理过程中在 pipeline 发生异常时调用
</span><span class="c1"></span>    <span class="nd">@Deprecated</span>
    <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">ChannelHandler</span> <span class="n">的作用就是处理</span> <span class="n">IO</span> <span class="n">事件或拦截</span> <span class="n">IO</span> <span class="n">事件</span><span class="err">，</span><span class="n">并将其转发给下一个处理程序</span> <span class="n">ChannelHandler</span><span class="err">。</span><span class="n">Handler</span> <span class="n">处理</span>
<span class="n">事件时分入站和出站的</span><span class="err">，</span><span class="n">两个方向的操作都是不同的</span><span class="err">，</span><span class="n">因此</span><span class="err">，</span><span class="n">Netty</span> <span class="n">定义了两个子接口继承</span> <span class="n">ChannelHandler</span>
</code></pre></td></tr></table>
</div>
</div><p><code>1、ChannelInboundHandler 入站事件接口</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105301.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105301.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105301.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105301.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105301.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105301.png" /></p>
<ul>
<li>channelActive 用于当 Channel 处于活动状态时被调用</li>
<li>channelRead 当从 channel 读取数据时被调用</li>
<li>程序员需要重写一些方法，当发生关注的事件，需要在方法中实现我们的业务逻辑，因此当事件发生时，Netty 会回调对应的方法</li>
</ul>
<p><code>2、ChannelOutboundHandler 出战事件接口</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105755.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105755.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105755.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105755.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105755.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928105755.png" /></p>
<ul>
<li>bind 方法，当请求将 channel 绑定到本地地址时调用</li>
<li>close 方法，当请求关闭 channel 时调用</li>
<li>出站操作都是一些连接和写出数据类似的方法</li>
</ul>
<p><code>3、ChannelDuplexHandler</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928110012.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928110012.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928110012.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928110012.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928110012.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928110012.png" /></p>
<ul>
<li>ChannelDuplexHandler 间接实现了入站接口并直接实现了出战接口</li>
<li>是一个通用的能够同时处理入站事件和出站事件的类</li>
<li>现实中尽量不要使用 <code>ChannelDuplexHandler</code> 因为它既可读也可写，容易弄混淆</li>
</ul>
<p><code>4、ChannelHandlerContext</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112357.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112357.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112357.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112357.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112357.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112357.png" /></p>
<p>ChannelHandlerContext 继承了出站方法调用接口和入站方法调用接口</p>
<ol>
<li>ChannelOutboundInvoker 和 ChannelInboundInvoker 结构</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112937.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112937.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112937.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112937.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112937.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112937.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112951.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112951.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112951.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112951.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112951.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928112951.png" /></p>
<ul>
<li>这两个 invoker 就是针对入站或出站方法来的，就是在入站或出站 handler 的外层再包装一层，达到再方法前后<strong>拦截并做一些特定操作</strong>的目的</li>
</ul>
<ol start="2">
<li>ChannelHandlerContext 结构</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928113059.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928113059.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928113059.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928113059.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928113059.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928113059.png" /></p>
<ul>
<li>ChannelHandlerContext 不仅仅是继承了他们两个的方法，同时也定义了一些自己的方法</li>
<li>这些方法能够获取 Context 上下文环境中对应的 channel、executor、handler、pipeline、内存分配器、关联的 handler 是否被删除</li>
<li>Context 就是包装了 handler 相关的一切，以方便 Context 可以再pipeline 方便的操作 handler</li>
</ul>
<p><code>5、ChannelPipeline 、 ChannelHandler 和 ChannelHandlerContext 创建过程</code></p>
<p>分为三步骤来看创建过程</p>
<ul>
<li>任何一个 ChannelSocket 创建的同时都会创建一个 pipeline</li>
<li>当用户或系统内部调用 pipeline 的 add*** 方法添加 handler 时，都会创建一个包装这个 handler 的Context</li>
<li>这些 Context 在 pipeline 中组成了双向链表</li>
</ul>
<p><strong>Socket 创建的时候创建 pipeline</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="c1">// 在 SocketChannel 的抽象父类 AbstractChannel 的构造方法中
</span><span class="c1"></span><span class="kd">protected</span> <span class="nf">AbstractChannel</span><span class="o">(</span><span class="n">Channel</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>  
 <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>  
    <span class="n">id</span> <span class="o">=</span> <span class="n">newId</span><span class="o">();</span>  
    <span class="n">unsafe</span> <span class="o">=</span> <span class="n">newUnsafe</span><span class="o">();</span>  
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">newChannelPipeline</span><span class="o">();</span>  
<span class="o">}</span>

<span class="c1">// Debug后，代码会执行到这里，继续追踪
</span><span class="c1"></span><span class="kd">protected</span> <span class="nf">DefaultChannelPipeline</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>  
 <span class="k">this</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="s">&#34;channel&#34;</span><span class="o">);</span>  
    <span class="n">succeededFuture</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SucceededChannelFuture</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>  
    <span class="n">voidPromise</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VoidChannelPromise</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>  
  
    <span class="n">tail</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TailContext</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>  
    <span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HeadContext</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>  
  
    <span class="n">head</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span>  
    <span class="n">tail</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>  
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">将</span> <span class="n">channel</span> <span class="n">赋值给</span> <span class="n">channel</span> <span class="n">字段</span><span class="err">，</span><span class="n">用于</span> <span class="n">pipeline</span> <span class="n">操作</span> <span class="n">channel</span>
<span class="n">2</span><span class="err">、</span><span class="n">创建一个</span> <span class="n">future</span> <span class="n">和</span> <span class="n">promise</span><span class="err">，</span><span class="n">用于异步回调</span>
<span class="n">3</span><span class="err">、</span><span class="n">创建一个</span> <span class="n">inbound</span> <span class="n">的</span> <span class="n">tailContext</span><span class="err">，</span><span class="n">创建一个既是</span> <span class="n">inbound</span> <span class="n">类型又是</span> <span class="n">outbound</span> <span class="n">类型的</span> <span class="n">headContext</span>
<span class="n">4</span><span class="err">、</span><span class="n">最后</span><span class="err">，</span><span class="n">将两个</span> <span class="n">Context</span> <span class="n">互相连接</span><span class="err">，</span><span class="n">形成双向链表</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>在 add&mdash; 添加处理器的时候创建 Context&mdash;-</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="n">查看</span> <span class="n">DefaultChannelPipeline</span> <span class="n">的</span> <span class="n">addLast</span> <span class="n">方法如何创建的</span> <span class="n">Context</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">addLast</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">executor</span><span class="o">,</span> <span class="n">ChannelHandler</span><span class="o">...</span> <span class="n">handlers</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">handlers</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;handlers&#34;</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="k">for</span> <span class="o">(</span><span class="n">ChannelHandler</span> <span class="n">h</span><span class="o">:</span> <span class="n">handlers</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">break</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">addLast</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">h</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

 <span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">addLast</span><span class="o">(</span><span class="n">EventExecutorGroup</span> <span class="n">group</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">,</span> <span class="n">ChannelHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">newCtx</span><span class="o">;</span>
	<span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">checkMultiplicity</span><span class="o">(</span><span class="n">handler</span><span class="o">);</span>

		<span class="n">newCtx</span> <span class="o">=</span> <span class="n">newContext</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">filterName</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">handler</span><span class="o">),</span> <span class="n">handler</span><span class="o">);</span>

		<span class="n">addLast0</span><span class="o">(</span><span class="n">newCtx</span><span class="o">);</span>

		<span class="c1">// If the registered is false it means that the channel was not registered on an eventloop yet.
</span><span class="c1"></span>		<span class="c1">// In this case we add the context to the pipeline and add a task that will call
</span><span class="c1"></span>		<span class="c1">// ChannelHandler.handlerAdded(...) once the channel is registered.
</span><span class="c1"></span>		<span class="k">if</span> <span class="o">(!</span><span class="n">registered</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">newCtx</span><span class="o">.</span><span class="na">setAddPending</span><span class="o">();</span>
			<span class="n">callHandlerCallbackLater</span><span class="o">(</span><span class="n">newCtx</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
			<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">newCtx</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">newCtx</span><span class="o">.</span><span class="na">setAddPending</span><span class="o">();</span>
			<span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
				<span class="nd">@Override</span>
				<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
					<span class="n">callHandlerAdded0</span><span class="o">(</span><span class="n">newCtx</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">});</span>
			<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
		<span class="o">}</span>
	<span class="o">}</span>
	<span class="n">callHandlerAdded0</span><span class="o">(</span><span class="n">newCtx</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">pipeline</span> <span class="n">添加</span> <span class="n">handler</span><span class="err">，</span><span class="n">参数是线程池</span><span class="err">，</span><span class="n">name</span> <span class="n">是</span> <span class="kc">null</span><span class="err">，</span><span class="n">handler</span> <span class="n">是我们或者系统传入的handler</span><span class="err">。</span>
<span class="n">Netty</span> <span class="n">为了防止多个线程导致安全问题</span><span class="err">，</span><span class="n">同步了这段代码</span><span class="err">，</span><span class="n">步骤如下</span>
<span class="n">2</span><span class="err">、</span><span class="n">检查这个</span> <span class="n">handler</span> <span class="n">实例是否是共享的</span><span class="err">，</span><span class="n">如果不是</span><span class="err">，</span><span class="n">并且已经被别的</span> <span class="n">pipeline</span> <span class="n">使用了</span><span class="err">，</span><span class="n">则抛出异常</span>
<span class="n">3</span><span class="err">、</span> <span class="n">调用</span> <span class="n">newCtx</span> <span class="o">=</span> <span class="n">newContext</span><span class="o">(</span><span class="n">group</span><span class="o">,</span> <span class="n">filterName</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">handler</span><span class="o">),</span> <span class="n">handler</span><span class="o">)</span> <span class="n">方法</span><span class="err">，</span><span class="n">创建一个</span> <span class="n">Context</span><span class="err">。</span>
<span class="n">从这里可以看出来</span><span class="err">，</span><span class="n">每次添加一个</span> <span class="n">handler</span> <span class="n">都会创建一个</span> <span class="n">Context</span> <span class="n">关联</span>
<span class="n">4</span><span class="err">、</span><span class="n">调用</span> <span class="n">addLast</span> <span class="n">方法</span><span class="err">，</span><span class="n">将</span> <span class="n">Context</span> <span class="n">追加到链表中</span>
<span class="n">5</span><span class="err">、</span><span class="n">如果这个通道还没有注册到</span> <span class="n">selector</span> <span class="n">上</span><span class="err">，</span><span class="n">就将这个</span> <span class="n">Context</span> <span class="n">添加到</span> <span class="n">这个</span> <span class="n">pipeline</span> <span class="n">的待办任务中</span><span class="err">。</span>
<span class="n">当注册好了以后</span><span class="err">，</span><span class="n">就会调用</span> <span class="n">callHandlerAdded0</span> <span class="nf">方法</span> <span class="o">(</span><span class="n">默认是什么都不做</span><span class="err">，</span><span class="n">用户可实现该方法</span><span class="o">)</span>
<span class="n">6</span><span class="err">、</span><span class="n">到这里</span><span class="err">，</span><span class="n">针对三对象创建过程</span><span class="err">，</span><span class="n">基本了解</span><span class="err">，</span><span class="n">和最初说的一样</span><span class="err">，</span><span class="n">每当创建</span> <span class="n">ChannelSocket</span> <span class="n">的时候都会创建一个绑定的</span>
<span class="n">pipeline</span><span class="err">，</span><span class="n">一对一的关系</span><span class="err">，</span><span class="n">创建</span> <span class="n">pipeline</span> <span class="n">的时候也会创建</span> <span class="n">tail</span> <span class="n">节点和</span> <span class="n">head</span> <span class="n">节点</span><span class="err">，</span><span class="n">形成最初的链表</span><span class="err">，</span><span class="n">tail</span> <span class="n">是入站inbound</span>
<span class="n">类型的</span> <span class="n">handler</span><span class="err">，</span><span class="n">head</span> <span class="n">既是</span> <span class="n">inbound</span> <span class="n">也是</span> <span class="n">outbound</span> <span class="n">类型的</span> <span class="n">handler</span><span class="err">。</span><span class="n">在调用</span> <span class="n">pipeline</span> <span class="n">的</span> <span class="n">addLast</span> <span class="n">方法的时候会根据</span>
<span class="n">给定的</span> <span class="n">handler</span> <span class="n">创建一个</span> <span class="n">Context</span><span class="err">，</span><span class="n">然后</span><span class="err">，</span><span class="n">将这个</span> <span class="n">Context</span> <span class="nf">插入到链表的尾端</span><span class="o">(</span><span class="n">tail前面</span><span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="1043pipeline-handler-handlercontext-创建过程梳理">10.4.3、Pipeline Handler HandlerContext 创建过程梳理</h3>
<ol>
<li>每当创建 ChannelSocket 的时候都会创建一个绑定 pipeline，一对一的关系，创建 pipeline 的时候也会创建 tail 节点和 head 节点，形成最初的链表</li>
<li>在调用 pipeline 的 addLast 方法的时候，会根据给定的 handler 创建一个 Context，然后，将这个 Context 插入到链表的尾端(tail前面)</li>
<li>Context 包装 handler，多个 Context 在 pipeline 中形成了双向链表</li>
<li>入站的方向叫 inbound，由 head 节点开始，出站的方法叫 outbound，由 tail 节点开始</li>
</ol>
<h2 id="105channelpipeline-调度-handler-的源码剖析">10.5、ChannelPipeline 调度 handler 的源码剖析</h2>
<h3 id="1051源码剖析的目的">10.5.1、源码剖析的目的</h3>
<ol>
<li>当一个请求进来的时候，ChannelPipeline 是如何调用内部的这些 handle 的呢？</li>
<li>首先，当一个请求进来的时候，会第一个调用 pipeline 的相关方法，如果是入站事件，这些方法由 <code>fire</code> 开头，表示管道的流动，让后面的 handler 继续处理</li>
</ol>
<h3 id="1052源码剖析">10.5.2、源码剖析</h3>
<ol>
<li>当浏览器输入 http://localhost:8007/，可以看到会执行的handler</li>
<li>在 Debug 时，可以将断点下在 <code>DefaultChannelPipeline</code>类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">fireChannelActive</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">AbstractChannelHandlerContext</span><span class="o">.</span><span class="na">invokeChannelActive</span><span class="o">(</span><span class="n">head</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="1053源码分析">10.5.3、源码分析</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="n">pipeline</span> <span class="n">的</span> <span class="n">inbound</span> <span class="n">的</span> <span class="n">fire</span> <span class="n">方法实现</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">fireChannelActive</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">AbstractChannelHandlerContext</span><span class="o">.</span><span class="na">invokeChannelActive</span><span class="o">(</span><span class="n">head</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">fireChannelInactive</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">AbstractChannelHandlerContext</span><span class="o">.</span><span class="na">invokeChannelInactive</span><span class="o">(</span><span class="n">head</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">fireExceptionCaught</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">AbstractChannelHandlerContext</span><span class="o">.</span><span class="na">invokeExceptionCaught</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">cause</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">fireUserEventTriggered</span><span class="o">(</span><span class="n">Object</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">AbstractChannelHandlerContext</span><span class="o">.</span><span class="na">invokeUserEventTriggered</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">fireChannelRead</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">AbstractChannelHandlerContext</span><span class="o">.</span><span class="na">invokeChannelRead</span><span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">msg</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">fireChannelReadComplete</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">AbstractChannelHandlerContext</span><span class="o">.</span><span class="na">invokeChannelReadComplete</span><span class="o">(</span><span class="n">head</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">fireChannelWritabilityChanged</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">AbstractChannelHandlerContext</span><span class="o">.</span><span class="na">invokeChannelWritabilityChanged</span><span class="o">(</span><span class="n">head</span><span class="o">);</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">这些方法都是</span> <span class="n">inbound</span> <span class="n">方法</span><span class="err">，</span><span class="n">也就是入站事件</span><span class="err">，</span><span class="n">调用静态方法传入也是</span> <span class="n">inbound</span> <span class="n">类型的</span> <span class="n">head</span> <span class="n">handler</span><span class="err">。</span>
<span class="n">2</span><span class="err">、</span><span class="n">这些静态方法则会调用</span> <span class="n">head</span> <span class="n">的</span> <span class="n">ChannelInboundInvoker</span> <span class="n">接口的方法</span><span class="err">，</span><span class="n">然后调用</span> <span class="n">handler</span> <span class="n">的真正方法</span>

<span class="n">pipeline</span> <span class="n">的</span> <span class="n">outbound</span> <span class="n">的</span> <span class="n">fire</span> <span class="n">方法实现</span>
<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">bind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">remoteAddress</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">remoteAddress</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">remoteAddress</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">remoteAddress</span><span class="o">,</span> <span class="n">localAddress</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">disconnect</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">disconnect</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">close</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">deregister</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">deregister</span><span class="o">();</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelPipeline</span> <span class="nf">flush</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">tail</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
	<span class="k">return</span> <span class="k">this</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">bind</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span><span class="n">SocketAddress</span> <span class="n">remoteAddress</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">remoteAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
<span class="o">}</span>

<span class="nd">@Override</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">connect</span><span class="o">(</span>
		<span class="n">SocketAddress</span> <span class="n">remoteAddress</span><span class="o">,</span> <span class="n">SocketAddress</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">remoteAddress</span><span class="o">,</span> <span class="n">localAddress</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
<span class="o">}</span>
<span class="nd">@Override</span>  
<span class="kd">public</span> <span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="nf">disconnect</span><span class="o">(</span><span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>  
	<span class="k">return</span> <span class="n">tail</span><span class="o">.</span><span class="na">disconnect</span><span class="o">(</span><span class="n">promise</span><span class="o">);</span>  
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">这些都是出站的实现</span><span class="err">，</span><span class="n">但是调用的是</span> <span class="n">outbound</span> <span class="n">类型的</span> <span class="n">tail</span> <span class="n">handler</span> <span class="n">来进行处理的</span><span class="err">，</span><span class="n">因为这些都是</span> <span class="n">outbound</span> <span class="n">事件</span>
<span class="n">2</span><span class="err">、</span><span class="n">出站是</span> <span class="n">tail</span> <span class="n">开始</span><span class="err">，</span><span class="n">入站从</span> <span class="n">head</span> <span class="n">开始</span><span class="err">。</span><span class="n">因为出站是从内部向外面写</span><span class="err">，</span><span class="n">从</span> <span class="n">tail</span> <span class="n">开始</span><span class="err">，</span><span class="n">能够让前面的</span> <span class="n">handler</span> <span class="n">进行处理</span><span class="err">，</span>
<span class="n">防止</span> <span class="n">handler</span> <span class="n">被遗漏</span><span class="err">，</span><span class="n">比如编码</span><span class="err">。</span><span class="n">反之</span><span class="err">，</span><span class="n">入站当然是从</span> <span class="n">head</span> <span class="n">往内部输入</span><span class="err">，</span><span class="n">让后面的</span> <span class="n">handler</span> <span class="n">能够处理这些输入的数据</span><span class="err">。</span>
<span class="n">比如解码</span><span class="err">。</span><span class="n">因此虽然</span> <span class="n">head</span> <span class="n">也实现了</span> <span class="n">outbound</span> <span class="n">接口</span><span class="err">，</span><span class="n">单不是从</span> <span class="n">head</span> <span class="n">开始执行出站任务</span>
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928162603.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928162603.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928162603.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928162603.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928162603.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928162603.png" /></p>
<pre><code>说明：
1、pipeline 首先会调用 Context 的静态方法 fireXXX，并传入 Context
2、然后，静态方法调用 Context 的 invoker 方法，而 invoker 方法内部会调用该 Context 所包含的 Handler 的真正 XXX 
方法，调用结束后，如果还需要继续往后传递，就调用 Context 的 fireXXX2 方法，循环往复
</code></pre>
<h3 id="1054channel-pipeline-调度-handler-梳理">10.5.4、Channel Pipeline 调度 handler 梳理</h3>
<ol>
<li>Context 包装 handler，多个 Context 在 pipeline 中形成了<code>双向链表</code>，<code>入站方向叫 inbound</code>，<strong>由 head 节点开始</strong>，<code>出站方法叫 outbound</code> ，<strong>由 tail 节点开始</strong></li>
<li>而节点中间的传递通过 AbstractChannelHandlerContext 类内部的 <code>fire</code> 系列方法，找到当前节点的下一个节点不断的循环传播。是一个过滤器形式完成对handler 的调度</li>
</ol>
<h2 id="106netty-心跳heartbeat服务源码剖析">10.6、Netty 心跳(heartbeat)服务源码剖析</h2>
<ol>
<li>源码剖析目的
<ul>
<li>Netty 作为一个网络框架，提供了诸多功能，比如编码解码等，Netty 还提供了非常重要的一个服务&mdash;&ndash;心跳机制heartbeat。通过心跳检查对方是否有效，这是 RPC 框架中是必不可少的功能。下面我们分析一下Netty内部心跳服务源码实现</li>
</ul>
</li>
<li>源码剖析
<ul>
<li>Netty 提供了 <code>IdleStateHandler</code> ，<code>ReadTimeoutHandler</code>，<code>WriteTimeoutHandler</code> 三个Handler 检测连接的有效性，<strong>重点分析 IdleStateHandler</strong></li>
<li><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928172415.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928172415.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928172415.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928172415.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928172415.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928172415.png" /></li>
</ul>
</li>
</ol>
<h3 id="1061idlestatehandler-分析">10.6.1、IdleStateHandler 分析</h3>
<ol>
<li>4 个属性</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">observeOutput</span><span class="o">;</span>		<span class="c1">// 是否考虑出站时比较慢的情况。默认值是false
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">readerIdleTimeNanos</span><span class="o">;</span>	   <span class="c1">// 读事件空闲时间，0 代表禁用事件
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">writerIdleTimeNanos</span><span class="o">;</span>		<span class="c1">// 写事件空闲事件，0 代表禁用事件
</span><span class="c1"></span><span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">allIdleTimeNanos</span><span class="o">;</span>		  <span class="c1">//  读或写空闲事件，0 代表禁用事件
</span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>handlerAdded 方法；<strong>当该 handler 被添加到 pipeline 中时，则调用 initialize 方法</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// Avoid the case where destroy() is called before scheduling timeouts.
</span><span class="c1"></span>	<span class="c1">// See: https://github.com/netty/netty/issues/143
</span><span class="c1"></span>	<span class="k">switch</span> <span class="o">(</span><span class="n">state</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">case</span> <span class="n">1</span><span class="o">:</span>
	<span class="k">case</span> <span class="n">2</span><span class="o">:</span>
		<span class="k">return</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
	<span class="c1">// 重要方法！！！！！
</span><span class="c1"></span>	<span class="n">initOutputChanged</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>

	<span class="n">lastReadTime</span> <span class="o">=</span> <span class="n">lastWriteTime</span> <span class="o">=</span> <span class="n">ticksInNanos</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">readerIdleTimeNanos</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 这里的 schedule 方法会调用 eventLoop 的 schedule 方法，将定时任务添加进队列任务中
</span><span class="c1"></span>		<span class="n">readerIdleTimeout</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="k">new</span> <span class="n">ReaderIdleTimeoutTask</span><span class="o">(</span><span class="n">ctx</span><span class="o">),</span>
				<span class="n">readerIdleTimeNanos</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">writerIdleTimeNanos</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">writerIdleTimeout</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="k">new</span> <span class="n">WriterIdleTimeoutTask</span><span class="o">(</span><span class="n">ctx</span><span class="o">),</span>
				<span class="n">writerIdleTimeNanos</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">allIdleTimeNanos</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">allIdleTimeout</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="k">new</span> <span class="n">AllIdleTimeoutTask</span><span class="o">(</span><span class="n">ctx</span><span class="o">),</span>
				<span class="n">allIdleTimeNanos</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">只要给定的参数大于</span> <span class="n">0</span> <span class="err">，</span><span class="n">就创建一个定时任务</span><span class="err">，</span><span class="n">每个事件都创建</span><span class="err">。</span><span class="n">同时</span><span class="err">，</span><span class="n">将</span> <span class="n">state</span> <span class="n">状态设置为</span> <span class="n">1</span><span class="err">，</span><span class="n">防止重复初始化</span><span class="err">，</span><span class="n">调用</span> 
<span class="n">initOutputChanged</span> <span class="n">方法</span><span class="err">，</span><span class="n">初始化</span><span class="err">“</span><span class="n">监控出站数据属性</span><span class="err">”</span>
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>该内部类的 3 个定时任务类</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928173359.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928173359.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928173359.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928173359.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928173359.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928173359.png" /></p>
<ul>
<li>这三个定时任务分别对应 读、写、读或者写 事件，共有一个父类(AbstractIdleTask)。这个父类提供了一个模板方法</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kd">abstract</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">AbstractIdleTask</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>

	<span class="kd">private</span> <span class="kd">final</span> <span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">;</span>

	<span class="n">AbstractIdleTask</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">this</span><span class="o">.</span><span class="na">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">isOpen</span><span class="o">())</span> <span class="o">{</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">run</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">);</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span><span class="n">当通道关闭了</span><span class="err">，</span><span class="n">就不执行任务了</span><span class="err">，</span><span class="n">反之</span><span class="err">，</span><span class="n">执行子类的</span> <span class="n">run</span> <span class="n">方法</span>
</code></pre></td></tr></table>
</div>
</div><ol start="4">
<li><strong>读事件的 run 方法(即 ReadIdleTimeoutTask 的run 方法)分析</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReaderIdleTimeoutTask</span> <span class="kd">extends</span> <span class="n">AbstractIdleTask</span> <span class="o">{</span>

	<span class="n">ReaderIdleTimeoutTask</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
		<span class="kt">long</span> <span class="n">nextDelay</span> <span class="o">=</span> <span class="n">readerIdleTimeNanos</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">reading</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// ticksInNanos()：当前时间
</span><span class="c1"></span>			<span class="c1">// lastReadTime：上次最后1次读的时间
</span><span class="c1"></span>			<span class="c1">// nextDelay：设置的超时时间
</span><span class="c1"></span>			<span class="n">nextDelay</span> <span class="o">-=</span> <span class="n">ticksInNanos</span><span class="o">()</span> <span class="o">-</span> <span class="n">lastReadTime</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">nextDelay</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Reader is idle - set a new timeout and notify the callback.
</span><span class="c1"></span>			<span class="c1">// 用于取消任务 promise
</span><span class="c1"></span>			<span class="n">readerIdleTimeout</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">readerIdleTimeNanos</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span>

			<span class="kt">boolean</span> <span class="n">first</span> <span class="o">=</span> <span class="n">firstReaderIdleEvent</span><span class="o">;</span>
			<span class="n">firstReaderIdleEvent</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// 再次提交任务
</span><span class="c1"></span>				<span class="n">IdleStateEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="n">newIdleStateEvent</span><span class="o">(</span><span class="n">IdleState</span><span class="o">.</span><span class="na">READER_IDLE</span><span class="o">,</span> <span class="n">first</span><span class="o">);</span>
				<span class="n">channelIdle</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">ctx</span><span class="o">.</span><span class="na">fireExceptionCaught</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="c1">// Read occurred before the timeout - set a new timeout with shorter delay.
</span><span class="c1"></span>			<span class="n">readerIdleTimeout</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">nextDelay</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">得到用户设置的超时事件</span>
<span class="n">2</span><span class="err">、</span><span class="n">如果读取操作结束了</span><span class="o">(</span><span class="n">执行了</span> <span class="n">channelReadComplete</span> <span class="n">方法设置</span><span class="o">)</span><span class="err">，</span><span class="n">就用设置时间</span><span class="o">-(</span><span class="n">给定时间</span><span class="o">-</span><span class="n">上次最后一次读的</span>
<span class="n">时间的结果</span><span class="o">)</span><span class="err">，</span><span class="n">如果小于</span> <span class="n">0</span> <span class="err">，</span><span class="n">就触发事件</span><span class="err">。</span><span class="n">反之</span><span class="err">，</span><span class="n">继续放入队列</span><span class="err">。</span><span class="n">间隔时间是新的计算时间</span>
<span class="n">3</span><span class="err">、</span><span class="n">触发的逻辑是</span><span class="err">：</span><span class="n">首先将任务再次放到队列</span><span class="err">，</span><span class="n">时间是设置的超时时间</span><span class="err">，</span><span class="n">返回一个</span> <span class="n">promise</span> <span class="n">对象</span><span class="err">，</span><span class="n">用于做取消操作</span><span class="err">，</span>
<span class="n">然后</span><span class="err">，</span><span class="n">设置</span> <span class="n">first</span> <span class="n">属性为</span> <span class="kc">false</span><span class="err">，</span><span class="n">表示下一次读取不再是第一次了</span><span class="err">，</span><span class="n">这个属性在</span> <span class="n">channelRead</span> <span class="n">方法会被改成</span> <span class="kc">true</span>
<span class="n">4</span><span class="err">、</span><span class="n">创建一个</span> <span class="n">IdleStateEvent</span> <span class="n">类型的写事件对象</span><span class="err">，</span><span class="n">将次对象传递给用户的</span> <span class="n">UserEventTriggered</span> <span class="n">方法</span><span class="err">，</span><span class="n">完成触发事件操作</span>
<span class="n">5</span><span class="err">、</span><span class="n">总的来说</span><span class="err">，</span><span class="n">每次读取操作都会记录一个时间</span><span class="err">，</span><span class="n">定时任务时间到了</span><span class="err">，</span><span class="n">会计算当前时间和最后一次读的时间的间隔</span><span class="err">，</span><span class="n">如果</span>
<span class="n">时间间隔超过了设置的时间</span><span class="err">，</span><span class="n">就触发</span> <span class="n">UserEventTriggered</span> <span class="n">方法</span><span class="err">（</span><span class="n">前面写心跳机制案例时提到过的自定义handler名</span><span class="err">）</span>
</code></pre></td></tr></table>
</div>
</div><ol start="5">
<li><strong>写事件的 run 方法(即 WriterIdleTimeoutTask 的run 方法)分析</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">WriterIdleTimeoutTask</span> <span class="kd">extends</span> <span class="n">AbstractIdleTask</span> <span class="o">{</span>

	<span class="n">WriterIdleTimeoutTask</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>

		<span class="kt">long</span> <span class="n">lastWriteTime</span> <span class="o">=</span> <span class="n">IdleStateHandler</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">lastWriteTime</span><span class="o">;</span>
		<span class="kt">long</span> <span class="n">nextDelay</span> <span class="o">=</span> <span class="n">writerIdleTimeNanos</span> <span class="o">-</span> <span class="o">(</span><span class="n">ticksInNanos</span><span class="o">()</span> <span class="o">-</span> <span class="n">lastWriteTime</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">nextDelay</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Writer is idle - set a new timeout and notify the callback.
</span><span class="c1"></span>			<span class="n">writerIdleTimeout</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">writerIdleTimeNanos</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span>

			<span class="kt">boolean</span> <span class="n">first</span> <span class="o">=</span> <span class="n">firstWriterIdleEvent</span><span class="o">;</span>
			<span class="n">firstWriterIdleEvent</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

			<span class="k">try</span> <span class="o">{</span>
				<span class="c1">// 不同点！！！！！
</span><span class="c1"></span>				<span class="k">if</span> <span class="o">(</span><span class="n">hasOutputChanged</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">first</span><span class="o">))</span> <span class="o">{</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="o">}</span>

				<span class="n">IdleStateEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="n">newIdleStateEvent</span><span class="o">(</span><span class="n">IdleState</span><span class="o">.</span><span class="na">WRITER_IDLE</span><span class="o">,</span> <span class="n">first</span><span class="o">);</span>
				<span class="n">channelIdle</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">ctx</span><span class="o">.</span><span class="na">fireExceptionCaught</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="c1">// Write occurred before the timeout - set a new timeout with shorter delay.
</span><span class="c1"></span>			<span class="n">writerIdleTimeout</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">nextDelay</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span><span class="n">写任务的</span> <span class="n">run</span> <span class="n">代码逻辑基本上和读任务的逻辑一样</span><span class="err">，</span><span class="n">唯一不同的就是由一个针对出站较慢数据的判断</span> <span class="n">hasOutputChanged</span>
</code></pre></td></tr></table>
</div>
</div><ol start="6">
<li><strong>所有事件的 run 方法(即 AllIdleTimeoutTask 的run 方法)分析</strong></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">AllIdleTimeoutTask</span> <span class="kd">extends</span> <span class="n">AbstractIdleTask</span> <span class="o">{</span>

	<span class="n">AllIdleTimeoutTask</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">super</span><span class="o">(</span><span class="n">ctx</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>

		<span class="kt">long</span> <span class="n">nextDelay</span> <span class="o">=</span> <span class="n">allIdleTimeNanos</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(!</span><span class="n">reading</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">nextDelay</span> <span class="o">-=</span> <span class="n">ticksInNanos</span><span class="o">()</span> <span class="o">-</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">lastReadTime</span><span class="o">,</span> <span class="n">lastWriteTime</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">nextDelay</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
			<span class="c1">// Both reader and writer are idle - set a new timeout and
</span><span class="c1"></span>			<span class="c1">// notify the callback.
</span><span class="c1"></span>			<span class="n">allIdleTimeout</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">allIdleTimeNanos</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span>

			<span class="kt">boolean</span> <span class="n">first</span> <span class="o">=</span> <span class="n">firstAllIdleEvent</span><span class="o">;</span>
			<span class="n">firstAllIdleEvent</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>

			<span class="k">try</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">hasOutputChanged</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">first</span><span class="o">))</span> <span class="o">{</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="o">}</span>

				<span class="n">IdleStateEvent</span> <span class="n">event</span> <span class="o">=</span> <span class="n">newIdleStateEvent</span><span class="o">(</span><span class="n">IdleState</span><span class="o">.</span><span class="na">ALL_IDLE</span><span class="o">,</span> <span class="n">first</span><span class="o">);</span>
				<span class="n">channelIdle</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="n">event</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">ctx</span><span class="o">.</span><span class="na">fireExceptionCaught</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="c1">// Either read or write occurred before the timeout - set a new
</span><span class="c1"></span>			<span class="c1">// timeout with shorter delay.
</span><span class="c1"></span>			<span class="n">allIdleTimeout</span> <span class="o">=</span> <span class="n">schedule</span><span class="o">(</span><span class="n">ctx</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="n">nextDelay</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">NANOSECONDS</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">表示这个监控着所有的事件</span><span class="err">。</span><span class="n">当读写事件发生时</span><span class="err">，</span><span class="n">都会记录</span><span class="err">。</span><span class="n">代码逻辑和写事件基本一致</span>
<span class="n">2</span><span class="err">、</span><span class="n">要注意的是</span><span class="err">：</span><span class="n">nextDelay</span> <span class="o">-=</span> <span class="n">ticksInNanos</span><span class="o">()</span> <span class="o">-</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">lastReadTime</span><span class="o">,</span> <span class="n">lastWriteTime</span><span class="o">);</span>
<span class="n">3</span><span class="err">、</span><span class="n">这里的时间计算是取读写事件中的最大值来的</span><span class="err">。</span><span class="n">然后像写事件一样</span><span class="err">，</span><span class="n">判断是否发生了写的慢的情况</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="1062小结netty的心跳机制">10.6.2、小结Netty的心跳机制</h3>
<ol>
<li>IdleStateHandler 可以实现心跳功能，当服务器和客户端没有任何读写交互时，并超过了给定的时间，则会触发用户 handler 的 userEventTriggered 方法。用户可以在这个方法中尝试向对方发送消息，如果发送失败，则关闭连接</li>
<li>IdleStateHandler 的实现基于 EventLoop 的定时任务，每次读写都会记录一个值，在定时任务运行的时候，通过计算当前时间、设置时间和上次事件发生时间的结果，来判断是否空闲</li>
<li>内部有 3 个定时任务，分别对应读事件、写事件、读写事件。通常用户监听读写事件就足够了</li>
<li>同时，IdleStateHandler 内部也考虑了一些<code>极端情况</code>：<code>客户端接收缓慢，一次接收数据的速度超过了设置的空闲时间</code>。Netty 通过构造方法中的 observeOutput 属性来绝定是否对出站缓冲区的情况进行判断</li>
<li><code>如果出站缓慢，Netty 不认为这是空闲，也就不触发空闲事件。但第一次无论如何也是要触发的。因为第一次无法判断时出站缓慢还是空闲</code>。当然，出站缓慢的化，可能造成 OOM(内存溢出) ，OOM 比空闲问题更大</li>
<li>所以，当你的应用出现了内存溢出，OOM 之类，并且写空闲极少发生（使用了observeOutput 为 true),那么就需要注意是不是数据出站速度过慢</li>
<li>还有一个注意的地方:就是 <code>ReadTimeoutHandler</code> ，<strong>它继承自 IdleStateHandler，当触发读空闲事件的时候，就触发ctx.fireExceptionCaught 方法，并传入一个 ReadTimeoutException，然后关闭Socket</strong></li>
<li>而 <code>WriteTimeoutHandler</code> 的实现<code>不是基于 IdleStateHandler 的</code>，<strong>他的原理是，当调用 write 方法的时候，会创建一个定时任务，任务内容是根据传入的 promise 的完成情况来判断是否超出了写的时间。当定时任务根据指定时间开始运行，发现 promise的 isDone方法返回false，表明还没有写完，说明超时了，则抛出异常。当 write方法完成后，会打断定时任务</strong></li>
</ol>
<h2 id="107netty-核心组件-eventloop-源码剖析">10.7、Netty 核心组件 EventLoop 源码剖析</h2>
<h3 id="1071源码剖析">10.7.1、源码剖析</h3>
<ol>
<li>
<p>EventLoop 介绍</p>
<pre><code> NioEventLoop 的继承图
</code></pre>
</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928213844.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928213844.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928213844.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928213844.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928213844.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928213844.png" /></p>
<pre><code>说明：
1、ScheduledExecutorService 接口表示是一个定时任务接口，EventLoop可以接受定时任务。
2、EventLoop 接口:Netty接口文档说明该接口作用:一旦 Channel 注册了，就处理该Channel对应的所有I/O操作
3、SingleThreadEventExecutor 表示这是一个单个线程的线程池
4、EventLoop是一个单例的线程池，里面含有一个死循环的线程不断的做着3件事情:监听端口，处理端口
事件，处理队列事件。每个 EventLoop都可以绑定多个Channel，而每个Channel 始终只能由一个EventLoop 来处理
</code></pre>
<ol start="2">
<li>NioEventLoop 的使用 - execute 方法
<ul>
<li>execute 源码解析</li>
</ul>
</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928214800.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928214800.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928214800.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928214800.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928214800.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210928214800.png" /></p>
<p>在 EventLoop 的使用，一般就是 <strong>eventloop.execute(task)</strong>，看看 execute 方法的实现(在 SingleThreadEventExecutor 类中)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;task&#34;</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="kt">boolean</span> <span class="n">inEventLoop</span> <span class="o">=</span> <span class="n">inEventLoop</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">inEventLoop</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">addTask</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="n">startThread</span><span class="o">();</span>
		<span class="n">addTask</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">isShutdown</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">removeTask</span><span class="o">(</span><span class="n">task</span><span class="o">))</span> <span class="o">{</span>
			<span class="n">reject</span><span class="o">();</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="k">if</span> <span class="o">(!</span><span class="n">addTaskWakesUp</span> <span class="o">&amp;&amp;</span> <span class="n">wakesUpForTask</span><span class="o">(</span><span class="n">task</span><span class="o">))</span> <span class="o">{</span>
		<span class="n">wakeup</span><span class="o">(</span><span class="n">inEventLoop</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span>
<span class="n">1</span><span class="err">、</span><span class="n">首先判断该</span> <span class="n">EventLoop</span> <span class="n">的线程是否是当前线程</span><span class="err">，</span><span class="n">如果是</span><span class="err">，</span><span class="n">直接添加到任务队列中去</span><span class="err">，</span><span class="n">如果不是</span><span class="err">，</span><span class="n">则尝试启动线程</span><span class="err">（</span><span class="n">但</span>
<span class="n">由于线程是单个的</span><span class="err">，</span><span class="n">因此只能启动一次</span><span class="err">），</span><span class="n">随后再将任务添加到队列中去</span><span class="err">。</span>
<span class="n">2</span><span class="err">、</span><span class="n">如果线程已经停止</span><span class="err">，</span><span class="n">并且删除任务失败</span><span class="err">，</span><span class="n">则执行拒绝策略</span><span class="err">，</span><span class="n">默认是抛出异常</span><span class="err">。</span>
<span class="n">3</span><span class="err">、</span><span class="n">如果</span> <span class="n">addTaskWakesUp</span> <span class="n">是false</span><span class="err">，</span><span class="n">并且任务不是</span> <span class="n">NonWakeupRunnable</span> <span class="n">类型的</span><span class="err">，</span><span class="n">就尝试唤醒</span> <span class="n">selector</span> <span class="err">。</span><span class="n">这个时候</span><span class="err">，</span>
<span class="n">阻塞在</span> <span class="n">selector</span> <span class="n">的线程就会立即返回</span>
<span class="n">4</span><span class="err">、</span><span class="n">可以下断点来追踪</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>debug addTask 和 offerTask</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">addTask</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">task</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">NullPointerException</span><span class="o">(</span><span class="s">&#34;task&#34;</span><span class="o">);</span>
	<span class="o">}</span>
	<span class="k">if</span> <span class="o">(!</span><span class="n">offerTask</span><span class="o">(</span><span class="n">task</span><span class="o">))</span> <span class="o">{</span>
		<span class="n">reject</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">offerTask</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">isShutdown</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">reject</span><span class="o">();</span>
	<span class="o">}</span>
	<span class="k">return</span> <span class="n">taskQueue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>NioEventLoop 的父类 SingleThreadEventExecutor 的 startThread 方法
<ul>
<li>当执行 execute 方法的时候,如果当前线程不是 EventLoop 所属线程,则尝试启动线程,也就是 starThread 方法，dubug 代码如下:</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">startThread</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ST_NOT_STARTED</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ST_NOT_STARTED</span><span class="o">,</span> <span class="n">ST_STARTED</span><span class="o">))</span> <span class="o">{</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">doStartThread</span><span class="o">();</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ST_NOT_STARTED</span><span class="o">);</span>
				<span class="n">PlatformDependent</span><span class="o">.</span><span class="na">throwException</span><span class="o">(</span><span class="n">cause</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">该方法首先判断是否启动过了</span><span class="err">，</span><span class="n">保证</span> <span class="n">EventLoop</span> <span class="n">只有一个线程</span><span class="err">，</span><span class="n">如果没有启动过</span><span class="err">，</span><span class="n">则尝试使用</span> <span class="n">Cas</span> <span class="n">将</span> <span class="n">state</span> <span class="n">状态改为</span>
<span class="n">ST_STARTED</span><span class="err">，</span><span class="n">也就是已启动</span><span class="err">。</span><span class="n">然后调用doStartThread</span> <span class="n">方法</span><span class="err">。</span><span class="n">如果失败</span><span class="err">，</span><span class="n">则进行回滚</span>


<span class="kd">private</span> <span class="kt">void</span> <span class="nf">doStartThread</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">assert</span> <span class="n">thread</span> <span class="o">==</span> <span class="kc">null</span><span class="o">;</span>
	<span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
		<span class="nd">@Override</span>
		<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
			<span class="n">thread</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">interrupted</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">thread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
			<span class="o">}</span>

			<span class="kt">boolean</span> <span class="n">success</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
			<span class="n">updateLastExecutionTime</span><span class="o">();</span>
			<span class="k">try</span> <span class="o">{</span>
				<span class="n">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
				<span class="n">success</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
			<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">&#34;Unexpected exception from an event executor: &#34;</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
			<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
				<span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
					<span class="kt">int</span> <span class="n">oldState</span> <span class="o">=</span> <span class="n">state</span><span class="o">;</span>
					<span class="k">if</span> <span class="o">(</span><span class="n">oldState</span> <span class="o">&gt;=</span> <span class="n">ST_SHUTTING_DOWN</span> <span class="o">||</span> <span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span>
							<span class="n">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">oldState</span><span class="o">,</span> <span class="n">ST_SHUTTING_DOWN</span><span class="o">))</span> <span class="o">{</span>
						<span class="k">break</span><span class="o">;</span>
					<span class="o">}</span>
				<span class="o">}</span>

				<span class="c1">// Check if confirmShutdown() was called at the end of the loop.
</span><span class="c1"></span>				<span class="k">if</span> <span class="o">(</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="n">gracefulShutdownStartTime</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;Buggy &#34;</span> <span class="o">+</span> <span class="n">EventExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; implementation; &#34;</span> <span class="o">+</span>
							<span class="n">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;.confirmShutdown() must be called &#34;</span> <span class="o">+</span>
							<span class="s">&#34;before run() implementation terminates.&#34;</span><span class="o">);</span>
				<span class="o">}</span>

				<span class="k">try</span> <span class="o">{</span>
					<span class="c1">// Run all remaining tasks and shutdown hooks.
</span><span class="c1"></span>					<span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
						<span class="k">if</span> <span class="o">(</span><span class="n">confirmShutdown</span><span class="o">())</span> <span class="o">{</span>
							<span class="k">break</span><span class="o">;</span>
						<span class="o">}</span>
					<span class="o">}</span>
				<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="n">cleanup</span><span class="o">();</span>
					<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
						<span class="n">STATE_UPDATER</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">SingleThreadEventExecutor</span><span class="o">.</span><span class="na">this</span><span class="o">,</span> <span class="n">ST_TERMINATED</span><span class="o">);</span>
						<span class="n">threadLock</span><span class="o">.</span><span class="na">release</span><span class="o">();</span>
						<span class="k">if</span> <span class="o">(!</span><span class="n">taskQueue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
							<span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
									<span class="s">&#34;An event executor terminated with &#34;</span> <span class="o">+</span>
											<span class="s">&#34;non-empty task queue (&#34;</span> <span class="o">+</span> <span class="n">taskQueue</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="sc">&#39;)&#39;</span><span class="o">);</span>
						<span class="o">}</span>

						<span class="n">terminationFuture</span><span class="o">.</span><span class="na">setSuccess</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">});</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">首先调用executor</span> <span class="n">的execute方法</span><span class="err">，</span><span class="n">这个executor</span> <span class="n">就是在创建Event</span> <span class="n">LoopGroup</span> <span class="n">的时候创建的</span>
<span class="n">ThreadPerTaskExecutor类</span><span class="err">。</span><span class="n">该execute方法会将Runnable包装成Netty的</span> <span class="n">FastThreadLocalThread</span><span class="err">。</span>
<span class="n">2</span><span class="err">、</span><span class="n">任务中</span><span class="err">，</span><span class="n">首先判断线程中断状态</span><span class="err">，</span><span class="n">然后设置最后一次的执行时间</span>
<span class="n">3</span><span class="err">、</span><span class="n">执行当前NioEventLoop</span> <span class="n">的</span> <span class="n">run方法</span><span class="err">，</span><span class="n">注意</span><span class="o">:</span><span class="n">这个方法是个死循环</span><span class="err">，</span><span class="n">是整个EventLoop</span> <span class="n">的核心</span>
<span class="n">4</span><span class="err">、</span><span class="n">在finally</span> <span class="n">块中</span><span class="err">，</span><span class="n">使用CAS</span> <span class="n">不断修改</span> <span class="n">state</span> <span class="n">状态</span><span class="err">，</span><span class="n">改成ST_SHUTTING_DOWN</span><span class="err">。</span><span class="n">也就是当线程Loop</span> <span class="n">结束的时候</span><span class="err">。</span><span class="n">关闭</span>
<span class="n">线程</span><span class="err">。</span><span class="n">最后还要死循环确认是否关闭</span><span class="err">，</span><span class="n">否则不会</span> <span class="k">break</span><span class="err">。</span><span class="n">然后</span><span class="err">，</span><span class="n">执行</span> <span class="n">cleanup操作</span><span class="err">，</span><span class="n">更新状态为</span> <span class="n">ST_TERMINATED</span><span class="err">，</span>
<span class="n">并释放当前线程锁</span><span class="err">。</span><span class="n">如果任务队列不是空</span><span class="err">，</span><span class="n">则打印队列中还有多少个未完成的任务</span><span class="err">。</span><span class="n">并回调terminationFuture方法</span><span class="err">。</span>
<span class="n">5</span><span class="err">、</span><span class="n">其实最核心的就是</span> <span class="n">Event</span> <span class="n">Loop自身的run方法</span><span class="err">。</span><span class="n">再继续深入run方法</span>
</code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>EventLoop 中的 Loop 是靠 run 实现的，我们分析下 run 方法（该方法在 NioEventLoop）</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
		<span class="k">try</span> <span class="o">{</span>
			<span class="k">switch</span> <span class="o">(</span><span class="n">selectStrategy</span><span class="o">.</span><span class="na">calculateStrategy</span><span class="o">(</span><span class="n">selectNowSupplier</span><span class="o">,</span> <span class="n">hasTasks</span><span class="o">()))</span> <span class="o">{</span>
				<span class="k">case</span> <span class="n">SelectStrategy</span><span class="o">.</span><span class="na">CONTINUE</span><span class="o">:</span>
					<span class="k">continue</span><span class="o">;</span>
				<span class="k">case</span> <span class="n">SelectStrategy</span><span class="o">.</span><span class="na">SELECT</span><span class="o">:</span>
					<span class="n">select</span><span class="o">(</span><span class="n">wakenUp</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="kc">false</span><span class="o">));</span>

					<span class="c1">// &#39;wakenUp.compareAndSet(false, true)&#39; is always evaluated
</span><span class="c1"></span>					<span class="c1">// before calling &#39;selector.wakeup()&#39; to reduce the wake-up
</span><span class="c1"></span>					<span class="c1">// overhead. (Selector.wakeup() is an expensive operation.)
</span><span class="c1"></span>					<span class="c1">//
</span><span class="c1"></span>					<span class="c1">// However, there is a race condition in this approach.
</span><span class="c1"></span>					<span class="c1">// The race condition is triggered when &#39;wakenUp&#39; is set to
</span><span class="c1"></span>					<span class="c1">// true too early.
</span><span class="c1"></span>					<span class="c1">//
</span><span class="c1"></span>					<span class="c1">// &#39;wakenUp&#39; is set to true too early if:
</span><span class="c1"></span>					<span class="c1">// 1) Selector is waken up between &#39;wakenUp.set(false)&#39; and
</span><span class="c1"></span>					<span class="c1">//    &#39;selector.select(...)&#39;. (BAD)
</span><span class="c1"></span>					<span class="c1">// 2) Selector is waken up between &#39;selector.select(...)&#39; and
</span><span class="c1"></span>					<span class="c1">//    &#39;if (wakenUp.get()) { ... }&#39;. (OK)
</span><span class="c1"></span>					<span class="c1">//
</span><span class="c1"></span>					<span class="c1">// In the first case, &#39;wakenUp&#39; is set to true and the
</span><span class="c1"></span>					<span class="c1">// following &#39;selector.select(...)&#39; will wake up immediately.
</span><span class="c1"></span>					<span class="c1">// Until &#39;wakenUp&#39; is set to false again in the next round,
</span><span class="c1"></span>					<span class="c1">// &#39;wakenUp.compareAndSet(false, true)&#39; will fail, and therefore
</span><span class="c1"></span>					<span class="c1">// any attempt to wake up the Selector will fail, too, causing
</span><span class="c1"></span>					<span class="c1">// the following &#39;selector.select(...)&#39; call to block
</span><span class="c1"></span>					<span class="c1">// unnecessarily.
</span><span class="c1"></span>					<span class="c1">//
</span><span class="c1"></span>					<span class="c1">// To fix this problem, we wake up the selector again if wakenUp
</span><span class="c1"></span>					<span class="c1">// is true immediately after selector.select(...).
</span><span class="c1"></span>					<span class="c1">// It is inefficient in that it wakes up the selector for both
</span><span class="c1"></span>					<span class="c1">// the first case (BAD - wake-up required) and the second case
</span><span class="c1"></span>					<span class="c1">// (OK - no wake-up required).
</span><span class="c1"></span>
					<span class="k">if</span> <span class="o">(</span><span class="n">wakenUp</span><span class="o">.</span><span class="na">get</span><span class="o">())</span> <span class="o">{</span>
						<span class="n">selector</span><span class="o">.</span><span class="na">wakeup</span><span class="o">();</span>
					<span class="o">}</span>
					<span class="c1">// fall through
</span><span class="c1"></span>				<span class="k">default</span><span class="o">:</span>
			<span class="o">}</span>

			<span class="n">cancelledKeys</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
			<span class="n">needsToSelectAgain</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
			<span class="kd">final</span> <span class="kt">int</span> <span class="n">ioRatio</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">ioRatio</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">ioRatio</span> <span class="o">==</span> <span class="n">100</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">processSelectedKeys</span><span class="o">();</span>
				<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
					<span class="c1">// Ensure we always run tasks.
</span><span class="c1"></span>					<span class="n">runAllTasks</span><span class="o">();</span>
				<span class="o">}</span>
			<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
				<span class="kd">final</span> <span class="kt">long</span> <span class="n">ioStartTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
				<span class="k">try</span> <span class="o">{</span>
					<span class="n">processSelectedKeys</span><span class="o">();</span>
				<span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
					<span class="c1">// Ensure we always run tasks.
</span><span class="c1"></span>					<span class="kd">final</span> <span class="kt">long</span> <span class="n">ioTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">ioStartTime</span><span class="o">;</span>
					<span class="n">runAllTasks</span><span class="o">(</span><span class="n">ioTime</span> <span class="o">*</span> <span class="o">(</span><span class="n">100</span> <span class="o">-</span> <span class="n">ioRatio</span><span class="o">)</span> <span class="o">/</span> <span class="n">ioRatio</span><span class="o">);</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">handleLoopException</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// Always handle shutdown even if the loop processing threw an exception.
</span><span class="c1"></span>		<span class="k">try</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">isShuttingDown</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">closeAll</span><span class="o">();</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">confirmShutdown</span><span class="o">())</span> <span class="o">{</span>
					<span class="k">return</span><span class="o">;</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">handleLoopException</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">从上面的步骤可以看出</span><span class="err">，</span><span class="n">整个run方法做了3件事情</span><span class="o">:</span>
		<span class="n">1</span><span class="o">.</span><span class="na">select</span> <span class="n">获取感兴趣的事件</span><span class="err">。</span>
		<span class="n">2</span><span class="o">.</span><span class="na">processSelectedKeys</span> <span class="n">处理事件</span><span class="err">。</span>
		<span class="n">3</span><span class="o">.</span><span class="na">runAllTasks执行队列中的任务</span><span class="err">。</span>
<span class="n">2</span><span class="err">、</span><span class="n">上面的三个方法</span><span class="err">，</span><span class="n">我们就追一下select</span> <span class="nf">方法</span><span class="o">(</span><span class="n">体现非阻塞</span><span class="o">)</span><span class="n">核心select方法解析</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">select</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">oldWakenUp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
	<span class="n">Selector</span> <span class="n">selector</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">selector</span><span class="o">;</span>
	<span class="k">try</span> <span class="o">{</span>
		<span class="kt">int</span> <span class="n">selectCnt</span> <span class="o">=</span> <span class="n">0</span><span class="o">;</span>
		<span class="kt">long</span> <span class="n">currentTimeNanos</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
		<span class="kt">long</span> <span class="n">selectDeadLineNanos</span> <span class="o">=</span> <span class="n">currentTimeNanos</span> <span class="o">+</span> <span class="n">delayNanos</span><span class="o">(</span><span class="n">currentTimeNanos</span><span class="o">);</span>
		<span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
			<span class="kt">long</span> <span class="n">timeoutMillis</span> <span class="o">=</span> <span class="o">(</span><span class="n">selectDeadLineNanos</span> <span class="o">-</span> <span class="n">currentTimeNanos</span> <span class="o">+</span> <span class="n">500000L</span><span class="o">)</span> <span class="o">/</span> <span class="n">1000000L</span><span class="o">;</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">timeoutMillis</span> <span class="o">&lt;=</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
				<span class="k">if</span> <span class="o">(</span><span class="n">selectCnt</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
					<span class="n">selector</span><span class="o">.</span><span class="na">selectNow</span><span class="o">();</span>
					<span class="n">selectCnt</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
				<span class="o">}</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="c1">// If a task was submitted when wakenUp value was true, the task didn&#39;t get a chance to call
</span><span class="c1"></span>			<span class="c1">// Selector#wakeup. So we need to check task queue again before executing select operation.
</span><span class="c1"></span>			<span class="c1">// If we don&#39;t, the task might be pended until select operation was timed out.
</span><span class="c1"></span>			<span class="c1">// It might be pended until idle timeout if IdleStateHandler existed in pipeline.
</span><span class="c1"></span>			<span class="k">if</span> <span class="o">(</span><span class="n">hasTasks</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">wakenUp</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="kc">false</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="o">{</span>
				<span class="n">selector</span><span class="o">.</span><span class="na">selectNow</span><span class="o">();</span>
				<span class="n">selectCnt</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="kt">int</span> <span class="n">selectedKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">timeoutMillis</span><span class="o">);</span>
			<span class="n">selectCnt</span> <span class="o">++;</span>

			<span class="c1">// 如果 1 秒后返回，有返回值 || select 被用户唤醒 || 任务队列有任务 || 有定时任务即将被执行；则跳出循环
</span><span class="c1"></span>			<span class="k">if</span> <span class="o">(</span><span class="n">selectedKeys</span> <span class="o">!=</span> <span class="n">0</span> <span class="o">||</span> <span class="n">oldWakenUp</span> <span class="o">||</span> <span class="n">wakenUp</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">||</span> <span class="n">hasTasks</span><span class="o">()</span> <span class="o">||</span> <span class="n">hasScheduledTasks</span><span class="o">())</span> <span class="o">{</span>
				<span class="c1">// - Selected something,
</span><span class="c1"></span>				<span class="c1">// - waken up by user, or
</span><span class="c1"></span>				<span class="c1">// - the task queue has a pending task.
</span><span class="c1"></span>				<span class="c1">// - a scheduled task is ready for processing
</span><span class="c1"></span>				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
				<span class="c1">// Thread was interrupted so reset selected keys and break so we not run into a busy loop.
</span><span class="c1"></span>				<span class="c1">// As this is most likely a bug in the handler of the user or it&#39;s client library we will
</span><span class="c1"></span>				<span class="c1">// also log it.
</span><span class="c1"></span>				<span class="c1">//
</span><span class="c1"></span>				<span class="c1">// See https://github.com/netty/netty/issues/2426
</span><span class="c1"></span>				<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
					<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Selector.select() returned prematurely because &#34;</span> <span class="o">+</span>
							<span class="s">&#34;Thread.currentThread().interrupt() was called. Use &#34;</span> <span class="o">+</span>
							<span class="s">&#34;NioEventLoop.shutdownGracefully() to shutdown the NioEventLoop.&#34;</span><span class="o">);</span>
				<span class="o">}</span>
				<span class="n">selectCnt</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeoutMillis</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="n">currentTimeNanos</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// timeoutMillis elapsed without anything selected.
</span><span class="c1"></span>				<span class="n">selectCnt</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
			<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">SELECTOR_AUTO_REBUILD_THRESHOLD</span> <span class="o">&gt;</span> <span class="n">0</span> <span class="o">&amp;&amp;</span>
					<span class="n">selectCnt</span> <span class="o">&gt;=</span> <span class="n">SELECTOR_AUTO_REBUILD_THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// The selector returned prematurely many times in a row.
</span><span class="c1"></span>				<span class="c1">// Rebuild the selector to work around the problem.
</span><span class="c1"></span>				<span class="n">logger</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span>
						<span class="s">&#34;Selector.select() returned prematurely {} times in a row; rebuilding Selector {}.&#34;</span><span class="o">,</span>
						<span class="n">selectCnt</span><span class="o">,</span> <span class="n">selector</span><span class="o">);</span>

				<span class="n">rebuildSelector</span><span class="o">();</span>
				<span class="n">selector</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">selector</span><span class="o">;</span>

				<span class="c1">// Select again to populate selectedKeys.
</span><span class="c1"></span>				<span class="n">selector</span><span class="o">.</span><span class="na">selectNow</span><span class="o">();</span>
				<span class="n">selectCnt</span> <span class="o">=</span> <span class="n">1</span><span class="o">;</span>
				<span class="k">break</span><span class="o">;</span>
			<span class="o">}</span>

			<span class="n">currentTimeNanos</span> <span class="o">=</span> <span class="n">time</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">selectCnt</span> <span class="o">&gt;</span> <span class="n">MIN_PREMATURE_SELECTOR_RETURNS</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
				<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&#34;Selector.select() returned prematurely {} times in a row for Selector {}.&#34;</span><span class="o">,</span>
						<span class="n">selectCnt</span> <span class="o">-</span> <span class="n">1</span><span class="o">,</span> <span class="n">selector</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
	<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CancelledKeyException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">logger</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">logger</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="n">CancelledKeyException</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; raised by a Selector {} - JDK bug?&#34;</span><span class="o">,</span>
					<span class="n">selector</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// Harmless exception - log anyway
</span><span class="c1"></span>	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">调用</span> <span class="n">selector</span> <span class="n">的</span> <span class="n">select方法</span><span class="err">，</span><span class="n">默认阻塞1秒钟</span><span class="err">，</span><span class="n">如果有定时任务</span><span class="err">，</span><span class="n">则在定时任务剩余时间的基础上在加上0</span><span class="o">.</span><span class="na">5秒进行阻塞</span><span class="err">。</span>
<span class="n">当执行execute方法的时候</span><span class="err">，</span><span class="n">也就是添加任务的时候</span><span class="err">，</span><span class="n">selector</span><span class="err">，</span><span class="n">防止</span> <span class="n">selector</span> <span class="n">阻塞时间过长</span>
</code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>
<p>EventLoop 作为 Netty 的核心运行机制小结</p>
<p>1、每次执行 ececute 方法都是向队列中添加任务。当第一次添加时就启动线程，执行 run方法，而 run 方法是整个 EventLoop 的核心，就像 EventLoop 的名字一样，Loop Loop ，不停的 Loop ,Loop做什么呢?做3件事情。</p>
<ul>
<li>调用 selector 的 select方法，默认阻塞一秒钟，如果有定时任务，则在定时任务剩余时间的基础上在加上0.5秒进行阻塞。当执行 execute方法的时候，也就是添加任务的时候，唤醒 selector，防止 selector 阻塞时间过长。</li>
<li>当 selector 返回的时候，回调用 processSelectedKeys 方法对 selectKey 进行处理。</li>
<li>当 processSelectedKeys 方法执行结束后，则按照 ioRatio 的比例执行 runAllTasks方法，默认是IO 任务时间和非IO 任务时间是相同的，你也可以根据你的应用特点进行调优。比如非IO任务比较多，那么你就将 ioRatio 调小一点，这样非IO任务就能执行的长一点，防止队列积攒过多任务</li>
</ul>
</li>
</ol>
<h2 id="108handler-中加入线程池和-context-中添加线程池的源码剖析">10.8、Handler 中加入线程池和 Context 中添加线程池的源码剖析</h2>
<h3 id="1081源码剖析目的">10.8.1、源码剖析目的</h3>
<ol>
<li>在Netty中做耗时的，不可预料的操作，比如数据库，网络请求，会严重影响Netty对Socket 的处理速度。</li>
<li>而解决方法就是将耗时任务添加到异步线程池中。但就添加线程池这步操作来讲，可以有2种方式，而且这2种方式实现的区别也蛮大的</li>
<li>处理耗时业务的第一种方式&mdash;handler中加入线程池</li>
<li>处理耗时业务的第二种方式&mdash;Context中添加线程池</li>
<li>我们就来分析下两种方式</li>
</ol>
<h3 id="1082第一种方式">10.8.2、第一种方式</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="cm">/*
</span><span class="cm"> * Copyright 2012 The Netty Project
</span><span class="cm"> *
</span><span class="cm"> * The Netty Project licenses this file to you under the Apache License,
</span><span class="cm"> * version 2.0 (the &#34;License&#34;); you may not use this file except in compliance
</span><span class="cm"> * with the License. You may obtain a copy of the License at:
</span><span class="cm"> *
</span><span class="cm"> *   http://www.apache.org/licenses/LICENSE-2.0
</span><span class="cm"> *
</span><span class="cm"> * Unless required by applicable law or agreed to in writing, software
</span><span class="cm"> * distributed under the License is distributed on an &#34;AS IS&#34; BASIS, WITHOUT
</span><span class="cm"> * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
</span><span class="cm"> * License for the specific language governing permissions and limitations
</span><span class="cm"> * under the License.
</span><span class="cm"> */</span>
<span class="kn">package</span> <span class="nn">com.clover.netty.source.echo2</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.buffer.ByteBuf</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.buffer.Unpooled</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandler.Sharable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.CharsetUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.concurrent.DefaultEventExecutorGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.util.concurrent.EventExecutorGroup</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.Callable</span><span class="o">;</span>

<span class="cm">/**
</span><span class="cm"> * Handler implementation for the echo server.
</span><span class="cm"> */</span>
<span class="nd">@Sharable</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EchoServerHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="kd">final</span> <span class="n">EventExecutorGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultEventExecutorGroup</span><span class="o">(</span><span class="n">16</span><span class="o">);</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;EchoServerHandler 的线程是 =&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>

        <span class="c1">// 将任务提交到 group 线程池
</span><span class="c1"></span>        <span class="n">group</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> <span class="n">Callable</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;()</span> <span class="o">{</span>
              <span class="nd">@Override</span>
              <span class="kd">public</span> <span class="n">Object</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                  <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
                  <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">buf</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()];</span>
                  <span class="n">buf</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
                  <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="s">&#34;UTF-8&#34;</span><span class="o">);</span>
                  <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3</span> <span class="o">*</span> <span class="n">1000</span><span class="o">);</span>
                  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;EchoServerHandler 中 group.submit 的线程是 =&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
                  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;s =&#34;</span> <span class="o">+</span> <span class="n">s</span><span class="o">);</span>
                  <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">((</span><span class="s">&#34;hello,clover&#34;</span><span class="o">).</span><span class="na">getBytes</span><span class="o">()));</span>
                  <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
              <span class="o">}</span>
        <span class="o">});</span>
		
		<span class="c1">// 普通方式
</span><span class="c1"></span>        <span class="n">ByteBuf</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">(</span><span class="n">ByteBuf</span><span class="o">)</span> <span class="n">msg</span><span class="o">;</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">buf</span><span class="o">.</span><span class="na">readableBytes</span><span class="o">()];</span>
        <span class="n">buf</span><span class="o">.</span><span class="na">readBytes</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>
        <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">,</span> <span class="s">&#34;UTF-8&#34;</span><span class="o">);</span>
        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3</span> <span class="o">*</span> <span class="n">1000</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;EchoServerHandler 中 普通方式 的线程是 =&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">Unpooled</span><span class="o">.</span><span class="na">copiedBuffer</span><span class="o">((</span><span class="s">&#34;hello,clover&#34;</span><span class="o">).</span><span class="na">getBytes</span><span class="o">()));</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;go on&#34;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelReadComplete</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Close the connection when an exception is raised.
</span><span class="c1"></span>        <span class="n">cause</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">在</span> <span class="n">channelRead</span> <span class="n">方法</span><span class="err">，</span><span class="n">模拟了一个耗时</span> <span class="n">10</span> <span class="n">秒的操作</span><span class="err">，</span><span class="n">这里</span><span class="err">，</span><span class="n">将这个任务提交到了一个自定义的业务线程池中</span><span class="err">，</span><span class="n">这样就</span>
<span class="n">不会阻塞</span> <span class="n">Netty</span> <span class="n">的</span> <span class="n">IO</span> <span class="n">线程</span>
<span class="n">2</span><span class="err">、</span><span class="n">当你运行多个</span> <span class="n">group</span><span class="o">.</span><span class="na">submit</span> <span class="n">方法时</span><span class="err">，</span><span class="n">在</span> <span class="n">group</span> <span class="n">线程池中也会使用多个</span> <span class="n">线程</span><span class="err">，</span><span class="n">而不是共用一个线程</span><span class="err">，</span><span class="n">而</span> <span class="n">handler</span> <span class="n">是共</span>
<span class="n">用一个线程</span>
</code></pre></td></tr></table>
</div>
</div><p>这样处理后，整个程序的逻辑图</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929120904.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929120904.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929120904.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929120904.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929120904.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929120904.png" /></p>
<p>说明：</p>
<ol>
<li>解释一下上图，当 IO 线程轮询到一个 socket 事件，然后，IO 线程开始处理，当走到耗时 handler 的时候，将耗时任务交给业务线程池</li>
<li>当耗时任务执行完毕再执行 pipeline write 方法的时候，(代码中使用的是 context 的 write方法，上图画的是执行 pipeline 方法，是一个意思)会将这个任务交给IO线程</li>
</ol>
<h3 id="1083write-方法的源码在-abstractchannelhandlercontext-类">10.8.3、write 方法的源码(在 AbstractChannelHandlerContext 类)</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="n">Object</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">flush</span><span class="o">,</span> <span class="n">ChannelPromise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span> <span class="o">=</span> <span class="n">findContextOutbound</span><span class="o">();</span>
	<span class="kd">final</span> <span class="n">Object</span> <span class="n">m</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="na">touch</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">next</span><span class="o">);</span>
	<span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
	<span class="c1">// 重点！！！！！！！
</span><span class="c1"></span>	<span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">flush</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">next</span><span class="o">.</span><span class="na">invokeWriteAndFlush</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
		<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
			<span class="n">next</span><span class="o">.</span><span class="na">invokeWrite</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="n">AbstractWriteTask</span> <span class="n">task</span><span class="o">;</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">flush</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">task</span> <span class="o">=</span> <span class="n">WriteAndFlushTask</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">next</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
		<span class="o">}</span>  <span class="k">else</span> <span class="o">{</span>
			<span class="n">task</span> <span class="o">=</span> <span class="n">WriteTask</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">next</span><span class="o">,</span> <span class="n">m</span><span class="o">,</span> <span class="n">promise</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="c1">// 重点！！！！！！！
</span><span class="c1"></span>		<span class="n">safeExecute</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span> <span class="n">task</span><span class="o">,</span> <span class="n">promise</span><span class="o">,</span> <span class="n">m</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">当判定下个</span> <span class="n">outbound</span> <span class="n">的</span> <span class="n">executor</span> <span class="n">线程不是当前线程的时候</span><span class="err">，</span><span class="n">会将当前的工作封装成task</span> <span class="o">,</span><span class="n">然后放入mpsc队列中</span><span class="err">，</span><span class="n">等</span>
<span class="n">待IO任务执行完毕后执行队列中的任务</span><span class="err">。</span>
<span class="n">2</span><span class="err">、</span><span class="n">这里可以Debug</span> <span class="nf">来验证</span><span class="o">(</span><span class="n">提醒</span><span class="o">:</span><span class="n">Debug时</span><span class="err">，</span><span class="n">服务器端Debug</span> <span class="o">,</span><span class="n">客户端Run</span> <span class="n">的方式</span><span class="o">)</span><span class="err">，</span><span class="n">当我们使用了</span> <span class="n">group</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">new</span> 
<span class="n">Callable</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;()</span><span class="n">在</span> <span class="n">handler中加入线程池</span><span class="err">，</span><span class="n">就会进入到</span> <span class="nf">safeExecute</span><span class="o">(</span><span class="n">executor</span><span class="o">;</span><span class="n">task</span><span class="o">,</span><span class="n">promise</span><span class="o">,</span> <span class="n">m</span><span class="o">);</span><span class="n">如果去掉这段代</span>
<span class="n">码</span><span class="err">，</span><span class="n">而使用普通方式来执行耗时的业务</span><span class="err">，</span><span class="n">那么就不会进入到</span> <span class="nf">safeExecute</span><span class="o">(</span><span class="n">executor</span><span class="o">,</span><span class="n">task</span><span class="o">,</span> <span class="n">promise</span><span class="o">,</span><span class="n">m</span><span class="o">);</span><span class="err">（</span><span class="n">说明</span><span class="o">:</span><span class="n">普通方式执</span>
<span class="n">行耗时代码</span><span class="err">，</span><span class="n">看我准备好的案例即可</span><span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="1084第二种方式">10.8.4、第二种方式</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kd">static</span> <span class="kd">final</span> <span class="n">EventExecutorGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultEventExecutorGroup</span><span class="o">(</span><span class="n">2</span><span class="o">);</span>
<span class="n">ServerBootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>
<span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
 <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
 <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">SO_BACKLOG</span><span class="o">,</span> <span class="n">100</span><span class="o">)</span>
 <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">LoggingHandler</span><span class="o">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span>
 <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
	 <span class="nd">@Override</span>
	 <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
		 <span class="n">ChannelPipeline</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
		 <span class="k">if</span> <span class="o">(</span><span class="n">sslCtx</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			 <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">sslCtx</span><span class="o">.</span><span class="na">newHandler</span><span class="o">(</span><span class="n">ch</span><span class="o">.</span><span class="na">alloc</span><span class="o">()));</span>
		 <span class="o">}</span>
		 <span class="c1">//p.addLast(new LoggingHandler(LogLevel.INFO));
</span><span class="c1"></span>		 <span class="c1">//p.addLast(new EchoServerHandler());
</span><span class="c1"></span>		 <span class="cm">/*
</span><span class="cm">		  * 说明：如果我们在addLast 添加 handler，前面有指定 EventExecutorGroup
</span><span class="cm">		  *       那么该 Handler，会优先加入到该线程池中
</span><span class="cm">		  */</span>
		 <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">group</span><span class="o">,</span><span class="k">new</span> <span class="n">EchoServerHandler</span><span class="o">());</span>
	 <span class="o">}</span>
 <span class="o">});</span>
 
<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">handler中的代码就使用普通的方式来处理耗时业务</span>
<span class="n">2</span><span class="err">、</span><span class="n">当我们在调用</span> <span class="n">addLast</span> <span class="n">方法添加线程池后</span><span class="err">，</span><span class="n">handler</span> <span class="n">将优先使用这个线程池</span><span class="err">，</span><span class="n">如果不添加</span><span class="err">，</span><span class="n">将使用IO</span> <span class="n">线程</span>
<span class="n">3</span><span class="err">、</span><span class="n">当走到</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">的</span> <span class="n">invokeChannelRead</span> <span class="n">方法的时候</span><span class="err">，</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">()</span> <span class="n">是不会通过</span>
<span class="n">的</span><span class="o">,</span><span class="n">因为当前线程是IO</span> <span class="nf">线程Context</span><span class="o">(</span><span class="n">也就是Handler</span><span class="err">）</span><span class="n">的</span> <span class="n">executor</span> <span class="n">是业务线程</span><span class="o">,</span><span class="n">所以会异步执行</span><span class="o">,</span> <span class="n">debug下源码</span>

<span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeChannelRead</span><span class="o">(</span><span class="kd">final</span> <span class="n">AbstractChannelHandlerContext</span> <span class="n">next</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
	<span class="kd">final</span> <span class="n">Object</span> <span class="n">m</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">pipeline</span><span class="o">.</span><span class="na">touch</span><span class="o">(</span><span class="n">ObjectUtil</span><span class="o">.</span><span class="na">checkNotNull</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="s">&#34;msg&#34;</span><span class="o">),</span> <span class="n">next</span><span class="o">);</span>
	<span class="n">EventExecutor</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">next</span><span class="o">.</span><span class="na">executor</span><span class="o">();</span>
	<span class="c1">// 重点！！！！！
</span><span class="c1"></span>	<span class="k">if</span> <span class="o">(</span><span class="n">executor</span><span class="o">.</span><span class="na">inEventLoop</span><span class="o">())</span> <span class="o">{</span>
		<span class="n">next</span><span class="o">.</span><span class="na">invokeChannelRead</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
		<span class="n">executor</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span><span class="c1">// 执行 run 方法
</span><span class="c1"></span>			<span class="nd">@Override</span>
			<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
				<span class="n">next</span><span class="o">.</span><span class="na">invokeChannelRead</span><span class="o">(</span><span class="n">m</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">});</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">说明</span><span class="err">：</span>
<span class="n">1</span><span class="err">、</span><span class="n">验证时</span><span class="err">，</span><span class="n">我们如果去掉</span> <span class="n">p</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">group</span><span class="o">,</span><span class="k">new</span> <span class="n">EchoServerHandler</span><span class="o">());</span> <span class="n">改成</span> <span class="n">p</span><span class="o">.</span><span class="na">addLastnewEchoServerHandler</span><span class="o">();</span> <span class="n">你</span>
<span class="n">会发现代码不会进行异步执行</span>
<span class="n">2</span><span class="err">、</span><span class="n">后面的整个流程就变成和第一个方式一样了</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="1085两种方式的比较">10.8.5、两种方式的比较</h3>
<ol>
<li>第一种方式在 handler 中添加异步，<code>可能更加的自由</code>，比如如果需要访问数据库，那我就异步，如果不需要，就不异步，<code>异步会拖长接口响应时间</code>。因为需要将任务放进mpscTask 中。如果IO 时间很短，task 很多，能一个循环下来，都没时间执行整个task，导致响应时间达不到指标。</li>
<li>第二种方式是 Netty 标准方式(即加入到队列)，但是，这么做会将整个handler 都交给业务线程池。<code>不论耗时不耗时，都加入到队列里，不够灵活</code>。</li>
<li>各有优劣，从灵活性考虑，第一种较好</li>
</ol>
<h1 id="11用-netty-自己实现-dubbo-rpc">11、用 Netty 自己实现 dubbo RPC</h1>
<h2 id="111rpc-基本介绍">11.1、RPC 基本介绍</h2>
<ol>
<li><code>RPC（Remote Procedure Call）</code>— 远程过程调用，是一个计算机通信协议。该协议允许运行于一台计算机的程序调用另一台计算机的子程序，而程序员无需额外地为这个交互作用编程</li>
<li>两个或多个应用程序都分布在不同的服务器上，它们之间的调用都像是本地方法调用一样(如图)</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173923.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173923.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173923.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173923.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173923.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173923.png" /></p>
<ol start="2">
<li>常见的 RPC 框架有: 比较知名的如阿里的Dubbo、google的g RPC、Go语言的rpcx、Apache的thrift， Spring 旗下的 Spring Cloud</li>
</ol>
<h2 id="112rpc调用流程">11.2、RPC调用流程</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173608.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173608.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173608.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173608.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173608.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929173608.png" /></p>
<pre><code>术语说明：在RPC中，Client 叫服务消费者，Server 叫服务提供者
</code></pre>
<ol>
<li><strong>服务消费方(client)以本地调用方式调用服务</strong></li>
<li>client stub 接收到调用后负责将方法、参数等封装成能够进行网络传输的消息体</li>
<li>client stub 将消息进行编码并发送到服务端</li>
<li>server stub 收到消息后进行解码</li>
<li>server stub 根据解码结果调用本地的服务</li>
<li>本地服务执行并将结果返回给 server stub</li>
<li>server stub 将返回导入结果进行编码并发送至消费方</li>
<li>client stub 接收到消息并进行解码</li>
<li><strong>服务消费方(client)得到结果</strong></li>
</ol>
<p><strong>小结：RPC 的目标就是将 2-8 这些步骤都封装起来，用户无需关心这些细节，可以像调
用本地方法一样即可完成远程服务调用</strong></p>
<h2 id="113自己实现-dubbo-rpc-基于-netty">11.3、自己实现 dubbo RPC (基于 Netty)</h2>
<h3 id="1131需求说明">11.3.1、需求说明</h3>
<ol>
<li>dubbo 底层使用了 Netty 作为网络通讯框架，要求用 Netty 实现一个简单的 RPC 框架</li>
<li>模仿 dubbo，<code>消费者和提供者约定接口和协议</code>，消费者远程调用提供者的服务，提供者返回一个字符串，消费者打印提供者返回的数据。底层网络通信使用 Netty 4.1.20</li>
</ol>
<h3 id="1132设计说明">11.3.2、设计说明</h3>
<ol>
<li>创建一个接口，定义抽象方法。用于消费者和提供者之间的约定</li>
<li>创建一个提供者，该类需要监听消费者的请求，并按照约定返回数据</li>
<li>创建一个消费者，该类需要透明的调用自己不存在的方法，内部需要使用 Netty 请求提供者返回数据</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929211840.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929211840.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929211840.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929211840.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929211840.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20210929211840.png" /></p>
<pre><code>这个里面的难点在于代理对象的创建
</code></pre>
<h2 id="114代码实现">11.4、代码实现</h2>
<p><strong>公共接口</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.dubborpc.publicinterface</span><span class="o">;</span>

<span class="c1">// 这个是接口，是 服务提供方 和 消费者方 都需要的
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">HelloService</span> <span class="o">{</span>
    <span class="n">String</span> <span class="nf">hello</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">);</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>服务提供方实现接口</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.dubborpc.provider</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.netty.dubborpc.publicinterface.HelloService</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloServiceImpl</span> <span class="kd">implements</span> <span class="n">HelloService</span> <span class="o">{</span>

    <span class="c1">// 如果你想在此统计客户端发送了多少次消息，你可以设置一个变量，但是你不设置为静态变量是无法统计到的
</span><span class="c1"></span>    <span class="c1">// 因为它每次都是调用的一个新的 HelloServiceImpl 对象，并不是每次使用的是同一个
</span><span class="c1"></span>
    <span class="c1">// 当有消费方调用该方法时，就返回一个结果
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">hello</span><span class="o">(</span><span class="n">String</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;收到客户端消息：&#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>
        <span class="c1">// 根据 msg 返回不同的结果
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="s">&#34;你好客户端，我已经收到你的消息 [&#34;</span> <span class="o">+</span> <span class="n">msg</span> <span class="o">+</span><span class="s">&#34;]&#34;</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">&#34;你好客户端，我已经收到你的消息 &#34;</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务提供方(服务器端)启动类</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.dubborpc.provider</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.netty.dubborpc.netty.NettyServer</span><span class="o">;</span>

<span class="c1">// ServerBootstrap 会启动一个服务提供者，就是 NettyServer
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServerBootstrap</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">NettyServer</span><span class="o">.</span><span class="na">startServer</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span><span class="n">7000</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>NettyServer</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.dubborpc.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.ServerBootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelFuture</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.EventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioServerSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringEncoder</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServer</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">startServer</span><span class="o">(</span><span class="n">String</span> <span class="n">hostName</span><span class="o">,</span><span class="kt">int</span> <span class="n">port</span><span class="o">){</span>
        <span class="n">startServer0</span><span class="o">(</span><span class="n">hostName</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">startServer0</span><span class="o">(</span><span class="n">String</span> <span class="n">hostname</span><span class="o">,</span><span class="kt">int</span> <span class="n">port</span><span class="o">){</span>
        <span class="n">EventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">(</span><span class="n">1</span><span class="o">);</span>
        <span class="n">EventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

        <span class="k">try</span><span class="o">{</span>

            <span class="n">ServerBootstrap</span> <span class="n">serverBootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerBootstrap</span><span class="o">();</span>

            <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span><span class="n">workerGroup</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                            <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>

                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringDecoder</span><span class="o">());</span>
                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringEncoder</span><span class="o">());</span>
                            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">NettyServerHandler</span><span class="o">());</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
            <span class="n">ChannelFuture</span> <span class="n">channelFuture</span> <span class="o">=</span> <span class="n">serverBootstrap</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">7000</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;服务提供方开始提供服务&#34;</span><span class="o">);</span>
            <span class="n">channelFuture</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">closeFuture</span><span class="o">().</span><span class="na">sync</span><span class="o">();</span>

        <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span><span class="k">finally</span><span class="o">{</span>
            <span class="n">bossGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
            <span class="n">workerGroup</span><span class="o">.</span><span class="na">shutdownGracefully</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>NettyServerHandler</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.dubborpc.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.netty.dubborpc.provider.HelloServiceImpl</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyServerHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 获取客户端发送的消息，并调用服务
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;msg =&#34;</span> <span class="o">+</span> <span class="n">msg</span><span class="o">);</span>

        <span class="c1">// 客户端在调用服务器的 api 时，我们需要定义一个协议
</span><span class="c1"></span>        <span class="c1">// 比如我们要求 每次发送消息时都必须以某个字符串开头 &#34;CloverFelix#hello#xxxx&#34;
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&#34;CloverFelix#hello#&#34;</span><span class="o">)){</span>
            <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HelloServiceImpl</span><span class="o">().</span><span class="na">hello</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">lastIndexOf</span><span class="o">(</span><span class="s">&#34;#&#34;</span><span class="o">)</span> <span class="o">+</span> <span class="n">1</span><span class="o">));</span>
            <span class="n">ctx</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>NettyCLient</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.dubborpc.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.bootstrap.Bootstrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInitializer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelOption</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelPipeline</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.nio.NioEventLoopGroup</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.SocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.socket.nio.NioSocketChannel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringDecoder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.handler.codec.string.StringEncoder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.ExecutorService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.Executors</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClient</span> <span class="o">{</span>
    <span class="c1">// 创建线程池
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">ExecutorService</span> <span class="n">executor</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newFixedThreadPool</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">());</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="n">NettyClientHandler</span> <span class="n">client</span><span class="o">;</span>

    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getBean</span><span class="o">(</span><span class="kd">final</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">serviceClass</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">providerName</span><span class="o">){</span>
        <span class="k">return</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">(),</span><span class="k">new</span> <span class="n">Class</span><span class="o">&lt;?&gt;[]{</span><span class="n">serviceClass</span><span class="o">},(</span><span class="n">proxy</span><span class="o">,</span> <span class="n">method</span><span class="o">,</span> <span class="n">args</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="c1">//{} 这部分代码，客户端每调用一次 hello，就会进入到该代码
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">client</span> <span class="o">==</span> <span class="kc">null</span><span class="o">){</span>
               <span class="n">initClient</span><span class="o">();</span>
            <span class="o">}</span>

            <span class="c1">// 设置要发送给服务器端的消息
</span><span class="c1"></span>            <span class="c1">// providerName 就是协议头，args[0] 就是客户端调用 api 时，传入的参数
</span><span class="c1"></span>            <span class="n">client</span><span class="o">.</span><span class="na">setParam</span><span class="o">(</span><span class="n">providerName</span> <span class="o">+</span> <span class="n">args</span><span class="o">[</span><span class="n">0</span><span class="o">]);</span>

            <span class="c1">// 将 client 提交到线程池中去执行，并获取到返回结果
</span><span class="c1"></span>            <span class="k">return</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="n">client</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>
        <span class="o">});</span>
    <span class="o">}</span>

    <span class="c1">// 初始化客户端
</span><span class="c1"></span>    <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">initClient</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NettyClientHandler</span><span class="o">();</span>
        <span class="c1">// 创建 EventLoopGroup
</span><span class="c1"></span>        <span class="n">NioEventLoopGroup</span> <span class="n">group</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NioEventLoopGroup</span><span class="o">();</span>

        <span class="n">Bootstrap</span> <span class="n">bootstrap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Bootstrap</span><span class="o">();</span>

        <span class="n">bootstrap</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">group</span><span class="o">)</span>
                <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
                <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">TCP_NODELAY</span><span class="o">,</span><span class="kc">true</span><span class="o">)</span>
                <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="nd">@Override</span>
                    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
                        <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>

                        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringEncoder</span><span class="o">());</span>
                        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="n">StringDecoder</span><span class="o">());</span>
                        <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">client</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">});</span>

        <span class="n">bootstrap</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="s">&#34;127.0.0.1&#34;</span><span class="o">,</span> <span class="n">7000</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
<span class="c1">//            channelFuture.channel().closeFuture().sync();
</span><span class="c1"></span>    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>NettyCLientHandler</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.dubborpc.netty</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelHandlerContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">io.netty.channel.ChannelInboundHandlerAdapter</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.Callable</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NettyClientHandler</span> <span class="kd">extends</span> <span class="n">ChannelInboundHandlerAdapter</span> <span class="kd">implements</span> <span class="n">Callable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">ChannelHandlerContext</span> <span class="n">context</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">result</span><span class="o">;</span><span class="c1">// 返回的结果
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">String</span> <span class="n">param</span><span class="o">;</span><span class="c1">// 客户端调用方法时，传入的参数
</span><span class="c1"></span>
    <span class="c1">// 与服务器的连接创建后，就会被调用
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">channelActive</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelActive 被调用&#34;</span><span class="o">);</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">;</span><span class="c1">// 因为我在其它方法也会使用到 ctx
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="c1">// 收到服务器数据后，调用该方法
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">channelRead</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Object</span> <span class="n">msg</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;channelRead 被调用&#34;</span><span class="o">);</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
        <span class="cm">/*
</span><span class="cm">         * 说明：
</span><span class="cm">         * 1、因为客户端启动时，向服务器会传送一个消息，是通过 proxy 对象，即代理对象调用 call 方法
</span><span class="cm">         * 2、call 方法会将数据传递给服务端，但是服务端并没有立即返回结果消息，所以就使用了 wait 方法，让其沉睡等待结果
</span><span class="cm">         * 3、而服务器返回结果消息是发送给客户端handler中的 channelRead 方法，所以当我们拿到消息后，就需要唤醒等待线程，让其继续执行下去
</span><span class="cm">         */</span>
        <span class="n">notify</span><span class="o">();</span><span class="c1">// 唤醒等待线程
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exceptionCaught</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">cause</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">ctx</span><span class="o">.</span><span class="na">channel</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 被代理对象调用，发送数据给服务器，然后使用wait方法沉睡，并且等待被唤醒(被 channelRead 唤醒)，在返回结果
</span><span class="c1"></span>    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kd">synchronized</span> <span class="n">Object</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;call1 被调用&#34;</span><span class="o">);</span>
        <span class="n">context</span><span class="o">.</span><span class="na">writeAndFlush</span><span class="o">(</span><span class="n">param</span><span class="o">);</span>
        <span class="c1">// 进行 wait
</span><span class="c1"></span>        <span class="n">wait</span><span class="o">();</span><span class="c1">// 等待 channelRead 获取到服务器的结果后唤醒
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;call2 被调用&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span><span class="c1">// 服务方返回的结果
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setParam</span><span class="o">(</span><span class="n">String</span> <span class="n">param</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;setParam 被调用&#34;</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">param</span> <span class="o">=</span> <span class="n">param</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>服务消费方(客户端)启动类</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.netty.dubborpc.customer</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.netty.dubborpc.netty.NettyClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.netty.dubborpc.publicinterface.HelloService</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ClientBootstrap</span> <span class="o">{</span>

    <span class="c1">// 这里定义协议头
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">providerName</span> <span class="o">=</span> <span class="s">&#34;CloverFelix#hello#&#34;</span><span class="o">;</span>


    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="c1">// 创建一个消费者
</span><span class="c1"></span>        <span class="n">NettyClient</span> <span class="n">customer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NettyClient</span><span class="o">();</span>

        <span class="c1">// 创建代理对象
</span><span class="c1"></span>        <span class="n">HelloService</span> <span class="n">service</span> <span class="o">=</span> <span class="o">(</span><span class="n">HelloService</span><span class="o">)</span> <span class="n">customer</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">HelloService</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">providerName</span><span class="o">);</span>

        <span class="c1">// 通过代理对象调用服务提供者的方法(服务)
</span><span class="c1"></span>        <span class="n">String</span> <span class="n">res</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">hello</span><span class="o">(</span><span class="s">&#34;你好，dubbo&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;调用的结果 res= &#34;</span> <span class="o">+</span> <span class="n">res</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-07-04</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://cloverfelix.github.io/netty/" data-title="Netty" data-hashtags="Netty"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://cloverfelix.github.io/netty/" data-hashtag="Netty"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://cloverfelix.github.io/netty/" data-title="Netty"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://cloverfelix.github.io/netty/" data-title="Netty"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://cloverfelix.github.io/netty/" data-title="Netty"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/netty/">Netty</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/spring/" class="prev" rel="prev" title="Spring"><i class="fas fa-angle-left fa-fw"></i>Spring</a>
            <a href="/environment/" class="next" rel="next" title="Environment">Environment<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Clover</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"QEH6MSAUGD","algoliaIndex":"blog","algoliaSearchKey":"83e0e9a01bb86efaff215298300450e1","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
