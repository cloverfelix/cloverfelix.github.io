<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Springcloud - clover</title><meta name="Description" content="SpringCloud"><meta property="og:title" content="Springcloud" />
<meta property="og:description" content="SpringCloud" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cloverfelix.github.io/springcloud/" /><meta property="og:image" content="https://cloverfelix.github.io/RW.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-14T10:38:04&#43;08:00" />
<meta property="article:modified_time" content="2021-10-14T10:38:04&#43;08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://cloverfelix.github.io/RW.png"/>

<meta name="twitter:title" content="Springcloud"/>
<meta name="twitter:description" content="SpringCloud"/>
<meta name="application-name" content="Clover">
<meta name="apple-mobile-web-app-title" content="Clover"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://cloverfelix.github.io/springcloud/" /><link rel="prev" href="https://cloverfelix.github.io/reactexpand/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Springcloud",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/cloverfelix.github.io\/springcloud\/"
        },"image": ["https:\/\/cloverfelix.github.io\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "SpringCloud","wordcount":  30005 ,
        "url": "https:\/\/cloverfelix.github.io\/springcloud\/","datePublished": "2021-10-14T10:38:04+08:00","dateModified": "2021-10-14T10:38:04+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "clover","logo": "https:\/\/cloverfelix.github.io\/images\/RW.png"},"author": {
                "@type": "Person",
                "name": "Clover"
            },"description": "SpringCloud"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="clover"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Clover</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="https://github.com/cloverfelix" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="clover"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>Clover</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="https://github.com/cloverfelix" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Springcloud</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>Clover</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/springcloud/"><i class="far fa-folder fa-fw"></i>SpringCloud</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-10-14">2021-10-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 30005 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 60 分钟&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#11springboot版本选择">1.1、SpringBoot版本选择</a></li>
    <li><a href="#12springcloud版本选择">1.2、SpringCloud版本选择</a>
      <ul>
        <li><a href="#121cloud命名规则">1.2.1、Cloud命名规则</a></li>
      </ul>
    </li>
    <li><a href="#13springcloud和springboot之间的依赖关系如何看">1.3、SpringCloud和SpringBoot之间的依赖关系如何看</a>
      <ul>
        <li><a href="#131依赖">1.3.1、依赖</a></li>
      </ul>
    </li>
    <li><a href="#14目前使用版本">1.4、目前使用版本</a>
      <ul>
        <li><a href="#141题外话">1.4.1、题外话</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#31idea新建project工作空间">3.1、IDEA新建project工作空间</a></li>
    <li><a href="#32父工程pom">3.2、父工程POM</a></li>
    <li><a href="#33maven工程落地细节复习">3.3、Maven工程落地细节复习</a>
      <ul>
        <li><a href="#331maven中的dependencymanagement和dependencies">3.3.1、Maven中的DependencyManagement和Dependencies</a></li>
        <li><a href="#332maven中跳过单元测试">3.3.2、Maven中跳过单元测试</a></li>
      </ul>
    </li>
    <li><a href="#34rest微服务工程构建">3.4、Rest微服务工程构建</a>
      <ul>
        <li><a href="#341提供者模块构建">3.4.1、提供者模块构建</a></li>
        <li><a href="#342小知识点补充">3.4.2、小知识点补充</a></li>
        <li><a href="#343消费者模块构建">3.4.3、消费者模块构建</a></li>
        <li><a href="#344小知识点补充">3.4.4、小知识点补充</a></li>
      </ul>
    </li>
    <li><a href="#35工程重构">3.5、工程重构</a></li>
  </ul>

  <ul>
    <li><a href="#41eureka基础知识">4.1、Eureka基础知识</a>
      <ul>
        <li><a href="#411什么是服务治理">4.1.1、什么是服务治理</a></li>
        <li><a href="#412什么是服务注册">4.1.2、什么是服务注册</a></li>
        <li><a href="#413eureka两组件">4.1.3、Eureka两组件</a></li>
      </ul>
    </li>
    <li><a href="#42单机eureka构建步骤">4.2、单机Eureka构建步骤</a>
      <ul>
        <li><a href="#421idea生成eurekaserver端服务注册中心类似物业公司">4.2.1、IDEA生成eurekaServer端服务注册中心类似物业公司</a></li>
        <li><a href="#422eurekaclient端cloud-provider-payment8001">4.2.2、EurekaClient端cloud-provider-payment8001</a></li>
        <li><a href="#423eurekaclient端cloud-consumer-order80">4.2.3、EurekaClient端cloud-consumer-order80</a></li>
      </ul>
    </li>
    <li><a href="#43集群eureka构建步骤">4.3、集群Eureka构建步骤</a>
      <ul>
        <li><a href="#431eureka集群原理说明">4.3.1、Eureka集群原理说明</a></li>
        <li><a href="#432eurekaserver集群环境构建步骤">4.3.2、EurekaServer集群环境构建步骤</a></li>
        <li><a href="#433将支付服务8001微服务发布到上面2台eureka集群配置中">4.3.3、将支付服务8001微服务发布到上面2台Eureka集群配置中</a></li>
        <li><a href="#434将订单服务80微服务发布到上面2台eureka集群配置中">4.3.4、将订单服务80微服务发布到上面2台Eureka集群配置中</a></li>
        <li><a href="#435支付服务提供者8001集群环境构建">4.3.5、支付服务提供者8001集群环境构建</a></li>
        <li><a href="#436负载均衡">4.3.6、负载均衡</a></li>
      </ul>
    </li>
    <li><a href="#44actuator微服务信息完善">4.4、actuator微服务信息完善</a>
      <ul>
        <li><a href="#441主机名称服务名称修改">4.4.1、主机名称:服务名称修改</a></li>
        <li><a href="#442访问信息有ip信息提示">4.4.2、访问信息有IP信息提示</a></li>
      </ul>
    </li>
    <li><a href="#45服务发现discovery">4.5、服务发现Discovery</a></li>
    <li><a href="#46eureka自我保护机制">4.6、Eureka自我保护机制</a>
      <ul>
        <li><a href="#461故障现象">4.6.1、故障现象</a>
          <ul>
            <li><a href="#4611概述">4.6.1.1、概述</a></li>
          </ul>
        </li>
        <li><a href="#462导致原因">4.6.2、导致原因</a>
          <ul>
            <li><a href="#4621为什么会产生eureka自我保护机制">4.6.2.1、为什么会产生Eureka自我保护机制？</a></li>
            <li><a href="#4622什么是自我保护模式">4.6.2.2、什么是自我保护模式</a></li>
          </ul>
        </li>
        <li><a href="#463怎么禁止自我保护">4.6.3、怎么禁止自我保护</a>
          <ul>
            <li><a href="#4631修改注册中心eureakeserver端7001">4.6.3.1、修改注册中心eureakeServer端7001</a></li>
            <li><a href="#4632修改生产者客户端eureakeclient端8001">4.6.3.2、修改生产者客户端eureakeClient端8001</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#51springcloud整合zookeeper代替eureka">5.1、SpringCloud整合Zookeeper代替Eureka</a>
      <ul>
        <li><a href="#511注册中心zookeeper">5.1.1、注册中心Zookeeper</a></li>
        <li><a href="#512服务提供者">5.1.2、服务提供者</a></li>
        <li><a href="#513服务消费者">5.1.3、服务消费者</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#61consul简介">6.1、Consul简介</a></li>
    <li><a href="#62安装并运行consul">6.2、安装并运行Consul</a></li>
    <li><a href="#63服务提供者">6.3、服务提供者</a></li>
    <li><a href="#64服务消费者">6.4、服务消费者</a></li>
    <li><a href="#65三个注册中心异同点">6.5、三个注册中心异同点</a></li>
  </ul>

  <ul>
    <li><a href="#71概述">7.1、概述</a></li>
    <li><a href="#72ribbon负载均衡演示">7.2、Ribbon负载均衡演示</a>
      <ul>
        <li><a href="#721架构说明">7.2.1、架构说明</a></li>
        <li><a href="#722pom">7.2.2、POM</a></li>
        <li><a href="#723二说resttemplate的使用">7.2.3、二说RestTemplate的使用</a>
          <ul>
            <li><a href="#7231getforobject方法getforentity方法">7.2.3.1、getForObject方法/getForEntity方法</a></li>
            <li><a href="#7232postforobjectpostforentity方法">7.2.3.2、postForObject/postForEntity方法</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#73ribbon核心组件irule">7.3、Ribbon核心组件IRule</a>
      <ul>
        <li><a href="#731irule根据特定算法中从服务列表中选取一个要访问的服务">7.3.1、IRule：根据特定算法中从服务列表中选取一个要访问的服务</a></li>
        <li><a href="#732如何替换">7.3.2、如何替换</a></li>
      </ul>
    </li>
    <li><a href="#74ribbon负载均衡算法">7.4、Ribbon负载均衡算法</a>
      <ul>
        <li><a href="#741原理">7.4.1、原理</a></li>
        <li><a href="#742手写一个本地负载均衡器">7.4.2、手写一个本地负载均衡器</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#81概述">8.1、概述</a>
      <ul>
        <li><a href="#811openfeign是什么">8.1.1、OpenFeign是什么？</a></li>
        <li><a href="#812能干嘛">8.1.2、能干嘛？</a></li>
        <li><a href="#813feign和openfeign两者区别">8.1.3、Feign和OpenFeign两者区别</a></li>
      </ul>
    </li>
    <li><a href="#82openfeign使用步骤">8.2、OpenFeign使用步骤</a></li>
    <li><a href="#83openfeign超时控制">8.3、OpenFeign超时控制</a>
      <ul>
        <li><a href="#831超时设置故意设置超时演示出错情况">8.3.1、超时设置，故意设置超时演示出错情况</a></li>
        <li><a href="#832openfeign默认等待1秒钟超过后报错">8.3.2、OpenFeign默认等待1秒钟，超过后报错</a></li>
        <li><a href="#833是什么">8.3.3、是什么？</a></li>
        <li><a href="#834yml文件里需要开启openfeign客户端超时控制">8.3.4、YML文件里需要开启OpenFeign客户端超时控制</a></li>
      </ul>
    </li>
    <li><a href="#84openfeign日志打印功能">8.4、OpenFeign日志打印功能</a>
      <ul>
        <li><a href="#841是什么">8.4.1、是什么？</a></li>
        <li><a href="#842日志级别">8.4.2、日志级别</a></li>
        <li><a href="#843配置日志bean">8.4.3、配置日志bean</a></li>
        <li><a href="#834yml文件里需要开启日志的feign客户端">8.3.4、YML文件里需要开启日志的Feign客户端</a></li>
        <li><a href="#835后台日志查看">8.3.5、后台日志查看</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#91概述">9.1、概述</a>
      <ul>
        <li><a href="#911分布式系统面临的问题">9.1.1、分布式系统面临的问题</a></li>
        <li><a href="#912hystrix是什么">9.1.2、Hystrix是什么？</a></li>
        <li><a href="#913hystrix能干嘛">9.1.3、Hystrix能干嘛？</a></li>
        <li><a href="#914官网资料">9.1.4、官网资料</a></li>
      </ul>
    </li>
    <li><a href="#92hystrix重要概念">9.2、Hystrix重要概念</a>
      <ul>
        <li><a href="#921服务降级">9.2.1、服务降级</a></li>
        <li><a href="#922服务熔断">9.2.2、服务熔断</a></li>
        <li><a href="#923服务限流">9.2.3、服务限流</a></li>
      </ul>
    </li>
    <li><a href="#93hystrix案例">9.3、hystrix案例</a>
      <ul>
        <li><a href="#931构建">9.3.1、构建</a></li>
        <li><a href="#932高并发测试">9.3.2、高并发测试</a></li>
        <li><a href="#933故障现象和导致原因">9.3.3、故障现象和导致原因</a></li>
        <li><a href="#934上诉结论">9.3.4、上诉结论</a></li>
        <li><a href="#935如何解决解决的要求">9.3.5、如何解决？解决的要求</a></li>
        <li><a href="#936服务降级">9.3.6、服务降级</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="1从22x和h版本开始说起">1、从2.2.x和H版本开始说起</h1>
<h2 id="11springboot版本选择">1.1、SpringBoot版本选择</h2>
<p><a href="https://github.com/spring-projects/spring-boot/releases/" target="_blank" rel="noopener noreffer">GitHub源码地址</a></p>
<p>SpringBoot2.0新特性</p>
<ul>
<li>通过上面官网发现，Boot官方强烈建议你升级到2.X以上版本</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016153757.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016153757.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016153757.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016153757.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016153757.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016153757.png" /></p>
<h2 id="12springcloud版本选择">1.2、SpringCloud版本选择</h2>
<p><a href="https://github.com/spring-projects/spring-cloud" target="_blank" rel="noopener noreffer">GitHub源码地址</a></p>
<p><a href="https://spring.io/projects/spring-cloud" target="_blank" rel="noopener noreffer">官网</a></p>
<h3 id="121cloud命名规则">1.2.1、Cloud命名规则</h3>
<p>Spring Cloud 采用了英国伦敦地铁站的名称来命名，并由地铁站名称字母A-Z依次类推的形式来发布迭代
版本SpringCloud是一个由许多子项目组成的综合项目，各子项目有不同的发布节奏。为了管理SpringCloud与各子项目的版本依赖关系，发布了一个清单，其中包括了某个SpringCloud版本对应的子项目版本。为了避免SpringCloud版本号与子项目版本号混淆，<strong>SpringCloud版本采用了名称而非版本号的命名，这些版本的名字采用了伦敦地铁站的名字，根据字母表的顺序来对应版本时间顺序</strong>。例如Angel是第一个版本, Brixton是第二个版本。</p>
<p>当SpringCloud的发布内容积累到临界点或者一个重大BUG被解决后，会发布一个&quot;service releases&quot;版本，简称SRX版本，比如Greenwich.SR2就是SpringCloud发布的Greenwich版本的第2个SRX版本。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154404.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154404.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154404.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154404.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154404.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154404.png" /></p>
<h2 id="13springcloud和springboot之间的依赖关系如何看">1.3、SpringCloud和SpringBoot之间的依赖关系如何看</h2>
<p><a href="https://spring.io/projects/spring-cloud#overview" target="_blank" rel="noopener noreffer">官网说明</a></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154648.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154648.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154648.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154648.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154648.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154648.png" /></p>
<h3 id="131依赖">1.3.1、依赖</h3>
<p>Finchley 是基于 Spring Boot 2.0.x 构建的不再 Boot 1.5.x</p>
<p>Dalston 和 Edgware 是基于 Spring Boot 1.5.x 构建的，不支持 Spring Boot 2.0.x</p>
<p>Camden 构建于 Spring Boot 1.4.x，但依然能支持 Spring Boot 1.5.x</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154734.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154734.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154734.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154734.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154734.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154734.png" /></p>
<p><a href="https://start.spring.io/actuator/info" target="_blank" rel="noopener noreffer">更详细的版本对应查看方法</a></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154945.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154945.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154945.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154945.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154945.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016154945.png" /></p>
<h2 id="14目前使用版本">1.4、目前使用版本</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155101.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155101.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155101.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155101.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155101.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155101.png" /></p>
<h3 id="141题外话">1.4.1、题外话</h3>
<ul>
<li>
<p>boot版本以及到2.2.4为最新(截止2020.2.15)，为什么选2.2.2</p>
<ul>
<li>只用boot，直接用最新</li>
<li>同时用boot和cloud，需要照顾cloud，由cloud决定boot版本</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155252.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155252.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155252.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155252.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155252.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155252.png" /></p>
</li>
<li>
<p>SpringCloud和SpringBoot版本对应关系</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155334.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155334.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155334.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155334.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155334.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155334.png" /></p>
</li>
<li>
<p>X版本常用的组件pom</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependencies&gt;</span>
  <span class="c">&lt;!--spring boot 2.2.2--&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-boot-dependencies<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>2.2.2.RELEASE<span class="nt">&lt;/version&gt;</span>
	<span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
	<span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
  <span class="c">&lt;!--spring cloud Hoxton.SR1--&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>Hoxton.SR1<span class="nt">&lt;/version&gt;</span>
	<span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
	<span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
  <span class="c">&lt;!--spring cloud alibaba 2.1.0.RELEASE--&gt;</span>
  <span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-cloud-alibaba-dependencies<span class="nt">&lt;/artifactId&gt;</span>
	<span class="nt">&lt;version&gt;</span>2.1.0.RELEASE<span class="nt">&lt;/version&gt;</span>
	<span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
	<span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
  <span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="2关于cloud各种组件的停更升级替换">2、关于Cloud各种组件的停更/升级/替换</h1>
<ul>
<li>
<p>以前学习</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155723.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155723.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155723.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155723.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155723.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155723.png" /></p>
</li>
<li>
<p>现在</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155757.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155757.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155757.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155757.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155757.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016155757.png" /></p>
</li>
</ul>
<p><a href="https://cloud.spring.io/spring-cloud-static/Hoxton.SR1/reference/htmlsingle/" target="_blank" rel="noopener noreffer">SpringCloud官方文档</a></p>
<p><a href="https://www.bookstack.cn/read/spring-cloud-docs/docs-index.md" target="_blank" rel="noopener noreffer">SpringCloud中文文档</a></p>
<p><a href="https://docs.spring.io/spring-boot/docs/2.2.2.RELEASE/reference/htmlsingle/" target="_blank" rel="noopener noreffer">SpringBoot官方文档</a></p>
<h1 id="3微服务架构编码构建">3、微服务架构编码构建</h1>
<p><strong>约定 &gt; 配置 &gt; 编码</strong></p>
<h2 id="31idea新建project工作空间">3.1、IDEA新建project工作空间</h2>
<ol>
<li>
<p>创建maven项目</p>
</li>
<li>
<p>设置字符编码为<code>utf-8</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160424.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160424.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160424.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160424.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160424.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160424.png" /></p>
</li>
<li>
<p>设置注解生效激活</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160540.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160540.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160540.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160540.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160540.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160540.png" /></p>
</li>
<li>
<p>Java编译版本选择8</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160631.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160631.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160631.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160631.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160631.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160631.png" /></p>
</li>
<li>
<p>File Type过滤 <strong>(可选)</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160706.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160706.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160706.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160706.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160706.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016160706.png" /></p>
</li>
</ol>
<h2 id="32父工程pom">3.2、父工程POM</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span><span class="lnt">98
</span><span class="lnt">99
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>

<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;packaging&gt;</span>pom<span class="nt">&lt;/packaging&gt;</span>
 
    <span class="c">&lt;!-- 统一管理jar包版本 --&gt;</span>
    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span>
        <span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
        <span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
        <span class="nt">&lt;junit.version&gt;</span>4.12<span class="nt">&lt;/junit.version&gt;</span>
        <span class="nt">&lt;log4j.version&gt;</span>1.2.17<span class="nt">&lt;/log4j.version&gt;</span>
        <span class="nt">&lt;lombok.version&gt;</span>1.16.18<span class="nt">&lt;/lombok.version&gt;</span>
        <span class="nt">&lt;mysql.version&gt;</span>5.1.47<span class="nt">&lt;/mysql.version&gt;</span>
        <span class="nt">&lt;druid.version&gt;</span>1.1.16<span class="nt">&lt;/druid.version&gt;</span>
        <span class="nt">&lt;mybatis.spring.boot.version&gt;</span>1.3.0<span class="nt">&lt;/mybatis.spring.boot.version&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>
 
    <span class="c">&lt;!-- 子模块继承之后，提供作用：锁定版本+子modlue不用写groupId和version  --&gt;</span>
    <span class="nt">&lt;dependencyManagement&gt;</span>
        <span class="nt">&lt;dependencies&gt;</span>
            <span class="c">&lt;!--spring boot 2.2.2--&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-boot-dependencies<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>2.2.2.RELEASE<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
            <span class="c">&lt;!--spring cloud Hoxton.SR1--&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-cloud-dependencies<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>Hoxton.SR1<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
            <span class="c">&lt;!--spring cloud alibaba 2.1.0.RELEASE--&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>com.alibaba.cloud<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-cloud-alibaba-dependencies<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>2.1.0.RELEASE<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
                <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>${mysql.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>druid<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>${druid.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.mybatis.spring.boot<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>${mybatis.spring.boot.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>${junit.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>log4j<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>log4j<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>${log4j.version}<span class="nt">&lt;/version&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
            <span class="nt">&lt;dependency&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;version&gt;</span>${lombok.version}<span class="nt">&lt;/version&gt;</span>
                <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
            <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;/dependencies&gt;</span>
    <span class="nt">&lt;/dependencyManagement&gt;</span>

    <span class="nt">&lt;build&gt;</span>
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
                <span class="nt">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;configuration&gt;</span>
                    <span class="nt">&lt;fork&gt;</span>true<span class="nt">&lt;/fork&gt;</span>
                    <span class="nt">&lt;addResources&gt;</span>true<span class="nt">&lt;/addResources&gt;</span>
                <span class="nt">&lt;/configuration&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
    <span class="nt">&lt;/build&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="33maven工程落地细节复习">3.3、Maven工程落地细节复习</h2>
<h3 id="331maven中的dependencymanagement和dependencies">3.3.1、Maven中的DependencyManagement和Dependencies</h3>
<p>Maven 使用 <code>dependencyManagement</code> 元素来提供了一种管理依赖版本号的方式。</p>
<p><strong>通常会在一个组织或者项目的最顶层的父POM 中看到 dependencyManagement 元素。</strong></p>
<p>使用 <code>pom.xml </code>中的 dependencyManagement 元素能让所有在子项目中引用一个依赖而不用显式的列出版本号。</p>
<p>Maven 会沿着父子层次向上走，直到找到一个拥有 dependencyManagement 元素的项目，然后它就会使用这个</p>
<p><code>dependencyManagement</code> 元素中指定的版本号。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161035.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161035.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161035.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161035.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161035.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161035.png" /></p>
<pre><code>这样做的好处就是：
	如果有多个子项目都引用同一样依赖，则可以避免在每个使用的子项目里都声明一个版本号，这样当想升级或切换到另一
	个版本时，只需要在顶层父容器里更新，而不需要一个一个子项目的修改;另外如果某个子项目需要另外的一个版本，只需
	要声明version就可。
</code></pre>
<ul>
<li><code>dependencyManagement</code> 里只是声明依赖，<strong>并不实现引入</strong>，因此子项目需要显示的声明需要用的依赖。</li>
<li><strong>如果不在子项目中声明依赖，是不会从父项目中继承下来的；只有在子项目中写了该依赖项，并且没有指定具体版本，才会从父项目中继承该项，并且version和scope都读取自父pom;</strong></li>
<li>如果子项目中指定了版本号，那么会使用子项目中指定的jar版本。</li>
</ul>
<h3 id="332maven中跳过单元测试">3.3.2、Maven中跳过单元测试</h3>
<ol>
<li>配置</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;build&gt;</span><span class="c">&lt;!-- maven中跳过单元测试 --&gt;</span>
	<span class="nt">&lt;plugins&gt;</span>
		<span class="nt">&lt;plugin&gt;</span>
			<span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
			<span class="nt">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="nt">&lt;/artifactId&gt;</span>
			<span class="nt">&lt;configuration&gt;</span>
				<span class="nt">&lt;skip&gt;</span>true<span class="nt">&lt;/skip&gt;</span>
			<span class="nt">&lt;/configuration&gt;</span>
		<span class="nt">&lt;/plugin&gt;</span>
	<span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>
<p>IDEA工具支持 <strong>(推荐)</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161438.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161438.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161438.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161438.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161438.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211016161438.png" /></p>
</li>
</ol>
<h2 id="34rest微服务工程构建">3.4、Rest微服务工程构建</h2>
<h3 id="341提供者模块构建">3.4.1、提供者模块构建</h3>
<p><code>cloud-provider-payment8001</code>微服务提供者支付Module模块</p>
<ol>
<li>新建 cloud-provider-payment8001</li>
<li>修改POM文件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"> <span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>  
 <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>  
 <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>  
	
	 <span class="nt">&lt;parent&gt;</span>  
 		<span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>  
 		<span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>  
 		<span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>  
 	<span class="nt">&lt;/parent&gt;</span>  
 	<span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>  
  
 	<span class="nt">&lt;artifactId&gt;</span>cloud-provider-payment8001<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.mybatis.spring.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>druid-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.1.10<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--mysql-connector-java--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--jdbc--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-jdbc<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-devtools<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>编写YML</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml">server:
  port: 8001

spring:
  application:
    name: cloud-payment-service
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource            # 当前数据源操作类型
    driver-class-name: org.gjt.mm.mysql.Driver              # mysql驱动包 com.mysql.jdbc.Driver
    url: jdbc:mysql://localhost:3306/springcloud?useUnicode=true<span class="err">&amp;</span>characterEncoding=utf-8<span class="err">&amp;</span>useSSL=false
    username: root
    password: xn123456


mybatis:
  mapperLocations: classpath:mapper/*.xml
  type-aliases-package: com.clover.springcloud.entities    # 所有Entity别名类所在包
</code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>建立主启动类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentMain8001</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaymentMain8001</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>业务类</li>
<li>测试</li>
</ol>
<h3 id="342小知识点补充">3.4.2、小知识点补充</h3>
<p>1、为什么<code>DAO层</code>传入参数时为什么使用<code>@Param注解</code></p>
<pre><code>因为java没有保存行参的记录，java在运行的时候会把List queryAll(int offset,int limit);中的参数变成这样:
queryAll(int arg0,int arg1),这样我们就没有办法去传递多个参数。所以需要使用@Param注解给方法参数命名，然后在xml
文件的该dao层方法对应的sql语句中就可以正常使用@Param注解的参数名。
还可以传入多个参数
</code></pre>
<p><a href="https://blog.csdn.net/zijikanwa/article/details/103056857" target="_blank" rel="noopener noreffer">参考博客</a></p>
<p>2、<code>Controller层</code>使用<code>GetMapping</code>时为什么使用<code>PathVariable注解</code></p>
<pre><code>1.因为PathVariable注解用于处理动态URL
2.在GetMapping定义的URL路径中存在变量传递，使用PathVariable注解可获取该变量的值
3.默认情况下，Spring会对PathVariable注解的变量进行自动赋值，当然你也可以指定PathVariable注解使用哪一个URL中的变量
4.你也可以定义多个URL变量，但是你在函数的形参中使用该注解时，必须显示的表名具体是哪个URL变量值
</code></pre>
<p><a href="https://blog.csdn.net/qq_37370132/article/details/107972265" target="_blank" rel="noopener noreffer">参考博客</a></p>
<p>3、<code>POST请求</code>时为什么要使用<code>RequestBody注解</code></p>
<pre><code>RequestBody注解可以将请求体中的JSON字符串绑定到相应的bean上，也可以将其绑定到对应的字符串上
</code></pre>
<p><a href="https://blog.csdn.net/qq_35246620/article/details/59620858" target="_blank" rel="noopener noreffer">参考博客1</a>
<a href="https://www.jianshu.com/p/bd998a400f29" target="_blank" rel="noopener noreffer">参考博客2</a></p>
<p><strong>主实体Payment</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.entities</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Payment</span> <span class="kd">implements</span> <span class="n">Serializable</span>
<span class="o">{</span>

    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serial</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Json封装体CommonResult</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.entities</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="o">;</span>

<span class="cm">/*
</span><span class="cm"> * 返回给前端人员的数据，实体类是供给我们后端人员使用的
</span><span class="cm"> * 给前端人员只需要将状态与数据返回过去给其就行
</span><span class="cm"> */</span>
<span class="nd">@Data</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommonResult</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="o">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">T</span> <span class="n">data</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CommonResult</span><span class="o">(</span><span class="n">Integer</span> <span class="n">code</span><span class="o">,</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">code</span><span class="o">,</span><span class="n">message</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>接口PaymentDao</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.dao</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Mapper</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="o">;</span>

<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PaymentDao</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">Payment</span> <span class="n">payment</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">Payment</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>映射文件PaymentMapper.xml</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="o">&lt;?</span><span class="n">xml</span> <span class="n">version</span><span class="o">=</span><span class="s">&#34;1.0&#34;</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#34;UTF-8&#34;</span> <span class="o">?&gt;</span>
<span class="o">&lt;!</span><span class="n">DOCTYPE</span> <span class="n">mapper</span> <span class="n">PUBLIC</span> <span class="s">&#34;-//mybatis.org//DTD Mapper 3.0//EN&#34;</span> <span class="s">&#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34;</span> <span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">mapper</span> <span class="n">namespace</span><span class="o">=</span><span class="s">&#34;com.clover.springcloud.dao.PaymentDao&#34;</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">resultMap</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;BaseResultMap&#34;</span> <span class="n">type</span><span class="o">=</span><span class="s">&#34;Payment&#34;</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">id</span> <span class="n">column</span><span class="o">=</span><span class="s">&#34;id&#34;</span> <span class="n">property</span><span class="o">=</span><span class="s">&#34;id&#34;</span> <span class="n">jdbcType</span><span class="o">=</span><span class="s">&#34;BIGINT&#34;</span><span class="o">/&gt;</span>
        <span class="o">&lt;</span><span class="n">result</span> <span class="n">column</span><span class="o">=</span><span class="s">&#34;serial&#34;</span> <span class="n">property</span><span class="o">=</span><span class="s">&#34;serial&#34;</span> <span class="n">jdbcType</span><span class="o">=</span><span class="s">&#34;VARCHAR&#34;</span><span class="o">/&gt;</span>
    <span class="o">&lt;/</span><span class="n">resultMap</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">insert</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;create&#34;</span> <span class="n">parameterType</span><span class="o">=</span><span class="s">&#34;Payment&#34;</span> <span class="n">useGeneratedKeys</span><span class="o">=</span><span class="s">&#34;true&#34;</span> <span class="n">keyProperty</span><span class="o">=</span><span class="s">&#34;id&#34;</span><span class="o">&gt;</span>
        <span class="n">insert</span> <span class="n">into</span> <span class="nf">payment</span><span class="o">(</span><span class="n">serial</span><span class="o">)</span> <span class="n">values</span><span class="o">(</span><span class="err">#</span><span class="o">{</span><span class="n">serial</span><span class="o">})</span>
    <span class="o">&lt;/</span><span class="n">insert</span><span class="o">&gt;</span>

    <span class="o">&lt;</span><span class="n">select</span> <span class="n">id</span><span class="o">=</span><span class="s">&#34;getPaymentById&#34;</span> <span class="n">parameterType</span><span class="o">=</span><span class="s">&#34;Long&#34;</span> <span class="n">resultMap</span><span class="o">=</span><span class="s">&#34;BaseResultMap&#34;</span><span class="o">&gt;</span>
        <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">payment</span> <span class="n">where</span> <span class="n">id</span> <span class="o">=</span> <span class="err">#</span><span class="o">{</span><span class="n">id</span><span class="o">}</span>
    <span class="o">&lt;/</span><span class="n">select</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">mapper</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>接口PaymentService</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.ibatis.annotations.Param</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PaymentService</span>
<span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">Payment</span> <span class="n">payment</span><span class="o">);</span>

    <span class="kd">public</span> <span class="n">Payment</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@Param</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>实现类</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.service.Impl</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.dao.PaymentDao</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentServiceImpl</span> <span class="kd">implements</span> <span class="n">PaymentService</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">public</span> <span class="n">PaymentDao</span> <span class="n">paymentDao</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">create</span><span class="o">(</span><span class="n">Payment</span> <span class="n">payment</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">paymentDao</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">payment</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Payment</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="n">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">paymentDao</span><span class="o">.</span><span class="na">getPaymentById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>controller</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentController</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">public</span> <span class="n">PaymentService</span> <span class="n">paymentService</span><span class="o">;</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/create&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">Payment</span> <span class="n">payment</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">payment</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********插入操作结果：&#34;</span><span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;插入数据成功&#34;</span><span class="o">,</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;插入数据失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">Payment</span> <span class="n">payment</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">getPaymentById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********查询结果：&#34;</span><span class="o">+</span> <span class="n">payment</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">payment</span> <span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;查询成功&#34;</span><span class="o">,</span><span class="n">payment</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;查询失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="343消费者模块构建">3.4.3、消费者模块构建</h3>
<p><code>cloud-consumer-order80</code>微服务消费者订单Module模块</p>
<ol>
<li>新建 cloud-consumer-order80 模块</li>
<li>改写POM</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>cloud-consumer-order80<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>

        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>编写YML</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>构建主启动类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderMain80</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">OrderMain80</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>业务类</li>
<li>测试</li>
</ol>
<h3 id="344小知识点补充">3.4.4、小知识点补充</h3>
<p>1、首说RestTemplate是什么？</p>
<pre><code>RestTemplate提供了多种便捷访问远程Http服务的方法， 
是一种简单便捷的访问restful服务模板类，是Spring提供的用于访问Rest服务的客户端模板工具集
</code></pre>
<p>2、使用</p>
<pre><code>使用restTemplate访问restful接口非常的简单粗暴无脑。(url, requestMap, ResponseBean.class)这三个参数分别代表
REST请求地址、请求参数、HTTP响应转换被转换成的对象类型。
</code></pre>
<p><a href="https://docs.spring.io/spring-framework/docs/5.2.2.RELEASE/javadoc-api/org/springframework/web/client/RestTemplate.html" target="_blank" rel="noopener noreffer">RestTemplate官网</a></p>
<p><strong>业务类：</strong></p>
<p><strong>主实体Payment</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.entities</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="nd">@Data</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Payment</span> <span class="kd">implements</span> <span class="n">Serializable</span>
<span class="o">{</span>

    <span class="kd">private</span> <span class="n">Long</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serial</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Json封装体CommonResult</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.entities</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.AllArgsConstructor</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.Data</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.NoArgsConstructor</span><span class="o">;</span>

<span class="cm">/*
</span><span class="cm"> * 返回给前端人员的数据，实体类是供给我们后端人员使用的
</span><span class="cm"> * 给前端人员只需要将状态与数据返回过去给其就行
</span><span class="cm"> */</span>
<span class="nd">@Data</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommonResult</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="o">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">code</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">message</span><span class="o">;</span>
    <span class="kd">private</span>  <span class="n">T</span> <span class="n">data</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">CommonResult</span><span class="o">(</span><span class="n">Integer</span> <span class="n">code</span><span class="o">,</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">code</span><span class="o">,</span><span class="n">message</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>config配置类</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApplicationContextConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">RestTemplate</span> <span class="nf">restTemplate</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">RestTemplate</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>controller</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">Payment_URL</span> <span class="o">=</span> <span class="s">&#34;http://localhost:8001&#34;</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">RestTemplate</span> <span class="n">restTemplate</span><span class="o">;</span>

    <span class="c1">//客户端用浏览器是get请求，但是底层实质发送post调用服务端8001
</span><span class="c1"></span>    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/consumer/payment/create&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">create</span><span class="o">(</span><span class="n">Payment</span> <span class="n">payment</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">postForObject</span><span class="o">(</span><span class="n">Payment_URL</span> <span class="o">+</span> <span class="s">&#34;/payment/create&#34;</span><span class="o">,</span><span class="n">payment</span><span class="o">,</span><span class="n">CommonResult</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/consumer/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="n">Payment_URL</span> <span class="o">+</span> <span class="s">&#34;/payment/get/&#34;</span> <span class="o">+</span> <span class="n">id</span><span class="o">,</span><span class="n">CommonResult</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><pre><code>注意：
在提供者的Controller中创建一个payment的时候，不要忘记了RequestBody注解，否则会造成数据库插入成功，但是数据没有插入进去
</code></pre>
<h2 id="35工程重构">3.5、工程重构</h2>
<p><strong>发现问题：项目中有重复部分，重构</strong></p>
<ol>
<li>新建 cloud-api-commons 模块</li>
<li>修改POM</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>cn.hutool<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>hutool-all<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>5.1.0<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>将entities复制过来</li>
<li>执行maven的 clean 和 install 命令</li>
<li>改造订单80和支付8001
<ol>
<li>删除原有的entities文件夹</li>
<li>各自粘贴POM内容</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span><span class="c">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="4eureka服务注册与发现">4、Eureka服务注册与发现</h1>
<h2 id="41eureka基础知识">4.1、Eureka基础知识</h2>
<h3 id="411什么是服务治理">4.1.1、什么是服务治理</h3>
<p>SpringCloud 封装了 Netflix 公司开发的 Eureka 模块来<strong>实现服务治理</strong></p>
<p>在传统的rpc远程调用框架中，管理每个服务与服务之间依赖关系比较复杂，管理比较复杂，所以需要使用服务治理，管理服务与服务之间依赖关系，可以实现服务调用、负载均衡、容错等，实现服务发现与注册。</p>
<h3 id="412什么是服务注册">4.1.2、什么是服务注册</h3>
<p>Eureka 采用了CS的设计架构，Eureka Server 作为服务注册功能的服务器，它是服务注册中心。而系统中的其他微服务，使用 Eureka 的客户端连接到 Eureka Server 并维持心跳连接。这样系统的维护人员就可以通过 Eureka Server 来监控系统中各个微服务是否正常运行。</p>
<p>在服务注册与发现中，有一个注册中心。当服务器启动的时候，会把当前自己服务器的信息,比如 服务地址、通讯地址等以别名方式注册到注册中心上。另一方（消费者|服务提供者），以该别名的方式去注册中心上获取到实际的服务通讯地址，然后再实现本地RPC调用RPC远程框架核心设计思想：在于注册中心，因为使用注册中心管理每个服务与服务之间的一个依赖关系(服务治理概念)。在任何RPC远程框架中，都会有一个注册中心(存放服务地址相关信息(接口地址))</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017112259.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017112259.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017112259.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017112259.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017112259.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017112259.png" /></p>
<h3 id="413eureka两组件">4.1.3、Eureka两组件</h3>
<p><strong>Eureka Server</strong>提供服务注册服务</p>
<p>各个微服务节点通过配置启动后，会在EurekaServer中进行注册，这样EurekaServer中的服务注册表中将会存储所有可用服务节点的信息，服务节点的信息可以在界面中直观看到。</p>
<p><strong>EurekaClient</strong>通过注册中心进行访问</p>
<p>是一个Java客户端，用于简化Eureka Server的交互，客户端同时也具备一个内置的、使用轮询(round-robin)负载算法的负载均衡器。在应用启动后，将会向Eureka Server发送心跳(默认周期为30秒)。如果Eureka Server在多个心跳周期内没有接收到某个节点的心跳，EurekaServer将会从服务注册表中把这个服务节点移除（默认90秒）</p>
<h2 id="42单机eureka构建步骤">4.2、单机Eureka构建步骤</h2>
<h3 id="421idea生成eurekaserver端服务注册中心类似物业公司">4.2.1、IDEA生成eurekaServer端服务注册中心类似物业公司</h3>
<ol>
<li>新建 springcloud-eureka-server7001 模块</li>
<li>修改POM</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>springcloud-eureka-server7001<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--eureka-server--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--boot web actuator--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>编写YML</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">7001</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w"> </span><span class="c">#eureka服务端的实例名称</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#false表示不向注册中心注册自己。</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="c">#false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</span><span class="w">
</span><span class="w">    </span><span class="nt">fetch-registry</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c">#设置与Eureka Server交互的地址查询服务和注册服务都需要依赖这个地址。</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://${eureka.instance.hostname}:${server.port}/eureka/</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>新建主启动类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.server.EnableEurekaServer</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaServer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EurekaMain7001</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">EurekaMain7001</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="422eurekaclient端cloud-provider-payment8001">4.2.2、EurekaClient端cloud-provider-payment8001</h3>
<p>将其注册进 EurekaServer 成为服务提供者provider，类似尚硅谷学校对外提供授课服务</p>
<ol>
<li>改写POM</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="c">&lt;!--eureka-client--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>改写YML</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#表示是否将自己注册进EurekaServer默认为true。</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span><span class="w">
</span><span class="w">    </span><span class="nt">fetchRegistry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:7001/eureka</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>改变主启动类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentMain8001</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaymentMain8001</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>测试：</p>
<p>1、<strong>先要启动EurekaServer</strong></p>
<p>2、访问 http://localhost:7001</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017194840.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017194840.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017194840.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017194840.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017194840.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017194840.png" /></p>
<p>3、微服务注册名配置说明</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017195005.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017195005.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017195005.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017195005.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017195005.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017195005.png" /></p>
<p><code>自我保护机制</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017200238.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017200238.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017200238.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017200238.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017200238.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017200238.png" /></p>
<h3 id="423eurekaclient端cloud-consumer-order80">4.2.3、EurekaClient端cloud-consumer-order80</h3>
<p>将其注册进 EurekaServer 成为服务消费者consumer，类似来尚硅谷上课消费的各位同学</p>
<ol>
<li>修改POM</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="c">&lt;!--eureka-client--&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
	<span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
	<span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>修改YML</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-order-service</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#表示是否将自己注册进EurekaServer默认为true。</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span><span class="w">
</span><span class="w">    </span><span class="nt">fetchRegistry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:7001/eureka</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>修改主启动类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderMain80</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">OrderMain80</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>测试：</p>
<p>1、<strong>先要启动EurekaServer，7001服务，再启动服务提供者provider，8001服务</strong></p>
<p>2、再启动80服务</p>
<h2 id="43集群eureka构建步骤">4.3、集群Eureka构建步骤</h2>
<h3 id="431eureka集群原理说明">4.3.1、Eureka集群原理说明</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017201223.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017201223.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017201223.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017201223.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017201223.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017201223.png" /></p>
<p><code>EurekaServer 集群是互相注册，相互守望</code></p>
<p>问题：微服务RPC远程服务调用最核心的是什么</p>
<pre><code>高可用，试想你的注册中心只有一个only one， 它出故障了那就呵呵(￣▽￣)&quot;了，会导致整个为服务环境不可用，所以
解决办法：搭建Eureka注册中心集群 ，实现负载均衡+故障容错
</code></pre>
<h3 id="432eurekaserver集群环境构建步骤">4.3.2、EurekaServer集群环境构建步骤</h3>
<p>1、参考 springcloud-eureka-server7001 新建 springcloud-eureka-server7002</p>
<p>2、修改POM</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>springcloud-eureka-server7002<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--eureka-server--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--boot web actuator--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>3、修改映射配置</p>
<ul>
<li>找到C:\Windows\System32\drivers\etc路径下的hosts文件</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017204314.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017204314.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017204314.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017204314.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017204314.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017204314.png" /></p>
<ul>
<li>修改映射配置添加进hosts文件
<ul>
<li>127.0.0.1  eureka7001.com</li>
<li>127.0.0.1  eureka7002.com</li>
</ul>
</li>
</ul>
<p><code>如果你的用户无法编辑host文件</code>：<a href="https://blog.csdn.net/yuanlaijike/article/details/79668711" target="_blank" rel="noopener noreffer">参考博客</a></p>
<p>4、改写以前的YML <strong>(以前单机)</strong></p>
<p>5、编写主启动类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.server.EnableEurekaServer</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaServer</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EurekaMain7002</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">EurekaMain7002</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="433将支付服务8001微服务发布到上面2台eureka集群配置中">4.3.3、将支付服务8001微服务发布到上面2台Eureka集群配置中</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-payment-service</span><span class="w">
</span><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource           </span><span class="w"> </span><span class="c"># 当前数据源操作类型</span><span class="w">
</span><span class="w">    </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">org.gjt.mm.mysql.Driver             </span><span class="w"> </span><span class="c"># mysql驱动包 com.mysql.jdbc.Driver</span><span class="w">
</span><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://localhost:3306/springcloud?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span><span class="w">
</span><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">xn123456</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#表示是否将自己注册进EurekaServer默认为true。</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span><span class="w">
</span><span class="w">    </span><span class="nt">fetchRegistry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c">#defaultZone: http://localhost:7001/eureka # 单机版</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka </span><span class="w"> </span><span class="c"># 集群版</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">mapperLocations</span><span class="p">:</span><span class="w"> </span><span class="l">classpath:mapper/*.xml</span><span class="w">
</span><span class="w">  </span><span class="nt">type-aliases-package</span><span class="p">:</span><span class="w"> </span><span class="l">com.clover.springcloud.entities   </span><span class="w"> </span><span class="c"># 所有Entity别名类所在包</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="434将订单服务80微服务发布到上面2台eureka集群配置中">4.3.4、将订单服务80微服务发布到上面2台Eureka集群配置中</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-order-service</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#表示是否将自己注册进EurekaServer默认为true。</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span><span class="w">
</span><span class="w">    </span><span class="nt">fetchRegistry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c">#defaultZone: http://localhost:7001/eureka # 单机版</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka </span><span class="w"> </span><span class="c"># 集群版</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>测试</p>
<p>1、<strong>先要启动EurekaServer，7001/7002服务</strong></p>
<p>2、<strong>再要启动服务提供者provider，8001</strong></p>
<p>3、<strong>再要启动消费者，80</strong></p>
<p>4、最后用查询验证是否正确：http://localhost/consumer/payment/get/1</p>
<h3 id="435支付服务提供者8001集群环境构建">4.3.5、支付服务提供者8001集群环境构建</h3>
<p>1、参考 cloud-provider-payment8001 新建 cloud-provider-payment8002</p>
<p>2、修改POM</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>cloud-provider-payment8002<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--eureka-client--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span><span class="c">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.mybatis.spring.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.alibaba<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>druid-spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.1.10<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--mysql-connector-java--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>mysql<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>mysql-connector-java<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--jdbc--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-jdbc<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>3、编写YML</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8002</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-payment-service</span><span class="w">
</span><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource           </span><span class="w"> </span><span class="c"># 当前数据源操作类型</span><span class="w">
</span><span class="w">    </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">org.gjt.mm.mysql.Driver             </span><span class="w"> </span><span class="c"># mysql驱动包 com.mysql.jdbc.Driver</span><span class="w">
</span><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://localhost:3306/springcloud?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span><span class="w">
</span><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">xn123456</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#表示是否将自己注册进EurekaServer默认为true。</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span><span class="w">
</span><span class="w">    </span><span class="nt">fetchRegistry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c">#defaultZone: http://localhost:7001/eureka # 单机版</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka </span><span class="w"> </span><span class="c"># 集群版</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">mapperLocations</span><span class="p">:</span><span class="w"> </span><span class="l">classpath:mapper/*.xml</span><span class="w">
</span><span class="w">  </span><span class="nt">type-aliases-package</span><span class="p">:</span><span class="w"> </span><span class="l">com.clover.springcloud.entities   </span><span class="w"> </span><span class="c"># 所有Entity别名类所在包</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>4、编写主启动类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentMain8002</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaymentMain8002</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>5、业务类：直接从8001copy</p>
<p>6、修改8001/8002的Controller</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentController</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">public</span> <span class="n">PaymentService</span> <span class="n">paymentService</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${server.port}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverPort</span><span class="o">;</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/create&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">Payment</span> <span class="n">payment</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">payment</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********插入操作结果：&#34;</span><span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;插入数据成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;插入数据失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">Payment</span> <span class="n">payment</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">getPaymentById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********查询结果：&#34;</span><span class="o">+</span> <span class="n">payment</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">payment</span> <span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;查询成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">payment</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;查询失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentController</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">public</span> <span class="n">PaymentService</span> <span class="n">paymentService</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${server.port}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverPort</span><span class="o">;</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/create&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">Payment</span> <span class="n">payment</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">payment</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********插入操作结果：&#34;</span><span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;插入数据成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;插入数据失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">Payment</span> <span class="n">payment</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">getPaymentById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********查询结果：&#34;</span><span class="o">+</span> <span class="n">payment</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">payment</span> <span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;查询成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">payment</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;查询失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="436负载均衡">4.3.6、负载均衡</h3>
<ol>
<li>订单服务访问地址不能写死</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213252.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213252.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213252.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213252.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213252.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213252.png" /></p>
<ol start="2">
<li><strong>使用@LoadBalanced注解赋予RestTemplate负载均衡的能力</strong></li>
<li>修改ApplicationContextBean</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213316.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213316.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213316.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213316.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213316.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017213316.png" /></p>
<p>测试：</p>
<p>1、<strong>先要启动EurekaServer，7001/7002服务</strong></p>
<p>2、<strong>再要启动服务提供者provider，8001/8002服务</strong></p>
<p>3、最后用查询验证是否正确：http://localhost/consumer/payment/get/1</p>
<p>4、结果</p>
<ul>
<li>负载均衡效果达到</li>
<li>8001/8002端口交替出现</li>
</ul>
<p>5、Ribbon和Eureka整合后Consumer可以直接调用服务而不用再关心地址和端口号，且该服务还有负载功能了。</p>
<h2 id="44actuator微服务信息完善">4.4、actuator微服务信息完善</h2>
<h3 id="441主机名称服务名称修改">4.4.1、主机名称:服务名称修改</h3>
<ol>
<li>当前问题</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017214651.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017214651.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017214651.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017214651.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017214651.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017214651.png" /></p>
<ol start="2">
<li>修改cloud-provider-payment8001/8002</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-payment-service</span><span class="w">
</span><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource           </span><span class="w"> </span><span class="c"># 当前数据源操作类型</span><span class="w">
</span><span class="w">    </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">org.gjt.mm.mysql.Driver             </span><span class="w"> </span><span class="c"># mysql驱动包</span><span class="w">
</span><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://localhost:3306/db2019?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span><span class="w">
</span><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="m">123456</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#表示是否将自己注册进EurekaServer默认为true。</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span><span class="w">
</span><span class="w">    </span><span class="nt">fetchRegistry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka </span><span class="w"> </span><span class="c"># 集群版</span><span class="w">
</span><span class="w">      </span><span class="c">#defaultZone: http://localhost:7001/eureka  # 单机版</span><span class="w">
</span><span class="w">  </span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">instance-id</span><span class="p">:</span><span class="w"> </span><span class="l">payment8001</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">mapperLocations</span><span class="p">:</span><span class="w"> </span><span class="l">classpath:mapper/*.xml</span><span class="w">
</span><span class="w">  </span><span class="nt">type-aliases-package</span><span class="p">:</span><span class="w"> </span><span class="l">com.atguigu.springcloud.entities   </span><span class="w"> </span><span class="c"># 所有Entity别名类所在包</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>修改之后</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215016.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215016.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215016.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215016.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215016.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215016.png" /></p>
<h3 id="442访问信息有ip信息提示">4.4.2、访问信息有IP信息提示</h3>
<ol>
<li>当前问题：<strong>没有IP提示</strong></li>
<li>修改cloud-provider-payment8001/8002</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-payment-service</span><span class="w">
</span><span class="w">  </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource           </span><span class="w"> </span><span class="c"># 当前数据源操作类型</span><span class="w">
</span><span class="w">    </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">org.gjt.mm.mysql.Driver             </span><span class="w"> </span><span class="c"># mysql驱动包</span><span class="w">
</span><span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://localhost:3306/db2019?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span><span class="w">
</span><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="m">123456</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#表示是否将自己注册进EurekaServer默认为true。</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span><span class="w">
</span><span class="w">    </span><span class="nt">fetchRegistry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka </span><span class="w"> </span><span class="c"># 集群版</span><span class="w">
</span><span class="w">      </span><span class="c">#defaultZone: http://localhost:7001/eureka  # 单机版</span><span class="w">
</span><span class="w">  </span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">instance-id</span><span class="p">:</span><span class="w"> </span><span class="l">payment8001</span><span class="w">
</span><span class="w">    </span><span class="nt">prefer-ip-address</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">     </span><span class="c">#访问路径可以显示IP地址</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">mapperLocations</span><span class="p">:</span><span class="w"> </span><span class="l">classpath:mapper/*.xml</span><span class="w">
</span><span class="w">  </span><span class="nt">type-aliases-package</span><span class="p">:</span><span class="w"> </span><span class="l">com.atguigu.springcloud.entities   </span><span class="w"> </span><span class="c"># 所有Entity别名类所在包</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>修改之后</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215122.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215122.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215122.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215122.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215122.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211017215122.png" /></p>
<h2 id="45服务发现discovery">4.5、服务发现Discovery</h2>
<p><strong>对于注册进eureka里面的微服务，可以通过服务发现来获得该服务的信息</strong></p>
<p>1、修改 cloud-provider-payment8001 的Controller</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.ServiceInstance</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.DiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentController</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">public</span> <span class="n">PaymentService</span> <span class="n">paymentService</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${server.port}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverPort</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">DiscoveryClient</span> <span class="n">discoveryClient</span><span class="o">;</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/create&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">Payment</span> <span class="n">payment</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">payment</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********插入操作结果：&#34;</span><span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;插入数据成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;插入数据失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">Payment</span> <span class="n">payment</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">getPaymentById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********查询结果：&#34;</span><span class="o">+</span> <span class="n">payment</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">payment</span> <span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;查询成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">payment</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;查询失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/discovery&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">discovery</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="c1">// 用于查询Eureka上有几个服务
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">services</span> <span class="o">=</span> <span class="n">discoveryClient</span><span class="o">.</span><span class="na">getServices</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">element</span><span class="o">:</span> <span class="n">services</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;***************element:&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// 用于查询某一个名称下的实例
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceInstance</span><span class="o">&gt;</span> <span class="n">instances</span> <span class="o">=</span> <span class="n">discoveryClient</span><span class="o">.</span><span class="na">getInstances</span><span class="o">(</span><span class="s">&#34;CLOUD-PAYMENT-SERVICE&#34;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ServiceInstance</span> <span class="n">element</span><span class="o">:</span> <span class="n">instances</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="na">getServiceId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="na">getHost</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="na">getPort</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="na">getUri</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">discoveryClient</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>2、在8001主启动类上加上<code>@EnableDiscoveryClient注解</code></p>
<p>3、测试</p>
<ul>
<li><strong>先启动EurekaServer</strong></li>
<li><strong>再启动8001主启动类</strong></li>
<li>最后用查询验证是否正确：http://localhost:8001/payment/discovery</li>
</ul>
<h2 id="46eureka自我保护机制">4.6、Eureka自我保护机制</h2>
<h3 id="461故障现象">4.6.1、故障现象</h3>
<h4 id="4611概述">4.6.1.1、概述</h4>
<p>保护模式主要用于一组客户端和Eureka Server之间存在网络分区场景下的保护。一旦进入保护模式，
<strong>Eureka Server将会尝试保护其服务注册表中的信息，不再删除服务注册表中的数据，也就是不会注销任何微服务</strong>。</p>
<p>如果在Eureka Server的首页看到以下这段提示，则说明Eureka进入了保护模式：</p>
<p>EMERGENCY! EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY&rsquo;RE NOT.
RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110517.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110517.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110517.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110517.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110517.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110517.png" /></p>
<h3 id="462导致原因">4.6.2、导致原因</h3>
<h4 id="4621为什么会产生eureka自我保护机制">4.6.2.1、为什么会产生Eureka自我保护机制？</h4>
<p>为了防止EurekaClient可以正常运行，但是与 EurekaServer 网络不通情况下，EurekaServer<strong>不会立刻</strong>将EurekaClient服务剔除</p>
<h4 id="4622什么是自我保护模式">4.6.2.2、什么是自我保护模式</h4>
<p>默认情况下，如果EurekaServer在一定时间内没有接收到某个微服务实例的心跳，EurekaServer将会注销该实例（默认90秒）。但是<code>当网络分区故障发生(延时、卡顿、拥挤)时</code>，微服务与EurekaServer之间无法正常通信，以上行为可能变得非常危险了——因为微服务本身其实是健康的，<strong>此时本不应该注销这个微服务</strong>。Eureka通过“自我保护模式”来解决这个问题——当EurekaServer节点在短时间内丢失过多客户端时（可能发生了网络分区故障），那么这个节点就会进入自我保护模式。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110839.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110839.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110839.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110839.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110839.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018110839.png" /></p>
<p><strong>在自我保护模式中，EurekaServer会保护服务注册表中的信息，不再注销任何服务实例。</strong></p>
<p>它的设计哲学就是宁可保留错误的服务注册信息，也不盲目注销任何可能健康的服务实例。<strong>一句话讲解：好死不如赖活着</strong></p>
<p>综上，自我保护模式是一种应对网络异常的安全保护措施。它的架构哲学是宁可同时保留所有微服务（健康的微服务和不健康的微服务都会保留）也不盲目注销任何健康的微服务。使用自我保护模式，可以让Eureka集群更加的健壮、稳定。</p>
<p><code>一句话：某时刻某一个微服务不可用了，Eureka不会立刻清理，依旧会对该微服务的信息进行保存</code></p>
<h3 id="463怎么禁止自我保护">4.6.3、怎么禁止自我保护</h3>
<h4 id="4631修改注册中心eureakeserver端7001">4.6.3.1、修改注册中心eureakeServer端7001</h4>
<p>1、出厂默认，自我保护机制是开启的<code>eureka.server.enable-self-preservation=true</code></p>
<p>2、使用<code>eureka.server.enable-self-preservation = false</code> 可以禁用自我保护模式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">7001</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l">eureka7001.com</span><span class="w"> </span><span class="c">#eureka服务端的实例名称</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">     </span><span class="c">#false表示不向注册中心注册自己。</span><span class="w">
</span><span class="w">    </span><span class="nt">fetch-registry</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">     </span><span class="c">#false表示自己端就是注册中心，我的职责就是维护服务实例，并不需要去检索服务</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c">#defaultZone: http://eureka7002.com:7002/eureka/</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001.com:7001/eureka</span><span class="w">
</span><span class="w">  </span><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#关闭自我保护机制，保证不可用服务被及时踢除</span><span class="w">
</span><span class="w">    </span><span class="nt">enable-self-preservation</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="nt">eviction-interval-timer-in-ms</span><span class="p">:</span><span class="w"> </span><span class="m">2000</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>3、关闭效果</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018112826.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018112826.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018112826.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018112826.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018112826.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018112826.png" /></p>
<h4 id="4632修改生产者客户端eureakeclient端8001">4.6.3.2、修改生产者客户端eureakeClient端8001</h4>
<p>1、默认设置
<code>eureka.instance.lease-renewal-interval-in-seconds=30</code>单位为秒(默认是30秒)
<code>eureka.instance.lease-expiration-duration-in-seconds=90</code>单位为秒(默认是90秒)</p>
<p>2、配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-payment-service</span><span class="w">
</span><span class="w"> </span><span class="nt">datasource</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">com.alibaba.druid.pool.DruidDataSource           </span><span class="w"> </span><span class="c"># 当前数据源操作类型</span><span class="w">
</span><span class="w">   </span><span class="nt">driver-class-name</span><span class="p">:</span><span class="w"> </span><span class="l">org.gjt.mm.mysql.Driver             </span><span class="w"> </span><span class="c"># mysql驱动包 com.mysql.jdbc.Driver</span><span class="w">
</span><span class="w">   </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l">jdbc:mysql://localhost:3306/springcloud?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span><span class="w">
</span><span class="w">   </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l">root</span><span class="w">
</span><span class="w">   </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l">xn123456</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="c">#表示是否将自己注册进EurekaServer默认为true。</span><span class="w">
</span><span class="w">   </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">   </span><span class="c">#是否从EurekaServer抓取已有的注册信息，默认为true。单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span><span class="w">
</span><span class="w">   </span><span class="nt">fetchRegistry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">   </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">     </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://localhost:7001/eureka</span><span class="w"> </span><span class="c"># 单机版</span><span class="w">
</span><span class="w">     </span><span class="c">#defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka  # 集群版</span><span class="w">
</span><span class="w"> </span><span class="c">#心跳检测与续约时间</span><span class="w">
</span><span class="w"> </span><span class="c">#开发时设置小些，保证服务关闭后注册中心能及时剔除服务</span><span class="w">
</span><span class="w"> </span><span class="nt">instance</span><span class="p">:</span><span class="w">
</span><span class="w">   </span><span class="nt">instance-id</span><span class="p">:</span><span class="w"> </span><span class="l">payment8001</span><span class="w">
</span><span class="w">   </span><span class="nt">prefer-ip-address</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">     </span><span class="c">#访问路径可以显示IP地址</span><span class="w">
</span><span class="w">   </span><span class="c">#Eureka客户端向服务端发送心跳的时间间隔，单位为秒(默认是30秒)</span><span class="w">
</span><span class="w">   </span><span class="nt">lease-renewal-interval-in-seconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">   </span><span class="c">#Eureka服务端在收到最后一次心跳后等待时间上限，单位为秒(默认是90秒)，超时将剔除服务</span><span class="w">
</span><span class="w">   </span><span class="nt">lease-expiration-duration-in-seconds</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">mybatis</span><span class="p">:</span><span class="w">
</span><span class="w"> </span><span class="nt">mapperLocations</span><span class="p">:</span><span class="w"> </span><span class="l">classpath:mapper/*.xml</span><span class="w">
</span><span class="w"> </span><span class="nt">type-aliases-package</span><span class="p">:</span><span class="w"> </span><span class="l">com.clover.springcloud.entities   </span><span class="w"> </span><span class="c"># 所有Entity别名类所在包</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>3、测试</p>
<ul>
<li>7001和8001都配置完成</li>
<li>先启动7001再启动8001</li>
<li>先关闭8001，马上就被删除了</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018113352.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018113352.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018113352.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018113352.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018113352.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018113352.png" /></p>
<h1 id="5zookeeper服务注册与发现">5、Zookeeper服务注册与发现</h1>
<h2 id="51springcloud整合zookeeper代替eureka">5.1、SpringCloud整合Zookeeper代替Eureka</h2>
<h3 id="511注册中心zookeeper">5.1.1、注册中心Zookeeper</h3>
<ul>
<li>zookeeper是一个分布式协调工具，可以实现注册中心功能</li>
<li>关闭Linux服务器防火墙后启动zookeeper服务器</li>
<li>zookeeper服务器取代Eureka服务器，zk作为服务注册中心</li>
</ul>
<h3 id="512服务提供者">5.1.2、服务提供者</h3>
<p>1、新建cloud-provider-payment8004</p>
<p>2、修改POM</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- SpringBoot整合Web组件 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span><span class="c">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- SpringBoot整合zookeeper客户端 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-devtools<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>runtime<span class="nt">&lt;/scope&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>3、编写YML</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="c">#8004表示注册到zookeeper服务器的支付服务提供者端口号</span><span class="w">
</span><span class="w"></span><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8004</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c">#服务别名----注册zookeeper到注册中心名称</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-provider-payment</span><span class="w">
</span><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">zookeeper</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">connect-string</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.167.48</span><span class="p">:</span><span class="m">2181</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>4、创建主启动类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableDiscoveryClient</span> <span class="c1">//该注解用于向使用consul或者zookeeper作为注册中心时注册服务
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentMain8004</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaymentMain8004</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>5、编写Controller</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentController</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${server.port}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverPort</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/zk&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentzk</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="s">&#34;springcloud with zookeeper:&#34;</span> <span class="o">+</span> <span class="n">serverPort</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>6、启动8004注册进zookeeper</p>
<ul>
<li>启动后问题
<ul>
<li>成功关闭了Linux防火墙时出现的问题
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018163705.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018163705.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018163705.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018163705.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018163705.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018163705.png" /></li>
<li>如果你没有关闭防火墙就运行，会出现该报错
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161906.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161906.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161906.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161906.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161906.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161906.png" /></li>
</ul>
</li>
</ul>
<p>7、why？</p>
<ul>
<li>解决zookeeper版本jar包冲突问题
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161954.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161954.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161954.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161954.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161954.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018161954.png" /></li>
<li>排出zk冲突后的新POM</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>cloud-provider-payment8004<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- SpringBoot整合Web组件 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span><span class="c">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- SpringBoot整合zookeeper客户端 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="nt">&lt;/artifactId&gt;</span>
            <span class="c">&lt;!--先排除自带的zookeeper3.5.3--&gt;</span>
            <span class="nt">&lt;exclusions&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.apache.zookeeper<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>zookeeper<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
            <span class="nt">&lt;/exclusions&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--添加zookeeper3.4.9版本--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.zookeeper<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>zookeeper<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.4.9<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>8、验证测试1：http://localhost:8004/payment/zk</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164421.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164421.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164421.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164421.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164421.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164421.png" /></p>
<p>9、验证测试2：</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164305.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164305.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164305.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164305.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164305.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164305.png" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164355.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164355.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164355.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164355.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164355.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018164355.png" /></p>
<pre><code>注意：如果你运行的时候出现该错误，说明你没有关闭Linux上的防火墙导致的
</code></pre>
<p><a href="https://blog.csdn.net/zjy15203167987/article/details/79029934" target="_blank" rel="noopener noreffer">参考博客</a></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018162922.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018162922.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018162922.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018162922.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018162922.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018162922.png" /></p>
<p>10、思考：<code>服务节点是临时节点还是持久节点？</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018170107.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018170107.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018170107.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018170107.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018170107.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018170107.png" /></p>
<pre><code>说明这是一个临时结点，当你关闭了提供者后，zookeeper会保留一段时间后，在去除，而当你在启动提供者时，
它会生成一个新的序列号
</code></pre>
<h3 id="513服务消费者">5.1.3、服务消费者</h3>
<p>1、新建cloud-consumerzk-order80</p>
<p>2、修改POM</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>cloud-consumerzk-order80<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!-- SpringBoot整合Web组件 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span><span class="c">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- SpringBoot整合zookeeper客户端 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-zookeeper-discovery<span class="nt">&lt;/artifactId&gt;</span>
            <span class="c">&lt;!--先排除自带的zookeeper--&gt;</span>
            <span class="nt">&lt;exclusions&gt;</span>
                <span class="nt">&lt;exclusion&gt;</span>
                    <span class="nt">&lt;groupId&gt;</span>org.apache.zookeeper<span class="nt">&lt;/groupId&gt;</span>
                    <span class="nt">&lt;artifactId&gt;</span>zookeeper<span class="nt">&lt;/artifactId&gt;</span>
                <span class="nt">&lt;/exclusion&gt;</span>
            <span class="nt">&lt;/exclusions&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--添加zookeeper3.4.9版本--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.zookeeper<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>zookeeper<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.4.9<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>3、修改YML</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-consumer-order</span><span class="w">
</span><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#注册到zookeeper地址</span><span class="w">
</span><span class="w">    </span><span class="nt">zookeeper</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">connect-string</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.167.48</span><span class="p">:</span><span class="m">2181</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>4、编写主启动类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableDiscoveryClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderZKMain80</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">OrderZKMain80</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>5、编写业务类</p>
<ul>
<li>配置Bean</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.loadbalancer.LoadBalanced</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApplicationContextConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="nd">@LoadBalanced</span>
    <span class="kd">public</span> <span class="n">RestTemplate</span> <span class="nf">getRestTemplate</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">RestTemplate</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Controller</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderZKController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">INVOKE_URL</span> <span class="o">=</span> <span class="s">&#34;http://cloud-provider-payment&#34;</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">RestTemplate</span> <span class="n">restTemplate</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/consumer/payment/zk&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="n">INVOKE_URL</span> <span class="o">+</span> <span class="s">&#34;/payment/zk&#34;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;消费者调用支付服务(zookeeper)---&gt;result:&#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>6、验证测试</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172445.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172445.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172445.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172445.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172445.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172445.png" /></p>
<p>7、访问测试地址</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172512.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172512.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172512.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172512.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172512.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018172512.png" /></p>
<h1 id="6consul服务注册与发现">6、Consul服务注册与发现</h1>
<h2 id="61consul简介">6.1、Consul简介</h2>
<ol>
<li>Consul是什么？
<a href="https://www.consul.io/intro/index.html" target="_blank" rel="noopener noreffer">官网</a></li>
<li>Consul能干嘛？
<ul>
<li>服务发现：提供HTTP和DNS两种发现方式。</li>
<li>健康监测：支持多种方式，HTTP、TCP、Docker、Shell脚本定制化监控</li>
<li>KV存储：Key、Value的存储方式</li>
<li>多数据中心：Consul支持多数据中心</li>
<li>可视化Web界面</li>
</ul>
</li>
<li>Consul去哪下？
<a href="https://www.consul.io/downloads.html" target="_blank" rel="noopener noreffer">下载地址</a></li>
<li>Consul怎么玩？
<a href="https://www.springcloud.cc/spring-cloud-consul.html" target="_blank" rel="noopener noreffer">Consul中文文档</a></li>
</ol>
<h2 id="62安装并运行consul">6.2、安装并运行Consul</h2>
<p><a href="https://learn.hashicorp.com/consul/getting-started/install.html" target="_blank" rel="noopener noreffer">官网安装说明</a></p>
<p>下载完成后只有一个consul.exe文件，硬盘路径下双击运行，查看版本号信息</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018204826.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018204826.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018204826.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018204826.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018204826.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018204826.png" /></p>
<p>使用开发模式启动</p>
<ul>
<li>consul agent -dev</li>
<li>通过以下地址可以访问Consul的首页：http://localhost:8500</li>
<li>结果页面
<img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018205022.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018205022.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018205022.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018205022.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018205022.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018205022.png" />]</li>
</ul>
<h2 id="63服务提供者">6.3、服务提供者</h2>
<p>1、新建 cloud-providerconsul-payment8006</p>
<p>2、修改POM</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>cloud-providerconsul-payment8006<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--SpringCloud consul-server --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-consul-discovery<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- SpringBoot整合Web组件 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--日常通用jar包配置--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>3、编写YML</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="c">###consul服务端口号</span><span class="w">
</span><span class="w"></span><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8006</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">consul-provider-payment</span><span class="w">
</span><span class="w">  </span><span class="c">####consul注册中心地址</span><span class="w">
</span><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">consul</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8500</span><span class="w">
</span><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c">#hostname: 127.0.0.1</span><span class="w">
</span><span class="w">        </span><span class="nt">service-name</span><span class="p">:</span><span class="w"> </span><span class="l">${spring.application.name}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>4、编写主启动类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableDiscoveryClient</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentMain8006</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaymentMain8006</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>5、编写Controller</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.UUID</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentController</span> <span class="o">{</span>
    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${server.port}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverPort</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/payment/consul&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="s">&#34;springcloud with consul: &#34;</span><span class="o">+</span><span class="n">serverPort</span><span class="o">+</span><span class="s">&#34;\t\t&#34;</span><span class="o">+</span> <span class="n">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>6、验证测试：http://localhost:8006/payment/consul</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018212259.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018212259.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018212259.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018212259.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018212259.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018212259.png" /></p>
<h2 id="64服务消费者">6.4、服务消费者</h2>
<p>1、新建 cloud-consumerconsul-order80</p>
<p>2、修改POM</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>cloud-consumerconsul-order80<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--SpringCloud consul-server --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-consul-discovery<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- SpringBoot整合Web组件 --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>3、编写YML</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="c">###consul服务端口号</span><span class="w">
</span><span class="w"></span><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">consul-consumer-order</span><span class="w">
</span><span class="w">  </span><span class="c">####consul注册中心地址</span><span class="w">
</span><span class="w">  </span><span class="nt">cloud</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">consul</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">localhost</span><span class="w">
</span><span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8500</span><span class="w">
</span><span class="w">      </span><span class="nt">discovery</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c">#hostname: 127.0.0.1</span><span class="w">
</span><span class="w">        </span><span class="nt">service-name</span><span class="p">:</span><span class="w"> </span><span class="l">${spring.application.name}</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>4、编写主启动类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableDiscoveryClient</span> <span class="c1">//该注解用于向使用consul或者zookeeper作为注册中心时注册服务
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderConsulMain80</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">OrderConsulMain80</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>5、配置Bean</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.loadbalancer.LoadBalanced</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ApplicationContextConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="nd">@LoadBalanced</span>
    <span class="kd">public</span> <span class="n">RestTemplate</span> <span class="nf">getRestTemplate</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">RestTemplate</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>6、编写Controller</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderConsulController</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">INVOKE_URL</span> <span class="o">=</span> <span class="s">&#34;http://consul-provider-payment&#34;</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">RestTemplate</span> <span class="n">restTemplate</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/consumer/payment/consul&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="n">INVOKE_URL</span> <span class="o">+</span> <span class="s">&#34;/payment/consul&#34;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;消费者调用支付服务(consul)---&gt;result:&#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>7、验证测试</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213820.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213820.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213820.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213820.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213820.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213820.png" /></p>
<p>8、访问测试地址：http://localhost/consumer/payment/consul</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213847.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213847.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213847.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213847.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213847.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018213847.png" /></p>
<h2 id="65三个注册中心异同点">6.5、三个注册中心异同点</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215113.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215113.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215113.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215113.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215113.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215113.png" /></p>
<p>１、CAP</p>
<ul>
<li><strong>C:Consistency（强一致性）</strong></li>
<li><strong>A:Availability（可用性）</strong></li>
<li><strong>P:Partition tolerance（分区容错性）</strong></li>
<li>CAP理论关注粒度是数据，而不是整体系统设计的策略</li>
</ul>
<p>２、经典CAP图</p>
<p><strong>最多只能同时较好的满足两个。</strong></p>
<p>CAP理论的核心是：<code>一个分布式系统不可能同时很好的满足一致性，可用性和分区容错性这三个需求，</code></p>
<p>因此，根据 CAP 原理将 NoSQL 数据库分成了满足 CA 原则、满足 CP 原则和满足 AP 原则</p>
<p>三大类：</p>
<ul>
<li>CA - 单点集群，满足一致性，可用性的系统，通常在可扩展性上不太强大。</li>
<li>CP -  满足一致性，分区容忍必的系统，通常性能不是特别高。</li>
<li>AP -  满足可用性，分区容忍性的系统，通常可能对一致性要求低一些。</li>
</ul>
<ol>
<li>
<p><strong>AP(Eureka)</strong></p>
<ul>
<li>AP架构</li>
</ul>
<p>当网络分区出现后，为了保证可用性，系统B<strong>可以返回旧值</strong>，保证系统的可用性。</p>
<pre><code> 结论：违背了一致性C的要求，只满足可用性和分区容错，即AP
</code></pre>
</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018220001.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018220001.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018220001.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018220001.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018220001.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018220001.png" /></p>
<ol start="2">
<li>
<p><strong>CP(Zookeeper/Consul)</strong></p>
<ul>
<li>CP架构</li>
</ul>
<p>当网络分区出现后，为了保证一致性，就必须拒接请求，否则无法保证一致性</p>
<pre><code> 结论：违背了可用性A的要求，只满足一致性和分区容错，即CP
</code></pre>
</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215844.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215844.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215844.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215844.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215844.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211018215844.png" /></p>
<h1 id="7ribbon负载均衡服务调用">7、Ribbon负载均衡服务调用</h1>
<h2 id="71概述">7.1、概述</h2>
<ol>
<li>
<p>Ribbon是什么？</p>
<ul>
<li>SpringCloud Ribbon是基于Netflix Ribbon实现的<strong>一套客户端</strong>       <strong>负载均衡的工具</strong>。</li>
<li>简单的说，Ribbon是Netflix发布的开源项目，主要功能是提供<strong>客户端的软件负载均衡算法和服务调用</strong>。Ribbon客户端组件提供一系列完善的配置项如连接超时，重试等。简单的说，就是在配置文件中列出<code>LoadBalancer（简称LB）</code>后面所有的机器，Ribbon会自动的帮助你基于某种规则（如简单轮询，随机连接等）去连接这些机器。我们很容易使用Ribbon实现自定义的负载均衡算法</li>
</ul>
</li>
<li>
<p>官网资料</p>
<p><a href="https://github.com/Netflix/ribbon/wiki/Getting-Started" target="_blank" rel="noopener noreffer">官方资料</a></p>
<p>Ribbon目前也进入维护模式</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102224.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102224.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102224.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102224.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102224.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102224.png" /></p>
<p>未来替换方案</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102313.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102313.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102313.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102313.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102313.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019102313.png" /></p>
</li>
<li>
<p>能干吗？</p>
<ul>
<li>LB(负载均衡)
<ul>
<li>集中式LB
<ul>
<li>即在服务的消费方和提供方之间使用独立的LB设施(可以是硬件，如F5, 也可以是软件，如nginx), 由该设施负责把访问请求通过某种策略转发至服务的提供方</li>
</ul>
</li>
<li>进程内LB
<ul>
<li>将LB逻辑集成到消费方，消费方从服务注册中心获知有哪些地址可用，然后自己再从这些地址中选择出一个合适的服务器</li>
<li><strong>Ribbon就属于进程内LB</strong>，它只是一个类库，<strong>集成于消费方进程</strong>，消费方通过它来获取到服务提供方的地址</li>
</ul>
</li>
</ul>
</li>
<li>前面我们讲解过了80通过轮询负载访问8001/8002</li>
<li>一句话：<strong>负载均衡+RestTemplate调用</strong></li>
</ul>
</li>
</ol>
<p><strong>LB负载均衡(Load Balance)是什么</strong></p>
<p>简单的说就是将用户的请求平摊的分配到多个服务上，从而达到系统的HA（高可用）。
常见的负载均衡有软件Nginx，LVS，硬件 F5等。</p>
<p><strong>Ribbon本地负载均衡客户端 VS Nginx服务端负载均衡区别</strong></p>
<p>Nginx是服务器负载均衡，客户端所有请求都会交给nginx，然后由nginx实现转发请求。即负载均衡是由服务端实现的。</p>
<p>Ribbon本地负载均衡，在调用微服务接口时候，会在注册中心上获取注册信息服务列表之后缓存到JVM本地，从而在本地实现RPC远程服务调用技术。</p>
<h2 id="72ribbon负载均衡演示">7.2、Ribbon负载均衡演示</h2>
<h3 id="721架构说明">7.2.1、架构说明</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104119.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104119.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104119.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104119.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104119.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104119.png" /></p>
<p>Ribbon在工作时分成两步</p>
<ul>
<li>第一步先选择 EurekaServer ,它优先选择在同一个区域内负载较少的server.</li>
<li>第二步再根据用户指定的策略，在从server取到的服务注册列表中选择一个地址。</li>
</ul>
<p>其中Ribbon提供了多种策略：比如轮询、随机和根据响应时间加权。</p>
<p><code>总结</code>：<strong>Ribbon其实就是一个软负载均衡的客户端组件，他可以和其他所需请求的客户端结合使用，和
eureka结合只是其中的一个实例。</strong></p>
<h3 id="722pom">7.2.2、POM</h3>
<p>之前写<code>cloud-consumer-order80</code>样例时候没有引入spring-cloud-starter-ribbon也可以使用ribbon</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-ribbon<span class="nt">&lt;/artifactId&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>猜测spring-cloud-starter-netflix-eureka-client自带了spring-cloud-starter-ribbon引用，</p>
<p>证明如下： <code>可以看到spring-cloud-starter-netflix-eureka-client 确实引入了Ribbon</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104718.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104718.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104718.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104718.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104718.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019104718.png" /></p>
<h3 id="723二说resttemplate的使用">7.2.3、二说RestTemplate的使用</h3>
<p><a href="https://docs.spring.io/spring-framework/docs/5.2.2.RELEASE/javadoc-api/org/springframework/web/client/RestTemplate.html" target="_blank" rel="noopener noreffer">官网</a></p>
<h4 id="7231getforobject方法getforentity方法">7.2.3.1、getForObject方法/getForEntity方法</h4>
<p><strong>返回对象为响应体中数据转化成的对象，基本上可以理解为Json</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019105055.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019105055.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019105055.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019105055.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019105055.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019105055.png" /></p>
<p><strong>返回对象为ResponseEntity对象，包含了响应中的一些重要信息，比如响应头，状态码、响应体等</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110324.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110324.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110324.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110324.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110324.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110324.png" /></p>
<h4 id="7232postforobjectpostforentity方法">7.2.3.2、postForObject/postForEntity方法</h4>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110504.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110504.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110504.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110504.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110504.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110504.png" /></p>
<h2 id="73ribbon核心组件irule">7.3、Ribbon核心组件IRule</h2>
<h3 id="731irule根据特定算法中从服务列表中选取一个要访问的服务">7.3.1、IRule：根据特定算法中从服务列表中选取一个要访问的服务</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110952.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110952.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110952.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110952.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110952.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019110952.png" /></p>
<p><code>com.netflix.loadbalancer.RoundRobinRule</code>：<strong>轮询</strong></p>
<p><code>com.netflix.loadbalancer.RandomRule</code>：<strong>随机</strong></p>
<p><code>com.netflix.loadbalancer.RetryRule</code>：<strong>先按照RoundRobinRule的策略获取服务，如果获取服务失败则在指定时间内会进行重试，获取可用的服务</strong></p>
<p><code>WeightedResponseTimeRule</code>：<strong>对RoundRobinRule的扩展，响应速度越快的实例选择权重越大，越容易被选择</strong></p>
<p><code>BestAvailableRule</code>：<strong>会先过滤掉由于多次访问故障而处于断路器跳闸状态的服务，然后选择一个并发量最小的服务</strong></p>
<p><code>AvailabilityFilteringRule</code>：<strong>先过滤掉故障实例，再选择并发较小的实例</strong></p>
<p><code>ZoneAvoidanceRule</code>：<strong>默认规则,复合判断server所在区域的性能和server的可用性选择服务器</strong></p>
<h3 id="732如何替换">7.3.2、如何替换</h3>
<p>1、修改cloud-consumer-order80</p>
<p>2、注意配置细节</p>
<p><strong>官方文档明确给出了警告：</strong></p>
<ul>
<li>这个自定义配置类不能放在<code>@ComponentScan所扫描的当前包下以及子包下</code>，</li>
<li>否则我们自定义的这个配置类就会被所有的Ribbon客户端所共享，达不到特殊化定制的目的了。</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019111846.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019111846.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019111846.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019111846.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019111846.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019111846.png" /></p>
<p>3、新建package ：com.clover.myrule</p>
<p>4、上面包下新建MySelfRule规则类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.myrule</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.netflix.loadbalancer.IRule</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.netflix.loadbalancer.RandomRule</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MySelfRule</span>
<span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">IRule</span> <span class="nf">myRule</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">RandomRule</span><span class="o">();</span><span class="c1">//定义为随机
</span><span class="c1"></span>    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>5、<strong>主启动类添加@RibbonClient</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.myrule.MySelfRule</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.EnableDiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.ribbon.RibbonClient</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span>
<span class="nd">@EnableDiscoveryClient</span>
<span class="nd">@RibbonClient</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;CLOUD-PAYMENT-SERVICE&#34;</span><span class="o">,</span><span class="n">configuration</span><span class="o">=</span> <span class="n">MySelfRule</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentMain8001</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaymentMain8001</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>6、测试：http://localhost/consumer/payment/get/1</p>
<h2 id="74ribbon负载均衡算法">7.4、Ribbon负载均衡算法</h2>
<h3 id="741原理">7.4.1、原理</h3>
<p>负载均衡算法：</p>
<pre><code>rest接口第几次请求数 % 服务器集群总数量 = 实际调用服务器位置下标  ，每次服务重启动后rest接口计数从1开始。
</code></pre>
<p>List&lt;&gt; instances = discoveryClient.getInstances(&ldquo;CLOUD-PAYMENT-SERVICE&rdquo;);</p>
<p>如：<br>
List [0] instances = 127.0.0.1:8002
　List [1] instances = 127.0.0.1:8001</p>
<p>8001+ 8002 组合成为集群，它们共计2台机器，集群总数为2， 按照轮询算法原理：</p>
<p>当总请求数为1时： 1 % 2 =1 对应下标位置为1 ，则获得服务地址为127.0.0.1:8001</p>
<p>当总请求数位2时： 2 % 2 =0 对应下标位置为0 ，则获得服务地址为127.0.0.1:8002</p>
<p>当总请求数位3时： 3 % 2 =1 对应下标位置为1 ，则获得服务地址为127.0.0.1:8001</p>
<p>当总请求数位4时： 4 % 2 =0 对应下标位置为0 ，则获得服务地址为127.0.0.1:8002</p>
<p>如此类推&hellip;&hellip;</p>
<h3 id="742手写一个本地负载均衡器">7.4.2、手写一个本地负载均衡器</h3>
<p>1、先启动7001/7002集群</p>
<p>2、8001/8002微服务改造</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.ServiceInstance</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.DiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentController</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">public</span> <span class="n">PaymentService</span> <span class="n">paymentService</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${server.port}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverPort</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">DiscoveryClient</span> <span class="n">discoveryClient</span><span class="o">;</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/create&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">Payment</span> <span class="n">payment</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">payment</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********插入操作结果：&#34;</span><span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;插入数据成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;插入数据失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">Payment</span> <span class="n">payment</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">getPaymentById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********查询结果：&#34;</span><span class="o">+</span> <span class="n">payment</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">payment</span> <span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;查询成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">payment</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;查询失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/discovery&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">discovery</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="c1">// 用于查询Eureka上有几个服务
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">services</span> <span class="o">=</span> <span class="n">discoveryClient</span><span class="o">.</span><span class="na">getServices</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">element</span><span class="o">:</span> <span class="n">services</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;***************element:&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// 用于查询某一个名称下的实例
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceInstance</span><span class="o">&gt;</span> <span class="n">instances</span> <span class="o">=</span> <span class="n">discoveryClient</span><span class="o">.</span><span class="na">getInstances</span><span class="o">(</span><span class="s">&#34;CLOUD-PAYMENT-SERVICE&#34;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ServiceInstance</span> <span class="n">element</span><span class="o">:</span> <span class="n">instances</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="na">getServiceId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="na">getHost</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="na">getPort</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="na">getUri</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">discoveryClient</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/lb&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPaymentLB</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">serverPort</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentController</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">public</span> <span class="n">PaymentService</span> <span class="n">paymentService</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${server.port}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverPort</span><span class="o">;</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/create&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">Payment</span> <span class="n">payment</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">payment</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********插入操作结果：&#34;</span><span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;插入数据成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;插入数据失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">Payment</span> <span class="n">payment</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">getPaymentById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********查询结果：&#34;</span><span class="o">+</span> <span class="n">payment</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">payment</span> <span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;查询成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">payment</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;查询失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/lb&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPaymentLB</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">serverPort</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>3、80订单微服务改造</p>
<ol>
<li>ApplicationContextBean 去掉<code>注解@LoadBalanced</code></li>
<li>编写<code> LoadBalancer 接口</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">com</span><span class="p">.</span><span class="nx">clover</span><span class="p">.</span><span class="nx">springcloud</span><span class="p">.</span><span class="nx">lb</span><span class="p">;</span>

<span class="kn">import</span> <span class="nx">org</span><span class="p">.</span><span class="nx">springframework</span><span class="p">.</span><span class="nx">cloud</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">ServiceInstance</span><span class="p">;</span>

<span class="kn">import</span> <span class="nx">java</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">List</span><span class="p">;</span>

<span class="nx">public</span> <span class="kd">interface</span> <span class="nx">LoadBalancer</span> <span class="p">{</span>
    <span class="nx">ServiceInstance</span> <span class="nf">instences</span><span class="p">(</span><span class="nx">List</span><span class="p">&lt;</span><span class="nx">ServiceInstance</span><span class="p">&gt;</span> <span class="nx">serviceInstances</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>实现 LoadBalancer 接口的实现类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.lb</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.ServiceInstance</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.atomic.AtomicInteger</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyLB</span> <span class="kd">implements</span> <span class="n">LoadBalancer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">getAndIncrement</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="kt">int</span> <span class="n">current</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">next</span><span class="o">;</span>

        <span class="cm">/*
</span><span class="cm">         * CAS是Compare And Set的一个简称，如下理解
</span><span class="cm">         * 1、一致当前内存里面的值current和预期要修改成的值next传入
</span><span class="cm">         * 2、内存中 AtomicInteger 对象地址对应的真实值(因为有可能被修改)real与current对比，
</span><span class="cm">         *    相等标识real违被修改过，是&#34;安全&#34;的，将next赋给real结束然后返回
</span><span class="cm">         *    不相等说明real以及被修改，结束并重新执行1知道修改成功
</span><span class="cm">         * CAS相比 Synchronized，避免了锁的使用，总体性能比 Synchronized 高很多
</span><span class="cm">         */</span>
        <span class="k">do</span><span class="o">{</span>
            <span class="c1">// 获取当前值
</span><span class="c1"></span>            <span class="n">current</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">atomicInteger</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
            <span class="c1">// 设置期望值
</span><span class="c1"></span>            <span class="n">next</span> <span class="o">=</span> <span class="n">current</span> <span class="o">&gt;=</span> <span class="n">2147483647</span> <span class="o">?</span> <span class="n">0</span> <span class="o">:</span> <span class="n">current</span> <span class="o">+</span> <span class="n">1</span><span class="o">;</span>
        <span class="o">}</span><span class="k">while</span> <span class="o">(!</span><span class="k">this</span><span class="o">.</span><span class="na">atomicInteger</span><span class="o">.</span><span class="na">compareAndSet</span><span class="o">(</span><span class="n">current</span><span class="o">,</span><span class="n">next</span><span class="o">));</span><span class="c1">//调用Native方法compareAndSet，执行CAS操作
</span><span class="c1"></span>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;************第几次出现：next&#34;</span> <span class="o">+</span> <span class="n">next</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">next</span><span class="o">;</span>
    <span class="o">}</span>



    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">ServiceInstance</span> <span class="nf">instences</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceInstance</span><span class="o">&gt;</span> <span class="n">serviceInstances</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">getAndIncrement</span><span class="o">()</span> <span class="o">%</span> <span class="n">serviceInstances</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">serviceInstances</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>修改 OrderController</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.lb.LoadBalancer</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.ServiceInstance</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.DiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.http.ResponseEntity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.client.RestTemplate</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.URI</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderController</span> <span class="o">{</span>
    <span class="c1">//public static final String Payment_URL = &#34;http://localhost:8001&#34;;
</span><span class="c1"></span>
    <span class="c1">// 通过在eureka上注册过的微服务名称调用
</span><span class="c1"></span>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">Payment_URL</span> <span class="o">=</span> <span class="s">&#34;http://CLOUD-PAYMENT-SERVICE&#34;</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">RestTemplate</span> <span class="n">restTemplate</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">DiscoveryClient</span> <span class="n">discoveryClient</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">LoadBalancer</span> <span class="n">loadBalancer</span><span class="o">;</span>

    <span class="c1">//客户端用浏览器是get请求，但是底层实质发送post调用服务端8001
</span><span class="c1"></span>    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/consumer/payment/create&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">create</span><span class="o">(</span><span class="n">Payment</span> <span class="n">payment</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">postForObject</span><span class="o">(</span><span class="n">Payment_URL</span> <span class="o">+</span> <span class="s">&#34;/payment/create&#34;</span><span class="o">,</span><span class="n">payment</span><span class="o">,</span><span class="n">CommonResult</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// return restTemplate.postForEntity(Payment_URL + &#34;/payment/create&#34;,payment,CommonResult.class).getBody();
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/consumer/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="n">Payment_URL</span> <span class="o">+</span> <span class="s">&#34;/payment/get/&#34;</span> <span class="o">+</span> <span class="n">id</span><span class="o">,</span><span class="n">CommonResult</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/consumer/payment/getForEntity/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">getPayment</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">CommonResult</span><span class="o">&gt;</span> <span class="n">entity</span> <span class="o">=</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForEntity</span><span class="o">(</span><span class="n">Payment_URL</span> <span class="o">+</span> <span class="s">&#34;/payment/get/&#34;</span> <span class="o">+</span> <span class="n">id</span><span class="o">,</span> <span class="n">CommonResult</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;-----------------&#34;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">entity</span><span class="o">.</span><span class="na">getHeaders</span><span class="o">());</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">entity</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>
        <span class="k">if</span><span class="o">(</span><span class="n">entity</span><span class="o">.</span><span class="na">getStatusCode</span><span class="o">().</span><span class="na">is2xxSuccessful</span><span class="o">()){</span>
            <span class="k">return</span> <span class="n">entity</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">444</span><span class="o">,</span><span class="s">&#34;操作失败&#34;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/consumer/payment/lb&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPaymentLB</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceInstance</span><span class="o">&gt;</span> <span class="n">instances</span> <span class="o">=</span> <span class="n">discoveryClient</span><span class="o">.</span><span class="na">getInstances</span><span class="o">(</span><span class="s">&#34;CLOUD-PAYMENT-SERVICE&#34;</span><span class="o">);</span>

        <span class="k">if</span><span class="o">(</span><span class="n">instances</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">instances</span><span class="o">.</span><span class="na">size</span><span class="o">()&lt;=</span><span class="n">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">ServiceInstance</span> <span class="n">serviceInstance</span> <span class="o">=</span> <span class="n">loadBalancer</span><span class="o">.</span><span class="na">instences</span><span class="o">(</span><span class="n">instances</span><span class="o">);</span>
        <span class="n">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">serviceInstance</span><span class="o">.</span><span class="na">getUri</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">restTemplate</span><span class="o">.</span><span class="na">getForObject</span><span class="o">(</span><span class="n">uri</span><span class="o">+</span><span class="s">&#34;/payment/lb&#34;</span><span class="o">,</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>
<p>测试：http://localhost/consumer/payment/lb</p>
<pre><code> 注意：在这个手写负载均衡中使用到了一个方法CompareAndSet，这个是AtomicInteger类compareAndSet
 AtomicInteger类compareAndSet通过原子操作实现了CAS操作，最底层基于汇编语言实现
 CAS是Compare And Set的一个简称，如下理解：
 1，已知当前内存里面的值current和预期要修改成的值new传入
 2，内存中AtomicInteger对象地址对应的真实值(因为有可能别修改)real与current对比，
 相等表示real未被修改过，是“安全”的，将new赋给real结束然后返回；
 不相等说明real已经被修改，结束并重新执行1直到修改成功
</code></pre>
</li>
</ol>
<p> </p>
<h1 id="8openfeign服务接口调用">8、OpenFeign服务接口调用</h1>
<h2 id="81概述">8.1、概述</h2>
<h3 id="811openfeign是什么">8.1.1、OpenFeign是什么？</h3>
<ol>
<li>Feign是一个声明式的Web服务客户端，让编写Web服务客户端变得非常容易，<strong>只需创建一个接口并在接口上添加注解即可</strong></li>
<li><a href="https://github.com/spring-cloud/spring-cloud-openfeign" target="_blank" rel="noopener noreffer">源码地址</a></li>
</ol>
<p><a href="https://cloud.spring.io/spring-cloud-static/Hoxton.SR1/reference/htmlsingle/#spring-cloud-openfeign" target="_blank" rel="noopener noreffer">官网解释</a></p>
<p>Feign是一个声明式WebService客户端。使用Feign能让编写WebService客户端更加简单。
它的使用方法是<strong>定义一个服务接口然后在上面添加注解</strong>。Feign也支持可拔插式的编码器和解码器。SpringCloud对Feign进行了封装，使其支持了Spring MVC标准注解和HttpMessageConverters。<strong>Feign可以与Eureka和Ribbon组合使用以支持负载均衡</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171123.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171123.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171123.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171123.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171123.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171123.png" /></p>
<h3 id="812能干嘛">8.1.2、能干嘛？</h3>
<p>Feign旨在使编写Java Http客户端变得更容易。</p>
<p>前面在使用Ribbon+RestTemplate时，利用 RestTemplate 对http请求的封装处理，形成了一套模版化的调用方法。但是在实际开发中，由于对服务依赖的调用可能不止一处，<strong>往往一个接口会被多处调用，所以通常都会针对每个微服务自行封装一些客户端类来包装这些依赖服务的调用</strong>。所以，Feign在此基础上做了进一步封装，由他来帮助我们定义和实现依赖服务接口的定义。在Feign的实现下，<strong>我们只需创建一个接口并使用注解的方式来配置它(以前是Dao接口上面标注Mapper注解,现在是一个微服务接口上面标注一个Feign注解即可)</strong>，即可完成对服务提供方的接口绑定，简化了Spring cloud 使用Ribbon时，自动封装服务调用客户端的开发量。</p>
<p><code>Feign集成了Ribbon</code></p>
<p>利用Ribbon维护了Payment的服务列表信息，并且通过轮询实现了客户端的负载均衡。而与Ribbon不同的是，<strong>通过feign只需要定义服务绑定接口且以声明式的方法</strong>，优雅而简单的实现了服务调用</p>
<h3 id="813feign和openfeign两者区别">8.1.3、Feign和OpenFeign两者区别</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171433.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171433.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171433.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171433.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171433.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019171433.png" /></p>
<h2 id="82openfeign使用步骤">8.2、OpenFeign使用步骤</h2>
<p>1、接口 + 注解：<strong>微服务调用接口+@FeignClient</strong></p>
<p>2、新建 cloud-consumer-feign-order80</p>
<ul>
<li>Feign在消费端使用</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019174703.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019174703.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019174703.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019174703.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019174703.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019174703.png" /></p>
<p>3、修改POM</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>cloud-consumer-feign-order80<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--openfeign--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--eureka client--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--web--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>


<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>4、编写主启动类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.openfeign.EnableFeignClients</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableFeignClients</span> <span class="c1">// 开启FeignClients注解的使用
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderFeignMain80</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">OrderFeignMain80</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>5、业务类</p>
<ul>
<li>业务逻辑接口+<strong>@FeignClient配置调用provider服务</strong></li>
<li>新建PaymentFeignService接口并新增注解@FeignClient</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.openfeign.FeignClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>

<span class="nd">@FeignClient</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;CLOUD-PAYMENT-SERVICE&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PaymentFeignService</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>控制层Controller</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentFeignService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderFeignController</span>
<span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">PaymentFeignService</span> <span class="n">paymentFeignService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/consumer/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">paymentFeignService</span><span class="o">.</span><span class="na">getPaymentById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>6、测试</p>
<ul>
<li>先启动2个eureka集群7001/7002</li>
<li>再启动2个微服务8001/8002</li>
<li>启动OpenFeign</li>
<li>http://localhost/consumer/payment/get/1</li>
<li><strong>Feign自带负载均衡配置项</strong></li>
</ul>
<p>7、总结</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019175149.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019175149.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019175149.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019175149.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019175149.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019175149.png" /></p>
<h2 id="83openfeign超时控制">8.3、OpenFeign超时控制</h2>
<h3 id="831超时设置故意设置超时演示出错情况">8.3.1、超时设置，故意设置超时演示出错情况</h3>
<ul>
<li>服务提供方8001故意写暂停程序</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.ServiceInstance</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.client.discovery.DiscoveryClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.*</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentController</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">public</span> <span class="n">PaymentService</span> <span class="n">paymentService</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${server.port}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverPort</span><span class="o">;</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">DiscoveryClient</span> <span class="n">discoveryClient</span><span class="o">;</span>

    <span class="nd">@PostMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/create&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@RequestBody</span> <span class="n">Payment</span> <span class="n">payment</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">payment</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********插入操作结果：&#34;</span><span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">result</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;插入数据成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">result</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;插入数据失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">Payment</span> <span class="n">payment</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">getPaymentById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;********查询结果：&#34;</span><span class="o">+</span> <span class="n">payment</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">payment</span> <span class="o">!=</span><span class="kc">null</span><span class="o">){</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">200</span><span class="o">,</span><span class="s">&#34;查询成功，serverPort：&#34;</span> <span class="o">+</span> <span class="n">serverPort</span><span class="o">,</span><span class="n">payment</span><span class="o">);</span>
        <span class="o">}</span><span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="n">CommonResult</span><span class="o">(</span><span class="n">404</span><span class="o">,</span><span class="s">&#34;查询失败&#34;</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/discovery&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">discovery</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="c1">// 用于查询Eureka上有几个服务
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">services</span> <span class="o">=</span> <span class="n">discoveryClient</span><span class="o">.</span><span class="na">getServices</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">element</span><span class="o">:</span> <span class="n">services</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;***************element:&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="c1">// 用于查询某一个名称下的实例
</span><span class="c1"></span>        <span class="n">List</span><span class="o">&lt;</span><span class="n">ServiceInstance</span><span class="o">&gt;</span> <span class="n">instances</span> <span class="o">=</span> <span class="n">discoveryClient</span><span class="o">.</span><span class="na">getInstances</span><span class="o">(</span><span class="s">&#34;CLOUD-PAYMENT-SERVICE&#34;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">ServiceInstance</span> <span class="n">element</span><span class="o">:</span> <span class="n">instances</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="na">getServiceId</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="na">getHost</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="na">getPort</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;\t&#34;</span> <span class="o">+</span> <span class="n">element</span><span class="o">.</span><span class="na">getUri</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">discoveryClient</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/lb&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getPaymentLB</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">serverPort</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/feign/timeout&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentFeignTimeOut</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&#34;*****paymentFeignTimeOut from port: &#34;</span><span class="o">+</span><span class="n">serverPort</span><span class="o">);</span>
        <span class="c1">//暂停几秒钟线程
</span><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">3</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">serverPort</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>服务消费方80添加超时方法 PaymentFeignService</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.openfeign.FeignClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>

<span class="nd">@FeignClient</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;CLOUD-PAYMENT-SERVICE&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PaymentFeignService</span> <span class="o">{</span>
    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">);</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/feign/timeout&#34;</span><span class="o">)</span>
    <span class="n">String</span> <span class="nf">paymentFeignTimeOut</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>服务消费方80添加超时方法OrderFeignController</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.CommonResult</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.entities.Payment</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentFeignService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderFeignController</span>
<span class="o">{</span>
    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">PaymentFeignService</span> <span class="n">paymentFeignService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/consumer/payment/get/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">CommonResult</span><span class="o">&lt;</span><span class="n">Payment</span><span class="o">&gt;</span> <span class="nf">getPaymentById</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Long</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">paymentFeignService</span><span class="o">.</span><span class="na">getPaymentById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/feign/timeout&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentFeignTimeOut</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">paymentFeignService</span><span class="o">.</span><span class="na">paymentFeignTimeOut</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>测试
<ul>
<li>http://localhost/consumer/payment/feign/timeout</li>
<li>错误页面</li>
</ul>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019182910.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019182910.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019182910.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019182910.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019182910.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019182910.png" /></p>
<h3 id="832openfeign默认等待1秒钟超过后报错">8.3.2、OpenFeign默认等待1秒钟，超过后报错</h3>
<h3 id="833是什么">8.3.3、是什么？</h3>
<p><strong>Feign客户端默认只等待一秒钟</strong>，但是服务端处理需要超过1秒钟，导致Feign客户端不想等待了，直接返回报错。
为了避免这样的情况，有时候我们需要设置Feign客户端的超时控制。</p>
<p>yml文件中开启配置，<code>OpenFeign默认支持Ribbon</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019183128.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019183128.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019183128.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019183128.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019183128.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019183128.png" /></p>
<h3 id="834yml文件里需要开启openfeign客户端超时控制">8.3.4、YML文件里需要开启OpenFeign客户端超时控制</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c">#设置feign客户端超时时间(OpenFeign默认支持ribbon)</span><span class="w">
</span><span class="w"></span><span class="nt">ribbon</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c">#指的是建立连接所用的时间，适用于网络状况正常的情况下,两端连接所用的时间</span><span class="w">
</span><span class="w">  </span><span class="nt">ReadTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span><span class="w">  </span><span class="c">#指的是建立连接后从服务器读取到可用资源所用的时间</span><span class="w">
</span><span class="w">  </span><span class="nt">ConnectTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="84openfeign日志打印功能">8.4、OpenFeign日志打印功能</h2>
<h3 id="841是什么">8.4.1、是什么？</h3>
<p>Feign 提供了日志打印功能，我们可以通过配置来调整日志级别，从而了解 Feign 中 Http 请求的细节。</p>
<p>说白了就是<strong>对Feign接口的调用情况进行监控和输出</strong></p>
<h3 id="842日志级别">8.4.2、日志级别</h3>
<ul>
<li>NONE：默认的，不显示任何日志；</li>
<li>BASIC：仅记录请求方法、URL、响应状态码及执行时间；</li>
<li>HEADERS：除了 BASIC 中定义的信息之外，还有请求和响应的头信息；</li>
<li>FULL：除了 HEADERS 中定义的信息之外，还有请求和响应的正文及元数据。</li>
</ul>
<h3 id="843配置日志bean">8.4.3、配置日志bean</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.config</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">feign.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>


<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FeignConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="n">Logger</span><span class="o">.</span><span class="na">Level</span> <span class="nf">feignLoggerLevel</span><span class="o">()</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">Logger</span><span class="o">.</span><span class="na">Level</span><span class="o">.</span><span class="na">FULL</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="834yml文件里需要开启日志的feign客户端">8.3.4、YML文件里需要开启日志的Feign客户端</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001.com:7001/eureka/,http://eureka7002.com:7002/eureka/</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c">#设置feign客户端超时时间(OpenFeign默认支持ribbon)</span><span class="w">
</span><span class="w"></span><span class="nt">ribbon</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c">#指的是建立连接所用的时间，适用于网络状况正常的情况下,两端连接所用的时间</span><span class="w">
</span><span class="w">  </span><span class="nt">ReadTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span><span class="w">  </span><span class="c">#指的是建立连接后从服务器读取到可用资源所用的时间</span><span class="w">
</span><span class="w">  </span><span class="nt">ConnectTimeout</span><span class="p">:</span><span class="w"> </span><span class="m">5000</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">logging</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># feign日志以什么级别监控哪个接口</span><span class="w">
</span><span class="w">    </span><span class="nt">com.clover.springcloud.service.PaymentFeignService</span><span class="p">:</span><span class="w"> </span><span class="l">debug</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="835后台日志查看">8.3.5、后台日志查看</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019184913.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019184913.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019184913.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019184913.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019184913.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019184913.png" /></p>
<h1 id="9hystrix断路器">9、Hystrix断路器</h1>
<h2 id="91概述">9.1、概述</h2>
<h3 id="911分布式系统面临的问题">9.1.1、分布式系统面临的问题</h3>
<p><strong>复杂分布式体系结构中的应用程序有数十个依赖关系，每个依赖关系在某些时候将不可避免地失败</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019200403.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019200403.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019200403.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019200403.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019200403.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019200403.png" /></p>
<p>服务雪崩</p>
<p>多个微服务之间调用的时候，假设微服务A调用微服务B和微服务C，微服务B和微服务C又调用其它的微服务，这就是所谓的<strong>扇出</strong>。如果扇出的链路上某个微服务的调用响应时间过长或者不可用，对微服务A的调用就会占用越来越多的系统资源，进而引起系统崩溃，所谓的“雪崩效应”.</p>
<p>对于高流量的应用来说，单一的后端依赖可能会导致所有服务器上的所有资源都在几秒钟内饱和。比失败更糟糕的是，这些应用程序还可能导致服务之间的延迟增加，备份队列，线程和其他系统资源紧张，导致整个系统发生更多的级联故障。这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系的失败，不能取消整个应用程序或系统。
所以，通常当你发现一个模块下的某个实例失败后，这时候这个模块依然还会接收流量，然后这个有问题的模块还调用了其他的模块，这样就会<strong>发生级联故障，或者叫雪崩</strong>。</p>
<h3 id="912hystrix是什么">9.1.2、Hystrix是什么？</h3>
<p>Hystrix是一个用于处理分布式系统的<strong>延迟</strong>和<strong>容错</strong>的开源库，在分布式系统里，许多依赖不可避免的会调用失败，比如超时、异常等，Hystrix能够保证在一个依赖出问题的情况下，<strong>不会导致整体服务失败，避免级联故障，以提高分布式系统的弹性</strong>。</p>
<p>“断路器”本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控（类似熔断保险丝），<strong>向调用方返回一个符合预期的、可处理的备选响应（FallBack），而不是长时间的等待或者抛出调用方无法处理的异常</strong>，这样就保证了服务调用方的线程不会被长时间、不必要地占用，从而避免了故障在分布式系统中的蔓延，乃至雪崩。</p>
<h3 id="913hystrix能干嘛">9.1.3、Hystrix能干嘛？</h3>
<ul>
<li>服务降级</li>
<li>服务熔断</li>
<li>接近实时的监控</li>
</ul>
<h3 id="914官网资料">9.1.4、官网资料</h3>
<p><a href="https://github.com/Netflix/Hystrix/wiki/How-To-Use" target="_blank" rel="noopener noreffer">官方资料</a></p>
<h2 id="92hystrix重要概念">9.2、Hystrix重要概念</h2>
<h3 id="921服务降级">9.2.1、服务降级</h3>
<ul>
<li>服务器忙，请稍后再试，不让客户端等待并立刻返回一个友好提示，fallback</li>
<li>哪些情况会触发降级
<ul>
<li>程序运行异常</li>
<li>超时</li>
<li>服务熔断触发降级</li>
<li>线程池/信号量打满也会导致服务降级</li>
</ul>
</li>
</ul>
<h3 id="922服务熔断">9.2.2、服务熔断</h3>
<ul>
<li>类比保险丝达到最大服务访问后，直接拒绝访问，拉闸限电，然后调用服务降级的方法并返回友好提示</li>
<li>就是保险丝
<ul>
<li>服务的降级-&gt;进而熔断-&gt;恢复调用链路</li>
</ul>
</li>
</ul>
<h3 id="923服务限流">9.2.3、服务限流</h3>
<ul>
<li>服务限流
<ul>
<li>秒杀高并发等操作，严禁一窝蜂的过来拥挤，大家排队，一秒钟N个，有序进行</li>
</ul>
</li>
</ul>
<h2 id="93hystrix案例">9.3、hystrix案例</h2>
<h3 id="931构建">9.3.1、构建</h3>
<p>1、新建 cloud-provider-hystrix-payment8001</p>
<p>2、修改POM</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>cloud-provider-hystrix-payment8001<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--hystrix--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--eureka client--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--web--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span><span class="c">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>3、编写YML</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8001</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">spring</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">application</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cloud-provider-hystrix-payment</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">fetch-registry</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c">#defaultZone: http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001.com:7001/eureka</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>4、编写主启动类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.netflix.eureka.EnableEurekaClient</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableEurekaClient</span><span class="c1">//本服务启动后会自动注册进eureka服务中
</span><span class="c1"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentHystrixMain8001</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">PaymentHystrixMain8001</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>5、编写业务类</p>
<ul>
<li>service</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>

<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentService</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * 正常访问，一切OK
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_OK</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="s">&#34;线程池：&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;paymentInfo_OK,id:&#34;</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/*
</span><span class="cm">     * 超时访问，演示降级
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_Timeout</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="kt">int</span> <span class="n">timeoutNumber</span> <span class="o">=</span> <span class="n">3</span><span class="o">;</span>
        <span class="c1">//暂停几秒钟线程
</span><span class="c1"></span>        <span class="k">try</span> <span class="o">{</span>
            <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">timeoutNumber</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="s">&#34;线程池：&#34;</span> <span class="o">+</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getName</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34;paymentInfo_Timeout,id:&#34;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">&#34;耗费时间：&#34;</span> <span class="o">+</span> <span class="n">timeoutNumber</span> <span class="o">+</span> <span class="s">&#34;秒&#34;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>controller</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Value</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PaymentController</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">PaymentService</span> <span class="n">paymentService</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">&#34;${server.port}&#34;</span><span class="o">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">serverPort</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/hystrix/ok/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_OK</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">paymentInfo_OK</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;*********result:&#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/payment/hystrix/timeout/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_Timeout</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">paymentService</span><span class="o">.</span><span class="na">paymentInfo_Timeout</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;*********result:&#34;</span> <span class="o">+</span> <span class="n">result</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>6、正常测试</p>
<ul>
<li>启动eureka7001</li>
<li>启动cloud-provider-hystrix-payment8001</li>
<li>访问
<ul>
<li>success的方法：http://localhost:8001/payment/hystrix/ok/1</li>
<li>每次调用耗费3秒钟：http://localhost:8001/payment/hystrix/timeout/1</li>
</ul>
</li>
<li>上述module均OK
<ul>
<li>以上述为根基平台，从正确-&gt;错误-&gt;降级熔断-&gt;恢复</li>
</ul>
</li>
</ul>
<h3 id="932高并发测试">9.3.2、高并发测试</h3>
<p>1、Jmeter压测测试</p>
<ul>
<li>开启Jmeter，来20000个并发压死8001，20000个请求都去访问paymentInfo_TimeOut服务</li>
<li>再来一个访问：http://localhost:8001/payment/hystrix/ok/1</li>
<li>看演示结果
<ul>
<li>两个都在自己转圈圈</li>
<li>为什么会被卡死
<ul>
<li>tomcat的默认的工作线程数被打满 了，没有多余的线程来分解压力和处理</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>2、Jmeter压测结论</p>
<p>上面还是服务<strong>提供者8001自己测试</strong>，假如此时外部的消费者80也来访问，那<strong>消费者</strong>只能干等，最终导致消费端80不满意，服务端8001直接被拖死</p>
<p>3、看热闹不嫌弃事大，80新建加入</p>
<ol>
<li>新建 cloud-consumer-feign-hystrix-order80</li>
<li>修改POM</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="cp">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0&#34;</span>
         <span class="na">xmlns:xsi=</span><span class="s">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parent&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>SpringCloud<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;/parent&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;artifactId&gt;</span>cloud-consumer-feign-hystrix-order80<span class="nt">&lt;/artifactId&gt;</span>


    <span class="nt">&lt;dependencies&gt;</span>
        <span class="c">&lt;!--openfeign--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-openfeign<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--hystrix--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-hystrix<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--eureka client--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.cloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!-- 引入自己定义的api通用包，可以使用Payment支付Entity --&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>com.clover.springcloud<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>cloud-api-commons<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--web--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-web<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="c">&lt;!--一般基础通用配置--&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.projectlombok<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>lombok<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-test<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>


<span class="nt">&lt;/project&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>编写YML</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">eureka</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">client</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">register-with-eureka</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span><span class="nt">service-url</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">defaultZone</span><span class="p">:</span><span class="w"> </span><span class="l">http://eureka7001.com:7001/eureka/</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>编写主启动类</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.boot.SpringApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.SpringBootApplication</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.openfeign.EnableFeignClients</span><span class="o">;</span>

<span class="nd">@SpringBootApplication</span>
<span class="nd">@EnableFeignClients</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderHystrixMain80</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">OrderHystrixMain80</span><span class="o">.</span><span class="na">class</span><span class="o">,</span><span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>编写业务类</li>
</ol>
<ul>
<li>PaymentHystrixService</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.service</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cloud.openfeign.FeignClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>

<span class="nd">@Component</span>
<span class="nd">@FeignClient</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;CLOUD-PROVIDER-HYSTRIX-PAYMENT&#34;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PaymentHystrixService</span> <span class="o">{</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/payment/hystrix/ok/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_OK</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">);</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/payment/hystrix/timeout/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_Timeout</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>

</code></pre></td></tr></table>
</div>
</div><ul>
<li>OrderHystirxController</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-Java" data-lang="Java"><span class="kn">package</span> <span class="nn">com.clover.springcloud.controller</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.clover.springcloud.service.PaymentHystrixService</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">lombok.extern.slf4j.Slf4j</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.GetMapping</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.PathVariable</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.web.bind.annotation.RestController</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.annotation.Resource</span><span class="o">;</span>

<span class="nd">@RestController</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderHystirxController</span> <span class="o">{</span>

    <span class="nd">@Resource</span>
    <span class="kd">private</span> <span class="n">PaymentHystrixService</span> <span class="n">paymentHystrixService</span><span class="o">;</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/consumer/payment/hystrix/ok/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_OK</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">paymentHystrixService</span><span class="o">.</span><span class="na">paymentInfo_OK</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@GetMapping</span><span class="o">(</span><span class="s">&#34;/consumer/payment/hystrix/timeout/{id}&#34;</span><span class="o">)</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">paymentInfo_Timeout</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">)</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">)</span>
    <span class="o">{</span>
        <span class="k">return</span> <span class="n">paymentHystrixService</span><span class="o">.</span><span class="na">paymentInfo_Timeout</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>正常测试：http://localhost/consumer/payment/hystrix/ok/1</li>
<li>高并发测试
<ol>
<li>2W个线程压8001</li>
<li>消费端80微服务再去访问正常的Ok微服务8001地址</li>
<li>http://localhost/consumer/payment/hystrix/ok/1</li>
<li>消费者80
<ol>
<li>要么转圈圈等待</li>
<li>要么消费端报超时错误</li>
</ol>
</li>
</ol>
</li>
</ol>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019212820.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019212820.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019212820.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019212820.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019212820.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019212820.png" /></p>
<h3 id="933故障现象和导致原因">9.3.3、故障现象和导致原因</h3>
<ol>
<li>8001同一层次的其它接口服务被困死，<strong>因为tomcat线程池里面的工作线程已经被挤占完毕</strong></li>
<li>80此时调用8001，客户端访问响应缓慢，转圈圈</li>
</ol>
<h3 id="934上诉结论">9.3.4、上诉结论</h3>
<p>正因为有上述故障或不佳表现才有我们的<code>降级/容错/限流等</code>技术诞生</p>
<h3 id="935如何解决解决的要求">9.3.5、如何解决？解决的要求</h3>
<ol>
<li>超时导致服务器变慢(转圈)	超时不再等待</li>
<li>出错(宕机或程序运行出错)	出错要有兜底</li>
<li>解决
<ol>
<li>对方服务(8001)超时了，调用者(80)不能一直卡死等待，必须有服务降级</li>
<li>对方服务(8001)down机了，调用者(80)不能一直卡死等待，必须有服务降级</li>
<li>对方服务(8001)OK，调用者(80)自己出故障或有自我要求（自己的等待时间小于服务提供者），自己处理降级</li>
</ol>
</li>
</ol>
<h3 id="936服务降级">9.3.6、服务降级</h3>
<p>1、降级配置  <strong>@HystrixCommand</strong></p>
<p>2、8001先从自身找问题</p>
<ul>
<li>设置自身调用超时时间的峰值，峰值内可以正常运行，超过了需要有兜底的方法处理，作服务降级fallback</li>
</ul>
<p>3、8001fallback</p>
<ul>
<li>
<p>业务类启用</p>
<ul>
<li><strong>@HystrixCommand</strong>报异常后如何处理
<ul>
<li>一旦调用服务方法失败并抛出了错误信息后，会自动调用<code>@HystrixCommand</code>标注好的<code>fallbackMethod</code>调用类中的指定方法</li>
</ul>
</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019215259.png"
        data-srcset="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019215259.png, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019215259.png 1.5x, https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019215259.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019215259.png"
        title="https://cdn.jsdelivr.net/gh/cloverfelix/image/image/20211019215259.png" /></p>
<p>上图故意制造两个异常：</p>
<p>1  int age = 10/0; 计算异常</p>
<p>2  我们能接受3秒钟，它运行5秒钟，超时异常</p>
<p><strong>当前服务不可用了，做服务降级，兜底的方案都是</strong><code>paymentInfo_TimeOutHandler</code></p>
</li>
<li>
<p>主启动类激活</p>
<ul>
<li><strong>添加新注解@EnableCircuitBreaker</strong></li>
</ul>
</li>
</ul>
<p>4、80fallback</p>
<ul>
<li>80订单微服务，也可以更好的保护自己，自己也依样画葫芦进行客户端降级保护</li>
<li><code>题外话，切记</code>
<ul>
<li>我们自己配置过的热部署方式对java代码的改动明显，但对<code>@HystrixCommand内属性的修改建议重启微服务</code></li>
</ul>
</li>
<li>修改YML</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yml" data-lang="yml"><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>修改主启动类
<ul>
<li>加入<code>@EnableHystrix注解</code></li>
</ul>
</li>
<li>修改业务类</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java">
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-10-14</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://cloverfelix.github.io/springcloud/" data-title="Springcloud" data-hashtags="SpringCloud"><i class="fab fa-twitter fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://cloverfelix.github.io/springcloud/" data-hashtag="SpringCloud"><i class="fab fa-facebook-square fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Hacker News" data-sharer="hackernews" data-url="https://cloverfelix.github.io/springcloud/" data-title="Springcloud"><i class="fab fa-hacker-news fa-fw"></i></a><a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://cloverfelix.github.io/springcloud/" data-title="Springcloud"><i data-svg-src="https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg"></i></a><a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://cloverfelix.github.io/springcloud/" data-title="Springcloud"><i class="fab fa-weibo fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/springcloud/">SpringCloud</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/reactexpand/" class="prev" rel="prev" title="ReactExpand"><i class="fas fa-angle-left fa-fw"></i>ReactExpand</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">Clover</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"QEH6MSAUGD","algoliaIndex":"blog","algoliaSearchKey":"83e0e9a01bb86efaff215298300450e1","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
